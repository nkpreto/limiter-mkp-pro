

----------------------------------------------------------------------------------------

limiter-mkp-pro/limiter-mkp-pro.php e o código do arquivo:
<?php
/**
 * Plugin Name: Limiter MKP Pro
 * Plugin URI: https://marketing-place.store/plugins/limiter-mkp-pro
 * Description: Plugin para WordPress multisite que limita a quantidade de páginas e posts que cada subdomínio pode criar. Inclui sistema completo de gestão do ciclo de vida baseado no WooCommerce Subscriptions.
 * Version: 2.3.1
 * Author: Marketing Place Store
 * Author URI: https://marketing-place.store
 * License: GPL-2.0+
 * License URI: http://www.gnu.org/licenses/gpl-2.0.txt
 * Text Domain: limiter-mkp-pro
 * Domain Path: /languages
 * Network: true
 * Requires at least: 5.8
 * Requires PHP: 7.4
 * WC requires at least: 6.0
 * WC tested up to: 7.0
 *
 * @package Limiter_MKP_Pro
 */

// Se este arquivo é chamado diretamente, aborta.
if (!defined('WPINC')) {
    die;
}

/*
 * Declara compatibilidade com HPOS (High-Performance Order Storage) do WooCommerce.
 */
add_action( 'before_woocommerce_init', function() {
    if ( class_exists( \Automattic\WooCommerce\Utilities\FeaturesUtil::class ) ) {
        \Automattic\WooCommerce\Utilities\FeaturesUtil::declare_compatibility( 'custom_order_tables', __FILE__, true );
    }
} );

// Define constantes do plugin
define('LIMITER_MKP_PRO_VERSION', '2.3.1');
define('LIMITER_MKP_PRO_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('LIMITER_MKP_PRO_PLUGIN_URL', plugin_dir_url(__FILE__));
define('LIMITER_MKP_PRO_PLUGIN_BASENAME', plugin_basename(__FILE__));

// Verifica requisitos mínimos antes de ativar
add_action('admin_notices', function() {
    if (!is_multisite()) {
        echo '<div class="notice notice-error"><p>';
        _e('O plugin <strong>Limiter MKP Pro</strong> requer uma instalação WordPress Multisite.', 'limiter-mkp-pro');
        echo '</p></div>';
    }
    
    if (version_compare(PHP_VERSION, '7.4', '<')) {
        echo '<div class="notice notice-error"><p>';
        printf(
            __('O plugin <strong>Limiter MKP Pro</strong> requer PHP 7.4 ou superior. Você está usando PHP %s.', 'limiter-mkp-pro'),
            PHP_VERSION
        );
        echo '</p></div>';
    }
    
    if (defined('WC_VERSION') && version_compare(WC_VERSION, '6.0', '<')) {
        echo '<div class="notice notice-warning"><p>';
        printf(
            __('O plugin <strong>Limiter MKP Pro</strong> funciona melhor com WooCommerce 6.0+. Você está usando WooCommerce %s.', 'limiter-mkp-pro'),
            WC_VERSION
        );
        echo '</p></div>';
    }
});

/**
 * Código executado durante a ativação do plugin.
 */
function activate_limiter_mkp_pro() {
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-activator.php';
    Limiter_MKP_Pro_Activator::activate();
}

/**
 * Código executado durante a desativação do plugin.
 */
function deactivate_limiter_mkp_pro() {
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-deactivator.php';
    Limiter_MKP_Pro_Deactivator::deactivate();
}

/**
 * Remove agendamentos de cron durante a desativação
 */
function limiter_mkp_pro_unschedule_cron_on_deactivation() {
    // Remove o evento principal
    $timestamp = wp_next_scheduled('limiter_mkp_pro_daily_cron');
    if ($timestamp) {
        wp_unschedule_event($timestamp, 'limiter_mkp_pro_daily_cron');
    }
    
    // Remove a fila de processamento se existir
    $queue_timestamp = wp_next_scheduled('limiter_mkp_pro_process_queue');
    if ($queue_timestamp) {
        wp_unschedule_event($queue_timestamp, 'limiter_mkp_pro_process_queue');
    }
}

/**
 * Agenda cron jobs durante a ativação - DEFINIDO PARA 03:00 AM
 */
function limiter_mkp_pro_schedule_cron_on_activation() {
    if (!wp_next_scheduled('limiter_mkp_pro_daily_cron')) {
        // Agenda para as 03:00 da manhã do dia seguinte
        wp_schedule_event(strtotime('tomorrow 03:00:00'), 'daily', 'limiter_mkp_pro_daily_cron');
    }
}

// Registra hooks de ativação/desativação
register_activation_hook(__FILE__, 'activate_limiter_mkp_pro');
register_activation_hook(__FILE__, 'limiter_mkp_pro_schedule_cron_on_activation');
register_deactivation_hook(__FILE__, 'deactivate_limiter_mkp_pro');
register_deactivation_hook(__FILE__, 'limiter_mkp_pro_unschedule_cron_on_deactivation');

/**
 * Inicializa o plugin após o WordPress carregar
 */
function limiter_mkp_pro_init() {
    // Carrega traduções
    load_plugin_textdomain(
        'limiter-mkp-pro',
        false,
        dirname(plugin_basename(__FILE__)) . '/languages'
    );

    // Verifica se é multisite (requisito obrigatório)
    if (!is_multisite()) {
        add_action('admin_notices', function() {
            echo '<div class="notice notice-error"><p>';
            _e('Limiter MKP Pro requer WordPress Multisite. O plugin foi desativado.', 'limiter-mkp-pro');
            echo '</p></div>';
        });

        // Desativa o plugin
        require_once ABSPATH . 'wp-admin/includes/plugin.php';
        deactivate_plugins(plugin_basename(__FILE__));
        return;
    }
    
    // Carrega classes principais
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-limiter-mkp-pro.php';
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-backup-scheduler.php';
    
    // Inicializa o gerenciador do ciclo de vida
    Limiter_MKP_Pro_Lifecycle_Manager::init();

    // Inicializa o agendador de backups
    Limiter_MKP_Pro_Backup_Scheduler::init();

    // Inicializa o plugin principal
    $plugin = new Limiter_MKP_Pro();
    $plugin->run();
}

/**
 * Adiciona itens de menu para o ciclo de vida
 */
function limiter_mkp_pro_add_lifecycle_menu_items($menu_items) {
    $menu_items['lifecycle'] = [
        'title' => __('Ciclo de Vida', 'limiter-mkp-pro'),
        'capability' => 'manage_network',
        'callback' => 'display_lifecycle_settings_page'
    ];
    $menu_items['churn'] = [
        'title' => __('Gestão de Churn', 'limiter-mkp-pro'),
        'capability' => 'manage_network',
        'callback' => 'display_churn_dashboard_page'
    ];
    return $menu_items;
}
add_filter('limiter_mkp_pro_admin_menu_items', 'limiter_mkp_pro_add_lifecycle_menu_items');

/**
 * Funções de Callback para as páginas de administração
 */
function display_lifecycle_settings_page() {
    if (!class_exists('Limiter_MKP_Pro_Admin')) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-admin.php';
    }
    $admin = new Limiter_MKP_Pro_Admin('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
    $admin->display_lifecycle_page();
}

function display_churn_dashboard_page() {
    if (!class_exists('Limiter_MKP_Pro_Admin')) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-admin.php';
    }
    $admin = new Limiter_MKP_Pro_Admin('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
    $admin->display_churn_page();
}

/**
 * Handlers AJAX para o ciclo de vida
 */
function limiter_mkp_pro_register_lifecycle_ajax_handlers() {
    // Handler para salvar configurações do ciclo de vida
    add_action('wp_ajax_limiter_save_lifecycle_settings', function() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-lifecycle-handlers.php';
        $handler = new Limiter_MKP_Pro_Lifecycle_Handlers('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
        $handler->handle_save_lifecycle_settings();
    });
    // Handler para verificação manual
    add_action('wp_ajax_limiter_run_manual_check', function() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-lifecycle-handlers.php';
        $handler = new Limiter_MKP_Pro_Lifecycle_Handlers('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
        $handler->handle_run_manual_check();
    });
    // Handler para enviar email customizado
    add_action('wp_ajax_limiter_send_custom_email', function() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-lifecycle-handlers.php';
        $handler = new Limiter_MKP_Pro_Lifecycle_Handlers('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
        $handler->handle_send_custom_email();
    });
    // Handler para estender período de carência
    add_action('wp_ajax_limiter_extend_grace_period', function() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-lifecycle-handlers.php';
        $handler = new Limiter_MKP_Pro_Lifecycle_Handlers('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
        $handler->handle_extend_grace_period();
    });
}
add_action('init', 'limiter_mkp_pro_register_lifecycle_ajax_handlers');

/**
 * Registra endpoints REST para o ciclo de vida
 */
function limiter_mkp_pro_register_rest_routes() {
    register_rest_route('limiter/v1', '/lifecycle/status/(?P<blog_id>\d+)', [
        'methods' => 'GET',
        'callback' => function($request) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            $blog_id = $request->get_param('blog_id');
            return [
                'blog_id' => $blog_id,
                'status' => Limiter_MKP_Pro_Lifecycle_Manager::get_blog_status($blog_id),
                'days_in_status' => Limiter_MKP_Pro_Lifecycle_Manager::get_days_in_current_status($blog_id),
                'subscription_status' => get_blog_option($blog_id, 'limiter_subscription_status', 'unknown')
            ];
        },
        'permission_callback' => function() {
            return current_user_can('manage_network');
        }
    ]);
    register_rest_route('limiter/v1', '/churn/metrics', [
        'methods' => 'GET',
        'callback' => function() {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database-lifecycle.php';
            return Limiter_MKP_Pro_Database_Lifecycle::get_lifecycle_stats();
        },
        'permission_callback' => function() {
            return current_user_can('manage_network');
        }
    ]);
}
add_action('rest_api_init', 'limiter_mkp_pro_register_rest_routes');

/**
 * Adiciona webhooks para eventos do ciclo de vida
 */
function limiter_mkp_pro_setup_webhooks() {
    $webhooks = get_network_option(null, 'limiter_mkp_pro_webhooks', []);
    if (!empty($webhooks)) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-webhooks.php';
        Limiter_MKP_Pro_Webhooks::init($webhooks);
    }
}
add_action('plugins_loaded', 'limiter_mkp_pro_setup_webhooks');

/**
 * Adiciona scripts e estilos para o ciclo de vida
 */
function limiter_mkp_pro_enqueue_lifecycle_assets() {
    $screen = get_current_screen();
    if (strpos($screen->id, 'limiter-mkp-pro') !== false) {
        // CSS do ciclo de vida
        wp_enqueue_style(
            'limiter-mkp-pro-lifecycle',
            LIMITER_MKP_PRO_PLUGIN_URL . 'assets/css/lifecycle.css',
            [],
            LIMITER_MKP_PRO_VERSION
        );
        // JS do ciclo de vida
        wp_enqueue_script(
            'limiter-mkp-pro-lifecycle',
            LIMITER_MKP_PRO_PLUGIN_URL . 'assets/js/lifecycle.js',
            ['jquery', 'wp-util'],
            LIMITER_MKP_PRO_VERSION,
            true
        );
        wp_localize_script('limiter-mkp-pro-lifecycle', 'limiter_lifecycle', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('limiter_lifecycle_nonce'),
            'i18n' => [
                'confirm_action' => __('Tem certeza que deseja executar esta ação?', 'limiter-mkp-pro'),
                'processing' => __('Processando...', 'limiter-mkp-pro'),
                'success' => __('Ação concluída com sucesso!', 'limiter-mkp-pro'),
                'error' => __('Ocorreu um erro. Por favor, tente novamente.', 'limiter-mkp-pro')
            ]
        ]);
    }
}
add_action('admin_enqueue_scripts', 'limiter_mkp_pro_enqueue_lifecycle_assets');

/**
 * Hooks para eventos do WooCommerce Subscriptions
 */
function limiter_mkp_pro_woocommerce_hooks() {
    if (class_exists('WC_Subscriptions')) {
        add_action('woocommerce_subscription_status_updated', function($subscription, $new_status, $old_status) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            Limiter_MKP_Pro_Lifecycle_Manager::handle_subscription_status_change($subscription, $new_status, $old_status);
        }, 10, 3);
        add_action('woocommerce_subscription_payment_failed', function($subscription) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            Limiter_MKP_Pro_Lifecycle_Manager::handle_payment_failed($subscription);
        });
        add_action('woocommerce_subscription_payment_complete', function($subscription) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            Limiter_MKP_Pro_Lifecycle_Manager::handle_payment_complete($subscription);
        });
        add_action('woocommerce_subscription_cancelled', function($subscription) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            Limiter_MKP_Pro_Lifecycle_Manager::handle_cancellation($subscription);
        });
        add_action('woocommerce_subscription_expired', function($subscription) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            Limiter_MKP_Pro_Lifecycle_Manager::handle_expiration($subscription);
        });
    }
}
add_action('woocommerce_loaded', 'limiter_mkp_pro_woocommerce_hooks');

/**
 * Inicializa o plugin
 */
function run_limiter_mkp_pro() {
    // ALTERAÇÃO: Mudança de 'plugins_loaded' com prioridade 15 para 'init' com prioridade 20
    // Isso garante que o WooCommerce já carregou suas traduções, evitando o Notice.
    add_action('init', 'limiter_mkp_pro_init', 20);
}

// Executa o plugin
run_limiter_mkp_pro();



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-admin.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo painel de administração do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin
 */
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Admin {
    
    private $plugin_name;
    private $version;

    /**
     * Inicializa a classe e define suas propriedades.
     *
     * @since    1.0.0
     * @param    string    $plugin_name       O nome do plugin.
     * @param    string    $version           A versão do plugin.
     */
    public function __construct($plugin_name, $version) {
        $this->plugin_name = sanitize_text_field($plugin_name);
        $this->version = sanitize_text_field($version);
    }

    /**
     * Carrega CSS do admin.
     *
     * @since    1.0.0
     */
    public function enqueue_styles() {
        wp_enqueue_style(
            $this->plugin_name,
            plugin_dir_url(__FILE__) . 'css/admin.css',
            array(),
            $this->version,
            'all'
        
        );
    }

    /**
     * Carrega JS do admin.
     * * ATUALIZAÇÃO: Adicionada dependência 'jquery-ui-autocomplete' para busca AJAX de sites.
     *
     * @since    1.0.0
     */
    public function enqueue_scripts() {
        // Enqueue jQuery UI Autocomplete para a busca de sites otimizada
        wp_enqueue_script('jquery-ui-autocomplete');

        wp_enqueue_script(
            $this->plugin_name,
            plugin_dir_url(__FILE__) . 'js/admin.js',
            array('jquery', 'jquery-ui-autocomplete'), // Dependência necessária para o campo de busca
            $this->version,
            true
        );

        wp_localize_script($this->plugin_name, 'limiter_mkp_pro_admin', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('limiter_mkp_pro_admin_nonce'),
            'messages' => array(
                'confirm_delete' => __('Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.', 'limiter-mkp-pro'),
                'success' => __('Operação realizada com sucesso!', 'limiter-mkp-pro'),
                'error' => __('Ocorreu um erro. Por favor, tente novamente.', 'limiter-mkp-pro')
            )
        ));
    }

    /**
     * Menu no admin da rede.
     *
     * @since    1.0.0
     */
    public function add_network_admin_menu() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            return;
        }
        
        add_menu_page(
            __('Limiter MKP Pro', 'limiter-mkp-pro'),
            __('Limiter MKP Pro', 'limiter-mkp-pro'),
            'manage_network',
            'limiter-mkp-pro',
            array($this, 'display_dashboard_page'),
            'dashicons-chart-area',
            3
        );

        add_submenu_page('limiter-mkp-pro', __('Dashboard', 'limiter-mkp-pro'), __('Dashboard', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro', array($this, 'display_dashboard_page'));

        add_submenu_page('limiter-mkp-pro', __('Planos', 'limiter-mkp-pro'), __('Planos', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro-planos', array($this, 'display_planos_page'));

        add_submenu_page('limiter-mkp-pro', __('Subdomínios', 'limiter-mkp-pro'), __('Subdomínios', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro-subdominios', array($this, 'display_subdominios_page'));

        add_submenu_page('limiter-mkp-pro', __('Adicionar Subdomínio', 'limiter-mkp-pro'), __('Adicionar Subdomínio', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro-adicionar-subdominio', array($this, 'display_adicionar_subdominio_page'));

        add_submenu_page('limiter-mkp-pro', __('Configurações', 'limiter-mkp-pro'), __('Configurações', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro-configuracoes', array($this, 'display_configuracoes_page'));
            
        // NOVO MENU FERRAMENTAS
        add_submenu_page('limiter-mkp-pro', __('Ferramentas', 'limiter-mkp-pro'), __('Ferramentas', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro-tools', array($this, 'display_tools_page'));

        add_submenu_page('limiter-mkp-pro', __('Logs', 'limiter-mkp-pro'), __('Logs', 'limiter-mkp-pro'),
            'manage_network', 'limiter-mkp-pro-logs', array($this, 'display_logs_page'));

        // Menus de Ciclo de Vida e Churn
        add_submenu_page('limiter-mkp-pro', 
            __('Ciclo de Vida', 'limiter-mkp-pro'), 
            __('Ciclo de Vida', 'limiter-mkp-pro'),
            'manage_network', 
            'limiter-mkp-pro-lifecycle', 
            array($this, 'display_lifecycle_page')
        );

        add_submenu_page('limiter-mkp-pro', 
            __('Gestão de Churn', 'limiter-mkp-pro'), 
            __('Gestão de Churn', 'limiter-mkp-pro'),
            'manage_network', 
            'limiter-mkp-pro-churn', 
            array($this, 'display_churn_page')
        );
    }

    /**
     * Dashboard.
     *
     * @since    1.0.0
     */
    public function display_dashboard_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database-get-estatisticas.php';
        $estatisticas = Limiter_MKP_Pro_Database_Get_Estatisticas::get_estatisticas_gerais();
        $distribuicao_planos = Limiter_MKP_Pro_Database_Get_Estatisticas::get_distribuicao_planos();
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/dashboard.php';
    }

    /**
     * Página de planos.
     *
     * @since    1.0.0
     */
    public function display_planos_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $planos = Limiter_MKP_Pro_Database::get_planos();
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/planos.php';
    }

    /**
     * Página de subdomínios.
     *
     * @since    1.0.0
     */
    public function display_subdominios_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $subdominios = Limiter_MKP_Pro_Database::get_subdominios();
        $planos = Limiter_MKP_Pro_Database::get_planos();
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/subdominios.php';
    }

    /**
     * Página para adicionar subdomínio.
     * * OTIMIZAÇÃO: Removida a chamada get_sites() que carregava todos os sites da rede.
     * A seleção agora é feita via AJAX Search no partial.
     *
     * @since    1.0.0
     */
    public function display_adicionar_subdominio_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        // Mantemos os subdomínios já cadastrados para validação visual se necessário, 
        // mas em redes gigantes isso também poderia ser otimizado no futuro.
        $subdominios = Limiter_MKP_Pro_Database::get_subdominios();
        $blog_ids_cadastrados = array_map(function($s) { return intval($s->blog_id); }, $subdominios);
        
        $planos = Limiter_MKP_Pro_Database::get_planos();
        // O partial agora usará o campo de busca AJAX
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/adicionar-subdominio.php';
    }

    /**
     * Página de configurações.
     *
     * @since    1.0.0
     */
    public function display_configuracoes_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $config = wp_parse_args($config, array(
            'email_notificacao' => 'alterar-plano@marketing-place.store',
            'limite_alerta' => 1,
            'mensagem_limite' => 'Desculpe o inconveniente, mas seu plano tem suporte a criação de [X] páginas. Considere fazer upgrade.',
            'mensagem_alerta' => 'Você está na penúltima página. Considere fazer upgrade.'
        ));
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/configuracoes.php';
    }

    /**
     * NOVA PÁGINA: Ferramentas (Recursos Ocultos)
     */
    public function display_tools_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        // Inclui o template de ferramentas
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/ferramentas.php';
    }

    /**
     * Página de logs.
     *
     * @since    1.0.0
     */
    public function display_logs_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $blog_id = isset($_GET['blog_id']) ? intval($_GET['blog_id']) : null;
        $logs = Limiter_MKP_Pro_Database::get_logs(100, $blog_id);
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/logs.php';
    }

    // Métodos para exibir as páginas de Ciclo de Vida e Gestão de Churn
    public function display_lifecycle_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/lifecycle-settings.php';
    }

    public function display_churn_page() {
        if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
            wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
        }
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/churn-dashboard.php';
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-admin-handlers.php e os codigos deste arquivo:
<?php
if (!defined('ABSPATH')) {
    exit;
}

// Carrega a Trait de segurança
require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-security-trait.php';

class Limiter_MKP_Pro_Admin_Handlers {
    use Limiter_MKP_Pro_Security_Trait;
    private $plugin_name;
    private $version;

    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
        // Hooks AJAX existentes
        add_action('wp_ajax_limiter_mkp_pro_search_sites', array($this, 'handle_search_sites_ajax'));
        add_action('wp_ajax_limiter_mkp_pro_generate_backup', array($this, 'handle_generate_backup_ajax'));
        add_action('wp_ajax_limiter_mkp_pro_generate_site_backup', array($this, 'handle_generate_site_backup_ajax'));
        add_action('wp_ajax_limiter_mkp_pro_delete_backup', array($this, 'handle_delete_backup_ajax'));
        
        // Save Plano
        add_action('wp_ajax_limiter_mkp_pro_save_plano', array($this, 'handle_save_plano'));
        add_action('wp_ajax_limiter_mkp_pro_delete_plano', array($this, 'handle_delete_plano'));
        add_action('wp_ajax_limiter_mkp_pro_save_subdominio', array($this, 'handle_save_subdominio'));
        add_action('wp_ajax_limiter_mkp_pro_save_configuracoes', array($this, 'handle_save_configuracoes'));
        add_action('wp_ajax_limiter_mkp_pro_limpar_logs', array($this, 'handle_limpar_logs'));
    }

    private function log_error($message, $data = []) {
        $log_msg = '[Limiter MKP Pro Error]: ' . $message;
        if (!empty($data)) {
            $log_msg .= ' ' . json_encode($data);
        }
        error_log($log_msg);
    }

    private function verify_ajax_permissions() {
        if (!current_user_can('manage_network')) {
            wp_send_json_error(['message' => 'Você não tem permissão para realizar esta operação.']);
            exit;
        }
        if (!is_multisite()) {
            wp_send_json_error(['message' => 'Este plugin requer uma instalação WordPress Multisite.']);
            exit;
        }
    }

    private function verify_ajax_nonce($nonce, $action) {
        if (!wp_verify_nonce($nonce, $action)) {
            wp_send_json_error(['message' => 'Token de segurança inválido.']);
            exit;
        }
    }

    // --- HANDLER ATUALIZADO DE SALVAR PLANO ---

    public function handle_save_plano() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');
            
            $id = intval($_POST['id'] ?? 0);
            $nome = sanitize_text_field($_POST['nome'] ?? '');
            $descricao = sanitize_textarea_field($_POST['descricao'] ?? '');
            $duracao = intval($_POST['duracao'] ?? 30);
            $limite_paginas = intval($_POST['limite_paginas'] ?? 10);
            $limite_inodes = intval($_POST['limite_inodes'] ?? 1000);
            $limite_upload_mb = intval($_POST['limite_upload_mb'] ?? 100);
            
            // NOVOS CAMPOS
            $backup_frequency = sanitize_text_field($_POST['backup_frequency'] ?? 'none');
            $backup_retention = intval($_POST['backup_retention'] ?? 3);

            $post_types_contaveis = isset($_POST['post_types_contaveis']) ? 
                array_map('sanitize_text_field', $_POST['post_types_contaveis']) : ['page', 'post'];
            $post_status_contaveis = isset($_POST['post_status_contaveis']) ?
                array_map('sanitize_text_field', $_POST['post_status_contaveis']) : ['publish', 'draft', 'trash'];
            
            $woocommerce_product_ids = [];
            if (isset($_POST['woocommerce_product_ids']) && is_array($_POST['woocommerce_product_ids'])) {
                $woocommerce_product_ids = array_map('intval', $_POST['woocommerce_product_ids']);
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-planos.php';
            $planos = new Limiter_MKP_Pro_Planos($this->plugin_name, $this->version);
            
            $resultado = $planos->save_plano([
                'id' => $id,
                'nome' => $nome,
                'descricao' => $descricao,
                'duracao' => $duracao,
                'limite_paginas' => $limite_paginas,
                'limite_inodes' => $limite_inodes,
                'limite_upload_mb' => $limite_upload_mb,
                
                // Passa os novos campos
                'backup_frequency' => $backup_frequency,
                'backup_retention' => $backup_retention,
                
                'post_types_contaveis' => $post_types_contaveis,
                'post_status_contaveis' => $post_status_contaveis
            ]);
            
            if ($resultado) {
                $planos->save_plano_woocommerce_products($resultado, $woocommerce_product_ids);
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
                Limiter_MKP_Pro_Cache_Manager::clear_all();
                wp_send_json_success(['message' => 'Plano salvo com sucesso!']);
            } else {
                $this->log_error('Falha ao salvar plano', ['nome' => $nome]);
                wp_send_json_error(['message' => 'Não foi possível salvar o plano.']);
            }
        } catch (Exception $e) {
            $this->log_error($e->getMessage());
            wp_send_json_error(['message' => 'Erro interno ao salvar plano.']);
        }
    }

    public function handle_delete_plano() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');
            $id = intval($_POST['id'] ?? 0);
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-planos.php';
            $planos = new Limiter_MKP_Pro_Planos($this->plugin_name, $this->version);
            if ($planos->delete_plano($id)) {
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
                Limiter_MKP_Pro_Cache_Manager::clear_all();
                wp_send_json_success(['message' => 'Plano excluído com sucesso!']);
            } else {
                wp_send_json_error(['message' => 'Não foi possível excluir o plano. Verifique se ele está sendo usado por algum subdomínio.']);
            }
        } catch (Exception $e) {
            $this->log_error($e->getMessage());
            wp_send_json_error(['message' => 'Erro interno ao excluir plano.']);
        }
    }

    public function handle_save_subdominio() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            $plano_id = intval($_POST['plano_id'] ?? 0);
            if ($blog_id <= 0 || $plano_id <= 0) {
                wp_send_json_error(['message' => 'Dados inválidos.']);
                exit;
            }

            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-subdominios.php';
            $subdominios = new Limiter_MKP_Pro_Subdominios($this->plugin_name, $this->version);
            
            $resultado = $subdominios->save_subdominio([
                'blog_id' => $blog_id,
                'dominio' => sanitize_text_field($_POST['dominio'] ?? ''),
                'plano_id' => $plano_id,
                'limite_personalizado' => !empty($_POST['limite_personalizado']) ? intval($_POST['limite_personalizado']) : null,
                'limite_personalizado_inodes' => !empty($_POST['limite_personalizado_inodes']) ? intval($_POST['limite_personalizado_inodes']) : null,
                'nome_cliente' => sanitize_text_field($_POST['nome_cliente'] ?? ''),
                'email_cliente' => sanitize_email($_POST['email_cliente'] ?? ''),
                'telefone_cliente' => sanitize_text_field($_POST['telefone_cliente'] ?? ''),
                'status' => 'active',
                'regiao' => sanitize_text_field($_POST['regiao'] ?? 'global')
            ]);
            if ($resultado) {
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
                Limiter_MKP_Pro_Cache_Manager::clear_all();
                wp_send_json_success(['message' => 'Subdomínio salvo com sucesso!']);
            } else {
                wp_send_json_error(['message' => 'Erro ao salvar subdomínio.']);
            }
        } catch (Exception $e) {
            $this->log_error($e->getMessage());
            wp_send_json_error(['message' => 'Erro interno.']);
        }
    }

    public function handle_save_configuracoes() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');
            
            $config_data = [
                'email_notificacao' => sanitize_email($_POST['email_notificacao'] ?? ''),
                'limite_alerta' => intval($_POST['limite_alerta'] ?? 1),
                'mensagem_limite' => sanitize_textarea_field($_POST['mensagem_limite'] ?? ''),
                'mensagem_alerta' => sanitize_textarea_field($_POST['mensagem_alerta'] ?? ''),
                'planos_url_global' => esc_url_raw($_POST['planos_url_global'] ?? ''),
                'planos_url_jp' => esc_url_raw($_POST['planos_url_jp'] ?? ''),
                'sufixo_subdominio' => sanitize_text_field($_POST['sufixo_subdominio'] ?? '-mkp'),
                'nome_sistema' => sanitize_text_field($_POST['nome_sistema'] ?? 'Marketing Place Store'),
                'widget_alerta_limite' => sanitize_textarea_field($_POST['widget_alerta_limite'] ?? ''),
                'widget_sem_plano' => sanitize_textarea_field($_POST['widget_sem_plano'] ?? ''),
                'alerta_limite_arquivos_80' => sanitize_textarea_field($_POST['alerta_limite_arquivos_80'] ?? ''),
                'alerta_limite_arquivos_100' => sanitize_textarea_field($_POST['alerta_limite_arquivos_100'] ?? ''),
                'subdominio_disponivel' => sanitize_text_field($_POST['subdominio_disponivel'] ?? ''),
                'subdominio_indisponivel' => sanitize_text_field($_POST['subdominio_indisponivel'] ?? ''),
                'subdominio_curto' => sanitize_text_field($_POST['subdominio_curto'] ?? ''),
                'registro_concluido' => sanitize_text_field($_POST['registro_concluido'] ?? ''),
                'email_solicitacao_titulo' => sanitize_text_field($_POST['email_solicitacao_titulo'] ?? ''),
                'email_solicitacao_corpo' => sanitize_textarea_field($_POST['email_solicitacao_corpo'] ?? ''),
                'email_confirmacao_aprovada_titulo' => sanitize_text_field($_POST['email_confirmacao_aprovada_titulo'] ?? ''),
                'email_confirmacao_aprovada_corpo' => sanitize_textarea_field($_POST['email_confirmacao_aprovada_corpo'] ?? ''),
                'email_configuracao_subdominio_titulo' => sanitize_text_field($_POST['email_configuracao_subdominio_titulo'] ?? ''),
                'email_configuracao_subdominio_corpo' => sanitize_textarea_field($_POST['email_configuracao_subdominio_corpo'] ?? ''),
                'botao_ver_planos' => sanitize_text_field($_POST['botao_ver_planos'] ?? ''),
                'botao_acessar_loja' => sanitize_text_field($_POST['botao_acessar_loja'] ?? '')
            ];
            
            $subdomain_blacklist = array();
            if (isset($_POST['subdomain_blacklist']) && is_array($_POST['subdomain_blacklist'])) {
                foreach ($_POST['subdomain_blacklist'] as $word) {
                    $clean_word = sanitize_text_field(trim($word));
                    if (!empty($clean_word)) {
                        $subdomain_blacklist[] = $clean_word;
                    }
                }
            }
            $config_data['subdomain_blacklist'] = $subdomain_blacklist;
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
            $configuracoes = new Limiter_MKP_Pro_Configuracoes($this->plugin_name, $this->version);
            
            if ($configuracoes->save_configuracoes($config_data)) {
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
                Limiter_MKP_Pro_Cache_Manager::clear_all();
                wp_send_json_success(['message' => 'Configurações salvas com sucesso!']);
            } else {
                wp_send_json_success(['message' => 'Configurações salvas.']);
            }
        } catch (Exception $e) {
            $this->log_error($e->getMessage());
            wp_send_json_error(['message' => 'Erro interno ao salvar configurações.']);
        }
    }

    public function handle_limpar_logs() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');
            
            $dias = intval($_POST['dias'] ?? 90);
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-logs.php';
            $logs = new Limiter_MKP_Pro_Logs($this->plugin_name, $this->version);
            $removidos = $logs->limpar_logs_antigos($dias);
            
            wp_send_json_success(['message' => sprintf('Removidos %d logs.', $removidos)]);
        } catch (Exception $e) {
            wp_send_json_error(['message' => 'Erro ao limpar logs.']);
        }
    }

    public function handle_search_sites_ajax() {
        try {
            $this->verify_ajax_permissions();
            if (!isset($_GET['nonce']) || !wp_verify_nonce($_GET['nonce'], 'limiter_mkp_pro_admin_nonce')) {
               wp_send_json_error(['message' => 'Nonce inválido']);
               exit;
            }

            $term = sanitize_text_field($_GET['term'] ?? '');
            if (strlen($term) < 3) {
                wp_send_json_success([]);
                exit;
            }

            global $wpdb;
            $query = $wpdb->prepare(
                "SELECT blog_id, domain, path FROM {$wpdb->blogs} 
                 WHERE (domain LIKE %s OR path LIKE %s) 
                 AND deleted = 0 AND archived = '0' AND spam = '0'
                 LIMIT 20",
                '%' . $wpdb->esc_like($term) . '%',
                '%' . $wpdb->esc_like($term) . '%'
            );
            $sites = $wpdb->get_results($query);
            $results = [];
            
            foreach ($sites as $site) {
                $details = get_blog_details($site->blog_id);
                $label = $details ? $details->blogname . ' (' . $site->domain . $site->path . ')' : $site->domain;
                $results[] = [
                    'id' => $site->blog_id,
                    'label' => $label,
                    'value' => $label,
                    'domain' => $site->domain . $site->path
                ];
            }
            
            wp_send_json_success($results);
        } catch (Exception $e) {
            wp_send_json_error(['message' => 'Erro na busca']);
        }
    }

    public function handle_generate_backup_ajax() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');

            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-backup.php';
            
            $upload_dir = wp_upload_dir();
            $backup_dir = $upload_dir['basedir'] . '/limiter-mkp-pro-backups/';
            if (!file_exists($backup_dir)) {
                wp_mkdir_p($backup_dir);
                file_put_contents($backup_dir . '.htaccess', 'deny from all');
                file_put_contents($backup_dir . 'index.php', '<?php // Silence is golden');
            }

            $includes = isset($_POST['includes']) ? array_map('sanitize_text_field', $_POST['includes']) : ['config'];
            $data = Limiter_MKP_Pro_Backup::export_settings($includes);
            $filename = 'limiter-system-backup-' . date('Y-m-d-H-i-s') . '.json';
            $file_path = $backup_dir . $filename;

            if (file_put_contents($file_path, json_encode($data, JSON_PRETTY_PRINT))) {
                wp_send_json_success(['message' => 'Backup gerado com sucesso!', 'file' => $filename]);
            } else {
                wp_send_json_error(['message' => 'Falha ao salvar arquivo. Verifique permissões.']);
            }
        } catch (Exception $e) {
            wp_send_json_error(['message' => $e->getMessage()]);
        }
    }

    public function handle_generate_site_backup_ajax() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');

            $blog_id = intval($_POST['blog_id']);
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'Selecione um site válido.']);
                exit;
            }

            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-backup.php';
            
            $filename = Limiter_MKP_Pro_Backup::export_subdomain_sql($blog_id);

            if ($filename) {
                wp_send_json_success([
                    'message' => 'Backup do Site (SQL) gerado com sucesso!',
                    'file' => $filename
                ]);
            } else {
                wp_send_json_error(['message' => 'Falha ao exportar banco de dados.']);
            }

        } catch (Exception $e) {
            $this->log_error($e->getMessage());
            wp_send_json_error(['message' => 'Erro crítico: ' . $e->getMessage()]);
        }
    }

    public function handle_delete_backup_ajax() {
        try {
            $this->verify_ajax_permissions();
            $this->verify_ajax_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_admin_nonce');

            $filename = sanitize_file_name($_POST['file']);
            
            $upload_dir = wp_upload_dir();
            $backup_dir = $upload_dir['basedir'] . '/limiter-mkp-pro-backups/';
            $file_path = $backup_dir . $filename;

            if (file_exists($file_path) && is_file($file_path) && (strpos($filename, 'limiter-') === 0 || strpos($filename, 'backup-site-') === 0)) {
                if (unlink($file_path)) {
                    wp_send_json_success(['message' => 'Backup excluído com sucesso.']);
                } else {
                    wp_send_json_error(['message' => 'Erro ao excluir o arquivo. Verifique as permissões.']);
                }
            } else {
                wp_send_json_error(['message' => 'Arquivo não encontrado ou inválido.']);
            }

        } catch (Exception $e) {
            $this->log_error($e->getMessage());
            wp_send_json_error(['message' => 'Erro ao excluir: ' . $e->getMessage()]);
        }
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-configuracoes.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelas configurações do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin
 */
class Limiter_MKP_Pro_Configuracoes {

    private $plugin_name;
    private $version;

    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }

    public function get_configuracoes() {
        $configuracoes = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        
        // Define valores padrão
        $defaults = self::get_defaults();

        return wp_parse_args($configuracoes, $defaults);
    }

    public function save_configuracoes($data) {
        // 1. Recupera as configurações atuais do banco para evitar perda de dados (Overwrite vs Merge)
        $current_config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        
        // Se não for array (primeira instalação), inicializa vazio
        if (!is_array($current_config)) {
            $current_config = array();
        }

        // 2. Processa a Blacklist
        $blacklist = array();
        if (isset($data['subdomain_blacklist']) && is_array($data['subdomain_blacklist'])) {
            foreach ($data['subdomain_blacklist'] as $word) {
                $word = sanitize_text_field(trim($word));
                if (!empty($word)) {
                    $blacklist[] = $word;
                }
            }
        } else {
            // Mantém a blacklist existente se não foi fornecida no $data
            $blacklist = isset($current_config['subdomain_blacklist']) ? $current_config['subdomain_blacklist'] : self::get_subdomain_blacklist();
        }

        // 3. Prepara os novos dados, usando o operador de coalescência nula (??) 
        // para manter o valor atual caso o campo não venha no $data.
        $novos_dados = array(
            'email_notificacao' => isset($data['email_notificacao']) ? sanitize_email($data['email_notificacao']) : ($current_config['email_notificacao'] ?? ''),
            'limite_alerta' => isset($data['limite_alerta']) ? intval($data['limite_alerta']) : ($current_config['limite_alerta'] ?? 1),
            'mensagem_limite' => isset($data['mensagem_limite']) ? sanitize_textarea_field($data['mensagem_limite']) : ($current_config['mensagem_limite'] ?? ''),
            'mensagem_alerta' => isset($data['mensagem_alerta']) ? sanitize_textarea_field($data['mensagem_alerta']) : ($current_config['mensagem_alerta'] ?? ''),
            'planos_url_global' => isset($data['planos_url_global']) ? esc_url_raw($data['planos_url_global']) : ($current_config['planos_url_global'] ?? ''),
            'planos_url_jp' => isset($data['planos_url_jp']) ? esc_url_raw($data['planos_url_jp']) : ($current_config['planos_url_jp'] ?? ''),
            'sufixo_subdominio' => isset($data['sufixo_subdominio']) ? sanitize_text_field($data['sufixo_subdominio']) : ($current_config['sufixo_subdominio'] ?? '-mkp'),
            'subdomain_blacklist' => $blacklist,
            'nome_sistema' => isset($data['nome_sistema']) ? sanitize_text_field($data['nome_sistema']) : ($current_config['nome_sistema'] ?? ''),
            'widget_alerta_limite' => isset($data['widget_alerta_limite']) ? sanitize_textarea_field($data['widget_alerta_limite']) : ($current_config['widget_alerta_limite'] ?? ''),
            'widget_sem_plano' => isset($data['widget_sem_plano']) ? sanitize_textarea_field($data['widget_sem_plano']) : ($current_config['widget_sem_plano'] ?? ''),
            'alerta_limite_arquivos_80' => isset($data['alerta_limite_arquivos_80']) ? sanitize_textarea_field($data['alerta_limite_arquivos_80']) : ($current_config['alerta_limite_arquivos_80'] ?? ''),
            'alerta_limite_arquivos_100' => isset($data['alerta_limite_arquivos_100']) ? sanitize_textarea_field($data['alerta_limite_arquivos_100']) : ($current_config['alerta_limite_arquivos_100'] ?? ''),
            'subdominio_disponivel' => isset($data['subdominio_disponivel']) ? sanitize_text_field($data['subdominio_disponivel']) : ($current_config['subdominio_disponivel'] ?? ''),
            'subdominio_indisponivel' => isset($data['subdominio_indisponivel']) ? sanitize_text_field($data['subdominio_indisponivel']) : ($current_config['subdominio_indisponivel'] ?? ''),
            'subdominio_curto' => isset($data['subdominio_curto']) ? sanitize_text_field($data['subdominio_curto']) : ($current_config['subdominio_curto'] ?? ''),
            'registro_concluido' => isset($data['registro_concluido']) ? sanitize_text_field($data['registro_concluido']) : ($current_config['registro_concluido'] ?? ''),
            'email_solicitacao_titulo' => isset($data['email_solicitacao_titulo']) ? sanitize_text_field($data['email_solicitacao_titulo']) : ($current_config['email_solicitacao_titulo'] ?? ''),
            'email_solicitacao_corpo' => isset($data['email_solicitacao_corpo']) ? sanitize_textarea_field($data['email_solicitacao_corpo']) : ($current_config['email_solicitacao_corpo'] ?? ''),
            'email_confirmacao_aprovada_titulo' => isset($data['email_confirmacao_aprovada_titulo']) ? sanitize_text_field($data['email_confirmacao_aprovada_titulo']) : ($current_config['email_confirmacao_aprovada_titulo'] ?? ''),
            'email_confirmacao_aprovada_corpo' => isset($data['email_confirmacao_aprovada_corpo']) ? sanitize_textarea_field($data['email_confirmacao_aprovada_corpo']) : ($current_config['email_confirmacao_aprovada_corpo'] ?? ''),
            'email_configuracao_subdominio_titulo' => isset($data['email_configuracao_subdominio_titulo']) ? sanitize_text_field($data['email_configuracao_subdominio_titulo']) : ($current_config['email_configuracao_subdominio_titulo'] ?? ''),
            'email_configuracao_subdominio_corpo' => isset($data['email_configuracao_subdominio_corpo']) ? sanitize_textarea_field($data['email_configuracao_subdominio_corpo']) : ($current_config['email_configuracao_subdominio_corpo'] ?? ''),
            'botao_ver_planos' => isset($data['botao_ver_planos']) ? sanitize_text_field($data['botao_ver_planos']) : ($current_config['botao_ver_planos'] ?? ''),
            'botao_acessar_loja' => isset($data['botao_acessar_loja']) ? sanitize_text_field($data['botao_acessar_loja']) : ($current_config['botao_acessar_loja'] ?? '')
        );

        // 4. Merge final: Garante que chaves extras (não presentes no form) sejam preservadas
        $config_final = array_merge($current_config, $novos_dados);

        return update_network_option(null, 'limiter_mkp_pro_configuracoes', $config_final);
    }

    /**
     * Obtém uma mensagem específica da configuração
     */
    public static function get_mensagem($chave) {
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $defaults = self::get_defaults();
        return isset($config[$chave]) ? $config[$chave] : (isset($defaults[$chave]) ? $defaults[$chave] : '');
    }

    /**
     * Define valores padrão para todas as mensagens
     */
    private static function get_defaults() {
        $default_blacklist = array(
            'admin', 'suporte', 'root', 'api', 'www', 'mail', 'ftp', 'loja-oficial', 
            'login', 'wp', 'pagamento', 'cpanel', 'system', 'support', 'host', 'server',
            'webmail', 'backup', 'secure', 'ssl', 'cdn', 'test', 'demo'
        );

        return array(
            'email_notificacao' => 'alterar-plano@marketing-place.store',
            'limite_alerta' => 1,
            'mensagem_limite' => 'Desculpe o inconveniente, mas seu plano tem suporte a criação de [X] páginas. Considere fazer upgrade.',
            'mensagem_alerta' => 'Você está na penúltima página. Considere fazer upgrade.',
            'planos_url_global' => home_url('/planos/'),
            'planos_url_jp' => home_url('/planos-jp/'),
            'sufixo_subdominio' => '-mkp',
            'subdomain_blacklist' => $default_blacklist,
            'nome_sistema' => 'Marketing Place Store',
            'widget_titulo' => 'Limiter MKP Pro - Status do Plano',
            'widget_sem_plano' => 'Este subdomínio não possui um plano configurado. Entre em contato com o administrador da rede.',
            'widget_alerta_limite' => "⚠️ Limite Próximo\nVocê está usando [PERCENTUAL]% do seu limite. Considere fazer upgrade para continuar criando conteúdo.",
            'widget_sistema_automatico' => "Sistema Automático via WooCommerce\nPara mudar de plano, acesse nossa loja WooCommerce.\nApós o pagamento, a mudança é automática.",
            'alerta_limite_arquivos_80' => '⚠️ Aviso: 80% do limite de arquivos usado ([ARQUIVOS_USADOS]/[ARQUIVOS_LIMITE]) — Plano [NOME_PLANO].',
            'alerta_limite_arquivos_100' => "🚫 Limite de arquivos atingido: [ARQUIVOS_USADOS] de [ARQUIVOS_LIMITE] arquivos no plano [NOME_PLANO].\nExclua mídias antigas ou atualize seu plano.",
            'solicitacao_pendente' => "Sua solicitação está sendo analisada.\nVocê receberá um e-mail quando for processada.",
            'subdominio_disponivel' => '✓ Subdomínio disponível',
            'subdominio_indisponivel' => "✗ Este subdomínio não está disponível.\nEscolha outro nome.",
            'subdominio_curto' => 'Mínimo 3 caracteres.',
            'subdominio_termos_reservados' => 'Nome contém termos reservados.',
            'registro_concluido' => "Subdomínio criado com sucesso!\nVerifique seu e-mail para obter as credenciais de acesso.",
            'erro_registro' => 'Por favor, escolha um subdomínio disponível.',
            'botao_ver_planos' => '🛒 Ver Planos',
            'botao_acessar_loja' => '🛒 Acessar Loja de Planos',
            
            // E-mails
            'email_solicitacao_titulo' => '[Limiter MKP Pro] Nova solicitação de mudança de plano - [SITE]',
            'email_solicitacao_corpo' => "Uma nova solicitação de mudança de plano foi registrada:\nSite: [SITE]\nURL: [URL_SITE]\nID do Blog: [BLOG_ID]\nPlano Atual: [PLANO_ATUAL] (limite de [LIMITE_ATUAL] páginas)\nPlano Solicitado: [PLANO_SOLICITADO] (limite de [LIMITE_SOLICITADO] páginas)\nInformações do Cliente:\nNome: [NOME_CLIENTE]\nE-mail: [EMAIL_CLIENTE]\nTelefone: [TELEFONE_CLIENTE]\nPara processar esta solicitação, acesse o painel da rede:\n[PAINEL_LINK]\nMensagem automática do plugin Limiter MKP Pro.",
            'email_confirmacao_aprovada_titulo' => '[Limiter MKP Pro] Atualização da sua solicitação - [SITE]',
            'email_confirmacao_aprovada_corpo' => "Olá [NOME_CLIENTE],\nSua solicitação de mudança de plano foi APROVADA!\nSite: [SITE]\nURL: [URL_SITE]\nNovo Plano: [NOVO_PLANO]\nLimite de Páginas: [NOVO_LIMITE]\nSeu site já está atualizado com o novo limite.\nAtenciosamente,\nEquipe Marketing Place Store",
            'email_confirmacao_rejeitada_titulo' => '[Limiter MKP Pro] Atualização da sua solicitação - [SITE]',
            'email_confirmacao_rejeitada_corpo' => "Olá [NOME_CLIENTE],\nSua solicitação de mudança de plano foi REJEITADA.\nSite: [SITE]\nURL: [URL_SITE]\nPara mais detalhes, entre em contato com o suporte.\nAtenciosamente,\nEquipe Marketing Place Store",
            'email_alerta_limite_titulo' => '[Limiter MKP Pro] Alerta: limite de páginas quase atingido - [SITE]',
            'email_alerta_limite_corpo' => "Olá [NOME_CLIENTE],\nEste é um alerta automático:\nSeu site está próximo do limite de páginas permitido.\nSite: [SITE]\nURL: [URL_SITE]\nLimite: [LIMITE] páginas\nUtilizadas: [UTILIZADAS]\nRestantes: [RESTANTES]\nConsidere solicitar um plano maior para evitar interrupções.\nAtenciosamente,\nEquipe Marketing Place Store",
            'email_configuracao_subdominio_titulo' => 'Configure seu Subdomínio - Marketing Place Store',
            'email_configuracao_subdominio_corpo' => "Olá [NOME_CLIENTE],\nSua assinatura foi confirmada com sucesso! 🎉\nAgora você precisa configurar seu subdomínio para começar a usar nossa plataforma.\n📝 Configure seu subdomínio:\n[URL_CONFIGURACAO]\n⚠️ Este link expira em 7 dias\nComo funciona:\n1. Clique no link acima\n2. Escolha o nome do seu subdomínio (exemplo: 'loja' se tornará 'loja-mkp.marketing-place.store')\n3. Crie sua senha\n4. Seu subdomínio será criado automaticamente\nSe tiver qualquer dúvida, entre em contato conosco.\nAtenciosamente,\nEquipe Marketing Place Store",
            'email_boas_vindas_subdominio_titulo' => 'Bem-vindo ao seu Subdomínio - Marketing Place Store',
            'email_boas_vindas_subdominio_corpo' => "Olá [NOME_CLIENTE],\nSeu subdomínio foi criado com sucesso! 🎉\n📋 Detalhes do seu plano:\nPlano: [NOME_PLANO]\nLimite: [LIMITE_PAGINAS] páginas/posts\n🔐 Suas credenciais de acesso:\nSubdomínio: [NOME_SUBDOMINIO].marketing-place.store\nE-mail: [EMAIL_USUARIO]\nSenha: [SENHA_ACESSO]\n🌐 Links importantes:\nAcessar Administração: [URL_ADM]\nVer seu Site: [URL_SITE]\n💡 Dicas:\n- Você pode personalizar seu subdomínio acessando a área de administração\n- Crie páginas e posts dentro do limite do seu plano\n- Em caso de dúvidas, entre em contato conosco\nAtenciosamente,\nEquipe Marketing Place Store"
        );
    }

    /**
     * Obtém a blacklist de subdomínios configurada
     */
    public static function get_subdomain_blacklist() {
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $default_blacklist = array(
            'admin', 'suporte', 'root', 'api', 'www', 'mail', 'ftp', 'loja-oficial', 
            'login', 'wp', 'pagamento', 'cpanel', 'system', 'support', 'host', 'server',
            'webmail', 'backup', 'secure', 'ssl', 'cdn', 'test', 'demo'
        );
        return isset($config['subdomain_blacklist']) && is_array($config['subdomain_blacklist']) 
            ? $config['subdomain_blacklist'] 
            : $default_blacklist;
    }

    /**
     * Verifica se um subdomínio está na blacklist
     */
    public static function is_subdomain_blacklisted($subdomain_name) {
        $blacklist = self::get_subdomain_blacklist();
        $subdomain_name = strtolower(trim($subdomain_name));
        
        // Verifica correspondência exata
        if (in_array($subdomain_name, $blacklist)) {
            return true;
        }
        
        // Verifica padrões comuns (ex: admin1, admin2, etc.)
        foreach ($blacklist as $blacklisted_word) {
            // Bloqueia apenas se a palavra inteira corresponder 
            // ou se for um padrão como "admin1", "admin2", etc.
            if (preg_match('/^' . preg_quote($blacklisted_word, '/') . '\d+$/', $subdomain_name)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Substitui placeholders em mensagens
     */
    public static function substituir_placeholders($mensagem, $dados) {
        foreach ($dados as $placeholder => $valor) {
            $mensagem = str_replace('[' . strtoupper($placeholder) . ']', $valor, $mensagem);
            $mensagem = str_replace('[' . $placeholder . ']', $valor, $mensagem);
        }
        return $mensagem;
    }

    /**
     * Helper Estático: Obtém o sufixo de subdomínio
     */
    public static function get_sufixo_subdominio() {
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        return !empty($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp';
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-dashboard.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo dashboard do painel de administração.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin
 */

class Limiter_MKP_Pro_Dashboard {

    /**
     * O identificador único deste plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string    $plugin_name    O nome ou identificador único deste plugin.
     */
    private $plugin_name;

    /**
     * A versão atual do plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string    $version    A versão atual do plugin.
     */
    private $version;

    /**
     * Inicializa a classe e define suas propriedades.
     *
     * @since    1.0.0
     * @param    string    $plugin_name       O nome do plugin.
     * @param    string    $version           A versão do plugin.
     */
    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }

    /**
     * Obtém estatísticas para o dashboard.
     *
     * @since    1.0.0
     * @return   array    Array com estatísticas para o dashboard.
     */
    public function get_dashboard_stats() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database-get-estatisticas.php';
        
        $estatisticas = Limiter_MKP_Pro_Database_Get_Estatisticas::get_estatisticas_gerais();
        $distribuicao_planos = Limiter_MKP_Pro_Database_Get_Estatisticas::get_distribuicao_planos();
        $estatisticas_solicitacoes = Limiter_MKP_Pro_Database_Get_Estatisticas::get_estatisticas_solicitacoes();
        
        return array(
            'estatisticas' => $estatisticas,
            'distribuicao_planos' => $distribuicao_planos,
            'estatisticas_solicitacoes' => $estatisticas_solicitacoes
        );
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-lifecycle-handlers.php e os codigos deste arquivo:
<?php
/**
 * Handlers AJAX para o ciclo de vida
 * 
 * @since 2.0.0
 * @package Limiter_MKP_Pro
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Lifecycle_Handlers {
    
    private $plugin_name;
    private $version;
    
    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }
    
    /**
     * Handler para salvar configurações do ciclo de vida
     */
    public function handle_save_lifecycle_settings() {
        try {
            // DEBUG: Log inicial
            error_log('=== Limiter MKP Pro - Iniciando save_lifecycle_settings ===');
            error_log('POST data: ' . print_r($_POST, true));
            
            $this->verify_ajax_permissions();
            
            // CORREÇÃO: Usar o campo correto do formulário
            $nonce_field = '';
            
            // Verificar qual campo de nonce está sendo enviado
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_field = 'lifecycle_nonce';
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_field = 'nonce';
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            } else {
                wp_send_json_error([
                    'message' => 'Token de segurança não encontrado. Campos disponíveis: ' . implode(', ', array_keys($_POST))
                ]);
                exit;
            }
            
            error_log("Usando campo: $nonce_field, valor: $nonce_value, ação: $action");
            
            // Verificar o nonce
            if (!wp_verify_nonce($nonce_value, $action)) {
                error_log('Nonce inválido! Valor: ' . $nonce_value . ', Ação: ' . $action);
                wp_send_json_error(['message' => 'Token de segurança inválido. Por favor, atualize a página e tente novamente.']);
                exit;
            }
            
            error_log('Nonce verificado com sucesso!');
            
            $settings = $this->sanitize_lifecycle_settings($_POST);
            
            // Salva as configurações
            $result = update_network_option(null, 'limiter_mkp_pro_lifecycle_settings', $settings);
            
            if ($result !== false) {
                // Limpa cache
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
                Limiter_MKP_Pro_Cache_Manager::clear_all();
                
                // Log da ação
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
                Limiter_MKP_Pro_Database::log(0, 'lifecycle_settings_saved', 'Configurações do ciclo de vida salvas');
                
                error_log('Configurações salvas com sucesso!');
                wp_send_json_success(['message' => 'Configurações salvas com sucesso!']);
            } else {
                error_log('Falha ao salvar configurações no banco de dados');
                wp_send_json_error(['message' => 'Não foi possível salvar as configurações.']);
            }
            
        } catch (Exception $e) {
            error_log('Exceção em handle_save_lifecycle_settings: ' . $e->getMessage());
            error_log('Trace: ' . $e->getTraceAsString());
            wp_send_json_error(['message' => 'Erro interno: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para verificação manual
     */
    public function handle_run_manual_check() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            
            // Executa verificações
            $processed = Limiter_MKP_Pro_Lifecycle_Manager::run_daily_checks();
            
            // Log da ação
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log(0, 'manual_check_executed', 'Verificação manual executada');
            
            wp_send_json_success([
                'message' => 'Verificação manual concluída!',
                'processed' => $processed
            ]);
            
        } catch (Exception $e) {
            error_log('Erro em run_manual_check: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para enviar email customizado
     */
    public function handle_send_custom_email() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            $template = sanitize_text_field($_POST['template'] ?? '');
            $custom_message = wp_kses_post($_POST['custom_message'] ?? '');
            
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'ID do blog inválido.']);
            }
            
            if (empty($template) && empty($custom_message)) {
                wp_send_json_error(['message' => 'Template ou mensagem é obrigatório.']);
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
            
            // Obtém a assinatura
            $subscription = Limiter_MKP_Pro_WooCommerce_Integration::get_subscription_for_blog($blog_id);
            
            if ($subscription) {
                // Se tiver mensagem customizada, envia como template especial
                if (!empty($custom_message)) {
                    $this->send_custom_notification($blog_id, $custom_message, $subscription);
                } else {
                    Limiter_MKP_Pro_Lifecycle_Manager::notify($blog_id, $template, $subscription);
                }
                
                // Log da ação
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
                Limiter_MKP_Pro_Database::log($blog_id, 'custom_email_sent', 'Email customizado enviado');
                
                wp_send_json_success(['message' => 'Email enviado com sucesso!']);
            } else {
                wp_send_json_error(['message' => 'Assinatura não encontrada para este blog.']);
            }
            
        } catch (Exception $e) {
            error_log('Erro em send_custom_email: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para estender período de carência
     */
    public function handle_extend_grace_period() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            $days = intval($_POST['days'] ?? 7);
            $reason = sanitize_text_field($_POST['reason'] ?? 'Extensão manual pelo administrador');
            
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'ID do blog inválido.']);
            }
            
            if ($days <= 0 || $days > 365) {
                wp_send_json_error(['message' => 'Número de dias inválido (1-365).']);
            }
            
            // Obtém a data atual de expiração da carência
            $current_grace_end = get_blog_option($blog_id, 'limiter_grace_period_ends', '');
            
            if (empty($current_grace_end)) {
                // Se não houver data, cria a partir de agora
                $new_grace_end = date('Y-m-d H:i:s', strtotime("+{$days} days"));
            } else {
                // Estende a data existente
                $new_grace_end = date('Y-m-d H:i:s', strtotime($current_grace_end . " +{$days} days"));
            }
            
            // Atualiza a data
            update_blog_option($blog_id, 'limiter_grace_period_ends', $new_grace_end);
            
            // Atualiza o status para grace_period se não estiver
            if (get_blog_option($blog_id, 'limiter_blog_status') !== 'grace_period') {
                update_blog_option($blog_id, 'limiter_blog_status', 'grace_period');
                update_blog_option($blog_id, 'limiter_blog_status_date', current_time('mysql'));
            }
            
            // Log da ação
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log(
                $blog_id,
                'grace_period_extended',
                "Período de carência estendido em {$days} dias",
                [
                    'old_grace_end' => $current_grace_end,
                    'new_grace_end' => $new_grace_end,
                    'days_added' => $days,
                    'reason' => $reason
                ]
            );
            
            // Notifica o cliente
            $this->notify_grace_extension($blog_id, $days, $reason);
            
            wp_send_json_success([
                'message' => "Período de carência estendido em {$days} dias.",
                'new_grace_end' => $new_grace_end,
                'formatted_date' => date_i18n(get_option('date_format'), strtotime($new_grace_end))
            ]);
            
        } catch (Exception $e) {
            error_log('Erro em extend_grace_period: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para restaurar blog
     */
    public function handle_restore_blog() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'ID do blog inválido.']);
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            
            // Restaura o blog
            Limiter_MKP_Pro_Lifecycle_Manager::restore_blog($blog_id);
            
            // Atualiza status da assinatura para active
            update_blog_option($blog_id, 'limiter_subscription_status', 'active');
            
            // Log da ação
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log($blog_id, 'blog_restored', 'Blog restaurado manualmente pelo administrador');
            
            wp_send_json_success(['message' => 'Blog restaurado com sucesso!']);
            
        } catch (Exception $e) {
            error_log('Erro em restore_blog: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para suspender blog manualmente
     */
    public function handle_suspend_blog() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            $reason = sanitize_text_field($_POST['reason'] ?? 'Suspensão manual pelo administrador');
            
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'ID do blog inválido.']);
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            
            // Suspende o blog
            Limiter_MKP_Pro_Lifecycle_Manager::suspend_blog($blog_id);
            
            // Atualiza status
            update_blog_option($blog_id, 'limiter_blog_status', 'suspended');
            update_blog_option($blog_id, 'limiter_suspension_reason', $reason);
            
            // Log da ação
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log(
                $blog_id,
                'blog_suspended_manual',
                "Blog suspenso manualmente: {$reason}"
            );
            
            wp_send_json_success(['message' => 'Blog suspenso com sucesso!']);
            
        } catch (Exception $e) {
            error_log('Erro em suspend_blog: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para agendar exclusão
     */
    public function handle_schedule_deletion() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            $deletion_date = sanitize_text_field($_POST['deletion_date'] ?? '');
            $reason = sanitize_text_field($_POST['reason'] ?? 'Exclusão manual pelo administrador');
            
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'ID do blog inválido.']);
            }
            
            if (empty($deletion_date)) {
                $deletion_date = date('Y-m-d', strtotime('+7 days'));
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
            
            // Agenda exclusão
            Limiter_MKP_Pro_Lifecycle_Manager::schedule_deletion($blog_id, $deletion_date);
            
            // Atualiza status
            update_blog_option($blog_id, 'limiter_blog_status', 'scheduled_deletion');
            update_blog_option($blog_id, 'limiter_deletion_reason', $reason);
            
            // Log da ação
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log(
                $blog_id,
                'deletion_scheduled_manual',
                "Exclusão agendada para {$deletion_date}: {$reason}"
            );
            
            wp_send_json_success([
                'message' => "Exclusão agendada para {$deletion_date}!",
                'deletion_date' => $deletion_date
            ]);
            
        } catch (Exception $e) {
            error_log('Erro em schedule_deletion: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Handler para cancelar exclusão agendada
     */
    public function handle_cancel_deletion() {
        try {
            $this->verify_ajax_permissions();
            
            // Verificar nonce - compatibilidade com ambos os formatos
            $nonce_value = '';
            $action = 'limiter_lifecycle_nonce';
            
            if (isset($_POST['lifecycle_nonce']) && !empty($_POST['lifecycle_nonce'])) {
                $nonce_value = sanitize_text_field($_POST['lifecycle_nonce']);
                $action = 'limiter_mkp_pro_lifecycle_settings';
            } elseif (isset($_POST['nonce']) && !empty($_POST['nonce'])) {
                $nonce_value = sanitize_text_field($_POST['nonce']);
                $action = 'limiter_lifecycle_nonce';
            }
            
            if (empty($nonce_value) || !wp_verify_nonce($nonce_value, $action)) {
                wp_send_json_error(['message' => 'Token de segurança inválido.']);
                exit;
            }
            
            $blog_id = intval($_POST['blog_id'] ?? 0);
            
            if ($blog_id <= 0) {
                wp_send_json_error(['message' => 'ID do blog inválido.']);
            }
            
            // Remove data de exclusão
            delete_blog_option($blog_id, 'limiter_scheduled_deletion_date');
            
            // Restaura status anterior ou define como active
            $previous_status = get_blog_option($blog_id, 'limiter_previous_status', 'active');
            update_blog_option($blog_id, 'limiter_blog_status', $previous_status);
            
            // Log da ação
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log($blog_id, 'deletion_cancelled', 'Exclusão agendada cancelada manualmente');
            
            wp_send_json_success(['message' => 'Exclusão cancelada com sucesso!']);
            
        } catch (Exception $e) {
            error_log('Erro em cancel_deletion: ' . $e->getMessage());
            wp_send_json_error(['message' => 'Erro: ' . $e->getMessage()]);
        }
    }
    
    /**
     * Sanitiza configurações do ciclo de vida
     */
    private function sanitize_lifecycle_settings($data) {
        $settings = [
            'payment_failure' => [
                'grace_period_days' => intval($data['payment_failure']['grace_period_days'] ?? 7),
                'suspension_days' => intval($data['payment_failure']['suspension_days'] ?? 7),
                'lock_days' => intval($data['payment_failure']['lock_days'] ?? 14),
                'deletion_days' => intval($data['payment_failure']['deletion_days'] ?? 30)
            ],
            'cancellation' => [
                'immediate_suspend' => isset($data['cancellation']['immediate_suspend']) ? 1 : 0,
                'admin_access_days' => intval($data['cancellation']['admin_access_days'] ?? 7),
                'deletion_days' => intval($data['cancellation']['deletion_days'] ?? 30)
            ],
            'notification_emails' => sanitize_text_field($data['notification_emails'] ?? ''),
            'support_email' => sanitize_email($data['support_email'] ?? ''),
            'plans_url' => esc_url_raw($data['plans_url'] ?? ''),
            'suspension_page_template' => wp_kses_post($data['suspension_page_template'] ?? '')
        ];
        
        // Sanitiza templates de email
        if (isset($data['email_templates']) && is_array($data['email_templates'])) {
            $settings['email_templates'] = [];
            
            foreach ($data['email_templates'] as $key => $template) {
                $settings['email_templates'][sanitize_key($key)] = [
                    'subject' => sanitize_text_field($template['subject'] ?? ''),
                    'message' => wp_kses_post($template['message'] ?? '')
                ];
            }
        } else {
            // Templates padrão
            $settings['email_templates'] = [
                'payment_failed' => [
                    'subject' => 'Pagamento Pendente - [BLOG_NAME]',
                    'message' => 'Olá [CUSTOMER_NAME],\n\nSeu pagamento para o site [BLOG_NAME] está pendente.\nPor favor, regularize sua situação em até [DAYS_REMAINING] dias.\n\nAcesse: [PLANS_URL]\n\nSuporte: [SUPPORT_EMAIL]'
                ],
                'grace_period' => [
                    'subject' => 'Período de Carência - [BLOG_NAME]',
                    'message' => 'Olá [CUSTOMER_NAME],\n\nSeu site [BLOG_NAME] entrou em período de carência.\nVocê tem até [DAYS_REMAINING] dias para regularizar.\n\nAcesse: [PLANS_URL]\n\nSuporte: [SUPPORT_EMAIL]'
                ],
                'suspended' => [
                    'subject' => 'Site Suspenso - [BLOG_NAME]',
                    'message' => 'Olá [CUSTOMER_NAME],\n\nSeu site [BLOG_NAME] foi suspenso devido a falta de pagamento.\nPara reativar, acesse: [PLANS_URL]\n\nSuporte: [SUPPORT_EMAIL]'
                ],
                'scheduled_deletion' => [
                    'subject' => 'Exclusão Programada - [BLOG_NAME]',
                    'message' => 'Olá [CUSTOMER_NAME],\n\nSeu site [BLOG_NAME] será excluído em [DELETION_DATE].\nPara evitar a exclusão, regularize sua situação.\n\nAcesse: [PLANS_URL]\n\nSuporte: [SUPPORT_EMAIL]'
                ]
            ];
        }
        
        return $settings;
    }
    
    /**
     * Envia notificação customizada
     */
    private function send_custom_notification($blog_id, $message, $subscription) {
        $settings = get_network_option(null, 'limiter_mkp_pro_lifecycle_settings', []);
        $blog_details = get_blog_details($blog_id);
        
        // Dados para substituição
        $data = [
            'blog_name' => $blog_details->blogname,
            'blog_url' => $blog_details->siteurl,
            'customer_name' => get_blog_option($blog_id, 'limiter_nome_cliente', 'Cliente'),
            'customer_email' => get_blog_option($blog_id, 'limiter_email_cliente', ''),
            'support_email' => $settings['support_email'] ?? 'suporte@marketing-place.store',
            'plans_url' => $settings['plans_url'] ?? home_url('/planos/')
        ];
        
        // Substitui placeholders
        foreach ($data as $key => $value) {
            $message = str_replace("[{$key}]", $value, $message);
            $message = str_replace("[" . strtoupper($key) . "]", $value, $message);
        }
        
        $subject = "Notificação Importante - {$data['blog_name']}";
        
        // Envia para o cliente
        if ($data['customer_email']) {
            wp_mail($data['customer_email'], $subject, $message);
        }
        
        // Envia cópia para administradores
        $admin_emails = explode(',', $settings['notification_emails'] ?? '');
        foreach ($admin_emails as $email) {
            $email = trim($email);
            if (is_email($email)) {
                wp_mail($email, "[CÓPIA ADMIN] {$subject}", $message);
            }
        }
    }
    
    /**
     * Notifica extensão de carência
     */
    private function notify_grace_extension($blog_id, $days, $reason) {
        $blog_details = get_blog_details($blog_id);
        $customer_email = get_blog_option($blog_id, 'limiter_email_cliente', '');
        $customer_name = get_blog_option($blog_id, 'limiter_nome_cliente', 'Cliente');
        
        if (!$customer_email) {
            return;
        }
        
        $subject = "Extensão de Carência Concedida - {$blog_details->blogname}";
        
        $message = "Olá {$customer_name},\n\n";
        $message .= "Seu período de carência foi estendido em {$days} dias.\n\n";
        $message .= "**Detalhes:**\n";
        $message .= "- Site: {$blog_details->blogname}\n";
        $message .= "- URL: {$blog_details->siteurl}\n";
        $message .= "- Dias adicionados: {$days}\n";
        $message .= "- Razão: {$reason}\n\n";
        $message .= "Aproveite este tempo adicional para regularizar sua situação.\n\n";
        $message .= "Atenciosamente,\nEquipe Marketing Place Store";
        
        wp_mail($customer_email, $subject, $message);
    }
    
    /**
     * Verifica permissões AJAX
     */
    private function verify_ajax_permissions() {
        if (!current_user_can('manage_network')) {
            error_log('Permissão negada para usuário: ' . get_current_user_id());
            wp_send_json_error(['message' => 'Você não tem permissão para realizar esta operação.']);
            exit;
        }
    }
    
    /**
     * Verifica nonce AJAX (método mantido para compatibilidade)
     */
    private function verify_ajax_nonce($nonce, $action) {
        if (!wp_verify_nonce($nonce, $action)) {
            error_log("Nonce inválido para ação: $action");
            wp_send_json_error(['message' => 'Token de segurança inválido. Por favor, atualize a página e tente novamente.']);
            exit;
        }
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-logs.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo gerenciamento de logs.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin
 */

// Segurança: Prevenção de acesso direto ao arquivo.
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Logs {

    /**
     * O identificador único deste plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string
     */
    private $plugin_name;

    /**
     * A versão atual do plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string
     */
    private $version;

    /**
     * Inicializa a classe e define suas propriedades.
     *
     * @since    1.0.0
     * @param    string    $plugin_name
     * @param    string    $version
     */
    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }

    /**
     * Obtém os logs do sistema.
     *
     * @since    1.0.0
     * @param    int       $limit
     * @param    int|null  $blog_id
     * @return   array
     */
    public function get_logs($limit = 100, $blog_id = null) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::get_logs($limit, $blog_id);
    }

    /**
     * Registra uma ação no log.
     *
     * @since    1.0.0
     * @param    int       $blog_id
     * @param    string    $acao
     * @param    string    $descricao
     * @param    array     $dados_extras
     * @return   int|false
     */
    public function log($blog_id, $acao, $descricao, $dados_extras = []) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        $log_data = [
            'blog_id' => (int) $blog_id,
            'acao' => sanitize_text_field($acao),
            'descricao' => sanitize_text_field($descricao),
            'dados_extras' => maybe_serialize($dados_extras),
            'user_id' => get_current_user_id(),
            'ip' => $_SERVER['REMOTE_ADDR'] ?? 'unknown'
        ];
        
        return Limiter_MKP_Pro_Database::log_enhanced($log_data);
    }

    /**
     * Limpa logs antigos com segurança.
     *
     * @since    1.0.0
     * @param    int   $dias     Número de dias para manter logs.
     * @return   int             Quantidade de logs removidos.
     */
    public function limpar_logs_antigos($dias = 90) {
        global $wpdb;

        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';

        // Obtém nome da tabela
        $table_logs = Limiter_MKP_Pro_Database::get_table_name('logs');

        // Validação obrigatória do nome da tabela
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_logs)) {
            trigger_error(
                'Tentativa de limpar logs usando nome de tabela inválido: ' . esc_html($table_logs),
                E_USER_WARNING
            );
            return 0;
        }

        // Data limite
        $data_limite = date('Y-m-d H:i:s', strtotime("-{$dias} days"));

        // Query segura usando prepared statement
        $sql = $wpdb->prepare(
            "DELETE FROM {$table_logs} WHERE timestamp < %s",
            $data_limite
        );

        $result = $wpdb->query($sql);
        
        if ($result === false) {
            $this->log(0, 'erro_limpeza_logs', 'Falha ao limpar logs antigos: ' . $wpdb->last_error);
            return 0;
        }

        return intval($wpdb->rows_affected);
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-planos.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo gerenciamento de planos.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin
 */
class Limiter_MKP_Pro_Planos {
    use Limiter_MKP_Pro_Security_Trait;
    
    private $plugin_name;
    private $version;

    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }

    public function get_planos() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::get_planos();
    }

    public function get_plano($id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::get_plano($id);
    }

    /**
     * Salva um plano e sincroniza o espaço em disco.
     */
    public function save_plano($data) {
        // Se há produtos WooCommerce vinculados, usar a duração do primeiro produto
        if (!empty($data['woocommerce_product_ids'])) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
            $first_product_id = reset($data['woocommerce_product_ids']);
            $woocommerce_duration = Limiter_MKP_Pro_WooCommerce_Integration::get_product_duration_days($first_product_id);
            if ($woocommerce_duration > 0) {
                $data['duracao'] = $woocommerce_duration;
            }
        }
        
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $plano_id = Limiter_MKP_Pro_Database::save_plano($data);
        
        // --- Sincronizar espaço em disco (MB) para todos os sites deste plano ---
        if ($plano_id && isset($data['limite_upload_mb'])) {
            $this->sync_upload_space_for_plan($plano_id, intval($data['limite_upload_mb']));
        }

        return $plano_id;
    }

    public function delete_plano($id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::delete_plano($id);
    }

    /**
     * Atualiza a opção nativa do WP 'blog_upload_space' para todos os sites do plano.
     */
    private function sync_upload_space_for_plan($plano_id, $mb_limit) {
        global $wpdb;
        
        // Se o limite for inválido, não faz nada
        if ($mb_limit <= 0) return;

        // Pega tabela de subdomínios via classe Database para garantir prefixo correto
        $table_subs = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        
        // Busca todos os blog_ids vinculados a este plano
        $blog_ids = $wpdb->get_col($wpdb->prepare("SELECT blog_id FROM $table_subs WHERE plano_id = %d", $plano_id));
        
        if (!empty($blog_ids)) {
            foreach ($blog_ids as $blog_id) {
                // update_blog_option atualiza a opção nativa que o WP usa para quota
                update_blog_option($blog_id, 'blog_upload_space', $mb_limit);
            }
        }
    }

    public function get_plano_woocommerce_products($plano_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
        return Limiter_MKP_Pro_WooCommerce_Integration::get_plano_products($plano_id);
    }

    public function save_plano_woocommerce_products($plano_id, $product_ids) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
        return Limiter_MKP_Pro_WooCommerce_Integration::save_plano_products($plano_id, $product_ids);
    }
    
    public function get_limite_padrao($plano_id) {
        $plano = $this->get_plano($plano_id);
        return $plano ? intval($plano->limite_paginas) : 10;
    }

    public function get_post_types_contaveis($plano_id) {
        $plano = $this->get_plano($plano_id);
        if ($plano && !empty($plano->post_types_contaveis)) {
            return json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
        }
        return ['page', 'post'];
    }

    public function get_post_status_contaveis($plano_id) {
        $plano = $this->get_plano($plano_id);
        if ($plano && !empty($plano->post_status_contaveis)) {
            return json_decode($plano->post_status_contaveis, true) ?: ['publish', 'draft', 'trash'];
        }
        return ['publish', 'draft', 'trash'];
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/class-subdominios.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo gerenciamento de subdomínios.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin
 */

class Limiter_MKP_Pro_Subdominios {

    /**
     * O identificador único deste plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string    $plugin_name    O nome ou identificador único deste plugin.
     */
    private $plugin_name;

    /**
     * A versão atual do plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string    $version    A versão atual do plugin.
     */
    private $version;

    /**
     * Inicializa a classe e define suas propriedades.
     *
     * @since    1.0.0
     * @param    string    $plugin_name       O nome do plugin.
     * @param    string    $version           A versão do plugin.
     */
    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }

    /**
     * Obtém todos os subdomínios cadastrados.
     *
     * @since    1.0.0
     * @return   array    Array com os subdomínios cadastrados.
     */
    public function get_subdominios() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::get_subdominios();
    }

    /**
     * Obtém um subdomínio específico pelo blog_id.
     *
     * @since    1.0.0
     * @param    int       $blog_id    ID do blog.
     * @return   object                Objeto com os dados do subdomínio ou null se não encontrado.
     */
    public function get_subdominio_by_blog_id($blog_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
    }

    /**
     * Salva um subdomínio (novo ou existente).
     *
     * @since    1.0.0
     * @param    array     $data    Dados do subdomínio.
     * @return   int|false          ID do subdomínio inserido/atualizado ou false em caso de erro.
     */
    public function save_subdominio($data) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::save_subdominio($data);
    }

    /**
     * Obtém informações de um site da rede.
     *
     * @since    1.0.0
     * @param    int       $blog_id    ID do blog.
     * @return   array                 Array com informações do site.
     */
    public function get_site_info($blog_id) {
        $site_info = get_blog_details($blog_id);
        
        if (!$site_info) {
            return null;
        }
        
        return array(
            'blog_id' => $blog_id,
            'domain' => $site_info->domain,
            'path' => $site_info->path,
            'name' => $site_info->blogname,
            'url' => $site_info->siteurl
        );
    }

    /**
     * Obtém o limite de páginas para um blog específico.
     *
     * @since    1.0.0
     * @param    int       $blog_id    ID do blog.
     * @return   int                   Limite de páginas ou 0 se não encontrado.
     */
    public function get_limite_paginas($blog_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        return Limiter_MKP_Pro_Database::get_limite_paginas($blog_id);
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/css/admin.css e os codigos deste arquivo:
/* Estilos para o painel de administração */
.limiter-mkp-pro-admin-planos,
.limiter-mkp-pro-admin-subdominios,
.limiter-mkp-pro-admin-configuracoes,
.limiter-mkp-pro-admin-logs,
.limiter-mkp-pro-admin-health-check {
    padding: 20px;
}

.limiter-mkp-pro-admin-form-container {
    background: #fff;
    border: 1px solid #e3e6f0;
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.limiter-mkp-pro-admin-form-row {
    margin-bottom: 15px;
}

.limiter-mkp-pro-admin-form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.limiter-mkp-pro-admin-form-row input[type="text"],
.limiter-mkp-pro-admin-form-row input[type="number"],
.limiter-mkp-pro-admin-form-row input[type="email"],
.limiter-mkp-pro-admin-form-row textarea,
.limiter-mkp-pro-admin-form-row select {
    width: 100%;
    max-width: 500px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.limiter-mkp-pro-admin-form-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

/* Estilos para a tabela de planos e subdomínios */
.widefat td, .widefat th {
    vertical-align: middle;
}

.limiter-mkp-pro-edit-plano,
.limiter-mkp-pro-delete-plano,
.limiter-mkp-pro-edit-subdominio {
    margin-right: 5px;
}

/* Estilos para o dashboard */
.limiter-mkp-pro-admin-stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.limiter-mkp-pro-admin-card {
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 20px;
    text-align: center;
    border-left: 4px solid #4e73df;
}

.limiter-mkp-pro-admin-card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.limiter-mkp-pro-admin-card-header span {
    font-size: 24px;
    color: #4e73df;
    margin-right: 10px;
}

.limiter-mkp-pro-admin-card-value {
    font-size: 28px;
    font-weight: bold;
    color: #333;
    margin: 10px 0;
}

.limiter-mkp-pro-admin-card-description {
    color: #6c757d;
    font-size: 14px;
}

.limiter-mkp-pro-admin-card-footer {
    margin-top: 15px;
}

/* Progress bars */
.limiter-mkp-pro-admin-progress-bar {
    background-color: #e9ecef;
    border-radius: 4px;
    height: 20px;
    overflow: hidden;
    margin: 5px 0;
}

.limiter-mkp-pro-admin-progress {
    background-color: #4e73df;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
    transition: width 0.3s ease;
}

.limiter-mkp-pro-admin-progress-warning {
    background-color: #e74a3b !important;
}

/* Log visual */
.limiter-mkp-pro-admin-log-item {
    padding: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.limiter-mkp-pro-admin-log-date {
    color: #6c757d;
    font-size: 12px;
}

.limiter-mkp-pro-admin-log-action {
    font-weight: bold;
    color: #4e73df;
}

/* Health Check */
.limiter-health-check-item {
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 4px;
    border-left: 4px solid #4e73df;
}

.limiter-health-check-item.limiter-success {
    background-color: #d4edda;
    border-color: #28a745;
}

.limiter-health-check-item.limiter-warning {
    background-color: #fff3cd;
    border-color: #ffc107;
}

.limiter-health-check-item.limiter-error {
    background-color: #f8d7da;
    border-color: #dc3545;
}

/* Estilos para erro de debug */
.limiter-mkp-debug-error {
    background-color: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    border: 1px solid #f5c6cb;
    font-family: monospace;
    white-space: pre-wrap;
}

.limiter-mkp-pro-admin-quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.limiter-mkp-pro-admin-quick-action {
    display: block;
    padding: 15px;
    text-align: center;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    text-decoration: none;
    color: #5a5c69;
    transition: all 0.3s ease;
    border: 1px solid #e3e6f0;
}

.limiter-mkp-pro-admin-quick-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-color: #4e73df;
}

.limiter-mkp-pro-admin-quick-action span.dashicons {
    font-size: 24px;
    color: #4e73df;
    display: block;
    margin-bottom: 8px;
}

.limiter-mkp-pro-admin-quick-action-label {
    font-weight: 600;
    font-size: 14px;
}

/* Responsividade */
@media (max-width: 768px) {
    .limiter-mkp-pro-admin-form-actions {
        flex-direction: column;
    }
    
    .limiter-mkp-pro-admin-form-actions button {
        width: 100%;
    }
    
    .limiter-mkp-pro-admin-stats-cards,
    .limiter-mkp-pro-admin-quick-actions {
        grid-template-columns: 1fr;
    }
}

/* Adicionando estilos para o campo de limite de inodes */
.limiter-mkp-pro-inode-panel {
    background: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 4px;
    padding: 15px;
    margin: 20px 0;
}

/* Progress bar para arquivos */
.limiter-mkp-pro-progress-bar {
    background-color: #e9ecef;
    border-radius: 4px;
    height: 12px;
    overflow: hidden;
    margin: 10px 0;
}

.limiter-mkp-pro-progress {
    height: 100%;
    transition: width 0.3s ease;
}

.limiter-mkp-pro-progress-text {
    color: white;
    font-size: 10px;
    font-weight: bold;
    line-height: 12px;
    display: block;
    text-align: center;
}

/* Formulário de configurações */
.limiter-mkp-pro-admin-form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e3e6f0;
}

.limiter-mkp-pro-admin-section-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.limiter-mkp-pro-admin-section-header h2 {
    margin: 0;
    font-size: 20px;
    color: #4e73df;
}

.limiter-mkp-pro-admin-section-header span {
    font-size: 22px;
    margin-right: 10px;
    color: #4e73df;
}

/* Botões */
.button.limiter-mkp-pro-add-plan,
.button.limiter-mkp-pro-generate-backup {
    background: #4e73df;
    border-color: #4e73df;
    color: white;
}

.button.limiter-mkp-pro-add-plan:hover,
.button.limiter-mkp-pro-generate-backup:hover {
    background: #3a5dca;
    border-color: #3a5dca;
}

.button.limiter-mkp-pro-import-backup {
    background: #1cc88a;
    border-color: #1cc88a;
    color: white;
}

.button.limiter-mkp-pro-import-backup:hover {
    background: #17a673;
    border-color: #17a673;
}

.button.limiter-mkp-pro-regenerate-tokens {
    background: #f6c23e;
    border-color: #f6c23e;
    color: #333;
}

.button.limiter-mkp-pro-regenerate-tokens:hover {
    background: #f4b30d;
    border-color: #f4b30d;
}

/* Backup & Restore */
.limiter-mkp-pro-backup-section {
    background: #f8f9fc;
    padding: 20px;
    border-radius: 4px;
    margin: 20px 0;
    border: 1px solid #e3e6f0;
}

.limiter-mkp-pro-backup-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e3e6f0;
}

.limiter-mkp-pro-backup-item:last-child {
    border-bottom: none;
}

.limiter-mkp-pro-backup-actions {
    display: flex;
    gap: 10px;
}

/* Health Check detalhes */
.limiter-health-check-details {
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fc;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    max-height: 200px;
    overflow-y: auto;
}

/* --------------------------------------------------------------
   Estilos para o Autocomplete (Busca AJAX) de Sites
   --------------------------------------------------------------
*/
.ui-autocomplete {
    background: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-radius: 0 0 4px 4px;
    z-index: 99999;
}

.ui-menu-item {
    padding: 0;
    border-bottom: 1px solid #f0f0f0;
    list-style: none;
    margin: 0;
}

.ui-menu-item:last-child {
    border-bottom: none;
}

.ui-menu-item-wrapper {
    padding: 10px 12px;
    display: block;
    cursor: pointer;
    font-size: 14px;
    color: #3c434a;
}

/* Estado Hover e Ativo (Seleção) */
.ui-menu-item-wrapper:hover,
.ui-menu-item-wrapper.ui-state-active,
.ui-menu-item-wrapper.ui-state-focus {
    background-color: #4e73df !important;
    color: #fff !important;
    border: none;
    margin: 0;
}

/* Estado de Carregamento (Spinner) */
.ui-autocomplete-loading {
    background: url('../images/spinner.gif') no-repeat right 10px center;
    background-size: 20px;
}

.ui-helper-hidden-accessible {
    display: none;
}

/* --------------------------------------------------------------
   Estilos para Barra de Progresso de Ferramentas (AJAX)
   --------------------------------------------------------------
*/
.limiter-progress-wrapper {
    display: none; /* Oculto por padrão */
    margin-top: 20px;
    background: #fff;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.limiter-progress-container {
    height: 25px;
    background-color: #f0f0f1;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    position: relative;
}

.limiter-progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(45deg, #4e73df, #2e59d9);
    background-size: 30px 30px;
    background-image: linear-gradient(
        45deg, 
        rgba(255, 255, 255, .15) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255, 255, 255, .15) 50%, 
        rgba(255, 255, 255, .15) 75%, 
        transparent 75%, 
        transparent
    );
    transition: width 0.4s ease;
    animation: limiter-progress-stripes 1s linear infinite;
    display: flex;
    align-items: center;
    justify-content: center;
}

.limiter-progress-text {
    color: #fff;
    font-size: 11px;
    font-weight: bold;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
}

.limiter-progress-status {
    margin-top: 8px;
    font-size: 13px;
    color: #555;
    text-align: center;
    font-style: italic;
}

@keyframes limiter-progress-stripes {
    0% { background-position: 30px 0; }
    100% { background-position: 0 0; }
}

/* --- MELHORIAS VISUAIS DOS LOGS (CLICK POPUP) --- */

/* Badges de Status */
.limiter-log-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    line-height: 1.2;
}

.limiter-log-badge .dashicons {
    font-size: 14px;
    width: 14px;
    height: 14px;
    margin-right: 4px;
}

/* Cores dos Badges */
.log-status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.log-status-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.log-status-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.log-status-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* Botão de Olho */
.limiter-view-details {
    cursor: pointer;
    color: #4e73df;
    background: none;
    border: none;
    padding: 0;
    transition: all 0.2s;
}

.limiter-view-details:hover {
    color: #2e59d9;
    transform: scale(1.1);
}

/* Tooltip Flutuante (Popup Estático) - CORRIGIDO */
.limiter-log-tooltip {
    display: none;
    position: absolute; /* Mudado para absolute para seguir o fluxo da página se necessário */
    z-index: 9999999; /* Z-index altíssimo */
    background-color: #2d2d2d;
    color: #f0f0f0;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-wrap: break-word;
    border: 1px solid #444;
    
    /* HABILITANDO CLIQUES NO CONTEÚDO */
    pointer-events: auto; 
}

/* Setinha do Tooltip */
.limiter-log-tooltip::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -6px;
    width: 0; 
    height: 0; 
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 6px solid #2d2d2d;
}

/* Scrollbar do Tooltip */
.limiter-log-tooltip::-webkit-scrollbar {
    width: 8px;
}
.limiter-log-tooltip::-webkit-scrollbar-track {
    background: #222;
}
.limiter-log-tooltip::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/adicionar-subdominio.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de adicionar subdomínio.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */
?>

<div class="wrap limiter-mkp-pro-admin-adicionar-subdominio">
    <h1><?php _e('Limiter MKP Pro - Adicionar Subdomínio', 'limiter-mkp-pro'); ?></h1>
    
    <div class="limiter-mkp-pro-admin-form-container">
        <h2><?php _e('Adicionar Subdomínio Individual', 'limiter-mkp-pro'); ?></h2>
        
        <form id="limiter-mkp-pro-subdominio-form" class="limiter-mkp-pro-admin-form">
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-site-search"><?php _e('Buscar Site (Digite para pesquisar)', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-site-search" class="regular-text" placeholder="<?php _e('Digite o nome ou domínio do site...', 'limiter-mkp-pro'); ?>" style="width: 100%; max-width: 500px;">
                <input type="hidden" id="limiter-mkp-pro-subdominio-site" name="blog_id" required>
                <input type="hidden" id="limiter-mkp-pro-subdominio-dominio-hidden" name="dominio_hidden">
                <p class="description"><?php _e('Comece a digitar (mínimo 3 caracteres) para encontrar o site na rede.', 'limiter-mkp-pro'); ?></p>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-plano"><?php _e('Plano', 'limiter-mkp-pro'); ?></label>
                <select id="limiter-mkp-pro-subdominio-plano" name="plano_id" required>
                    <option value=""><?php _e('Selecione um plano', 'limiter-mkp-pro'); ?></option>
                    <?php foreach ($planos as $plano) : ?>
                        <option value="<?php echo esc_attr($plano->id); ?>"><?php echo esc_html($plano->nome); ?> (<?php echo esc_html($plano->limite_paginas); ?> <?php _e('páginas', 'limiter-mkp-pro'); ?>)</option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-limite"><?php _e('Limite Personalizado (opcional)', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-subdominio-limite" name="limite_personalizado" min="1">
                <p class="description"><?php _e('Se definido, substitui o limite do plano selecionado.', 'limiter-mkp-pro'); ?></p>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-nome-cliente"><?php _e('Nome do Cliente', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-nome-cliente" name="nome_cliente">
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-email-cliente"><?php _e('E-mail do Cliente', 'limiter-mkp-pro'); ?></label>
                <input type="email" id="limiter-mkp-pro-subdominio-email-cliente" name="email_cliente">
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-telefone-cliente"><?php _e('Telefone do Cliente', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-telefone-cliente" name="telefone_cliente">
            </div>
            
            <div class="limiter-mkp-pro-admin-form-actions">
                <button type="submit" id="limiter-mkp-pro-subdominio-submit" class="button button-primary"><?php _e('Adicionar Subdomínio', 'limiter-mkp-pro'); ?></button>
            </div>
        </form>
    </div>
    
    <div class="limiter-mkp-pro-admin-form-container">
        <h2><?php _e('Adicionar Subdomínios em Massa', 'limiter-mkp-pro'); ?></h2>
        <p class="description">
            <?php _e('Para garantir a performance e estabilidade do seu painel em redes grandes, a listagem automática de todos os sites foi desativada nesta tela. Recomendamos adicionar subdomínios individualmente usando a busca acima.', 'limiter-mkp-pro'); ?>
        </p>
    </div>
</div>

<style>
/* Estilo para o Autocomplete do jQuery UI no admin */
.ui-autocomplete {
    background: #fff;
    border: 1px solid #ddd;
    max-height: 250px;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 99999;
    width: 300px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-radius: 0 0 4px 4px;
}
.ui-menu-item {
    padding: 0;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}
.ui-menu-item-wrapper {
    padding: 10px 12px;
    display: block;
}
.ui-menu-item-wrapper:hover, 
.ui-state-active,
.ui-state-focus {
    background-color: #4e73df !important;
    color: #fff !important;
    border: none;
    margin: 0;
}
.ui-helper-hidden-accessible { display: none; }
</style>

<script>
jQuery(document).ready(function($) {
    
    // Inicializa Autocomplete para busca de sites
    $('#limiter-mkp-pro-site-search').autocomplete({
        source: function(request, response) {
            // Adiciona classe de carregando
            $('#limiter-mkp-pro-site-search').addClass('ui-autocomplete-loading');
            
            $.ajax({
                url: limiter_mkp_pro_admin.ajax_url,
                dataType: "json",
                data: {
                    action: 'limiter_mkp_pro_search_sites',
                    term: request.term,
                    nonce: limiter_mkp_pro_admin.nonce
                },
                success: function(data) {
                    $('#limiter-mkp-pro-site-search').removeClass('ui-autocomplete-loading');
                    if(data.success && data.data.length > 0) {
                        response(data.data);
                    } else {
                        // Feedback visual se não encontrar nada
                        response([{
                            label: '<?php _e("Nenhum site encontrado", "limiter-mkp-pro"); ?>',
                            value: '',
                            id: 0
                        }]);
                    }
                },
                error: function() {
                    $('#limiter-mkp-pro-site-search').removeClass('ui-autocomplete-loading');
                }
            });
        },
        minLength: 3, // Otimização: Começa a buscar apenas após 3 caracteres
        select: function(event, ui) {
            // Impede seleção do item "Nenhum site encontrado"
            if (ui.item.id === 0) {
                event.preventDefault();
                return false;
            }
            
            // Ao selecionar, preenche os campos ocultos e visuais
            $('#limiter-mkp-pro-subdominio-site').val(ui.item.id);
            $('#limiter-mkp-pro-subdominio-dominio-hidden').val(ui.item.domain);
            
            // Opcional: Feedback visual de seleção
            $(this).val(ui.item.label);
            return false; // Impede que o valor do input seja substituído pelo value do objeto
        }
    });

    // Lógica de envio do formulário ajustada para pegar do campo hidden
    $('#limiter-mkp-pro-subdominio-form').on('submit', function(e) {
        e.preventDefault();
        
        var blog_id = $('#limiter-mkp-pro-subdominio-site').val();
        var dominio = $('#limiter-mkp-pro-subdominio-dominio-hidden').val();
        var plano_id = $('#limiter-mkp-pro-subdominio-plano').val();
        
        // Coleta outros campos
        var limite_personalizado = $('#limiter-mkp-pro-subdominio-limite').val();
        var nome_cliente = $('#limiter-mkp-pro-subdominio-nome-cliente').val();
        var email_cliente = $('#limiter-mkp-pro-subdominio-email-cliente').val();
        var telefone_cliente = $('#limiter-mkp-pro-subdominio-telefone-cliente').val();
        
        // Validação
        if (!blog_id) {
            alert('<?php _e('Por favor, busque e selecione um site válido na lista.', 'limiter-mkp-pro'); ?>');
            $('#limiter-mkp-pro-site-search').focus();
            return;
        }
        
        if (!plano_id) {
            alert('<?php _e('Por favor, selecione um plano.', 'limiter-mkp-pro'); ?>');
            return;
        }
        
        var $btn = $('#limiter-mkp-pro-subdominio-submit');
        $btn.prop('disabled', true).text('<?php _e('Processando...', 'limiter-mkp-pro'); ?>');
        
        $.ajax({
            url: limiter_mkp_pro_admin.ajax_url,
            type: 'POST',
            data: {
                'action': 'limiter_mkp_pro_save_subdominio',
                'nonce': limiter_mkp_pro_admin.nonce,
                'blog_id': blog_id,
                'dominio': dominio,
                'plano_id': plano_id,
                'limite_personalizado': limite_personalizado,
                'nome_cliente': nome_cliente,
                'email_cliente': email_cliente,
                'telefone_cliente': telefone_cliente
            },
            success: function(response) {
                if (response.success) {
                    alert(response.data.message);
                    window.location.href = '<?php echo network_admin_url('admin.php?page=limiter-mkp-pro-subdominios'); ?>';
                } else {
                    alert(response.data.message);
                    $btn.prop('disabled', false).text('<?php _e('Adicionar Subdomínio', 'limiter-mkp-pro'); ?>');
                }
            },
            error: function() {
                alert(limiter_mkp_pro_admin.messages.error);
                $btn.prop('disabled', false).text('<?php _e('Adicionar Subdomínio', 'limiter-mkp-pro'); ?>');
            }
        });
    });
});
</script>



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/churn-dashboard.php e os codigos deste arquivo:
<?php
/**
 * Dashboard de Gestão de Churn
 * OTIMIZADO para performance
 *
 * @since 1.4.0
 */
if (!defined('ABSPATH')) {
    exit;
}

if (!Limiter_MKP_Pro_Security::check_network_permissions()) {
    wp_die(__('Você não tem permissão para acessar esta página.', 'limiter-mkp-pro'));
}

require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';

// OTIMIZAÇÃO: Usamos funções COUNT(*) diretas do SQL
// Isso evita carregar milhares de objetos PHP na memória (causa do Erro 520)
$count_active      = Limiter_MKP_Pro_Database::count_blogs_by_lifecycle_status('active');
$count_suspended   = Limiter_MKP_Pro_Database::count_blogs_by_lifecycle_status('suspended');
$count_cancelled   = Limiter_MKP_Pro_Database::count_blogs_by_lifecycle_status('cancelled');
$overdue_count     = Limiter_MKP_Pro_Database::count_overdue_subscriptions();

// Carrega apenas os últimos 20 cancelados para a tabela (Limitado para performance)
$recent_cancelled_blogs = Limiter_MKP_Pro_Database::get_blogs_by_lifecycle_status('cancelled', 20);
?>

<div class="wrap">
    <h1><?php _e('Gestão de Churn - Limiter MKP Pro', 'limiter-mkp-pro'); ?></h1>

    <div class="limiter-mkp-pro-admin-stats-cards">
        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Assinaturas Ativas', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-yes"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-value"><?php echo esc_html($count_active); ?></div>
        </div>
        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Suspensas', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-warning"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-value"><?php echo esc_html($count_suspended); ?></div>
        </div>
        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Canceladas', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-no"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-value"><?php echo esc_html($count_cancelled); ?></div>
        </div>
        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Vencidas (Overdue)', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-clock"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-value"><?php echo esc_html($overdue_count); ?></div>
        </div>
    </div>

    <h2><?php _e('Subdomínios Cancelados Recentes (Últimos 20)', 'limiter-mkp-pro'); ?></h2>
    <?php if (!empty($recent_cancelled_blogs)): ?>
        <table class="wp-list-table widefat striped">
            <thead>
                <tr>
                    <th><?php _e('Subdomínio', 'limiter-mkp-pro'); ?></th>
                    <th><?php _e('Cliente', 'limiter-mkp-pro'); ?></th>
                    <th><?php _e('Plano', 'limiter-mkp-pro'); ?></th>
                    <th><?php _e('Início', 'limiter-mkp-pro'); ?></th>
                    <th><?php _e('Expiração', 'limiter-mkp-pro'); ?></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($recent_cancelled_blogs as $blog): 
                    $site_info = get_blog_details($blog->blog_id);
                    ?>
                    <tr>
                        <td><?php echo esc_html($site_info ? $site_info->domain . $site_info->path : 'N/A'); ?></td>
                        <td>
                            <?php echo esc_html($blog->nome_cliente ?: $blog->email_cliente ?: '—'); ?>
                            <?php if (!empty($blog->telefone_cliente)): ?>
                                <br><small><?php echo esc_html($blog->telefone_cliente); ?></small>
                            <?php endif; ?>
                        </td>
                        <td><?php echo esc_html($blog->plano_nome ?: '—'); ?></td>
                        <td><?php echo esc_html($blog->data_inicio); ?></td>
                        <td><?php echo esc_html($blog->data_expiracao ?: '—'); ?></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php else: ?>
        <p><?php _e('Nenhum subdomínio cancelado encontrado.', 'limiter-mkp-pro'); ?></p>
    <?php endif; ?>

    <div class="limiter-mkp-pro-admin-quick-actions" style="margin-top: 30px;">
        <a href="<?php echo network_admin_url('admin.php?page=limiter-mkp-pro-lifecycle'); ?>" class="limiter-mkp-pro-admin-quick-action">
            <span class="dashicons dashicons-update"></span>
            <span class="limiter-mkp-pro-admin-quick-action-label"><?php _e('Configurar Ciclo de Vida', 'limiter-mkp-pro'); ?></span>
        </a>
        <a href="<?php echo network_admin_url('admin.php?page=limiter-mkp-pro-subdominios'); ?>" class="limiter-mkp-pro-admin-quick-action">
            <span class="dashicons dashicons-admin-site"></span>
            <span class="limiter-mkp-pro-admin-quick-action-label"><?php _e('Gerenciar Subdomínios', 'limiter-mkp-pro'); ?></span>
        </a>
    </div>
</div>



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/configuracoes.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de configurações.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */

if (!isset($configuracoes) || !is_array($configuracoes)) {
    $configuracoes = array();
}

// Garante que a classe de configurações esteja carregada para pegar os defaults
if (!class_exists('Limiter_MKP_Pro_Configuracoes')) {
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
}

// Recarrega as configurações do banco para garantir que temos os dados mais frescos ao renderizar
$config_obj = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', LIMITER_MKP_PRO_VERSION);
$configuracoes = $config_obj->get_configuracoes();

?>

<div class="wrap limiter-mkp-pro-admin-configuracoes">
    <h1><?php _e('Limiter MKP Pro - Configurações', 'limiter-mkp-pro'); ?></h1>
    
    <div class="notice notice-info inline" style="margin-bottom: 20px;">
        <p><strong>💡 Dica:</strong> As alterações feitas aqui afetam toda a rede. Certifique-se de salvar para aplicar as mudanças.</p>
    </div>

    <form id="limiter-mkp-pro-configuracoes-form" class="limiter-mkp-pro-admin-form">
        
        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Configurações de Subdomínios', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-sufixo-subdominio"><?php _e('Sufixo para Subdomínios', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-sufixo-subdominio" name="sufixo_subdominio" value="<?php echo esc_attr($configuracoes['sufixo_subdominio']); ?>" required>
                <p class="description"><?php _e('Sufixo que será adicionado automaticamente aos nomes de subdomínios (ex: "-mkp").', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label><?php _e('Blacklist de Subdomínios', 'limiter-mkp-pro'); ?></label>
                <p class="description"><?php _e('Nomes de subdomínios que não podem ser utilizados. Separe os nomes com vírgula.', 'limiter-mkp-pro'); ?></p>
                <textarea id="limiter-mkp-pro-subdomain-blacklist" name="subdomain_blacklist" rows="5" style="width: 100%; max-width: 500px;"><?php 
                    echo esc_textarea(implode(', ', $configuracoes['subdomain_blacklist'])); 
                ?></textarea>
                <p class="description">
                    <?php _e('Padrões bloqueados:', 'limiter-mkp-pro'); ?><br>
                    <?php _e('• Nomes exatos (ex: "admin")', 'limiter-mkp-pro'); ?><br>
                    <?php _e('• Nomes com números (ex: "admin1", "admin2")', 'limiter-mkp-pro'); ?>
                </p>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Configurações de Notificação', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-notificacao"><?php _e('E-mail para Notificações', 'limiter-mkp-pro'); ?></label>
                <input type="email" id="limiter-mkp-pro-email-notificacao" name="email_notificacao" value="<?php echo esc_attr($configuracoes['email_notificacao']); ?>" required>
                <p class="description"><?php _e('E-mail para receber notificações.', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-limite-alerta"><?php _e('Limite para Alerta', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-limite-alerta" name="limite_alerta" min="1" max="10" value="<?php echo esc_attr($configuracoes['limite_alerta']); ?>" required>
                <p class="description"><?php _e('Número de páginas restantes para exibir alerta.', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-nome-sistema"><?php _e('Nome do Sistema/Empresa', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-nome-sistema" name="nome_sistema" value="<?php echo esc_attr($configuracoes['nome_sistema']); ?>" required>
                <p class="description"><?php _e('Nome que aparecerá nos e-mails e mensagens do sistema.', 'limiter-mkp-pro'); ?></p>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Configuração de Planos por Região', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-planos-url-global"><?php _e('URL de Planos (Global)', 'limiter-mkp-pro'); ?></label>
                <input type="url" id="limiter-mkp-pro-planos-url-global" name="planos_url_global" 
                       value="<?php echo esc_attr($configuracoes['planos_url_global']); ?>" required>
                <p class="description"><?php _e('Ex: https://marketing-place.store/planos/', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-planos-url-jp"><?php _e('URL de Planos (Japão)', 'limiter-mkp-pro'); ?></label>
                <input type="url" id="limiter-mkp-pro-planos-url-jp" name="planos_url_jp" 
                       value="<?php echo esc_attr($configuracoes['planos_url_jp']); ?>" required>
                <p class="description"><?php _e('Ex: https://marketing-place.store/planos-jp/', 'limiter-mkp-pro'); ?></p>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Mensagens Personalizadas', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-mensagem-limite"><?php _e('Mensagem de Limite Atingido', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-mensagem-limite" name="mensagem_limite" rows="4" required><?php echo esc_textarea($configuracoes['mensagem_limite']); ?></textarea>
                <p class="description"><?php _e('Use [X] para substituir pelo limite do plano.', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-mensagem-alerta"><?php _e('Mensagem de Alerta', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-mensagem-alerta" name="mensagem_alerta" rows="4" required><?php echo esc_textarea($configuracoes['mensagem_alerta']); ?></textarea>
                <p class="description"><?php _e('Exibida na penúltima página.', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-widget-alerta"><?php _e('Mensagem de Alerta no Widget', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-widget-alerta" name="widget_alerta_limite" rows="4"><?php echo esc_textarea($configuracoes['widget_alerta_limite']); ?></textarea>
                <p class="description"><?php _e('Use [PERCENTUAL] para substituir pelo percentual de uso.', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-widget-sem-plano"><?php _e('Mensagem Widget Sem Plano', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-widget-sem-plano" name="widget_sem_plano" rows="3"><?php echo esc_textarea($configuracoes['widget_sem_plano']); ?></textarea>
                <p class="description"><?php _e('Mensagem exibida quando o subdomínio não tem plano configurado.', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-alerta-arquivos-80"><?php _e('Alerta Limite de Arquivos (80%)', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-alerta-arquivos-80" name="alerta_limite_arquivos_80" rows="3"><?php echo esc_textarea($configuracoes['alerta_limite_arquivos_80']); ?></textarea>
                <p class="description"><?php _e('Use [ARQUIVOS_USADOS], [ARQUIVOS_LIMITE], [NOME_PLANO].', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-alerta-arquivos-100"><?php _e('Alerta Limite de Arquivos (100%)', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-alerta-arquivos-100" name="alerta_limite_arquivos_100" rows="3"><?php echo esc_textarea($configuracoes['alerta_limite_arquivos_100']); ?></textarea>
                <p class="description"><?php _e('Use [ARQUIVOS_USADOS], [ARQUIVOS_LIMITE], [NOME_PLANO].', 'limiter-mkp-pro'); ?></p>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Mensagens de Registro e Configuração', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-disponivel"><?php _e('Subdomínio Disponível', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-disponivel" name="subdominio_disponivel" value="<?php echo esc_attr($configuracoes['subdominio_disponivel']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-indisponivel"><?php _e('Subdomínio Indisponível', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-indisponivel" name="subdominio_indisponivel" value="<?php echo esc_attr($configuracoes['subdominio_indisponivel']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-curto"><?php _e('Subdomínio Muito Curto', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-curto" name="subdominio_curto" value="<?php echo esc_attr($configuracoes['subdominio_curto']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-registro-concluido"><?php _e('Registro Concluído', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-registro-concluido" name="registro_concluido" value="<?php echo esc_attr($configuracoes['registro_concluido']); ?>" required>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Mensagens de E-mails', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-solicitacao-titulo"><?php _e('E-mail: Título Solicitação', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-email-solicitacao-titulo" name="email_solicitacao_titulo" value="<?php echo esc_attr($configuracoes['email_solicitacao_titulo']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-solicitacao-corpo"><?php _e('E-mail: Corpo Solicitação', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-email-solicitacao-corpo" name="email_solicitacao_corpo" rows="8"><?php echo esc_textarea($configuracoes['email_solicitacao_corpo']); ?></textarea>
                <p class="description"><?php _e('Use [SITE], [URL_SITE], [BLOG_ID], [PLANO_ATUAL], [LIMITE_ATUAL], [PLANO_SOLICITADO], [LIMITE_SOLICITADO], [NOME_CLIENTE], [EMAIL_CLIENTE], [TELEFONE_CLIENTE], [PAINEL_LINK].', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-confirmacao-aprovada-titulo"><?php _e('E-mail: Título Confirmação (Aprovada)', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-email-confirmacao-aprovada-titulo" name="email_confirmacao_aprovada_titulo" value="<?php echo esc_attr($configuracoes['email_confirmacao_aprovada_titulo']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-confirmacao-aprovada-corpo"><?php _e('E-mail: Corpo Confirmação (Aprovada)', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-email-confirmacao-aprovada-corpo" name="email_confirmacao_aprovada_corpo" rows="8"><?php echo esc_textarea($configuracoes['email_confirmacao_aprovada_corpo']); ?></textarea>
                <p class="description"><?php _e('Use [NOME_CLIENTE], [SITE], [URL_SITE], [NOVO_PLANO], [NOVO_LIMITE].', 'limiter-mkp-pro'); ?></p>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-configuracao-subdominio-titulo"><?php _e('E-mail: Título Configuração Subdomínio', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-email-configuracao-subdominio-titulo" name="email_configuracao_subdominio_titulo" value="<?php echo esc_attr($configuracoes['email_configuracao_subdominio_titulo']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-email-configuracao-subdominio-corpo"><?php _e('E-mail: Corpo Configuração Subdomínio', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-email-configuracao-subdominio-corpo" name="email_configuracao_subdominio_corpo" rows="10"><?php echo esc_textarea($configuracoes['email_configuracao_subdominio_corpo']); ?></textarea>
                <p class="description"><?php _e('Use [NOME_CLIENTE], [URL_CONFIGURACAO].', 'limiter-mkp-pro'); ?></p>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-section">
            <h2><?php _e('Textos do Sistema', 'limiter-mkp-pro'); ?></h2>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-botao-ver-planos"><?php _e('Botão Ver Planos', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-botao-ver-planos" name="botao_ver_planos" value="<?php echo esc_attr($configuracoes['botao_ver_planos']); ?>" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-botao-acessar-loja"><?php _e('Botão Acessar Loja', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-botao-acessar-loja" name="botao_acessar_loja" value="<?php echo esc_attr($configuracoes['botao_acessar_loja']); ?>" required>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-form-actions">
            <button type="submit" id="limiter-mkp-pro-configuracoes-submit" class="button button-primary button-large"><?php _e('Salvar Configurações', 'limiter-mkp-pro'); ?></button>
        </div>
    </form>
</div>

<script>
jQuery(document).ready(function($) {
    // CORREÇÃO CRÍTICA: Desvincula eventos anteriores antes de vincular o novo para evitar duplicação
    $('#limiter-mkp-pro-configuracoes-form').off('submit').on('submit', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation(); // Garante que nenhum outro handler interfira
        
        var $btn = $('#limiter-mkp-pro-configuracoes-submit');
        
        // Evita cliques duplos se já estiver processando
        if ($btn.data('submitting')) {
            return;
        }
        
        // Bloqueia a interface
        $btn.data('submitting', true);
        $btn.prop('disabled', true).text('<?php _e('Salvando...', 'limiter-mkp-pro'); ?>');
        
        // Processa a blacklist
        var blacklistText = $('#limiter-mkp-pro-subdomain-blacklist').val();
        var blacklistArray = blacklistText.split(',').map(function(item) {
            return item.trim().toLowerCase();
        }).filter(function(item) {
            return item !== '';
        });
        
        // Constrói objeto manual para garantir a estrutura correta
        var formData = {
            'action': 'limiter_mkp_pro_save_configuracoes',
            'nonce': limiter_mkp_pro_admin.nonce,
            'sufixo_subdominio': $('#limiter-mkp-pro-sufixo-subdominio').val(),
            'email_notificacao': $('#limiter-mkp-pro-email-notificacao').val(),
            'limite_alerta': $('#limiter-mkp-pro-limite-alerta').val(),
            'mensagem_limite': $('#limiter-mkp-pro-mensagem-limite').val(),
            'mensagem_alerta': $('#limiter-mkp-pro-mensagem-alerta').val(),
            'planos_url_global': $('#limiter-mkp-pro-planos-url-global').val(),
            'planos_url_jp': $('#limiter-mkp-pro-planos-url-jp').val(),
            'subdomain_blacklist': blacklistArray,
            'nome_sistema': $('#limiter-mkp-pro-nome-sistema').val(),
            'widget_alerta_limite': $('#limiter-mkp-pro-widget-alerta').val(),
            'widget_sem_plano': $('#limiter-mkp-pro-widget-sem-plano').val(),
            'alerta_limite_arquivos_80': $('#limiter-mkp-pro-alerta-arquivos-80').val(),
            'alerta_limite_arquivos_100': $('#limiter-mkp-pro-alerta-arquivos-100').val(),
            'subdominio_disponivel': $('#limiter-mkp-pro-subdominio-disponivel').val(),
            'subdominio_indisponivel': $('#limiter-mkp-pro-subdominio-indisponivel').val(),
            'subdominio_curto': $('#limiter-mkp-pro-subdominio-curto').val(),
            'registro_concluido': $('#limiter-mkp-pro-registro-concluido').val(),
            'email_solicitacao_titulo': $('#limiter-mkp-pro-email-solicitacao-titulo').val(),
            'email_solicitacao_corpo': $('#limiter-mkp-pro-email-solicitacao-corpo').val(),
            'email_confirmacao_aprovada_titulo': $('#limiter-mkp-pro-email-confirmacao-aprovada-titulo').val(),
            'email_confirmacao_aprovada_corpo': $('#limiter-mkp-pro-email-confirmacao-aprovada-corpo').val(),
            'email_configuracao_subdominio_titulo': $('#limiter-mkp-pro-email-configuracao-subdominio-titulo').val(),
            'email_configuracao_subdominio_corpo': $('#limiter-mkp-pro-email-configuracao-subdominio-corpo').val(),
            'botao_ver_planos': $('#limiter-mkp-pro-botao-ver-planos').val(),
            'botao_acessar_loja': $('#limiter-mkp-pro-botao-acessar-loja').val()
        };
        
        $.ajax({
            url: limiter_mkp_pro_admin.ajax_url,
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.data.message);
                    // Opcional: Recarregar a página para mostrar os dados frescos do banco
                    // location.reload();
                } else {
                    alert('Erro: ' + response.data.message);
                }
            },
            error: function(xhr, status, error) {
                alert('Ocorreu um erro de conexão ao salvar. Tente novamente.');
                console.error('Erro AJAX:', error, xhr.responseText);
            },
            complete: function() {
                // Libera a interface
                $btn.data('submitting', false);
                $btn.prop('disabled', false).text('<?php _e('Salvar Configurações', 'limiter-mkp-pro'); ?>');
            }
        });
    });
});
</script>


----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/dashboard.php e os codigos deste arquivo:
<?php
/**
 * Template para o dashboard do painel de administração.
 *
 * @since      1.4.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */

function limiter_mkp_get_mrr() {
    if (!class_exists('WC_Subscriptions') || !function_exists('wcs_get_subscriptions')) {
        return 0;
    }
    $subscriptions = wcs_get_subscriptions(['subscription_status' => 'active', 'limit' => -1]);
    $total = 0;
    foreach ($subscriptions as $sub) {
        foreach ($sub->get_items() as $item) {
            $product_id = $item->get_product_id();
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
            $plano_id = Limiter_MKP_Pro_WooCommerce_Integration::get_plano_by_product($product_id);
            if ($plano_id) {
                $total += $item->get_total();
                break;
            }
        }
    }
    return round($total, 2);
}

function limiter_mkp_get_active_subscriptions_count() {
    if (!class_exists('WC_Subscriptions')) {
        return 0;
    }
    $subscriptions = wcs_get_subscriptions(['subscription_status' => 'active', 'limit' => -1]);
    $count = 0;
    foreach ($subscriptions as $sub) {
        foreach ($sub->get_items() as $item) {
            $product_id = $item->get_product_id();
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
            if (Limiter_MKP_Pro_WooCommerce_Integration::get_plano_by_product($product_id)) {
                $count++;
                break;
            }
        }
    }
    return $count;
}

$mrr = limiter_mkp_get_mrr();
$active_subs = limiter_mkp_get_active_subscriptions_count();
?>
<div class="wrap limiter-mkp-pro-admin-dashboard">
    <h1><?php _e('Limiter MKP Pro - Dashboard', 'limiter-mkp-pro'); ?></h1>

    <div class="limiter-mkp-pro-admin-stats-cards">
        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Subdomínios Ativos', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-admin-site"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-content">
                <div class="limiter-mkp-pro-admin-card-value"><?php echo esc_html($estatisticas['total_subdominios']); ?></div>
                <div class="limiter-mkp-pro-admin-card-description"><?php _e('Sites gerenciados', 'limiter-mkp-pro'); ?></div>
            </div>
            <div class="limiter-mkp-pro-admin-card-footer">
                <a href="<?php echo network_admin_url('admin.php?page=limiter-mkp-pro-subdominios'); ?>" class="button button-secondary">
                    <?php _e('Ver Detalhes', 'limiter-mkp-pro'); ?>
                </a>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Assinaturas Ativas', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-products"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-content">
                <div class="limiter-mkp-pro-admin-card-value"><?php echo esc_html($active_subs); ?></div>
                <div class="limiter-mkp-pro-admin-card-description"><?php _e('WooCommerce Subscriptions', 'limiter-mkp-pro'); ?></div>
            </div>
            <div class="limiter-mkp-pro-admin-card-footer">
                <a href="<?php echo admin_url('edit.php?post_type=shop_subscription'); ?>" class="button button-secondary" target="_blank">
                    <?php _e('Ver Assinaturas', 'limiter-mkp-pro'); ?>
                </a>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Receita Mensal (MRR)', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-money"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-content">
                <div class="limiter-mkp-pro-admin-card-value"><?php echo wc_price($mrr); ?></div>
                <div class="limiter-mkp-pro-admin-card-description"><?php _e('Receita recorrente', 'limiter-mkp-pro'); ?></div>
            </div>
            <div class="limiter-mkp-pro-admin-card-footer">
                <a href="<?php echo admin_url('admin.php?page=wc-reports'); ?>" class="button button-secondary" target="_blank">
                    <?php _e('Relatórios', 'limiter-mkp-pro'); ?>
                </a>
            </div>
        </div>

        <div class="limiter-mkp-pro-admin-card">
            <div class="limiter-mkp-pro-admin-card-header">
                <h3><?php _e('Gerenciar Planos', 'limiter-mkp-pro'); ?></h3>
                <span class="dashicons dashicons-cart"></span>
            </div>
            <div class="limiter-mkp-pro-admin-card-content">
                <div class="limiter-mkp-pro-admin-card-value"><?php _e('Produtos WooCommerce', 'limiter-mkp-pro'); ?></div>
                <div class="limiter-mkp-pro-admin-card-description"><?php _e('Sistema automático', 'limiter-mkp-pro'); ?></div>
            </div>
            <div class="limiter-mkp-pro-admin-card-footer">
                <a href="<?php echo wc_get_page_permalink('shop'); ?>" class="button button-primary" target="_blank">
                    🛒 <?php _e('Ir para a Loja', 'limiter-mkp-pro'); ?>
                </a>
            </div>
        </div>
    </div>

    <div class="limiter-mkp-pro-admin-section">
        <h2><?php _e('Distribuição de Planos', 'limiter-mkp-pro'); ?></h2>
        <div class="limiter-mkp-pro-admin-planos-distribuicao">
            <?php if (!empty($distribuicao_planos)) : ?>
                <table class="widefat">
                    <thead>
                        <tr>
                            <th><?php _e('Plano', 'limiter-mkp-pro'); ?></th>
                            <th><?php _e('Subdomínios', 'limiter-mkp-pro'); ?></th>
                            <th><?php _e('Distribuição', 'limiter-mkp-pro'); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php 
                        $total_subdominios = $estatisticas['total_subdominios'];
                        foreach ($distribuicao_planos as $plano) : 
                            $percentual = $total_subdominios > 0 ? round(($plano->total / $total_subdominios) * 100) : 0;
                        ?>
                            <tr>
                                <td><?php echo esc_html($plano->nome); ?></td>
                                <td><?php echo esc_html($plano->total); ?></td>
                                <td>
                                    <div class="limiter-mkp-pro-admin-progress-bar">
                                        <div class="limiter-mkp-pro-admin-progress" style="width: <?php echo esc_attr($percentual); ?>%;">
                                            <?php echo esc_html($percentual); ?>%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php else : ?>
                <p><?php _e('Nenhum plano encontrado.', 'limiter-mkp-pro'); ?></p>
            <?php endif; ?>
        </div>
    </div>

    <div class="limiter-mkp-pro-admin-section">
        <h2><?php _e('Ações Rápidas', 'limiter-mkp-pro'); ?></h2>
        <div class="limiter-mkp-pro-admin-quick-actions">
            <a href="<?php echo network_admin_url('admin.php?page=limiter-mkp-pro-planos'); ?>" class="limiter-mkp-pro-admin-quick-action">
                <span class="dashicons dashicons-chart-pie"></span>
                <span class="limiter-mkp-pro-admin-quick-action-label"><?php _e('Gerenciar Planos', 'limiter-mkp-pro'); ?></span>
            </a>
            <a href="<?php echo network_admin_url('admin.php?page=limiter-mkp-pro-adicionar-subdominio'); ?>" class="limiter-mkp-pro-admin-quick-action">
                <span class="dashicons dashicons-plus"></span>
                <span class="limiter-mkp-pro-admin-quick-action-label"><?php _e('Adicionar Subdomínio', 'limiter-mkp-pro'); ?></span>
            </a>
            <a href="<?php echo wc_get_page_permalink('shop'); ?>" class="limiter-mkp-pro-admin-quick-action" target="_blank">
                <span class="dashicons dashicons-cart"></span>
                <span class="limiter-mkp-pro-admin-quick-action-label"><?php _e('Loja de Planos', 'limiter-mkp-pro'); ?></span>
            </a>
        </div>
    </div>
</div>


----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/ferramentas.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de Ferramentas Avançadas (Recursos Ocultos).
 *
 * @since      2.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */

if (!defined('ABSPATH')) {
    exit;
}

$active_tab = isset($_GET['tab']) ? sanitize_text_field($_GET['tab']) : 'backups';

// Lógica de Download
if (isset($_GET['action']) && $_GET['action'] === 'download_backup' && isset($_GET['file'])) {
    check_admin_referer('download_backup_nonce');
    $file_name = sanitize_file_name($_GET['file']);
    $backup_dir = wp_upload_dir()['basedir'] . '/limiter-mkp-pro-backups/';
    $file_path = $backup_dir . $file_name;

    if (file_exists($file_path)) {
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . basename($file_path) . '"');
        header('Content-Length: ' . filesize($file_path));
        readfile($file_path);
        exit;
    }
}
?>

<div class="wrap">
    <h1><?php _e('Ferramentas Avançadas - Limiter MKP Pro', 'limiter-mkp-pro'); ?></h1>
    
    <h2 class="nav-tab-wrapper">
        <a href="?page=limiter-mkp-pro-tools&tab=backups" class="nav-tab <?php echo $active_tab == 'backups' ? 'nav-tab-active' : ''; ?>">
            <?php _e('Backups e Snapshots', 'limiter-mkp-pro'); ?>
        </a>
        <a href="?page=limiter-mkp-pro-tools&tab=webhooks" class="nav-tab <?php echo $active_tab == 'webhooks' ? 'nav-tab-active' : ''; ?>">Webhooks</a>
    </h2>

    <div class="limiter-tools-content" style="background: #fff; padding: 20px; border: 1px solid #ccd0d4; margin-top: 10px;">
        
        <?php if ($active_tab == 'backups') : ?>
            
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                
                <div style="flex: 1; min-width: 300px; padding-right: 20px; border-right: 1px solid #eee;">
                    <h3><span class="dashicons dashicons-admin-site"></span> <?php _e('Backup Individual de Site', 'limiter-mkp-pro'); ?></h3>
                    <p><?php _e('Gera um arquivo SQL contendo todo o banco de dados de um subdomínio específico. Ideal para planos Business.', 'limiter-mkp-pro'); ?></p>
                    
                    <form id="limiter-site-backup-form">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Selecione o Subdomínio:</label>
                        
                        <select id="limiter-tools-site-select" style="width: 100%; max-width: 400px;">
                            <option value=""><?php _e('Selecione um site na lista...', 'limiter-mkp-pro'); ?></option>
                            <?php
                            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
                            $subs = Limiter_MKP_Pro_Database::get_subdominios();
                            
                            if (empty($subs)) {
                                echo '<option value="" disabled>' . __('Nenhum subdomínio cadastrado ainda', 'limiter-mkp-pro') . '</option>';
                            } else {
                                foreach ($subs as $sub) {
                                    $blog_details = get_blog_details($sub->blog_id);
                                    $nome_site = $blog_details ? $blog_details->blogname : 'Site ID ' . $sub->blog_id;
                                    $dominio = $blog_details ? $blog_details->domain . $blog_details->path : $sub->dominio;
                                    echo '<option value="' . esc_attr($sub->blog_id) . '">' . esc_html($nome_site . ' (' . $dominio . ')') . '</option>';
                                }
                            }
                            ?>
                        </select>

                        <button type="button" id="limiter-generate-site-backup-btn" class="button button-primary button-large" disabled style="margin-top: 10px; width: 100%;">
                            <span class="dashicons dashicons-database-export" style="line-height: 1.5; margin-right:5px;"></span> 
                            <?php _e('Gerar Backup SQL Agora', 'limiter-mkp-pro'); ?>
                        </button>
                    </form>
                    
                    <div id="limiter-site-progress" class="limiter-progress-wrapper">
                        <div class="limiter-progress-container">
                            <div class="limiter-progress-fill" style="width: 0%"><span class="limiter-progress-text">0%</span></div>
                        </div>
                        <div class="limiter-progress-status"><?php _e('Exportando tabelas...', 'limiter-mkp-pro'); ?></div>
                    </div>
                </div>

                <div style="flex: 1; min-width: 300px;">
                    <h3><span class="dashicons dashicons-admin-settings"></span> <?php _e('Backup Geral do Plugin', 'limiter-mkp-pro'); ?></h3>
                    <p><?php _e('Salva configurações globais, planos e lista de vínculos.', 'limiter-mkp-pro'); ?></p>
                    
                    <form id="limiter-system-backup-form">
                        <fieldset style="margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                            <label style="display:block; margin-bottom:5px;"><input type="checkbox" name="backup_includes[]" value="config" checked disabled> Configurações (Obrigatório)</label>
                            <label style="display:block; margin-bottom:5px;"><input type="checkbox" name="backup_includes[]" value="plans" checked> Planos e Limites</label>
                            <label style="display:block; margin-bottom:5px;"><input type="checkbox" name="backup_includes[]" value="subs" checked> Vínculos de Subdomínios</label>
                            <label style="display:block; margin-bottom:5px;"><input type="checkbox" name="backup_includes[]" value="clients" checked> Dados Cadastrais</label>
                            <label style="display:block; margin-bottom:5px;"><input type="checkbox" name="backup_includes[]" value="tokens" checked> Tokens</label>
                            <label style="display:block; margin-bottom:5px;"><input type="checkbox" name="backup_includes[]" value="logs" checked> Logs (Últimos 5000)</label>
                        </fieldset>

                        <button type="button" id="limiter-generate-system-btn" class="button button-secondary button-large" style="width: 100%;">
                            <?php _e('Gerar Backup JSON', 'limiter-mkp-pro'); ?>
                        </button>
                    </form>

                    <div id="limiter-system-progress" class="limiter-progress-wrapper">
                        <div class="limiter-progress-container">
                            <div class="limiter-progress-fill" style="width: 0%"><span class="limiter-progress-text">0%</span></div>
                        </div>
                        <div class="limiter-progress-status"><?php _e('Processando...', 'limiter-mkp-pro'); ?></div>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">

            <h3><?php _e('Arquivos Disponíveis para Download', 'limiter-mkp-pro'); ?></h3>
            <?php
            $backup_dir = wp_upload_dir()['basedir'] . '/limiter-mkp-pro-backups/';
            if (is_dir($backup_dir)) {
                $files = scandir($backup_dir);
                $valid_files = [];
                foreach ($files as $f) if (strpos($f, 'limiter-') === 0 || strpos($f, 'backup-site-') === 0) $valid_files[] = $f;
                usort($valid_files, function($a, $b) use ($backup_dir) { return filemtime($backup_dir . $b) - filemtime($backup_dir . $a); });
                
                if (!empty($valid_files)) {
                    echo '<table class="wp-list-table widefat fixed striped"><thead><tr><th>Arquivo</th><th>Tipo</th><th>Data</th><th>Tamanho</th><th>Ação</th></tr></thead><tbody>';
                    foreach ($valid_files as $file) {
                        $path = $backup_dir . $file;
                        $type = (strpos($file, '.sql') !== false) ? '<strong>Banco de Dados (SQL)</strong>' : 'Configurações (JSON)';
                        $download_url = wp_nonce_url(admin_url('admin.php?page=limiter-mkp-pro-tools&tab=backups&action=download_backup&file=' . $file), 'download_backup_nonce');
                        
                        // CORREÇÃO: Usamos wp_date passando o timestamp do arquivo.
                        // O WordPress detecta o timezone configurado no painel e converte corretamente.
                        $data_formatada = wp_date(
                            get_option('date_format') . ' ' . get_option('time_format'), 
                            filemtime($path)
                        );

                        echo '<tr>';
                        echo '<td>' . esc_html($file) . '</td>';
                        echo '<td>' . $type . '</td>';
                        echo '<td>' . esc_html($data_formatada) . '</td>';
                        echo '<td>' . size_format(filesize($path)) . '</td>';
                        echo '<td>';
                        // Botão Baixar
                        echo '<a href="' . $download_url . '" class="button button-secondary" style="margin-right:5px;" title="Baixar"><span class="dashicons dashicons-download" style="line-height: 1.3;"></span></a>';
                        // Botão Excluir
                        echo '<button type="button" class="button button-link-delete limiter-delete-backup-btn" data-file="' . esc_attr($file) . '" title="Excluir"><span class="dashicons dashicons-trash" style="line-height: 1.3; color: #a00;"></span></button>';
                        echo '</td>';
                        echo '</tr>';
                    }
                    echo '</tbody></table>';
                } else { echo '<p>Nenhum arquivo encontrado.</p>'; }
            }
            ?>

        <?php elseif ($active_tab == 'webhooks') : ?>
            <h3><?php _e('Integrações via Webhook', 'limiter-mkp-pro'); ?></h3>
            <p><em><?php _e('Em construção... Este recurso será ativado no próximo passo.', 'limiter-mkp-pro'); ?></em></p>

        <?php elseif ($active_tab == 'users') : ?>
            <h3><?php _e('Cofre de Permissões de Usuários', 'limiter-mkp-pro'); ?></h3>
            <p><em><?php _e('Em construção... Este recurso será ativado no próximo passo.', 'limiter-mkp-pro'); ?></em></p>

        <?php elseif ($active_tab == 'shortcodes') : ?>
            <h3><?php _e('Shortcodes Disponíveis', 'limiter-mkp-pro'); ?></h3>
            <p><em><?php _e('Em construção... Este recurso será ativado no próximo passo.', 'limiter-mkp-pro'); ?></em></p>

        <?php endif; ?>
    </div>
</div>

<script type="text/javascript">
jQuery(document).ready(function($) {
    // 1. Monitora o Dropdown de Sites
    $('#limiter-tools-site-select').on('change', function() {
        var siteId = $(this).val();
        $('#limiter-generate-site-backup-btn').prop('disabled', !siteId);
    });

    // 2. Handler Backup SQL Individual
    $('#limiter-generate-site-backup-btn').on('click', function() {
        var $btn = $(this);
        var blogId = $('#limiter-tools-site-select').val();
        if(!blogId) { alert('Selecione um site primeiro.'); return; }
        runBackupProcess($btn, '#limiter-site-progress', 'limiter_mkp_pro_generate_site_backup', { blog_id: blogId });
    });

    // 3. Handler Backup JSON Sistema
    $('#limiter-generate-system-btn').on('click', function() {
        var $btn = $(this);
        var includes = [];
        $('input[name="backup_includes[]"]:checked').each(function() { includes.push($(this).val()); });
        runBackupProcess($btn, '#limiter-system-progress', 'limiter_mkp_pro_generate_backup', { includes: includes });
    });

    // 4. Handler de Exclusão de Backup
    $('.limiter-delete-backup-btn').on('click', function() {
        var filename = $(this).data('file');
        if(confirm('Tem certeza que deseja excluir o arquivo "' + filename + '"? Esta ação é irreversível.')) {
            $.post(limiter_mkp_pro_admin.ajax_url, {
                action: 'limiter_mkp_pro_delete_backup',
                file: filename,
                nonce: limiter_mkp_pro_admin.nonce
            }, function(res) {
                if(res.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + res.data.message);
                }
            }).fail(function() {
                alert('Erro de conexão.');
            });
        }
    });

    // Função genérica de animação
    function runBackupProcess($btn, progressId, action, extraData) {
        var $progressWrapper = $(progressId);
        var $bar = $progressWrapper.find('.limiter-progress-fill');
        var $text = $progressWrapper.find('.limiter-progress-text');
        var $status = $progressWrapper.find('.limiter-progress-status');
        
        $btn.prop('disabled', true);
        $progressWrapper.slideDown();
        $bar.css('width', '10%');
        
        var p = 10;
        var interval = setInterval(function() {
            if(p < 90) { p += 5; $bar.css('width', p + '%'); $text.text(p + '%'); }
        }, 500);

        var data = { action: action, nonce: limiter_mkp_pro_admin.nonce };
        $.extend(data, extraData);

        $.post(limiter_mkp_pro_admin.ajax_url, data, function(res) {
            clearInterval(interval);
            if(res.success) {
                $bar.css('width', '100%').css('background', '#28a745');
                $text.text('100%');
                $status.html('<span style="color:green; font-weight:bold;">' + res.data.message + '</span>');
                setTimeout(function() { location.reload(); }, 1500);
            } else {
                $bar.css('background', '#dc3545');
                $status.html('<span style="color:red; font-weight:bold;">Erro: ' + res.data.message + '</span>');
                $btn.prop('disabled', false);
            }
        }).fail(function() {
            clearInterval(interval);
            $bar.css('background', '#dc3545');
            $status.text('Erro fatal no servidor.');
            $btn.prop('disabled', false);
        });
    }
});
</script>


----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/health-check.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de Health Check.
 *
 * @since      1.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */
?>
<div class="wrap limiter-mkp-pro-admin-health-check">
    <h1><?php _e('Limiter MKP Pro - Health Check', 'limiter-mkp-pro'); ?></h1>
    <p><?php _e('Este painel verifica a integridade do sistema e identifica possíveis problemas.', 'limiter-mkp-pro'); ?></p>

    <div class="limiter-mkp-pro-admin-section">
        <h2><?php _e('Relatório de Saúde', 'limiter-mkp-pro'); ?></h2>
        <table class="widefat striped">
            <thead>
                <tr>
                    <th><?php _e('Verificação', 'limiter-mkp-pro'); ?></th>
                    <th><?php _e('Status', 'limiter-mkp-pro'); ?></th>
                    <th><?php _e('Detalhes', 'limiter-mkp-pro'); ?></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($checks as $check_key => $result): ?>
                    <?php
                    $status_icon = '✅';
                    $status_class = 'limiter-success';
                    if ($result['status'] === 'warning') {
                        $status_icon = '⚠️';
                        $status_class = 'limiter-warning';
                    } elseif ($result['status'] === 'error') {
                        $status_icon = '❌';
                        $status_class = 'limiter-error';
                    }
                    ?>
                    <tr>
                        <td>
                            <strong><?php echo esc_html(str_replace('_', ' ', ucfirst($check_key))); ?></strong>
                        </td>
                        <td>
                            <span class="<?php echo esc_attr($status_class); ?>">
                                <?php echo $status_icon; ?> <?php echo esc_html($result['status']); ?>
                            </span>
                        </td>
                        <td>
                            <p><?php echo esc_html($result['message']); ?></p>
                            <?php if (!empty($result['details'])): ?>
                                <details>
                                    <summary><?php _e('Ver detalhes técnicos', 'limiter-mkp-pro'); ?></summary>
                                    <pre style="background:#f8f9fa; padding:10px; border-radius:4px; overflow:auto; max-height:150px;">
                                        <?php echo esc_html(wp_json_encode($result['details'], JSON_PRETTY_PRINT)); ?>
                                    </pre>
                                </details>
                            <?php endif; ?>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>

    <div class="limiter-mkp-pro-admin-section">
        <h2><?php _e('Ações de Manutenção', 'limiter-mkp-pro'); ?></h2>
        <p><?php _e('Use estas ferramentas para corrigir problemas comuns.', 'limiter-mkp-pro'); ?></p>
        <form method="post" action="">
            <?php submit_button(__('Gerar Relatório Completo (TXT)', 'limiter-mkp-pro'), 'secondary', 'generate_full_report'); ?>
        </form>
    </div>
</div>

<?php
// Geração de relatório completo
if (isset($_POST['generate_full_report'])) {
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-health-check.php';
    $report = Limiter_MKP_Pro_Health_Check::generate_report();
    header('Content-Type: text/plain');
    header('Content-Disposition: attachment; filename="limiter-mkp-pro-health-check-' . date('Y-m-d') . '.txt"');
    echo $report;
    exit;
}
?>

<style>
.limiter-success { color: #28a745; }
.limiter-warning { color: #ffc107; }
.limiter-error { color: #dc3545; }
</style>



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/lifecycle-settings.php e os codigos deste arquivo:
<?php
/**
 * Template para configurações do ciclo de vida
 */
if (!defined('ABSPATH')) {
    exit;
}

$settings = Limiter_MKP_Pro_Lifecycle_Manager::get_settings();
?>
<div class="wrap limiter-mkp-pro-lifecycle-settings">
    <h1><?php _e('Ciclo de Vida & Cobrança', 'limiter-mkp-pro'); ?></h1>
    
    <form id="limiter-lifecycle-settings-form">
        <?php wp_nonce_field('limiter_mkp_pro_lifecycle_settings', 'lifecycle_nonce'); ?>
        
        <div class="limiter-settings-section">
            <h2><?php _e('Falha de Pagamento', 'limiter-mkp-pro'); ?></h2>
            
            <table class="form-table">
                <tr>
                    <th><?php _e('Dias de Carência', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="number" name="payment_failure[grace_period_days]" 
                               value="<?php echo esc_attr($settings['payment_failure']['grace_period_days']); ?>" 
                               min="0" max="30" class="small-text">
                        <p class="description">Dias antes de suspender o site após falha de pagamento</p>
                    </td>
                </tr>
                <tr>
                    <th><?php _e('Dias até Suspensão', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="number" name="payment_failure[suspension_days]" 
                               value="<?php echo esc_attr($settings['payment_failure']['suspension_days']); ?>" 
                               min="1" max="30" class="small-text">
                        <p class="description">Dias até bloquear visualização do site</p>
                    </td>
                </tr>
                <tr>
                    <th><?php _e('Dias até Bloqueio Total', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="number" name="payment_failure[lock_days]" 
                               value="<?php echo esc_attr($settings['payment_failure']['lock_days']); ?>" 
                               min="1" max="60" class="small-text">
                        <p class="description">Dias até remover acesso de todos os usuários</p>
                    </td>
                </tr>
                <tr>
                    <th><?php _e('Dias até Exclusão', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="number" name="payment_failure[deletion_days]" 
                               value="<?php echo esc_attr($settings['payment_failure']['deletion_days']); ?>" 
                               min="1" max="365" class="small-text">
                        <p class="description">Dias até excluir completamente o site</p>
                    </td>
                </tr>
            </table>
        </div>
        
        <div class="limiter-settings-section">
            <h2><?php _e('Cancelamento', 'limiter-mkp-pro'); ?></h2>
            
            <table class="form-table">
                <tr>
                    <th><?php _e('Suspender Imediatamente', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <label>
                            <input type="checkbox" name="cancellation[immediate_suspend]" value="1" 
                                <?php checked($settings['cancellation']['immediate_suspend'], true); ?>>
                            Suspender visualização imediatamente ao cancelar
                        </label>
                    </td>
                </tr>
                <tr>
                    <th><?php _e('Dias de Acesso Admin', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="number" name="cancellation[admin_access_days]" 
                               value="<?php echo esc_attr($settings['cancellation']['admin_access_days']); ?>" 
                               min="0" max="30" class="small-text">
                        <p class="description">Dias que o administrador mantém acesso após cancelamento</p>
                    </td>
                </tr>
                <tr>
                    <th><?php _e('Dias até Exclusão', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="number" name="cancellation[deletion_days]" 
                               value="<?php echo esc_attr($settings['cancellation']['deletion_days']); ?>" 
                               min="1" max="365" class="small-text">
                        <p class="description">Dias até excluir o site após cancelamento</p>
                    </td>
                </tr>
            </table>
        </div>
        
        <div class="limiter-settings-section">
            <h2><?php _e('Notificações', 'limiter-mkp-pro'); ?></h2>
            
            <table class="form-table">
                <tr>
                    <th><?php _e('E-mails Administrativos', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <textarea name="notification_emails" rows="3" class="large-text"><?php 
                            echo esc_textarea($settings['notification_emails']); 
                        ?></textarea>
                        <p class="description">E-mails para notificações (separados por vírgula)</p>
                    </td>
                </tr>
                <tr>
                    <th><?php _e('E-mail de Suporte', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="email" name="support_email" 
                               value="<?php echo esc_attr($settings['support_email']); ?>" 
                               class="regular-text">
                    </td>
                </tr>
                <tr>
                    <th><?php _e('URL de Planos', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <input type="url" name="plans_url" 
                               value="<?php echo esc_attr($settings['plans_url']); ?>" 
                               class="regular-text">
                    </td>
                </tr>
            </table>
        </div>
        
        <div class="limiter-settings-section">
            <h2><?php _e('Template da Página de Suspensão', 'limiter-mkp-pro'); ?></h2>
            
            <table class="form-table">
                <tr>
                    <th><?php _e('HTML Personalizado', 'limiter-mkp-pro'); ?></th>
                    <td>
                        <textarea name="suspension_page_template" rows="10" class="large-text code"><?php 
                            echo esc_textarea($settings['suspension_page_template']); 
                        ?></textarea>
                        <p class="description">
                            Use os placeholders: [BLOG_NAME], [SUPPORT_EMAIL], [PLANS_URL]<br>
                            Deixe em branco para usar o template padrão
                        </p>
                    </td>
                </tr>
            </table>
        </div>
        
        <div class="limiter-settings-section">
            <h2><?php _e('Templates de E-mail', 'limiter-mkp-pro'); ?></h2>
            
            <?php foreach ($settings['email_templates'] as $key => $template): ?>
                <h3><?php echo esc_html($key); ?></h3>
                <table class="form-table">
                    <tr>
                        <th><?php _e('Assunto', 'limiter-mkp-pro'); ?></th>
                        <td>
                            <input type="text" name="email_templates[<?php echo $key; ?>][subject]" 
                                   value="<?php echo esc_attr($template['subject']); ?>" 
                                   class="large-text">
                        </td>
                    </tr>
                    <tr>
                        <th><?php _e('Mensagem', 'limiter-mkp-pro'); ?></th>
                        <td>
                            <textarea name="email_templates[<?php echo $key; ?>][message]" 
                                      rows="5" class="large-text"><?php 
                                echo esc_textarea($template['message']); 
                            ?></textarea>
                            <p class="description">
                                Placeholders disponíveis: [BLOG_NAME], [BLOG_URL], [CUSTOMER_NAME], 
                                [CUSTOMER_EMAIL], [DAYS_REMAINING], [SUSPENSION_DATE], [DELETION_DATE]
                            </p>
                        </td>
                    </tr>
                </table>
            <?php endforeach; ?>
        </div>
        
        <p class="submit">
            <button type="submit" class="button button-primary"><?php _e('Salvar Configurações', 'limiter-mkp-pro'); ?></button>
        </p>
    </form>
</div>

<script>
jQuery(document).ready(function($) {
    $('#limiter-lifecycle-settings-form').on('submit', function(e) {
        e.preventDefault();
        
        var formData = $(this).serialize();
        
        $.ajax({
            url: ajaxurl,
            type: 'POST',
            data: formData + '&action=limiter_save_lifecycle_settings',
            beforeSend: function() {
                $('.submit button').prop('disabled', true).text('Salvando...');
            },
            success: function(response) {
                if (response.success) {
                    alert('Configurações salvas com sucesso!');
                } else {
                    alert('Erro: ' + response.data.message);
                }
            },
            error: function() {
                alert('Erro ao salvar configurações');
            },
            complete: function() {
                $('.submit button').prop('disabled', false).text('Salvar Configurações');
            }
        });
    });
});
</script>



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/logs.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de logs com Visual Aprimorado e Tooltip via Clique.
 *
 * @since      2.3.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */

// Helper para definir estilo com base na ação
function limiter_get_log_style($acao) {
    $acao = strtolower($acao);
    
    // Padrões de Erro
    if (strpos($acao, 'erro') !== false || strpos($acao, 'falha') !== false || strpos($acao, 'failed') !== false || strpos($acao, 'excedido') !== false) {
        return ['class' => 'log-status-error', 'icon' => 'dashicons-warning'];
    }
    
    // Padrões de Sucesso
    if (strpos($acao, 'sucesso') !== false || strpos($acao, 'concluido') !== false || strpos($acao, 'criado') !== false || strpos($acao, 'success') !== false) {
        return ['class' => 'log-status-success', 'icon' => 'dashicons-yes-alt'];
    }
    
    // Padrões de Aviso/Manutenção
    if (strpos($acao, 'limpeza') !== false || strpos($acao, 'manutencao') !== false || strpos($acao, 'desativacao') !== false) {
        return ['class' => 'log-status-warning', 'icon' => 'dashicons-performance'];
    }
    
    // Padrão Informativo (Default)
    return ['class' => 'log-status-info', 'icon' => 'dashicons-info'];
}
?>

<div class="wrap limiter-mkp-pro-admin-logs">
    <h1 class="wp-heading-inline"><?php _e('Limiter MKP Pro - Logs do Sistema', 'limiter-mkp-pro'); ?></h1>
    <hr class="wp-header-end">
    
    <div class="limiter-mkp-pro-admin-filters" style="background: #fff; padding: 15px; border: 1px solid #ccd0d4; margin-top: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
        <form method="get" style="display: flex; align-items: center; gap: 10px;">
            <input type="hidden" name="page" value="limiter-mkp-pro-logs">
            
            <label for="limiter-mkp-pro-filter-blog-id" style="font-weight: 600;"><?php _e('Filtrar por:', 'limiter-mkp-pro'); ?></label>
            <select id="limiter-mkp-pro-filter-blog-id" name="blog_id">
                <option value=""><?php _e('Todos os Subdomínios', 'limiter-mkp-pro'); ?></option>
                <?php 
                $subdominios = Limiter_MKP_Pro_Database::get_subdominios();
                foreach ($subdominios as $subdominio) : 
                    $site_info = get_blog_details($subdominio->blog_id);
                    $selected = isset($_GET['blog_id']) && $_GET['blog_id'] == $subdominio->blog_id ? 'selected' : '';
                    $blogname = $site_info ? $site_info->blogname : 'Site ID ' . $subdominio->blog_id;
                    $domain = $site_info ? $site_info->domain . $site_info->path : $subdominio->dominio;
                ?>
                    <option value="<?php echo esc_attr($subdominio->blog_id); ?>" <?php echo $selected; ?>>
                        <?php echo esc_html($blogname); ?> (<?php echo esc_html($domain); ?>)
                    </option>
                <?php endforeach; ?>
            </select>
            
            <button type="submit" class="button button-secondary"><?php _e('Aplicar Filtro', 'limiter-mkp-pro'); ?></button>
        </form>

        <form id="limiter-mkp-pro-limpar-logs-form" style="margin:0;">
            <input type="hidden" id="limiter-mkp-pro-dias-logs" name="dias" value="30">
            <button type="submit" id="limiter-mkp-pro-limpar-logs-submit" class="button button-link-delete" title="Limpar logs com mais de 30 dias">
                <span class="dashicons dashicons-trash" style="vertical-align: middle;"></span> Limpar Antigos
            </button>
        </form>
    </div>
    
    <div class="limiter-mkp-pro-admin-list-container" style="margin-top: 20px;">
        
        <?php if (!empty($logs)) : ?>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th style="width: 160px;"><?php _e('Data/Hora', 'limiter-mkp-pro'); ?></th>
                        <th style="width: 200px;"><?php _e('Origem (Subdomínio)', 'limiter-mkp-pro'); ?></th>
                        <th style="width: 220px;"><?php _e('Ação', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Descrição', 'limiter-mkp-pro'); ?></th>
                        <th style="width: 80px; text-align: center;"><?php _e('Dados', 'limiter-mkp-pro'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($logs as $log) : 
                        $site_info = ($log->blog_id > 0) ? get_blog_details($log->blog_id) : null;
                        $style = limiter_get_log_style($log->acao);
                        
                        // Prepara dados extras
                        $has_details = !empty($log->dados_extras) && $log->dados_extras !== 'a:0:{}';
                        $details_json = '';
                        if ($has_details) {
                            $unserialized = maybe_unserialize($log->dados_extras);
                            $details_json = json_encode($unserialized, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
                        }
                    ?>
                        <tr>
                            <td>
                                <?php echo date_i18n(get_option('date_format'), strtotime($log->timestamp)); ?><br>
                                <small style="color: #888;"><?php echo date_i18n(get_option('time_format'), strtotime($log->timestamp)); ?></small>
                            </td>
                            <td>
                                <?php if ($log->blog_id == 0) : ?>
                                    <span class="dashicons dashicons-admin-network" style="color:#888; font-size:16px; width:16px; height:16px; vertical-align:middle;"></span> 
                                    <strong>Rede (Global)</strong>
                                <?php elseif ($site_info) : ?>
                                    <a href="<?php echo esc_url($site_info->siteurl); ?>" target="_blank" style="text-decoration:none; font-weight:500;">
                                        <?php echo esc_html($site_info->blogname); ?>
                                        <span class="dashicons dashicons-external" style="font-size:12px; width:12px; height:12px;"></span>
                                    </a>
                                    <br><small style="color:#888;"><?php echo esc_html($site_info->domain); ?></small>
                                <?php else : ?>
                                    <span style="color:#aa0000;"><?php _e('Site Deletado', 'limiter-mkp-pro'); ?></span> (ID: <?php echo esc_html($log->blog_id); ?>)
                                <?php endif; ?>
                            </td>
                            <td>
                                <span class="limiter-log-badge <?php echo esc_attr($style['class']); ?>">
                                    <span class="dashicons <?php echo esc_attr($style['icon']); ?>"></span>
                                    <?php echo esc_html($log->acao); ?>
                                </span>
                            </td>
                            <td>
                                <?php echo esc_html($log->descricao); ?>
                                <br>
                                <small style="color: #999;">IP: <?php echo esc_html($log->ip); ?> | User ID: <?php echo esc_html($log->user_id); ?></small>
                            </td>
                            <td style="text-align: center;">
                                <?php if ($has_details) : ?>
                                    <button type="button" class="limiter-view-details" 
                                            title="Clique para ver os detalhes"
                                            data-json="<?php echo htmlspecialchars($details_json, ENT_QUOTES, 'UTF-8'); ?>">
                                        <span class="dashicons dashicons-visibility" style="font-size: 18px;"></span>
                                    </button>
                                <?php else: ?>
                                    <span style="color:#ccc;">—</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else : ?>
            <div class="notice notice-info inline">
                <p><?php _e('Nenhum log encontrado para os critérios selecionados.', 'limiter-mkp-pro'); ?></p>
            </div>
        <?php endif; ?>
    </div>
</div>

<div id="limiter-log-tooltip" class="limiter-log-tooltip"></div>

<script>
jQuery(document).ready(function($) {
    var $tooltip = $('#limiter-log-tooltip');
    
    // Move o tooltip para o final do body para evitar problemas de overflow
    $('body').append($tooltip);

    $('.limiter-view-details').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        var $btn = $(this);
        var jsonContent = $btn.data('json');
        
        // Se clicar no mesmo botão que já está aberto, fecha
        if ($tooltip.is(':visible') && $tooltip.data('trigger') === this) {
            $tooltip.hide();
            return;
        }

        if (typeof jsonContent === 'object') {
            jsonContent = JSON.stringify(jsonContent, null, 2);
        }

        $tooltip.text(jsonContent).data('trigger', this).show();

        // Posicionamento absoluto usando offset()
        var btnOffset = $btn.offset();
        var tooltipWidth = $tooltip.outerWidth();
        
        // Calcula posição (ao lado esquerdo do botão por padrão)
        var top = btnOffset.top - 10;
        var left = btnOffset.left - tooltipWidth - 15;

        // Se ficar fora da tela à esquerda, joga para a direita
        if (left < 10) {
            left = btnOffset.left + $btn.outerWidth() + 15;
        }

        $tooltip.css({
            top: top,
            left: left
        });
    });

    // Fecha ao clicar fora
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.limiter-log-tooltip').length && !$(e.target).closest('.limiter-view-details').length) {
            $tooltip.hide();
        }
    });

    // Lógica de Limpeza de Logs
    $('#limiter-mkp-pro-limpar-logs-submit').on('click', function(e) {
        e.preventDefault();
        if (confirm('<?php _e('Tem certeza que deseja limpar os logs mais antigos que 30 dias?', 'limiter-mkp-pro'); ?>')) {
            $.ajax({
                url: limiter_mkp_pro_admin.ajax_url,
                type: 'POST',
                data: {
                    'action': 'limiter_mkp_pro_limpar_logs',
                    'nonce': limiter_mkp_pro_admin.nonce,
                    'dias': 30
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.data.message);
                    }
                }
            });
        }
    });
});
</script>



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/planos.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de planos.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */
// Segurança: impede acesso direto ao arquivo
if (!defined('ABSPATH')) {
    exit;
}

// Inicializa a variável para evitar Warning/Erro
$plano_products = isset($plano_products) ? $plano_products : array();
?>
<div class="wrap limiter-mkp-pro-admin-planos">
    <h1><?php esc_html_e('Limiter MKP Pro - Planos', 'limiter-mkp-pro'); ?></h1>
    <?php
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
    $woocommerce_active = Limiter_MKP_Pro_WooCommerce_Integration::is_woocommerce_active();
    $subscriptions_active = Limiter_MKP_Pro_WooCommerce_Integration::is_subscriptions_active();
    $subscription_products = $woocommerce_active ? Limiter_MKP_Pro_WooCommerce_Integration::get_subscription_products() : array();
    
    require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-planos.php';
    $planos_handler = new Limiter_MKP_Pro_Planos('limiter-mkp-pro', '1.0.0');
    ?>
    <div class="limiter-mkp-pro-admin-form-container">
        <h2 id="limiter-mkp-pro-form-title"><?php esc_html_e('Adicionar Novo Plano', 'limiter-mkp-pro'); ?></h2>
        <form id="limiter-mkp-pro-plano-form" class="limiter-mkp-pro-admin-form">
            <input type="hidden" id="limiter-mkp-pro-plano-id" name="id" value="0">
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-nome"><?php esc_html_e('Nome', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-plano-nome" name="nome" required>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-descricao"><?php esc_html_e('Descrição', 'limiter-mkp-pro'); ?></label>
                <textarea id="limiter-mkp-pro-plano-descricao" name="descricao" rows="3"></textarea>
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-duracao">
                    <?php esc_html_e('Duração (dias)', 'limiter-mkp-pro'); ?>
                    <?php if (!empty($subscription_products)): ?>
                        <small style="color: #0073aa;">(Sincronizado com WooCommerce)</small>
                    <?php endif; ?>
                </label>
                <input type="number" id="limiter-mkp-pro-plano-duracao" name="duracao" min="1" value="30">
            </div>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-limite"><?php esc_html_e('Limite de Páginas', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-plano-limite" name="limite_paginas" min="1" required>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-limite-upload"><?php esc_html_e('Espaço em Disco (MB)', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-plano-limite-upload" name="limite_upload_mb" min="1" value="100" required>
                <p class="description">
                    <?php esc_html_e('Limite nativo de armazenamento físico (ex: 500 para 500MB). O WordPress bloqueará uploads se exceder.', 'limiter-mkp-pro'); ?>
                </p>
            </div>

            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-limite-inodes"><?php esc_html_e('Limite de Arquivos (Inodes)', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-plano-limite-inodes" name="limite_inodes" min="1" value="1000" required>
                <p class="description">
                    <?php esc_html_e('Número máximo de arquivos permitidos (imagens, documentos, etc.) para este plano.', 'limiter-mkp-pro'); ?>
                </p>
            </div>

            <div class="limiter-mkp-pro-admin-form-section" style="background: #f8f9fc; padding: 15px; border-radius: 4px; border: 1px solid #e2e4e7; margin: 15px 0;">
                <h3><span class="dashicons dashicons-backup"></span> <?php _e('Rotina de Backup (Premium)', 'limiter-mkp-pro'); ?></h3>
                
                <div class="limiter-mkp-pro-admin-form-row">
                    <label for="limiter-mkp-pro-plano-backup-freq"><?php esc_html_e('Frequência de Backup Automático', 'limiter-mkp-pro'); ?></label>
                    <select id="limiter-mkp-pro-plano-backup-freq" name="backup_frequency">
                        <option value="none"><?php esc_html_e('Nenhum (Desativado)', 'limiter-mkp-pro'); ?></option>
                        <option value="daily"><?php esc_html_e('Diário (Todo dia)', 'limiter-mkp-pro'); ?></option>
                        <option value="weekly"><?php esc_html_e('Semanal (Toda semana)', 'limiter-mkp-pro'); ?></option>
                        <option value="monthly"><?php esc_html_e('Mensal (Todo mês)', 'limiter-mkp-pro'); ?></option>
                    </select>
                    <p class="description"><?php esc_html_e('Backup completo do banco de dados (SQL) do subdomínio.', 'limiter-mkp-pro'); ?></p>
                </div>

                <div class="limiter-mkp-pro-admin-form-row">
                    <label for="limiter-mkp-pro-plano-backup-ret"><?php esc_html_e('Retenção (Arquivos mantidos)', 'limiter-mkp-pro'); ?></label>
                    <input type="number" id="limiter-mkp-pro-plano-backup-ret" name="backup_retention" min="1" max="30" value="3">
                    <p class="description"><?php esc_html_e('Quantos backups recentes manter antes de apagar os antigos. Recomendado: 3 a 7.', 'limiter-mkp-pro'); ?></p>
                </div>
            </div>

            <div class="limiter-mkp-pro-admin-form-section">
                <h3><?php _e('Tipos de Conteúdo a Contabilizar', 'limiter-mkp-pro'); ?></h3>
                <?php
                $all_post_types = get_post_types(['public' => true], 'objects');
                $cpts = [];
                foreach ($all_post_types as $name => $obj) {
                    if (!in_array($name, ['post', 'page', 'attachment'])) {
                        $cpts[$name] = $obj->label;
                    }
                }
                ?>
                <div class="limiter-mkp-pro-admin-form-row">
                    <p><strong><?php _e('Tipos nativos:', 'limiter-mkp-pro'); ?></strong></p>
                    <label><input type="checkbox" name="post_types_contaveis[]" value="post" checked> Post</label><br>
                    <label><input type="checkbox" name="post_types_contaveis[]" value="page" checked> Página</label>
                </div>
                <?php if (!empty($cpts)): ?>
                <div class="limiter-mkp-pro-admin-form-row">
                    <p><strong><?php _e('Custom Post Types:', 'limiter-mkp-pro'); ?></strong></p>
                    <?php foreach ($cpts as $slug => $label): ?>
                        <label><input type="checkbox" name="post_types_contaveis[]" value="<?php echo esc_attr($slug); ?>"> <?php echo esc_html($label); ?> (<?php echo esc_html($slug); ?>)</label><br>
                    <?php endforeach; ?>
                </div>
                <?php endif; ?>
            </div>

            <div class="limiter-mkp-pro-admin-form-section">
                <h3><?php _e('Status de Conteúdo a Contabilizar', 'limiter-mkp-pro'); ?></h3>
                <div class="limiter-mkp-pro-admin-form-row">
                    <label><input type="checkbox" name="post_status_contaveis[]" value="publish" checked> <?php _e('Publicado', 'limiter-mkp-pro'); ?></label><br>
                    <label><input type="checkbox" name="post_status_contaveis[]" value="draft" checked> <?php _e('Rascunho', 'limiter-mkp-pro'); ?></label><br>
                    <label><input type="checkbox" name="post_status_contaveis[]" value="trash" checked> <?php _e('Lixeira', 'limiter-mkp-pro'); ?></label><br>
                    <label><input type="checkbox" name="post_status_contaveis[]" value="pending"> <?php _e('Pendente', 'limiter-mkp-pro'); ?></label><br>
                    <label><input type="checkbox" name="post_status_contaveis[]" value="future"> <?php _e('Agendado', 'limiter-mkp-pro'); ?></label><br>
                    <label><input type="checkbox" name="post_status_contaveis[]" value="private"> <?php _e('Privado', 'limiter-mkp-pro'); ?></label>
                </div>
            </div>

            <?php if ($woocommerce_active && $subscriptions_active): ?>
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-plano-woocommerce-products"><?php esc_html_e('Produtos WooCommerce Subscription', 'limiter-mkp-pro'); ?></label>
                <select id="limiter-mkp-pro-plano-woocommerce-products" name="woocommerce_product_ids[]" multiple="multiple" style="width: 100%; max-width: 500px; height: 150px;">
                    <option value=""><?php esc_html_e('Nenhum produto vinculado', 'limiter-mkp-pro'); ?></option>
                    <?php foreach ($subscription_products as $product): ?>
                        <option value="<?php echo esc_attr($product['id']); ?>">
                            <?php echo esc_html($product['name']); ?> 
                            (<?php echo wc_price($product['price']); ?> / 
                            <?php echo esc_html($product['interval'] . ' ' . $product['period']); ?>)
                        </option>
                    <?php endforeach; ?>
                </select>
                <p class="description">
                    <?php esc_html_e('Vincule este plano a um ou mais produtos de assinatura do WooCommerce.', 'limiter-mkp-pro'); ?>
                </p>
            </div>
            <?php endif; ?>
            
            <div class="limiter-mkp-pro-admin-form-actions">
                <button type="button" id="limiter-mkp-pro-plano-cancel" class="button" style="display: none;"><?php esc_html_e('Cancelar', 'limiter-mkp-pro'); ?></button>
                <button type="submit" id="limiter-mkp-pro-plano-submit" class="button button-primary"><?php esc_html_e('Salvar Plano', 'limiter-mkp-pro'); ?></button>
            </div>
        </form>
    </div>
    <div class="limiter-mkp-pro-admin-list-container">
        <h2><?php esc_html_e('Planos Disponíveis', 'limiter-mkp-pro'); ?></h2>
        <?php 
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $planos = Limiter_MKP_Pro_Database::get_planos();
        
        if (!empty($planos)) : ?>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th><?php esc_html_e('Nome', 'limiter-mkp-pro'); ?></th>
                        <th><?php esc_html_e('Duração', 'limiter-mkp-pro'); ?></th>
                        <th><?php esc_html_e('Limites (Pag/MB/File)', 'limiter-mkp-pro'); ?></th>
                        <th><?php esc_html_e('Backup', 'limiter-mkp-pro'); ?></th>
                        <th><?php esc_html_e('Ações', 'limiter-mkp-pro'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($planos as $plano) : 
                        $plano_products_linked = $planos_handler->get_plano_woocommerce_products($plano->id);
                        $plano_product_ids = array();
                        $plano_product_names = array();
                        foreach ($plano_products_linked as $product) {
                            $plano_product_ids[] = $product['id'];
                            $plano_product_names[] = $product['name'];
                        }
                        
                        $mb_display = isset($plano->limite_upload_mb) ? $plano->limite_upload_mb : 100;
                        
                        // Ícones de Backup
                        $backup_icon = 'dashicons-no';
                        $backup_color = '#ccc';
                        $backup_text = 'Nenhum';
                        
                        if ($plano->backup_frequency === 'daily') {
                            $backup_icon = 'dashicons-backup';
                            $backup_color = '#28a745';
                            $backup_text = 'Diário';
                        } elseif ($plano->backup_frequency === 'weekly') {
                            $backup_icon = 'dashicons-backup';
                            $backup_color = '#0073aa';
                            $backup_text = 'Semanal';
                        }
                    ?>
                        <tr>
                            <td><?php echo esc_html($plano->nome); ?></td>
                            <td><?php echo esc_html($plano->duracao); ?> dias</td>
                            <td>
                                <strong><?php echo esc_html($plano->limite_paginas); ?></strong> págs<br>
                                <strong><?php echo esc_html($mb_display); ?></strong> MB<br>
                                <strong><?php echo esc_html($plano->limite_inodes); ?></strong> arq.
                            </td>
                            <td>
                                <span class="dashicons <?php echo $backup_icon; ?>" style="color: <?php echo $backup_color; ?>;"></span> 
                                <?php echo esc_html($backup_text); ?>
                            </td>
                            <td>
                                <button type="button" class="button limiter-mkp-pro-edit-plano" 
                                    data-id="<?php echo esc_attr($plano->id); ?>" 
                                    data-nome="<?php echo esc_attr($plano->nome); ?>" 
                                    data-descricao="<?php echo esc_attr($plano->descricao); ?>" 
                                    data-duracao="<?php echo esc_attr($plano->duracao); ?>" 
                                    data-limite="<?php echo esc_attr($plano->limite_paginas); ?>"
                                    data-limite-inodes="<?php echo esc_attr($plano->limite_inodes); ?>"
                                    data-limite-upload="<?php echo esc_attr($mb_display); ?>"
                                    data-backup-freq="<?php echo esc_attr($plano->backup_frequency); ?>"
                                    data-backup-ret="<?php echo esc_attr($plano->backup_retention); ?>"
                                    data-produto-ids="<?php echo esc_attr(json_encode($plano_product_ids)); ?>"
                                    data-plano-types="<?php echo esc_attr($plano->post_types_contaveis); ?>"
                                    data-plano-status="<?php echo esc_attr($plano->post_status_contaveis); ?>">
                                    <?php esc_html_e('Editar', 'limiter-mkp-pro'); ?>
                                </button>
                                <button type="button" class="button limiter-mkp-pro-delete-plano" data-id="<?php echo esc_attr($plano->id); ?>">
                                    <?php esc_html_e('Excluir', 'limiter-mkp-pro'); ?>
                                </button>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else : ?>
            <p><?php esc_html_e('Nenhum plano encontrado.', 'limiter-mkp-pro'); ?></p>
        <?php endif; ?>
    </div>
</div>

<script>
jQuery(document).ready(function($) {
    // 2. Preencher Formulário ao Clicar em Editar (ATUALIZADO)
    $('.limiter-mkp-pro-edit-plano').on('click', function(e) {
        e.preventDefault();
        
        var id = $(this).data('id');
        var nome = $(this).data('nome');
        var descricao = $(this).data('descricao');
        var duracao = $(this).data('duracao');
        var limite = $(this).data('limite');
        var limiteInodes = $(this).data('limite-inodes');
        var limiteUpload = $(this).data('limite-upload');
        
        // NOVOS DADOS
        var backupFreq = $(this).data('backup-freq');
        var backupRet = $(this).data('backup-ret');
        
        var produtoIds = $(this).data('produto-ids'); 
        var planoTypes = $(this).data('plano-types');
        var planoStatus = $(this).data('plano-status');

        $('#limiter-mkp-pro-plano-id').val(id);
        $('#limiter-mkp-pro-plano-nome').val(nome);
        $('#limiter-mkp-pro-plano-descricao').val(descricao);
        $('#limiter-mkp-pro-plano-duracao').val(duracao);
        $('#limiter-mkp-pro-plano-limite').val(limite);
        $('#limiter-mkp-pro-plano-limite-inodes').val(limiteInodes);
        if ($('#limiter-mkp-pro-plano-limite-upload').length) {
            $('#limiter-mkp-pro-plano-limite-upload').val(limiteUpload);
        }
        
        // Preenche Backup
        $('#limiter-mkp-pro-plano-backup-freq').val(backupFreq || 'none');
        $('#limiter-mkp-pro-plano-backup-ret').val(backupRet || 3);

        // Preenche WooCommerce
        if (produtoIds) {
            if (typeof produtoIds === 'string') { try { produtoIds = JSON.parse(produtoIds); } catch(e) {} }
            $('#limiter-mkp-pro-plano-woocommerce-products').val(produtoIds);
        } else {
            $('#limiter-mkp-pro-plano-woocommerce-products').val([]);
        }

        // Preenche Checkboxes Types
        $('input[name="post_types_contaveis[]"]').prop('checked', false);
        if (planoTypes) {
            if (typeof planoTypes === 'string') { try { planoTypes = JSON.parse(planoTypes); } catch(e) {} }
            if (Array.isArray(planoTypes)) {
                planoTypes.forEach(function(type) {
                    $('input[name="post_types_contaveis[]"][value="' + type + '"]').prop('checked', true);
                });
            }
        }

        // Preenche Checkboxes Status
        $('input[name="post_status_contaveis[]"]').prop('checked', false);
        if (planoStatus) {
            if (typeof planoStatus === 'string') { try { planoStatus = JSON.parse(planoStatus); } catch(e) {} }
            if (Array.isArray(planoStatus)) {
                planoStatus.forEach(function(status) {
                    $('input[name="post_status_contaveis[]"][value="' + status + '"]').prop('checked', true);
                });
            }
        }

        // UI Updates
        $('#limiter-mkp-pro-form-title').text('Editar Plano: ' + nome);
        $('#limiter-mkp-pro-plano-submit').text('Atualizar Plano');
        $('#limiter-mkp-pro-plano-cancel').show();

        $('html, body').animate({
            scrollTop: $('.limiter-mkp-pro-admin-form-container').offset().top - 50
        }, 500);
    });

    // 3. Cancelar Edição (Reset)
    $('#limiter-mkp-pro-plano-cancel').on('click', function(e) {
        e.preventDefault();
        $('#limiter-mkp-pro-plano-form')[0].reset();
        $('#limiter-mkp-pro-plano-id').val(0);
        $('#limiter-mkp-pro-plano-woocommerce-products').val([]);
        
        // Reset Backup fields to default
        $('#limiter-mkp-pro-plano-backup-freq').val('none');
        $('#limiter-mkp-pro-plano-backup-ret').val(3);

        $('input[name="post_types_contaveis[]"]').prop('checked', false);
        $('input[name="post_types_contaveis[]"][value="post"]').prop('checked', true);
        $('input[name="post_types_contaveis[]"][value="page"]').prop('checked', true);

        $('input[name="post_status_contaveis[]"]').prop('checked', false);
        $('input[name="post_status_contaveis[]"][value="publish"]').prop('checked', true);
        $('input[name="post_status_contaveis[]"][value="draft"]').prop('checked', true);
        $('input[name="post_status_contaveis[]"][value="trash"]').prop('checked', true);

        $('#limiter-mkp-pro-form-title').text('Adicionar Novo Plano');
        $('#limiter-mkp-pro-plano-submit').text('Salvar Plano');
        $(this).hide();
    });
});
</script>



----------------------------------------------------------------------------------------

limiter-mkp-pro/admin/partials/subdominios.php e os codigos deste arquivo:
<?php
/**
 * Template para a página de subdomínios.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/admin/partials
 */
?>
<div class="wrap limiter-mkp-pro-admin-subdominios">
    <h1><?php _e('Limiter MKP Pro - Subdomínios', 'limiter-mkp-pro'); ?></h1>
    
    <div class="limiter-mkp-pro-admin-form-container">
        <h2 id="limiter-mkp-pro-form-title"><?php _e('Editar Subdomínio', 'limiter-mkp-pro'); ?></h2>
        <form id="limiter-mkp-pro-subdominio-form" class="limiter-mkp-pro-admin-form">
            <input type="hidden" id="limiter-mkp-pro-subdominio-blog-id" name="blog_id" value="0">
            <input type="hidden" id="limiter-mkp-pro-subdominio-dominio" name="dominio" value="">
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-plano"><?php _e('Plano', 'limiter-mkp-pro'); ?></label>
                <select id="limiter-mkp-pro-subdominio-plano" name="plano_id" required>
                    <option value=""><?php _e('Selecione um plano', 'limiter-mkp-pro'); ?></option>
                    <?php foreach ($planos as $plano) : ?>
                        <option value="<?php echo esc_attr($plano->id); ?>"><?php echo esc_html($plano->nome); ?> (<?php echo esc_html($plano->limite_paginas); ?> <?php _e('páginas', 'limiter-mkp-pro'); ?>)</option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-limite"><?php _e('Limite Personalizado de Páginas (opcional)', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-subdominio-limite" name="limite_personalizado" min="1">
                <p class="description"><?php _e('Se definido, substitui o limite de páginas do plano selecionado.', 'limiter-mkp-pro'); ?></p>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-limite-inodes"><?php _e('Limite Personalizado de Arquivos (opcional)', 'limiter-mkp-pro'); ?></label>
                <input type="number" id="limiter-mkp-pro-subdominio-limite-inodes" name="limite_personalizado_inodes" min="1">
                <p class="description"><?php _e('Se definido, substitui o limite de arquivos do plano selecionado.', 'limiter-mkp-pro'); ?></p>
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-nome-cliente"><?php _e('Nome do Cliente', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-nome-cliente" name="nome_cliente">
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-email-cliente"><?php _e('E-mail do Cliente', 'limiter-mkp-pro'); ?></label>
                <input type="email" id="limiter-mkp-pro-subdominio-email-cliente" name="email_cliente">
            </div>
            
            <div class="limiter-mkp-pro-admin-form-row">
                <label for="limiter-mkp-pro-subdominio-telefone-cliente"><?php _e('Telefone do Cliente', 'limiter-mkp-pro'); ?></label>
                <input type="text" id="limiter-mkp-pro-subdominio-telefone-cliente" name="telefone_cliente">
            </div>
            
            <div class="limiter-mkp-pro-admin-form-actions">
                <button type="button" id="limiter-mkp-pro-subdominio-cancel" class="button"><?php _e('Cancelar', 'limiter-mkp-pro'); ?></button>
                <button type="submit" id="limiter-mkp-pro-subdominio-submit" class="button button-primary"><?php _e('Salvar Subdomínio', 'limiter-mkp-pro'); ?></button>
            </div>
        </form>
    </div>
    
    <div class="limiter-mkp-pro-admin-list-container">
        <h2><?php _e('Subdomínios Gerenciados', 'limiter-mkp-pro'); ?></h2>
        <?php if (!empty($subdominios)) : ?>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th><?php _e('Subdomínio', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Cliente', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Plano', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Limite Páginas', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Limite Arquivos', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Páginas/Arquivos Utilizados', 'limiter-mkp-pro'); ?></th>
                        <th><?php _e('Ações', 'limiter-mkp-pro'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($subdominios as $subdominio) : 
                        // Obtém informações do site
                        $site_info = get_blog_details($subdominio->blog_id);
                        
                        // Obtém o plano
                        $plano = Limiter_MKP_Pro_Database::get_plano($subdominio->plano_id);
                        
                        // Conta conteúdo usando o método OTIMIZADO (cache no banco)
                        $total_pages = Limiter_MKP_Pro_Database::count_limited_content($subdominio->blog_id);
                        
                        // OTIMIZAÇÃO DE INODES:
                        // Em vez de wp_upload_dir (errado) ou switch_to_blog (lento),
                        // lemos a opção salva diretamente da tabela wp_x_options deste blog.
                        $count_files = (int) get_blog_option($subdominio->blog_id, 'limiter_mkp_pro_inode_count', 0);
                        
                        // Define os limites
                        $limite_paginas = $subdominio->limite_personalizado ? $subdominio->limite_personalizado : ($plano ? $plano->limite_paginas : 0);
                        $limite_inodes = $subdominio->limite_personalizado_inodes ? $subdominio->limite_personalizado_inodes : ($plano ? $plano->limite_inodes : 0);
                        
                        // Calcula percentuais
                        $percentual_paginas = $limite_paginas > 0 ? min(100, round(($total_pages / $limite_paginas) * 100)) : 0;
                        $percentual_inodes = $limite_inodes > 0 ? min(100, round(($count_files / $limite_inodes) * 100)) : 0;
                    ?>
                        <tr>
                            <td>
                                <?php if ($site_info) : ?>
                                    <strong><?php echo esc_html($site_info->blogname); ?></strong><br>
                                    <a href="<?php echo esc_url($site_info->siteurl); ?>" target="_blank"><?php echo esc_html($site_info->domain . $site_info->path); ?></a>
                                <?php else : ?>
                                    <strong><?php _e('Site Deletado', 'limiter-mkp-pro'); ?></strong><br>
                                    <span class="description">ID: <?php echo esc_html($subdominio->blog_id); ?></span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if (!empty($subdominio->nome_cliente)) : ?>
                                    <?php echo esc_html($subdominio->nome_cliente); ?><br>
                                    <?php if (!empty($subdominio->email_cliente)) : ?>
                                        <a href="mailto:<?php echo esc_attr($subdominio->email_cliente); ?>"><?php echo esc_html($subdominio->email_cliente); ?></a><br>
                                    <?php endif; ?>
                                    <?php if (!empty($subdominio->telefone_cliente)) : ?>
                                        <?php echo esc_html($subdominio->telefone_cliente); ?>
                                    <?php endif; ?>
                                <?php else : ?>
                                    <em><?php _e('Não informado', 'limiter-mkp-pro'); ?></em>
                                <?php endif; ?>
                            </td>
                            <td><?php echo esc_html($plano ? $plano->nome : 'Plano Removido'); ?></td>
                            <td>
                                <?php echo esc_html($limite_paginas); ?>
                                <?php if ($subdominio->limite_personalizado) : ?>
                                    <br><small><?php _e('(Personalizado)', 'limiter-mkp-pro'); ?></small>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php echo esc_html($limite_inodes); ?>
                                <?php if ($subdominio->limite_personalizado_inodes) : ?>
                                    <br><small><?php _e('(Personalizado)', 'limiter-mkp-pro'); ?></small>
                                <?php endif; ?>
                            </td>
                            <td>
                                <div style="margin-bottom: 8px;">
                                    <strong><?php _e('Páginas', 'limiter-mkp-pro'); ?>:</strong> <?php echo esc_html($total_pages); ?> / <?php echo esc_html($limite_paginas); ?>
                                    <div class="limiter-mkp-pro-admin-progress-bar">
                                        <?php 
                                        $class_paginas = $percentual_paginas >= 90 ? 'limiter-mkp-pro-admin-progress-warning' : '';
                                        ?>
                                        <div class="limiter-mkp-pro-admin-progress <?php echo esc_attr($class_paginas); ?>" style="width: <?php echo esc_attr($percentual_paginas); ?>%;">
                                            <?php echo esc_html($percentual_paginas); ?>%
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <strong><?php _e('Arquivos', 'limiter-mkp-pro'); ?>:</strong> <?php echo esc_html($count_files); ?> / <?php echo esc_html($limite_inodes); ?>
                                    <div class="limiter-mkp-pro-admin-progress-bar">
                                        <?php 
                                        $class_inodes = $percentual_inodes >= 90 ? 'limiter-mkp-pro-admin-progress-warning' : '';
                                        ?>
                                        <div class="limiter-mkp-pro-admin-progress <?php echo esc_attr($class_inodes); ?>" style="width: <?php echo esc_attr($percentual_inodes); ?>%;">
                                            <?php echo esc_html($percentual_inodes); ?>%
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="button limiter-mkp-pro-edit-subdominio" 
                                    data-blog-id="<?php echo esc_attr($subdominio->blog_id); ?>"
                                    data-dominio="<?php echo esc_attr(($site_info) ? $site_info->domain . $site_info->path : 'Site Deletado'); ?>"
                                    data-plano-id="<?php echo esc_attr($subdominio->plano_id); ?>"
                                    data-limite="<?php echo esc_attr($subdominio->limite_personalizado); ?>"
                                    data-limite-inodes="<?php echo esc_attr($subdominio->limite_personalizado_inodes); ?>"
                                    data-nome="<?php echo esc_attr($subdominio->nome_cliente); ?>"
                                    data-email="<?php echo esc_attr($subdominio->email_cliente); ?>"
                                    data-telefone="<?php echo esc_attr($subdominio->telefone_cliente); ?>">
                                    <?php _e('Editar', 'limiter-mkp-pro'); ?>
                                </button>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else : ?>
            <p><?php _e('Nenhum subdomínio encontrado.', 'limiter-mkp-pro'); ?></p>
        <?php endif; ?>
    </div>
</div>

<script>
jQuery(document).ready(function($) {
    // Esconde o formulário inicialmente
    $('.limiter-mkp-pro-admin-form-container').hide();
    
    // Editar subdomínio
    $('.limiter-mkp-pro-edit-subdominio').on('click', function() {
        var blog_id = $(this).data('blog-id');
        var dominio = $(this).data('dominio');
        var plano_id = $(this).data('plano-id');
        var limite = $(this).data('limite');
        var limite_inodes = $(this).data('limite-inodes');
        var nome = $(this).data('nome');
        var email = $(this).data('email');
        var telefone = $(this).data('telefone');
        
        $('#limiter-mkp-pro-subdominio-blog-id').val(blog_id);
        $('#limiter-mkp-pro-subdominio-dominio').val(dominio);
        $('#limiter-mkp-pro-subdominio-plano').val(plano_id);
        $('#limiter-mkp-pro-subdominio-limite').val(limite);
        $('#limiter-mkp-pro-subdominio-limite-inodes').val(limite_inodes);
        $('#limiter-mkp-pro-subdominio-nome-cliente').val(nome);
        $('#limiter-mkp-pro-subdominio-email-cliente').val(email);
        $('#limiter-mkp-pro-subdominio-telefone-cliente').val(telefone);
        
        $('.limiter-mkp-pro-admin-form-container').show();
        
        $('html, body').animate({
            scrollTop: $('.limiter-mkp-pro-admin-form-container').offset().top - 50
        }, 500);
    });
    
    // Cancelar edição
    $('#limiter-mkp-pro-subdominio-cancel').on('click', function() {
        $('.limiter-mkp-pro-admin-form-container').hide();
        $('#limiter-mkp-pro-subdominio-form')[0].reset();
    });
    
    // Salvar subdomínio
    $('#limiter-mkp-pro-subdominio-form').on('submit', function(e) {
        e.preventDefault();
        
        var formData = {
            'action': 'limiter_mkp_pro_save_subdominio',
            'nonce': limiter_mkp_pro_admin.nonce,
            'blog_id': $('#limiter-mkp-pro-subdominio-blog-id').val(),
            'dominio': $('#limiter-mkp-pro-subdominio-dominio').val(),
            'plano_id': $('#limiter-mkp-pro-subdominio-plano').val(),
            'limite_personalizado': $('#limiter-mkp-pro-subdominio-limite').val(),
            'limite_personalizado_inodes': $('#limiter-mkp-pro-subdominio-limite-inodes').val(),
            'nome_cliente': $('#limiter-mkp-pro-subdominio-nome-cliente').val(),
            'email_cliente': $('#limiter-mkp-pro-subdominio-email-cliente').val(),
            'telefone_cliente': $('#limiter-mkp-pro-subdominio-telefone-cliente').val()
        };
        
        $.ajax({
            url: limiter_mkp_pro_admin.ajax_url,
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.data.message);
                    location.reload();
                } else {
                    alert(response.data.message);
                }
            },
            error: function() {
                alert(limiter_mkp_pro_admin.messages.error);
            }
        });
    });
});
</script>


----------------------------------------------------------------------------------------

limiter-mkp-pro/assets/css/lifecycle.css e os codigos deste arquivo:
/**
 * Estilos para o sistema de ciclo de vida do Limiter MKP Pro
 * 
 * @version 2.0.0
 */

/* ==========================================================================
   Configurações Gerais
   ========================================================================== */

.limiter-lifecycle-settings,
.limiter-churn-dashboard {
    padding: 20px;
    background: #f8f9fa;
    min-height: calc(100vh - 60px);
}

.limiter-settings-section,
.limiter-dashboard-section {
    background: #fff;
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.limiter-settings-section h2,
.limiter-dashboard-section h2 {
    color: #4e73df;
    border-bottom: 2px solid #4e73df;
    padding-bottom: 10px;
    margin-top: 0;
    margin-bottom: 25px;
    font-size: 22px;
}

.limiter-settings-section h3,
.limiter-dashboard-section h3 {
    color: #5a5c69;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 18px;
}

/* ==========================================================================
   Formulários
   ========================================================================== */

.limiter-form-table {
    width: 100%;
    border-collapse: collapse;
}

.limiter-form-table th {
    width: 250px;
    text-align: left;
    padding: 12px 15px;
    font-weight: 600;
    color: #5a5c69;
    vertical-align: top;
    border-bottom: 1px solid #e3e6f0;
}

.limiter-form-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e3e6f0;
}

.limiter-form-table tr:last-child th,
.limiter-form-table tr:last-child td {
    border-bottom: none;
}

.limiter-form-table input[type="text"],
.limiter-form-table input[type="email"],
.limiter-form-table input[type="number"],
.limiter-form-table input[type="url"],
.limiter-form-table select {
    width: 100%;
    max-width: 400px;
    padding: 8px 12px;
    border: 1px solid #d1d3e2;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.15s ease-in-out;
}

.limiter-form-table input[type="text"]:focus,
.limiter-form-table input[type="email"]:focus,
.limiter-form-table input[type="number"]:focus,
.limiter-form-table input[type="url"]:focus,
.limiter-form-table select:focus {
    border-color: #4e73df;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.limiter-form-table textarea {
    width: 100%;
    min-height: 120px;
    padding: 10px 12px;
    border: 1px solid #d1d3e2;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
}

.limiter-form-table textarea.code {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
}

.limiter-form-table .description {
    color: #858796;
    font-size: 13px;
    margin-top: 5px;
    line-height: 1.4;
}

/* ==========================================================================
   Cartões de Estatísticas
   ========================================================================== */

.limiter-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.limiter-stat-card {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    border-left: 4px solid #4e73df;
    transition: transform 0.3s ease;
}

.limiter-stat-card:hover {
    transform: translateY(-2px);
}

.limiter-stat-card.warning {
    border-left-color: #f6c23e;
}

.limiter-stat-card.danger {
    border-left-color: #e74a3b;
}

.limiter-stat-card.success {
    border-left-color: #1cc88a;
}

.limiter-stat-card .stat-title {
    color: #5a5c69;
    font-size: 14px;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.limiter-stat-card .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #4e73df;
    margin: 10px 0;
}

.limiter-stat-card.warning .stat-value {
    color: #f6c23e;
}

.limiter-stat-card.danger .stat-value {
    color: #e74a3b;
}

.limiter-stat-card.success .stat-value {
    color: #1cc88a;
}

.limiter-stat-card .stat-change {
    font-size: 12px;
    color: #858796;
    display: flex;
    align-items: center;
    gap: 5px;
}

.limiter-stat-card .stat-change.positive {
    color: #1cc88a;
}

.limiter-stat-card .stat-change.negative {
    color: #e74a3b;
}

/* ==========================================================================
   Tabelas
   ========================================================================== */

.limiter-table-container {
    overflow-x: auto;
    margin: 20px 0;
}

.limiter-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.limiter-table thead {
    background: #f8f9fa;
}

.limiter-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #5a5c69;
    border-bottom: 2px solid #e3e6f0;
    white-space: nowrap;
}

.limiter-table td {
    padding: 15px;
    border-bottom: 1px solid #e3e6f0;
    vertical-align: middle;
}

.limiter-table tbody tr:hover {
    background: #f8f9fa;
}

.limiter-table .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.limiter-table .status-active {
    background: #d4edda;
    color: #155724;
}

.limiter-table .status-grace_period {
    background: #fff3cd;
    color: #856404;
}

.limiter-table .status-suspended {
    background: #f8d7da;
    color: #721c24;
}

.limiter-table .status-locked {
    background: #dc3545;
    color: white;
}

.limiter-table .status-scheduled_deletion {
    background: #6c757d;
    color: white;
}

.limiter-table .priority-high {
    color: #e74a3b;
    font-weight: 600;
}

.limiter-table .priority-medium {
    color: #f6c23e;
    font-weight: 600;
}

.limiter-table .priority-low {
    color: #1cc88a;
    font-weight: 600;
}

/* ==========================================================================
   Botões e Ações
   ========================================================================== */

.limiter-actions-bar {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #e3e6f0;
    flex-wrap: wrap;
}

.limiter-action-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
}

.limiter-action-btn-primary {
    background: #4e73df;
    color: white;
}

.limiter-action-btn-primary:hover {
    background: #2e59d9;
    transform: translateY(-1px);
}

.limiter-action-btn-secondary {
    background: #6c757d;
    color: white;
}

.limiter-action-btn-secondary:hover {
    background: #5a6268;
}

.limiter-action-btn-success {
    background: #1cc88a;
    color: white;
}

.limiter-action-btn-success:hover {
    background: #17a673;
}

.limiter-action-btn-warning {
    background: #f6c23e;
    color: #212529;
}

.limiter-action-btn-warning:hover {
    background: #f4b619;
}

.limiter-action-btn-danger {
    background: #e74a3b;
    color: white;
}

.limiter-action-btn-danger:hover {
    background: #e02d1b;
}

.limiter-action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.limiter-table-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.limiter-table-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.limiter-table-action-btn-email {
    background: #4e73df;
    color: white;
}

.limiter-table-action-btn-extend {
    background: #f6c23e;
    color: #212529;
}

.limiter-table-action-btn-restore {
    background: #1cc88a;
    color: white;
}

.limiter-table-action-btn-suspend {
    background: #858796;
    color: white;
}

.limiter-table-action-btn-delete {
    background: #e74a3b;
    color: white;
}

/* ==========================================================================
   Checkboxes e Seleção
   ========================================================================== */

.limiter-checkbox-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 10px 0;
}

.limiter-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.limiter-select-all {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ==========================================================================
   Progress Bars
   ========================================================================== */

.limiter-progress-bar {
    height: 20px;
    background: #eaecf4;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
    position: relative;
}

.limiter-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4e73df 0%, #2e59d9 100%);
    border-radius: 10px;
    transition: width 0.5s ease;
    position: relative;
}

.limiter-progress-fill.warning {
    background: linear-gradient(90deg, #f6c23e 0%, #f4b619 100%);
}

.limiter-progress-fill.danger {
    background: linear-gradient(90deg, #e74a3b 0%, #e02d1b 100%);
}

.limiter-progress-fill.success {
    background: linear-gradient(90deg, #1cc88a 0%, #17a673 100%);
}

.limiter-progress-text {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: white;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
}

/* ==========================================================================
   Tabs e Navegação
   ========================================================================== */

.limiter-tabs {
    display: flex;
    border-bottom: 2px solid #e3e6f0;
    margin-bottom: 25px;
}

.limiter-tab {
    padding: 12px 25px;
    background: none;
    border: none;
    font-size: 15px;
    font-weight: 600;
    color: #5a5c69;
    cursor: pointer;
    position: relative;
    transition: color 0.2s ease;
}

.limiter-tab:hover {
    color: #4e73df;
}

.limiter-tab.active {
    color: #4e73df;
}

.limiter-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #4e73df;
}

.limiter-tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.limiter-tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ==========================================================================
   Modais
   ========================================================================== */

.limiter-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.limiter-modal-content {
    background: white;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateY(-30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.limiter-modal-header {
    padding: 20px;
    border-bottom: 1px solid #e3e6f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.limiter-modal-title {
    font-size: 20px;
    font-weight: 600;
    color: #5a5c69;
    margin: 0;
}

.limiter-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #858796;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s ease;
}

.limiter-modal-close:hover {
    background: #f8f9fa;
}

.limiter-modal-body {
    padding: 20px;
}

.limiter-modal-footer {
    padding: 20px;
    border-top: 1px solid #e3e6f0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* ==========================================================================
   Notificações e Alertas
   ========================================================================== */

.limiter-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideInRight 0.3s ease;
    max-width: 400px;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.limiter-notification-success {
    background: #1cc88a;
    border-left: 4px solid #17a673;
}

.limiter-notification-error {
    background: #e74a3b;
    border-left: 4px solid #e02d1b;
}

.limiter-notification-warning {
    background: #f6c23e;
    border-left: 4px solid #f4b619;
    color: #212529;
}

.limiter-notification-info {
    background: #4e73df;
    border-left: 4px solid #2e59d9;
}

/* ==========================================================================
   Loaders e Estados de Carregamento
   ========================================================================== */

.limiter-loader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9998;
}

.limiter-loader .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4e73df;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.limiter-loading {
    opacity: 0.6;
    pointer-events: none;
    position: relative;
}

.limiter-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: #4e73df;
}

/* ==========================================================================
   Tooltips
   ========================================================================== */

.limiter-tooltip {
    position: absolute;
    background: #212529;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1000;
    max-width: 250px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: fadeIn 0.2s ease;
    pointer-events: none;
}

.limiter-tooltip::before {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px 5px 0;
    border-style: solid;
    border-color: #212529 transparent transparent;
}

/* ==========================================================================
   Filtros e Busca
   ========================================================================== */

.limiter-filters {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e3e6f0;
    margin-bottom: 20px;
}

.limiter-filter-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-end;
}

.limiter-filter-group {
    flex: 1;
    min-width: 200px;
}

.limiter-filter-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #5a5c69;
    font-size: 14px;
}

.limiter-search-box {
    position: relative;
}

.limiter-search-box input {
    padding-left: 40px;
}

.limiter-search-box::before {
    content: '🔍';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #858796;
}

/* ==========================================================================
   Responsividade
   ========================================================================== */

@media (max-width: 768px) {
    .limiter-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .limiter-form-table {
        display: block;
    }
    
    .limiter-form-table thead {
        display: none;
    }
    
    .limiter-form-table tbody,
    .limiter-form-table tr,
    .limiter-form-table td {
        display: block;
        width: 100%;
    }
    
    .limiter-form-table tr {
        margin-bottom: 15px;
        border: 1px solid #e3e6f0;
        border-radius: 6px;
        overflow: hidden;
    }
    
    .limiter-form-table td {
        padding: 10px 15px;
        border: none;
        border-top: 1px solid #e3e6f0;
    }
    
    .limiter-form-table td:first-child {
        border-top: none;
        background: #f8f9fa;
        font-weight: 600;
        color: #5a5c69;
    }
    
    .limiter-actions-bar {
        flex-direction: column;
    }
    
    .limiter-action-btn {
        width: 100%;
        justify-content: center;
    }
    
    .limiter-table-actions {
        flex-direction: column;
    }
    
    .limiter-modal-content {
        width: 95%;
        margin: 10px;
    }
}

@media (max-width: 480px) {
    .limiter-settings-section,
    .limiter-dashboard-section {
        padding: 15px;
    }
    
    .limiter-tabs {
        flex-wrap: wrap;
    }
    
    .limiter-tab {
        flex: 1;
        min-width: 120px;
        text-align: center;
        padding: 10px;
    }
}

/* ==========================================================================
   Utilitários
   ========================================================================== */

.limiter-text-muted {
    color: #858796;
}

.limiter-text-success {
    color: #1cc88a;
}

.limiter-text-warning {
    color: #f6c23e;
}

.limiter-text-danger {
    color: #e74a3b;
}

.limiter-text-info {
    color: #4e73df;
}

.limiter-badge {
    display: inline-block;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 4px;
}

.limiter-badge-success {
    background: #d4edda;
    color: #155724;
}

.limiter-badge-warning {
    background: #fff3cd;
    color: #856404;
}

.limiter-badge-danger {
    background: #f8d7da;
    color: #721c24;
}

.limiter-badge-info {
    background: #d1ecf1;
    color: #0c5460;
}

.limiter-divider {
    height: 1px;
    background: #e3e6f0;
    margin: 25px 0;
    border: none;
}

.limiter-help-text {
    font-size: 13px;
    color: #858796;
    margin-top: 5px;
    line-height: 1.4;
}

.limiter-required::after {
    content: '*';
    color: #e74a3b;
    margin-left: 4px;
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/assets/js/lifecycle.js e os codigos deste arquivo:
/**
 * JavaScript para o ciclo de vida do Limiter MKP Pro
 * * @version 2.0.0
 */

(function($) {
    'use strict';
    
    /**
     * Inicializa o sistema de ciclo de vida
     */
    function initLifecycle() {
        console.log('Limiter MKP Pro Lifecycle JS inicializado');
        
        // Configura os event listeners
        setupEventListeners();
        
        // Inicializa componentes
        initComponents();
        
        // Carrega dados iniciais se necessário
        loadInitialData();
    }
    
    /**
     * Configura os event listeners
     */
    function setupEventListeners() {
        // Formulário de configurações do ciclo de vida
        if ($('#limiter-lifecycle-settings-form').length) {
            $('#limiter-lifecycle-settings-form').on('submit', handleSaveSettings);
        }
        
        // Botão de verificação manual
        $('.run-manual-check').on('click', handleManualCheck);
        
        // Botões de ação rápida no dashboard
        $('.quick-action-btn').on('click', handleQuickAction);
        
        // Botões de email individual
        $(document).on('click', '.send-email-btn', handleSendEmail);
        
        // Botões de extensão de carência
        $(document).on('click', '.extend-grace-btn', handleExtendGrace);
        
        // Botões de restauração
        $(document).on('click', '.restore-blog-btn', handleRestoreBlog);
        
        // Botões de suspensão manual
        $(document).on('click', '.suspend-blog-btn', handleSuspendBlog);
        
        // Botões de agendamento de exclusão
        $(document).on('click', '.schedule-deletion-btn', handleScheduleDeletion);
        
        // Botões de cancelar exclusão
        $(document).on('click', '.cancel-deletion-btn', handleCancelDeletion);
        
        // Exportação de relatórios
        $('.export-report-btn').on('click', handleExportReport);
        
        // Envio de lembretes em massa
        $('.send-bulk-reminders-btn').on('click', handleBulkReminders);
        
        // Atualização de estatísticas em tempo real
        $('.refresh-stats-btn').on('click', refreshStats);
        
        // Tooltips
        $(document).on('mouseenter', '[data-toggle="tooltip"]', showTooltip);
    }
    
    /**
     * Inicializa componentes
     */
    function initComponents() {
        // Datepickers
        if ($.fn.datepicker) {
            $('.datepicker').datepicker({
                dateFormat: 'yy-mm-dd',
                minDate: 0
            });
        }
        
        // Select2 para seleções múltiplas
        if ($.fn.select2) {
            $('.select2-multiple').select2({
                width: '100%',
                placeholder: 'Selecione...'
            });
        }
        
        // Tabs
        $('.lifecycle-tabs a').on('click', function(e) {
            e.preventDefault();
            var tab = $(this).attr('href');
            $('.lifecycle-tabs a').removeClass('active');
            $(this).addClass('active');
            $('.tab-content').hide();
            $(tab).show();
        });
        
        // Modais
        initModals();
    }
    
    /**
     * Inicializa modais
     */
    function initModals() {
        // Modal de email customizado
        $(document).on('click', '.custom-email-modal-btn', function() {
            var blogId = $(this).data('blog-id');
            var blogName = $(this).data('blog-name');
            var customerEmail = $(this).data('customer-email');
            
            $('#custom-email-blog-id').val(blogId);
            $('#custom-email-blog-name').text(blogName);
            $('#custom-email-recipient').text(customerEmail);
            
            $('#custom-email-modal').show();
        });
        
        // Fechar modais
        $('.modal-close, .modal-cancel').on('click', function() {
            $(this).closest('.modal').hide();
        });
        
        // Fechar ao clicar fora
        $(window).on('click', function(e) {
            if ($(e.target).hasClass('modal')) {
                $('.modal').hide();
            }
        });
    }
    
    /**
     * Carrega dados iniciais
     */
    function loadInitialData() {
        // Se estiver na página do dashboard, carrega estatísticas
        if ($('.churn-dashboard').length) {
            refreshStats();
            
            // Atualiza estatísticas a cada 30 segundos
            setInterval(refreshStats, 30000);
        }
    }
    
    /**
     * Handler para salvar configurações
     */
    function handleSaveSettings(e) {
        e.preventDefault();
        
        var formData = $(this).serialize();
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: formData + '&action=limiter_save_lifecycle_settings',
            beforeSend: function() {
                $('#save-settings-btn').prop('disabled', true).text('Salvando...');
                showLoader();
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro ao salvar configurações:', error);
                showNotification('error', 'Erro ao salvar configurações. Verifique o console para detalhes.');
            },
            complete: function() {
                $('#save-settings-btn').prop('disabled', false).text('Salvar Configurações');
                hideLoader();
            }
        });
    }
    
    /**
     * Handler para verificação manual
     */
    function handleManualCheck() {
        if (!confirm(limiter_lifecycle.i18n.confirm_action)) {
            return;
        }
        
        var $button = $(this);
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_run_manual_check',
                nonce: limiter_lifecycle.nonce
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Verificando...');
                showLoader();
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                    // Recarrega após 2 segundos
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', limiter_lifecycle.i18n.error);
            },
            complete: function() {
                $button.prop('disabled', false).text('Executar Verificação Manual');
                hideLoader();
            }
        });
    }
    
    /**
     * Handler para ações rápidas
     */
    function handleQuickAction() {
        var action = $(this).data('action');
        
        switch(action) {
            case 'send_test_email':
                sendTestEmail();
                break;
            case 'clear_cache':
                clearCache();
                break;
            case 'export_logs':
                exportLogs();
                break;
        }
    }
    
    /**
     * Handler para enviar email individual
     */
    function handleSendEmail() {
        var $button = $(this);
        var blogId = $button.data('blog-id');
        var template = $button.data('template');
        
        if (!blogId || !template) {
            showNotification('error', 'Dados insuficientes para enviar email.');
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_send_custom_email',
                nonce: limiter_lifecycle.nonce,
                blog_id: blogId,
                template: template
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Enviando...');
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao enviar email.');
            },
            complete: function() {
                setTimeout(function() {
                    $button.prop('disabled', false).text('Enviar Email');
                }, 2000);
            }
        });
    }
    
    /**
     * Handler para extensão de carência
     */
    function handleExtendGrace() {
        var $button = $(this);
        var blogId = $button.data('blog-id');
        var blogName = $button.data('blog-name');
        
        var days = prompt('Quantos dias deseja estender a carência para "' + blogName + '"?', '7');
        
        if (!days || isNaN(days) || parseInt(days) <= 0) {
            return;
        }
        
        var reason = prompt('Qual o motivo da extensão?', 'Extensão manual pelo administrador');
        
        if (!reason) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_extend_grace_period',
                nonce: limiter_lifecycle.nonce,
                blog_id: blogId,
                days: days,
                reason: reason
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Processando...');
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                    // Atualiza a linha na tabela
                    updateBlogRow(blogId, {
                        grace_ends: response.data.formatted_date,
                        status: 'grace_period'
                    });
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao estender carência.');
            },
            complete: function() {
                setTimeout(function() {
                    $button.prop('disabled', false).text('Estender Carência');
                }, 2000);
            }
        });
    }
    
    /**
     * Handler para restauração de blog
     */
    function handleRestoreBlog() {
        var $button = $(this);
        var blogId = $button.data('blog-id');
        var blogName = $button.data('blog-name');
        
        if (!confirm('Tem certeza que deseja restaurar o blog "' + blogName + '"?')) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_restore_blog',
                nonce: limiter_lifecycle.nonce,
                blog_id: blogId
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Restaurando...');
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                    // Remove a linha da tabela ou atualiza status
                    updateBlogRow(blogId, { status: 'active' });
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao restaurar blog.');
            },
            complete: function() {
                setTimeout(function() {
                    $button.prop('disabled', false).text('Restaurar');
                }, 2000);
            }
        });
    }
    
    /**
     * Handler para suspensão manual
     */
    function handleSuspendBlog() {
        var $button = $(this);
        var blogId = $button.data('blog-id');
        var blogName = $button.data('blog-name');
        
        var reason = prompt('Qual o motivo da suspensão manual para "' + blogName + '"?', 'Suspensão manual pelo administrador');
        
        if (!reason) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_suspend_blog',
                nonce: limiter_lifecycle.nonce,
                blog_id: blogId,
                reason: reason
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Suspendo...');
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                    // Atualiza a linha na tabela
                    updateBlogRow(blogId, { status: 'suspended' });
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao suspender blog.');
            },
            complete: function() {
                setTimeout(function() {
                    $button.prop('disabled', false).text('Suspender');
                }, 2000);
            }
        });
    }
    
    /**
     * Handler para agendamento de exclusão
     */
    function handleScheduleDeletion() {
        var $button = $(this);
        var blogId = $button.data('blog-id');
        var blogName = $button.data('blog-name');
        
        var deletionDate = prompt('Data para exclusão (YYYY-MM-DD) para "' + blogName + '"?\nDeixe em branco para 7 dias a partir de hoje.', getDateInFuture(7));
        
        if (deletionDate === null) {
            return;
        }
        
        // Valida a data
        if (deletionDate && !isValidDate(deletionDate)) {
            showNotification('error', 'Data inválida. Use o formato YYYY-MM-DD.');
            return;
        }
        
        var reason = prompt('Qual o motivo do agendamento de exclusão?', 'Exclusão manual pelo administrador');
        
        if (!reason) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_schedule_deletion',
                nonce: limiter_lifecycle.nonce,
                blog_id: blogId,
                deletion_date: deletionDate,
                reason: reason
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Agendando...');
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                    // Atualiza a linha na tabela
                    updateBlogRow(blogId, {
                        status: 'scheduled_deletion',
                        deletion_date: response.data.deletion_date
                    });
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao agendar exclusão.');
            },
            complete: function() {
                setTimeout(function() {
                    $button.prop('disabled', false).text('Agendar Exclusão');
                }, 2000);
            }
        });
    }
    
    /**
     * Handler para cancelar exclusão
     */
    function handleCancelDeletion() {
        var $button = $(this);
        var blogId = $button.data('blog-id');
        var blogName = $button.data('blog-name');
        
        if (!confirm('Cancelar exclusão agendada para "' + blogName + '"?')) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_cancel_deletion',
                nonce: limiter_lifecycle.nonce,
                blog_id: blogId
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Cancelando...');
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                    // Atualiza a linha na tabela
                    updateBlogRow(blogId, { status: 'active' });
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao cancelar exclusão.');
            },
            complete: function() {
                setTimeout(function() {
                    $button.prop('disabled', false).text('Cancelar Exclusão');
                }, 2000);
            }
        });
    }
    
    /**
     * Handler para exportação de relatórios
     */
    function handleExportReport() {
        var type = $(this).data('type') || 'csv';
        var url = limiter_lifecycle.ajax_url + '?action=limiter_export_churn_report&type=' + type + '&nonce=' + limiter_lifecycle.nonce;
        
        window.open(url, '_blank');
    }
    
    /**
     * Handler para lembretes em massa
     */
    function handleBulkReminders() {
        var $button = $(this);
        var blogIds = [];
        
        // Coleta IDs dos blogs selecionados
        $('.blog-checkbox:checked').each(function() {
            blogIds.push($(this).val());
        });
        
        if (blogIds.length === 0) {
            showNotification('warning', 'Selecione pelo menos um blog.');
            return;
        }
        
        if (!confirm('Enviar lembretes para ' + blogIds.length + ' blog(s) selecionado(s)?')) {
            return;
        }
        
        var template = prompt('Qual template de email deseja usar?', 'payment_failed_day1');
        
        if (!template) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_send_bulk_reminders',
                nonce: limiter_lifecycle.nonce,
                blog_ids: blogIds,
                template: template
            },
            beforeSend: function() {
                $button.prop('disabled', true).text('Enviando...');
                showLoader();
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', response.data.message);
                } else {
                    showNotification('error', response.data.message);
                }
            },
            error: function() {
                showNotification('error', 'Erro ao enviar lembretes.');
            },
            complete: function() {
                $button.prop('disabled', false).text('Enviar Lembretes em Massa');
                hideLoader();
            }
        });
    }
    
    /**
     * Atualiza estatísticas em tempo real
     */
    function refreshStats() {
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_get_realtime_stats',
                nonce: limiter_lifecycle.nonce
            },
            success: function(response) {
                if (response.success) {
                    updateStatsDisplay(response.data.stats);
                }
            }
        });
    }
    
    /**
     * Atualiza a exibição de estatísticas
     */
    function updateStatsDisplay(stats) {
        // Atualiza cada elemento de estatística
        $.each(stats, function(key, value) {
            var $element = $('.stat-' + key);
            if ($element.length) {
                // Anima a mudança de valor
                var current = $element.text().replace(/[^0-9.]/g, '');
                if (current !== value.toString()) {
                    $element.fadeOut(200, function() {
                        $(this).text(typeof value === 'number' ? value.toLocaleString() : value);
                        $(this).fadeIn(200);
                    });
                }
            }
        });
        
        // Atualiza timestamp
        $('.stats-timestamp').text('Atualizado: ' + new Date().toLocaleTimeString());
    }
    
    /**
     * Atualiza uma linha na tabela de blogs
     */
    function updateBlogRow(blogId, updates) {
        var $row = $('tr[data-blog-id="' + blogId + '"]');
        
        $.each(updates, function(key, value) {
            var $cell = $row.find('.cell-' + key);
            if ($cell.length) {
                $cell.text(value);
                
                // Atualiza classes CSS baseadas no status
                if (key === 'status') {
                    $row.removeClass('status-active status-grace_period status-suspended status-locked status-scheduled_deletion');
                    $row.addClass('status-' + value);
                }
            }
        });
    }
    
    /**
     * Mostra um tooltip
     */
    function showTooltip() {
        var text = $(this).data('tooltip');
        var $tooltip = $('<div class="limiter-tooltip">' + text + '</div>');
        
        $('body').append($tooltip);
        
        var pos = $(this).offset();
        $tooltip.css({
            top: pos.top - $tooltip.outerHeight() - 10,
            left: pos.left + ($(this).outerWidth() / 2) - ($tooltip.outerWidth() / 2)
        });
        
        $(this).on('mouseleave', function() {
            $tooltip.remove();
        });
    }
    
    /**
     * Mostra uma notificação
     */
    function showNotification(type, message) {
        var $notification = $('<div class="limiter-notification limiter-notification-' + type + '">' + message + '</div>');
        
        $('body').append($notification);
        
        // Posiciona a notificação
        $notification.css({
            position: 'fixed',
            top: '20px',
            right: '20px',
            zIndex: '9999'
        });
        
        // Remove após 5 segundos
        setTimeout(function() {
            $notification.fadeOut(500, function() {
                $(this).remove();
            });
        }, 5000);
    }
    
    /**
     * Mostra loader
     */
    function showLoader() {
        if ($('#limiter-loader').length === 0) {
            $('body').append('<div id="limiter-loader" class="limiter-loader"><div class="spinner"></div></div>');
        }
        $('#limiter-loader').show();
    }
    
    /**
     * Esconde loader
     */
    function hideLoader() {
        $('#limiter-loader').fadeOut();
    }
    
    /**
     * Envia email de teste
     */
    function sendTestEmail() {
        var email = prompt('Para qual email deseja enviar o teste?', 'admin@example.com');
        
        if (!email) {
            return;
        }
        
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_send_test_email',
                nonce: limiter_lifecycle.nonce,
                email: email
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', 'Email de teste enviado!');
                } else {
                    showNotification('error', response.data.message);
                }
            }
        });
    }
    
    /**
     * Limpa cache
     */
    function clearCache() {
        $.ajax({
            url: limiter_lifecycle.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_clear_cache',
                nonce: limiter_lifecycle.nonce
            },
            success: function(response) {
                if (response.success) {
                    showNotification('success', 'Cache limpo com sucesso!');
                }
            }
        });
    }
    
    /**
     * Exporta logs
     */
    function exportLogs() {
        var url = limiter_lifecycle.ajax_url + '?action=limiter_export_logs&nonce=' + limiter_lifecycle.nonce;
        window.open(url, '_blank');
    }
    
    /**
     * Helper: Obtém data futura
     */
    function getDateInFuture(days) {
        var date = new Date();
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
    }
    
    /**
     * Helper: Valida data
     */
    function isValidDate(dateString) {
        var regex = /^\d{4}-\d{2}-\d{2}$/;
        if (!regex.test(dateString)) {
            return false;
        }
        
        var date = new Date(dateString);
        return date instanceof Date && !isNaN(date);
    }
    
    /**
     * Inicializa quando o documento estiver pronto
     */
    $(document).ready(function() {
        initLifecycle();
    });
    
})(jQuery);


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-activator.php e os codigos deste arquivo:
<?php
/**
 * Acionado durante a ativação do plugin.
 *
 * @since       1.0.0
 * @package     Limiter_MKP_Pro
 * @subpackage  Limiter_MKP_Pro/includes
 */
// Segurança: impede acesso direto ao arquivo
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Activator {
    /**
     * Método executado durante a ativação do plugin.
     *
     * Cria as tabelas necessárias no banco de dados e configura os planos padrão.
     *
     * @since    1.0.0
     */
    public static function activate() {
        global $wpdb;
        // Verifica se é uma instalação multisite
        if (!is_multisite()) {
            deactivate_plugins(plugin_basename(__FILE__));
            wp_die(__('Este plugin requer uma instalação WordPress Multisite.', 'limiter-mkp-pro'));
        }
        
        // Define o charset do banco de dados
        $charset_collate = $wpdb->get_charset_collate();
        // Prefixo para as tabelas do plugin
        $table_prefix = $wpdb->base_prefix . 'limiter_mkp_pro_';
        
        // Tabela de planos
        $table_planos = $table_prefix . 'planos';
        $sql_planos = "CREATE TABLE $table_planos (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            nome varchar(100) NOT NULL,
            descricao text NOT NULL,
            duracao int(11) NOT NULL DEFAULT 30,
            limite_paginas int(11) NOT NULL DEFAULT 10,
            limite_inodes int(11) NOT NULL DEFAULT 1000,
            limite_upload_mb int(11) NOT NULL DEFAULT 100,
            backup_frequency varchar(20) NOT NULL DEFAULT 'none',
            backup_retention int(11) NOT NULL DEFAULT 3,
            post_types_contaveis text NULL, 
            post_status_contaveis text NULL,
            data_criacao datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
            PRIMARY KEY  (id)
        ) $charset_collate;";
        
        // Tabela de subdomínios
        $table_subdominios = $table_prefix . 'subdominios';
        $sql_subdominios = "CREATE TABLE $table_subdominios (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            blog_id bigint(20) NOT NULL,
            user_id bigint(20) NOT NULL,
            dominio varchar(255) NOT NULL,
            plano_id mediumint(9) NOT NULL,
            limite_personalizado int(11) NULL,
            limite_personalizado_inodes int(11) NULL,
            nome_cliente varchar(255) NULL,
            email_cliente varchar(255) NULL,
            telefone_cliente varchar(50) NULL,
            status varchar(20) NOT NULL DEFAULT 'active',
            regiao varchar(10) NOT NULL DEFAULT 'global',
            data_inicio datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
            data_expiracao datetime NULL,
            PRIMARY KEY  (id),
            UNIQUE KEY  blog_id (blog_id),
            KEY  user_id (user_id),
            KEY  status (status),
            KEY  plano_id (plano_id),
            KEY  email_cliente (email_cliente),
            KEY  status_regiao (status, regiao),
            KEY  user_status (user_id, status)
        ) $charset_collate;";
        
        // Tabela de logs
        $table_logs = $table_prefix . 'logs';
        $sql_logs = "CREATE TABLE $table_logs (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            blog_id bigint(20) NOT NULL,
            acao varchar(100) NOT NULL,
            descricao text NOT NULL,
            dados_extras longtext NULL,
            user_id bigint(20) NOT NULL DEFAULT 0,
            ip varchar(45) NOT NULL DEFAULT 'unknown',
            timestamp datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
            PRIMARY KEY  (id),
            KEY  blog_id (blog_id),
            KEY  acao (acao),
            KEY  timestamp (timestamp),
            KEY  blog_acao_time (blog_id, acao, timestamp)
        ) $charset_collate;";
        
        // Tabela de clientes/assinantes
        $table_clientes = $table_prefix . 'clientes';
        $sql_clientes = "CREATE TABLE $table_clientes (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            blog_id bigint(20) NOT NULL,
            nome varchar(255) NOT NULL,
            endereco text NOT NULL,
            telefone varchar(50) NOT NULL,
            cpf_passaporte varchar(100) NOT NULL,
            documento_url varchar(255) NOT NULL,
            subdominio varchar(255) NOT NULL,
            username varchar(100) NOT NULL,
            data_cadastro datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
            PRIMARY KEY  (id),
            UNIQUE KEY  cpf_passaporte (cpf_passaporte),
            KEY  blog_id (blog_id)
        ) $charset_collate;";
        
        // Tabela de vinculação planos-produtos WooCommerce
        $table_plano_products = $table_prefix . 'plano_products';
        $sql_plano_products = "CREATE TABLE $table_plano_products (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            plano_id mediumint(9) NOT NULL,
            woocommerce_product_id bigint(20) NOT NULL,
            ordem int(11) NOT NULL DEFAULT 0,
            data_vinculo datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
            PRIMARY KEY  (id),
            UNIQUE KEY  unique_plano_product (plano_id, woocommerce_product_id),
            KEY  plano_id (plano_id),
            KEY  product_id (woocommerce_product_id)
        ) $charset_collate;";
        
        // Tabela de tokens
        $table_tokens = $table_prefix . 'tokens';
        $sql_tokens = "CREATE TABLE $table_tokens (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            user_id bigint(20) NOT NULL,
            subscription_id bigint(20) NOT NULL,
            token varchar(255) NOT NULL,
            email varchar(255) NOT NULL,
            plano_id mediumint(9) NOT NULL,
            status varchar(20) NOT NULL DEFAULT 'pending',
            subdomain_name varchar(255) NULL,
            expires_at datetime NOT NULL,
            regiao varchar(10) NULL DEFAULT 'global',
            created_at datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
            PRIMARY KEY  (id),
            UNIQUE KEY  token (token),
            UNIQUE KEY  email (email),
            KEY  user_id (user_id),
            KEY  subscription_id (subscription_id),
            KEY  status_expires (status, expires_at)
        ) $charset_collate;";
        
        // Inclui o arquivo necessário para a função dbDelta
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        
        // Cria as tabelas
        dbDelta($sql_planos);
        dbDelta($sql_subdominios);
        dbDelta($sql_logs);
        dbDelta($sql_clientes);
        dbDelta($sql_plano_products);
        dbDelta($sql_tokens);
        
        // Insere os planos padrão se a tabela estiver vazia
        $count_planos = $wpdb->get_var("SELECT COUNT(*) FROM $table_planos");
        if ($count_planos == 0) {
            $default_post_types = json_encode(array("post", "page"));
            $default_post_status = json_encode(array("publish", "draft", "trash"));
            $wpdb->insert(
                $table_planos,
                array(
                    'nome' => 'Starter',
                    'descricao' => 'Plano básico com limite de 10 páginas/posts.',
                    'duracao' => 30,
                    'limite_paginas' => 10,
                    'limite_inodes' => 1000,
                    'limite_upload_mb' => 100,
                    'backup_frequency' => 'none',
                    'backup_retention' => 0,
                    'post_types_contaveis' => $default_post_types,
                    'post_status_contaveis' => $default_post_status,
                )
            );
            $wpdb->insert(
                $table_planos,
                array(
                    'nome' => 'Business',
                    'descricao' => 'Plano avançado com backup diário.',
                    'duracao' => 30,
                    'limite_paginas' => 100,
                    'limite_inodes' => 6000,
                    'limite_upload_mb' => 1000,
                    'backup_frequency' => 'daily',
                    'backup_retention' => 7,
                    'post_types_contaveis' => $default_post_types,
                    'post_status_contaveis' => $default_post_status,
                )
            );
        }
        
        // --- CHECKS DE ATUALIZAÇÃO (COLUNAS NOVAS) ---
        
        // 1. Limite Upload MB
        $column_exists = $wpdb->get_var("SHOW COLUMNS FROM $table_planos LIKE 'limite_upload_mb'");
        if (!$column_exists) {
            $wpdb->query("ALTER TABLE $table_planos ADD COLUMN limite_upload_mb int(11) NOT NULL DEFAULT 100 AFTER limite_inodes");
        }

        // 2. Limite Inodes
        $column_exists_inodes = $wpdb->get_var("SHOW COLUMNS FROM $table_planos LIKE 'limite_inodes'");
        if (!$column_exists_inodes) {
            $wpdb->query("ALTER TABLE $table_planos ADD COLUMN limite_inodes int(11) NOT NULL DEFAULT 1000 AFTER limite_paginas");
        }

        // 3. Backup Frequency (NOVO)
        $column_exists_bkp = $wpdb->get_var("SHOW COLUMNS FROM $table_planos LIKE 'backup_frequency'");
        if (!$column_exists_bkp) {
            $wpdb->query("ALTER TABLE $table_planos ADD COLUMN backup_frequency varchar(20) NOT NULL DEFAULT 'none' AFTER limite_upload_mb");
        }

        // 4. Backup Retention (NOVO)
        $column_exists_ret = $wpdb->get_var("SHOW COLUMNS FROM $table_planos LIKE 'backup_retention'");
        if (!$column_exists_ret) {
            $wpdb->query("ALTER TABLE $table_planos ADD COLUMN backup_retention int(11) NOT NULL DEFAULT 3 AFTER backup_frequency");
        }

        // 5. Post Types e Status
        $column_exists_types = $wpdb->get_var("SHOW COLUMNS FROM $table_planos LIKE 'post_types_contaveis'");
        if (!$column_exists_types) {
            $wpdb->query("ALTER TABLE $table_planos ADD COLUMN post_types_contaveis text NULL AFTER backup_retention");
        }
        $column_exists_status = $wpdb->get_var("SHOW COLUMNS FROM $table_planos LIKE 'post_status_contaveis'");
        if (!$column_exists_status) {
            $wpdb->query("ALTER TABLE $table_planos ADD COLUMN post_status_contaveis text NULL AFTER post_types_contaveis");
        }
        
        // Colunas de Subdomínios
        $column_exists_sub = $wpdb->get_var("SHOW COLUMNS FROM $table_subdominios LIKE 'limite_personalizado_inodes'");
        if (!$column_exists_sub) {
            $wpdb->query("ALTER TABLE $table_subdominios ADD COLUMN limite_personalizado_inodes int(11) NULL DEFAULT NULL");
        }
        
        // Atualiza versão
        add_network_option(null, 'limiter_mkp_pro_version', LIMITER_MKP_PRO_VERSION);
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-backup.php e os codigos deste arquivo:
<?php
/**
 * Classe para backup de configurações e dados.
 *
 * @since      1.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Backup {
    
    /**
     * Exporta configurações do plugin (JSON).
     */
    public static function export_settings($includes = array()) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        if (empty($includes)) {
            $includes = array('config', 'plans', 'subs');
        }

        $export_data = [
            'metadata' => [
                'version' => LIMITER_MKP_PRO_VERSION,
                'export_date' => current_time('mysql'),
                'site_url' => get_site_url(),
                'network' => is_multisite(),
                'type' => 'settings_json'
            ]
        ];

        if (in_array('config', $includes)) {
            $export_data['configuracoes'] = get_network_option(null, 'limiter_mkp_pro_configuracoes');
            $export_data['woocommerce_links'] = self::get_woocommerce_links();
        }

        if (in_array('plans', $includes)) {
            $export_data['planos'] = Limiter_MKP_Pro_Database::get_planos();
        }

        if (in_array('subs', $includes)) {
            $export_data['subdominios'] = Limiter_MKP_Pro_Database::get_subdominios();
        }

        if (in_array('logs', $includes)) {
            $export_data['logs'] = Limiter_MKP_Pro_Database::get_logs(5000); 
        }

        if (in_array('clients', $includes)) {
            global $wpdb;
            $table_clientes = Limiter_MKP_Pro_Database::get_table_name('clientes');
            if (Limiter_MKP_Pro_Database::validate_table_name($table_clientes)) {
                $export_data['clientes'] = $wpdb->get_results("SELECT * FROM $table_clientes");
            }
        }

        if (in_array('tokens', $includes)) {
            global $wpdb;
            $table_tokens = Limiter_MKP_Pro_Database::get_table_name('tokens');
            if (Limiter_MKP_Pro_Database::validate_table_name($table_tokens)) {
                $export_data['tokens'] = $wpdb->get_results("SELECT * FROM $table_tokens");
            }
        }

        return $export_data;
    }

    /**
     * Exporta o Banco de Dados de um Subdomínio Específico (SQL).
     * * @since 2.2.0
     * @param int $blog_id ID do blog.
     * @return string|false Caminho do arquivo ou false.
     */
    public static function export_subdomain_sql($blog_id) {
        global $wpdb;
        
        // Aumenta tempo de execução para evitar timeout
        if (function_exists('set_time_limit')) {
            set_time_limit(300); // 5 minutos
        }

        $blog_id = intval($blog_id);
        if ($blog_id <= 1 && !is_main_site($blog_id)) {
            return false; // Proteção para não exportar site principal por engano via ID errado
        }

        // Obtém prefixo das tabelas deste blog (ex: wp_2_)
        $prefix = $wpdb->get_blog_prefix($blog_id);
        
        // Lista todas as tabelas deste blog
        $tables = $wpdb->get_results("SHOW TABLES LIKE '{$prefix}%'", ARRAY_N);
        
        if (empty($tables)) {
            return false;
        }

        // Prepara arquivo
        $upload_dir = wp_upload_dir();
        $backup_dir = $upload_dir['basedir'] . '/limiter-mkp-pro-backups/';
        
        if (!file_exists($backup_dir)) {
            wp_mkdir_p($backup_dir);
        }

        $filename = "backup-site-{$blog_id}-" . date('Y-m-d-H-i-s') . '.sql';
        $filepath = $backup_dir . $filename;
        
        // Abre arquivo para escrita
        $handle = fopen($filepath, 'w');
        if (!$handle) return false;

        // Cabeçalho do SQL
        fwrite($handle, "-- Backup Limiter MKP Pro\n");
        fwrite($handle, "-- Blog ID: {$blog_id}\n");
        fwrite($handle, "-- Date: " . date('Y-m-d H:i:s') . "\n\n");
        fwrite($handle, "SET FOREIGN_KEY_CHECKS = 0;\n\n");

        foreach ($tables as $row) {
            $table = $row[0];
            
            // Estrutura da tabela
            $create_table = $wpdb->get_row("SHOW CREATE TABLE {$table}", ARRAY_N);
            fwrite($handle, "DROP TABLE IF EXISTS `{$table}`;\n");
            fwrite($handle, $create_table[1] . ";\n\n");

            // Dados da tabela (em chunks para não estourar memória)
            $row_count = $wpdb->get_var("SELECT COUNT(*) FROM {$table}");
            $limit = 1000;
            
            if ($row_count > 0) {
                for ($offset = 0; $offset < $row_count; $offset += $limit) {
                    $rows = $wpdb->get_results("SELECT * FROM {$table} LIMIT {$offset}, {$limit}", ARRAY_A);
                    
                    if ($rows) {
                        foreach ($rows as $row_data) {
                            $values = array();
                            foreach ($row_data as $value) {
                                if (is_null($value)) {
                                    $values[] = "NULL";
                                } else {
                                    $values[] = "'" . esc_sql($value) . "'";
                                }
                            }
                            fwrite($handle, "INSERT INTO `{$table}` VALUES (" . implode(', ', $values) . ");\n");
                        }
                    }
                    // Libera memória
                    $wpdb->flush(); 
                }
            }
            fwrite($handle, "\n");
        }

        fwrite($handle, "SET FOREIGN_KEY_CHECKS = 1;\n");
        fclose($handle);

        // Tenta compactar se possível (.gz)
        if (function_exists('gzopen')) {
            $gz_path = $filepath . '.gz';
            $fp_out = gzopen($gz_path, 'w9');
            $fp_in = fopen($filepath, 'rb');
            if ($fp_out && $fp_in) {
                while (!feof($fp_in)) {
                    gzwrite($fp_out, fread($fp_in, 1024 * 512));
                }
                fclose($fp_in);
                gzclose($fp_out);
                unlink($filepath); // Remove o .sql original
                return basename($gz_path);
            }
        }

        return basename($filename);
    }
    
    /**
     * Importa configurações (Mantido do anterior).
     */
    public static function import_settings($data) {
        // ... (Mesmo código anterior para importação JSON) ...
        // Mantido simplificado aqui para brevidade, mas deve conter a mesma lógica
        return ['success' => true, 'message' => 'Importação de JSON ainda não implementada completamente.'];
    }
    
    private static function get_woocommerce_links() {
        global $wpdb;
        $table = Limiter_MKP_Pro_Database::get_table_name('plano_products');
        if ($wpdb->get_var("SHOW TABLES LIKE '$table'") != $table) return [];
        return $wpdb->get_results("SELECT * FROM $table");
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-backup-scheduler.php e os codigos deste arquivo:
<?php
/**
 * Gerenciador de Agendamento de Backups (Fila Assíncrona Inteligente)
 * Integração total com configurações de Planos, Retenção e Redundância por E-mail.
 *
 * @package Limiter_MKP_Pro
 * @since 2.3.4
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Backup_Scheduler {

    const QUEUE_OPTION = 'limiter_mkp_backup_queue';
    const CRON_PROCESS_HOOK = 'limiter_mkp_process_backup_queue';

    /**
     * Inicializa os ganchos do agendador
     */
    public static function init() {
        // 1. O GERENTE: Roda 1x por dia (gancho existente no seu plugin)
        add_action('limiter_mkp_pro_daily_cron', [__CLASS__, 'populate_daily_queue']);
        
        // 2. O OPERÁRIO: Roda a cada poucos minutos para processar a fila
        add_action(self::CRON_PROCESS_HOOK, [__CLASS__, 'process_queue_batch']);
    }

    /**
     * Passo 1: Verifica todos os sites e monta a fila do dia baseada nos PLANOS
     */
    public static function populate_daily_queue() {
        global $wpdb;
        
        // Tabelas do plugin (prefixo correto via classe Database)
        if (!class_exists('Limiter_MKP_Pro_Database')) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        }

        $table_subs = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        $table_planos = Limiter_MKP_Pro_Database::get_table_name('planos');

        // Busca apenas sites ATIVOS com planos que tenham backup ativado
        $sql = "
            SELECT s.blog_id, p.backup_frequency, p.backup_retention 
            FROM {$table_subs} s
            INNER JOIN {$table_planos} p ON s.plano_id = p.id
            WHERE s.status = 'active' 
            AND p.backup_frequency != 'none'
        ";

        $sites = $wpdb->get_results($sql);
        $queue = [];

        foreach ($sites as $site) {
            // Verifica se "hoje" é dia de backup para este site específico
            if (self::should_backup_today($site->blog_id, $site->backup_frequency)) {
                $queue[] = [
                    'blog_id' => $site->blog_id,
                    'retention' => (int) $site->backup_retention
                ];
            }
        }

        // Se houver trabalho para hoje, salva a fila e acorda o operário
        if (!empty($queue)) {
            update_option(self::QUEUE_OPTION, $queue, false);
            
            // Agenda o primeiro processamento para daqui a 60 segundos
            if (!wp_next_scheduled(self::CRON_PROCESS_HOOK)) {
                wp_schedule_single_event(time() + 60, self::CRON_PROCESS_HOOK);
            }
            
            // Log de auditoria
            Limiter_MKP_Pro_Database::log(0, 'backup_fila_criada', 'Fila de backup diária gerada com ' . count($queue) . ' sites.');
        }
    }

    /**
     * Passo 2: Processa UM item da fila e para (Proteção de Performance)
     */
    public static function process_queue_batch() {
        // Recupera a fila atual
        $queue = get_option(self::QUEUE_OPTION, []);

        if (empty($queue)) {
            return; // Fila vazia, volta a dormir
        }

        // Pega o primeiro da fila (FIFO)
        $item = array_shift($queue);
        
        // Atualiza a fila no banco (remove o que pegamos)
        if (empty($queue)) {
            delete_option(self::QUEUE_OPTION);
        } else {
            update_option(self::QUEUE_OPTION, $queue, false);
            // Reagenda o próximo lote para daqui a 2 minutos (tempo seguro)
            wp_schedule_single_event(time() + 120, self::CRON_PROCESS_HOOK);
        }

        // Executa o trabalho pesado
        self::execute_backup($item['blog_id'], $item['retention']);
    }

    /**
     * Executa a geração do SQL, aplica a retenção e envia por E-MAIL (Redundância)
     */
    private static function execute_backup($blog_id, $retention) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-backup.php';
        
        try {
            // Gera o arquivo
            $filename = Limiter_MKP_Pro_Backup::export_subdomain_sql($blog_id);
            
            if ($filename) {
                // Sucesso! Atualiza a data do último backup
                update_blog_option($blog_id, 'limiter_last_backup_date', current_time('mysql'));
                
                // Aplica a política de retenção (apaga os velhos do servidor)
                self::enforce_retention($blog_id, $retention);

                $site_info = get_blog_details($blog_id);
                $nome_site = $site_info ? $site_info->blogname : "ID $blog_id";
                $site_url = $site_info ? $site_info->siteurl : '';

                // --- NOVO: Envia Backup por E-mail (Redundância Off-site) ---
                $enviado_email = self::send_backup_email($filename, $nome_site, $site_url);
                $msg_extra = $enviado_email ? " (Cópia enviada por e-mail)" : " (Falha ao enviar por e-mail)";

                // Log de Sucesso
                Limiter_MKP_Pro_Database::log(
                    $blog_id, 
                    'backup_auto_sucesso', 
                    "Backup automático realizado para: {$nome_site}. Arquivo: {$filename}{$msg_extra}"
                );
            } else {
                Limiter_MKP_Pro_Database::log($blog_id, 'backup_auto_falha', "A exportação retornou vazio.");
            }

        } catch (Exception $e) {
            Limiter_MKP_Pro_Database::log($blog_id, 'backup_auto_erro', "Erro crítico: " . $e->getMessage());
        }
    }

    /**
     * Envia o arquivo de backup para o e-mail do administrador
     */
    private static function send_backup_email($filename, $site_name, $site_url) {
        $upload_dir = wp_upload_dir();
        $file_path = $upload_dir['basedir'] . '/limiter-mkp-pro-backups/' . $filename;
        
        if (!file_exists($file_path)) {
            return false;
        }

        // Verifica tamanho do arquivo (limite seguro de anexo ~10MB)
        if (filesize($file_path) > 10 * 1024 * 1024) {
            return false; // Arquivo muito grande para e-mail
        }

        $admin_email = get_network_option(null, 'admin_email');
        if (!is_email($admin_email)) {
            return false;
        }

        $subject = "[Backup Auto] {$site_name} - " . date('d/m/Y');
        $message = "Olá,\n\n";
        $message .= "Segue em anexo o backup automático do banco de dados do subdomínio:\n";
        $message .= "Site: {$site_name}\n";
        $message .= "URL: {$site_url}\n";
        $message .= "Data: " . current_time('d/m/Y H:i') . "\n\n";
        $message .= "Armazene este arquivo em local seguro.\n";
        $message .= "Limiter MKP Pro System.";

        $headers = array('Content-Type: text/plain; charset=UTF-8');
        
        // Envia com anexo
        return wp_mail($admin_email, $subject, $message, $headers, array($file_path));
    }

    /**
     * Lógica de Frequência: Decide se deve fazer backup hoje
     */
    private static function should_backup_today($blog_id, $frequency) {
        $last_backup = get_blog_option($blog_id, 'limiter_last_backup_date');
        
        if (!$last_backup) return true; // Nunca fez, faz agora.

        $last = new DateTime($last_backup);
        $today = new DateTime(current_time('mysql'));
        $diff = $last->diff($today)->days;

        switch ($frequency) {
            case 'daily':
                return $diff >= 1; // 1 dia ou mais
            case 'weekly':
                return $diff >= 7; // 7 dias ou mais
            case 'monthly':
                return $diff >= 30; // 30 dias ou mais
            default:
                return false;
        }
    }

    /**
     * Lógica de Retenção: Apaga backups antigos excedentes
     */
    private static function enforce_retention($blog_id, $limit) {
        if ($limit <= 0) return; // Se limite for 0, guarda infinito

        $backup_dir = wp_upload_dir()['basedir'] . '/limiter-mkp-pro-backups/';
        
        // Encontra todos os backups deste site específico
        $files = glob($backup_dir . "backup-site-{$blog_id}-*");
        
        if ($files && count($files) > $limit) {
            // Ordena por data de modificação (mais novos primeiro)
            usort($files, function($a, $b) {
                return filemtime($b) - filemtime($a);
            });

            // Pega a lista dos que sobraram (além do limite)
            $files_to_delete = array_slice($files, $limit);
            
            foreach ($files_to_delete as $file) {
                if (file_exists($file)) {
                    @unlink($file); // @ suprime erros de permissão se houver
                }
            }
        }
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-cache-manager.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo gerenciamento de cache do plugin.
 *
 * @since      1.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

// Segurança: impede acesso direto ao arquivo
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Cache_Manager {

    /**
     * Prefixo para as chaves de cache.
     *
     * @since    1.2.0
     * @access   private
     * @var      string    $cache_prefix    Prefixo para as chaves de cache.
     */
    private static $cache_prefix = 'limiter_mkp_pro_';

    /**
     * Obtém um valor do cache.
     *
     * @since    1.2.0
     * @param    string    $key    Chave do cache.
     * @return   mixed             Valor em cache ou false se não encontrado.
     */
    public static function get($key) {
        $full_key = self::$cache_prefix . $key;
        return get_transient($full_key);
    }

    /**
     * Define um valor no cache.
     *
     * @since    1.2.0
     * @param    string    $key       Chave do cache.
     * @param    mixed     $value     Valor a ser armazenado.
     * @param    int       $expire    Tempo de expiração em segundos (opcional).
     * @return   boolean              Verdadeiro se salvo com sucesso.
     */
    public static function set($key, $value, $expire = 0) {
        $full_key = self::$cache_prefix . $key;
        $expire = $expire ?: 15 * MINUTE_IN_SECONDS; // 15 minutos padrão
        return set_transient($full_key, $value, $expire);
    }

    /**
     * Remove um valor do cache.
     *
     * @since    1.2.0
     * @param    string    $key    Chave do cache.
     * @return   boolean           Verdadeiro se removido com sucesso.
     */
    public static function delete($key) {
        $full_key = self::$cache_prefix . $key;
        return delete_transient($full_key);
    }

    /**
     * Limpa todo o cache do plugin.
     *
     * @since    1.2.0
     * @return   boolean    Verdadeiro se limpo com sucesso.
     */
    public static function clear_all() {
        global $wpdb;
        
        // Limpa todos os transients do plugin
        $wpdb->query(
            $wpdb->prepare(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                '_transient_' . self::$cache_prefix . '%'
            )
        );
        
        $wpdb->query(
            $wpdb->prepare(
                "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s",
                '_transient_timeout_' . self::$cache_prefix . '%'
            )
        );
        
        return true;
    }

    /**
     * Obtém estatísticas com cache inteligente.
     *
     * @since    1.2.0
     * @param    int       $blog_id        ID do blog (opcional).
     * @param    bool      $force_refresh  Forçar atualização do cache.
     * @return   array                     Estatísticas do blog ou gerais.
     */
    public static function get_cached_stats($blog_id = null, $force_refresh = false) {
        if ($blog_id) {
            $cache_key = "estatisticas_blog_{$blog_id}";
        } else {
            $cache_key = "estatisticas_gerais";
        }
        
        $stats = self::get($cache_key);
        
        if ($stats === false || $force_refresh) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database-get-estatisticas.php';
            
            if ($blog_id) {
                $stats = Limiter_MKP_Pro_Database_Get_Estatisticas::get_estatisticas_blog($blog_id);
            } else {
                $stats = Limiter_MKP_Pro_Database_Get_Estatisticas::get_estatisticas_gerais();
            }
            
            // Cache mais longo para estatísticas gerais
            $expiration = $blog_id ? 300 : 900; // 5min para blog, 15min para geral
            self::set($cache_key, $stats, $expiration);
        }
        
        return $stats;
    }

    /**
     * Obtém contagem de posts com cache.
     *
     * @since    1.2.0
     * @param    int       $blog_id    ID do blog.
     * @return   int                   Total de posts e páginas.
     */
    public static function get_cached_post_count($blog_id) {
        $cache_key = "post_count_blog_{$blog_id}";
        $count = self::get($cache_key);
        
        if ($count === false) {
            switch_to_blog($blog_id);
            $count_pages = wp_count_posts('page');
            $count_posts = wp_count_posts('post');
            $count = (int) $count_pages->publish + (int) $count_posts->publish;
            restore_current_blog();
            
            self::set($cache_key, $count, 300); // 5 minutos
        }
        
        return $count;
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-churn-dashboard.php e os codigos deste arquivo:
<?php
/**
 * Classe para gerenciar o dashboard de churn
 * 
 * @since 2.0.0
 * @package Limiter_MKP_Pro
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Churn_Dashboard {
    
    /**
     * Inicializa o dashboard
     */
    public static function init() {
        // Adiciona ações AJAX específicas para o dashboard
        self::add_ajax_actions();
        
        // Adiciona filtros para estatísticas
        add_filter('limiter_churn_stats', [__CLASS__, 'enhance_churn_stats']);
    }
    
    /**
     * Renderiza o dashboard de churn
     */
    public static function render_dashboard() {
        // Carrega as estatísticas
        $stats = self::get_churn_statistics();
        $at_risk_blogs = self::get_at_risk_blogs();
        $recent_cancellations = self::get_recent_cancellations();
        $upcoming_renewals = self::get_upcoming_renewals();
        
        // Carrega o template
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/partials/churn-dashboard.php';
    }
    
    /**
     * Obtém estatísticas de churn
     */
    public static function get_churn_statistics() {
        global $wpdb;
        
        // Estatísticas básicas
        $stats = [
            'total_blogs' => 0,
            'active_blogs' => 0,
            'at_risk_blogs' => 0,
            'suspended_blogs' => 0,
            'locked_blogs' => 0,
            'cancelled_this_month' => 0,
            'renewed_this_month' => 0,
            'churn_rate' => 0,
            'mrr' => 0,
            'arr' => 0
        ];
        
        // Total de blogs
        $stats['total_blogs'] = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->blogs} WHERE deleted = 0");
        
        // Blogs por status
        $status_counts = $wpdb->get_results("
            SELECT meta_value as status, COUNT(*) as count
            FROM {$wpdb->blogmeta}
            WHERE meta_key = 'limiter_blog_status'
            GROUP BY meta_value
        ");
        
        foreach ($status_counts as $row) {
            switch ($row->status) {
                case 'active':
                    $stats['active_blogs'] = $row->count;
                    break;
                case 'grace_period':
                    $stats['at_risk_blogs'] = $row->count;
                    break;
                case 'suspended':
                    $stats['suspended_blogs'] = $row->count;
                    break;
                case 'locked':
                    $stats['locked_blogs'] = $row->count;
                    break;
            }
        }
        
        // Cancelamentos deste mês
        $stats['cancelled_this_month'] = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(DISTINCT blog_id)
            FROM {$wpdb->blogmeta}
            WHERE meta_key = 'limiter_subscription_status'
            AND meta_value = 'cancelled'
            AND DATE(meta_date) >= %s
        ", date('Y-m-01')));
        
        // Renovações deste mês
        $stats['renewed_this_month'] = $wpdb->get_var($wpdb->prepare("
            SELECT COUNT(DISTINCT blog_id)
            FROM {$wpdb->blogmeta}
            WHERE meta_key = 'limiter_last_renewal_date'
            AND DATE(meta_value) >= %s
        ", date('Y-m-01')));
        
        // Calcula taxa de churn
        if ($stats['active_blogs'] > 0) {
            $stats['churn_rate'] = round(($stats['cancelled_this_month'] / $stats['active_blogs']) * 100, 2);
        }
        
        // Calcula MRR (Monthly Recurring Revenue)
        $stats['mrr'] = self::calculate_mrr();
        
        // Calcula ARR (Annual Recurring Revenue)
        $stats['arr'] = $stats['mrr'] * 12;
        
        return apply_filters('limiter_churn_stats', $stats);
    }
    
    /**
     * Obtém blogs em risco
     */
    public static function get_at_risk_blogs($limit = 50) {
        global $wpdb;
        
        return $wpdb->get_results($wpdb->prepare("
            SELECT 
                b.blog_id,
                b.domain,
                b.path,
                bm1.meta_value as customer_name,
                bm2.meta_value as customer_email,
                bm3.meta_value as subscription_status,
                bm4.meta_value as days_in_status,
                bm5.meta_value as last_payment_date,
                bm6.meta_value as plan_name,
                bm7.meta_value as monthly_amount
            FROM {$wpdb->blogs} b
            LEFT JOIN {$wpdb->blogmeta} bm1 ON b.blog_id = bm1.blog_id AND bm1.meta_key = 'limiter_nome_cliente'
            LEFT JOIN {$wpdb->blogmeta} bm2 ON b.blog_id = bm2.blog_id AND bm2.meta_key = 'limiter_email_cliente'
            LEFT JOIN {$wpdb->blogmeta} bm3 ON b.blog_id = bm3.blog_id AND bm3.meta_key = 'limiter_subscription_status'
            LEFT JOIN {$wpdb->blogmeta} bm4 ON b.blog_id = bm4.blog_id AND bm4.meta_key = 'limiter_days_in_status'
            LEFT JOIN {$wpdb->blogmeta} bm5 ON b.blog_id = bm5.blog_id AND bm5.meta_key = 'limiter_last_payment_date'
            LEFT JOIN {$wpdb->blogmeta} bm6 ON b.blog_id = bm6.blog_id AND bm6.meta_key = 'limiter_plan_name'
            LEFT JOIN {$wpdb->blogmeta} bm7 ON b.blog_id = bm7.blog_id AND bm7.meta_key = 'limiter_monthly_amount'
            WHERE b.deleted = 0
            AND bm3.meta_value IN ('on-hold', 'failed', 'past-due')
            ORDER BY bm4.meta_value DESC
            LIMIT %d
        ", $limit));
    }
    
    /**
     * Obtém cancelamentos recentes
     */
    public static function get_recent_cancellations($limit = 20) {
        global $wpdb;
        
        return $wpdb->get_results($wpdb->prepare("
            SELECT 
                b.blog_id,
                b.domain,
                b.path,
                bm1.meta_value as customer_name,
                bm2.meta_value as customer_email,
                bm3.meta_value as cancellation_date,
                bm4.meta_value as cancellation_reason,
                bm5.meta_value as plan_name,
                bm6.meta_value as monthly_amount_lost
            FROM {$wpdb->blogs} b
            LEFT JOIN {$wpdb->blogmeta} bm1 ON b.blog_id = bm1.blog_id AND bm1.meta_key = 'limiter_nome_cliente'
            LEFT JOIN {$wpdb->blogmeta} bm2 ON b.blog_id = bm2.blog_id AND bm2.meta_key = 'limiter_email_cliente'
            LEFT JOIN {$wpdb->blogmeta} bm3 ON b.blog_id = bm3.blog_id AND bm3.meta_key = 'limiter_cancellation_date'
            LEFT JOIN {$wpdb->blogmeta} bm4 ON b.blog_id = bm4.blog_id AND bm4.meta_key = 'limiter_cancellation_reason'
            LEFT JOIN {$wpdb->blogmeta} bm5 ON b.blog_id = bm5.blog_id AND bm5.meta_key = 'limiter_plan_name'
            LEFT JOIN {$wpdb->blogmeta} bm6 ON b.blog_id = bm6.blog_id AND bm6.meta_key = 'limiter_monthly_amount'
            WHERE b.deleted = 0
            AND bm3.meta_value IS NOT NULL
            ORDER BY bm3.meta_value DESC
            LIMIT %d
        ", $limit));
    }
    
    /**
     * Obtém renovações próximas
     */
    public static function get_upcoming_renewals($limit = 20) {
        global $wpdb;
        
        return $wpdb->get_results($wpdb->prepare("
            SELECT 
                b.blog_id,
                b.domain,
                b.path,
                bm1.meta_value as customer_name,
                bm2.meta_value as customer_email,
                bm3.meta_value as next_payment_date,
                bm4.meta_value as plan_name,
                bm5.meta_value as monthly_amount,
                DATEDIFF(bm3.meta_value, CURDATE()) as days_until_renewal
            FROM {$wpdb->blogs} b
            LEFT JOIN {$wpdb->blogmeta} bm1 ON b.blog_id = bm1.blog_id AND bm1.meta_key = 'limiter_nome_cliente'
            LEFT JOIN {$wpdb->blogmeta} bm2 ON b.blog_id = bm2.blog_id AND bm2.meta_key = 'limiter_email_cliente'
            LEFT JOIN {$wpdb->blogmeta} bm3 ON b.blog_id = bm3.blog_id AND bm3.meta_key = 'limiter_next_payment_date'
            LEFT JOIN {$wpdb->blogmeta} bm4 ON b.blog_id = bm4.blog_id AND bm4.meta_key = 'limiter_plan_name'
            LEFT JOIN {$wpdb->blogmeta} bm5 ON b.blog_id = bm5.blog_id AND bm5.meta_key = 'limiter_monthly_amount'
            WHERE b.deleted = 0
            AND bm3.meta_value IS NOT NULL
            AND bm3.meta_value >= CURDATE()
            ORDER BY bm3.meta_value ASC
            LIMIT %d
        ", $limit));
    }
    
    /**
     * Calcula o MRR (Monthly Recurring Revenue)
     */
    private static function calculate_mrr() {
        if (!class_exists('WC_Subscriptions')) {
            return 0;
        }
        
        $subscriptions = wcs_get_subscriptions([
            'subscription_status' => 'active',
            'limit' => -1
        ]);
        
        $mrr = 0;
        
        foreach ($subscriptions as $subscription) {
            // Verifica se esta assinatura está vinculada a um blog do plugin
            $blog_id = self::get_blog_id_from_subscription($subscription);
            
            if ($blog_id) {
                $mrr += $subscription->get_total();
            }
        }
        
        return round($mrr, 2);
    }
    
    /**
     * Adiciona ações AJAX
     */
    private static function add_ajax_actions() {
        // Exportar relatório de churn
        add_action('wp_ajax_limiter_export_churn_report', [__CLASS__, 'ajax_export_churn_report']);
        
        // Enviar lembretes em massa
        add_action('wp_ajax_limiter_send_bulk_reminders', [__CLASS__, 'ajax_send_bulk_reminders']);
        
        // Obter estatísticas em tempo real
        add_action('wp_ajax_limiter_get_realtime_stats', [__CLASS__, 'ajax_get_realtime_stats']);
    }
    
    /**
     * AJAX: Exporta relatório de churn
     */
    public static function ajax_export_churn_report() {
        check_ajax_referer('limiter_churn_nonce', 'nonce');
        
        if (!current_user_can('manage_network')) {
            wp_die('Permissão negada.');
        }
        
        $type = $_GET['type'] ?? 'csv';
        $date = date('Y-m-d');
        
        switch ($type) {
            case 'csv':
                self::export_csv_report();
                break;
            case 'pdf':
                self::export_pdf_report();
                break;
            case 'excel':
                self::export_excel_report();
                break;
            default:
                self::export_csv_report();
        }
        
        exit;
    }
    
    /**
     * Exporta relatório CSV
     */
    private static function export_csv_report() {
        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="churn-report-' . date('Y-m-d') . '.csv"');
        
        $output = fopen('php://output', 'w');
        
        // Cabeçalho
        fputcsv($output, [
            'ID',
            'Blog',
            'Cliente',
            'Email',
            'Status',
            'Último Pagamento',
            'Plano',
            'Valor Mensal',
            'Dias em Risco',
            'Próximo Pagamento'
        ]);
        
        // Dados
        $blogs = self::get_at_risk_blogs(-1); // -1 para todos
        
        foreach ($blogs as $blog) {
            fputcsv($output, [
                $blog->blog_id,
                $blog->domain . $blog->path,
                $blog->customer_name,
                $blog->customer_email,
                $blog->subscription_status,
                $blog->last_payment_date,
                $blog->plan_name,
                $blog->monthly_amount,
                $blog->days_in_status,
                $blog->next_payment_date ?? 'N/A'
            ]);
        }
        
        fclose($output);
    }
    
    /**
     * AJAX: Envia lembretes em massa
     */
    public static function ajax_send_bulk_reminders() {
        check_ajax_referer('limiter_churn_nonce', 'nonce');
        
        if (!current_user_can('manage_network')) {
            wp_send_json_error(['message' => 'Permissão negada.']);
        }
        
        $blog_ids = $_POST['blog_ids'] ?? [];
        $template = $_POST['template'] ?? 'payment_failed_day1';
        $count = 0;
        
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-lifecycle-manager.php';
        
        foreach ($blog_ids as $blog_id) {
            $blog_id = intval($blog_id);
            
            if ($blog_id > 0) {
                // Obtém a assinatura do blog
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
                $subscription = Limiter_MKP_Pro_WooCommerce_Integration::get_subscription_for_blog($blog_id);
                
                if ($subscription) {
                    Limiter_MKP_Pro_Lifecycle_Manager::notify($blog_id, $template, $subscription);
                    $count++;
                }
            }
        }
        
        wp_send_json_success([
            'message' => "{$count} lembretes enviados com sucesso.",
            'count' => $count
        ]);
    }
    
    /**
     * AJAX: Obtém estatísticas em tempo real
     */
    public static function ajax_get_realtime_stats() {
        check_ajax_referer('limiter_churn_nonce', 'nonce');
        
        if (!current_user_can('manage_network')) {
            wp_send_json_error(['message' => 'Permissão negada.']);
        }
        
        $stats = self::get_churn_statistics();
        
        wp_send_json_success([
            'stats' => $stats,
            'timestamp' => current_time('mysql')
        ]);
    }
    
    /**
     * Melhora as estatísticas de churn
     */
    public static function enhance_churn_stats($stats) {
        // Adiciona métricas adicionais
        $stats['estimated_recovery'] = self::calculate_estimated_recovery();
        $stats['lifetime_value'] = self::calculate_average_lifetime_value();
        $stats['retention_rate'] = 100 - $stats['churn_rate'];
        
        return $stats;
    }
    
    /**
     * Calcula estimativa de recuperação
     */
    private static function calculate_estimated_recovery() {
        // Implementação simplificada
        // Em produção, use dados históricos
        return '35%';
    }
    
    /**
     * Calcula valor médio de vida do cliente
     */
    private static function calculate_average_lifetime_value() {
        // Implementação simplificada
        // Em produção, use dados históricos
        return '$1,250';
    }
    
    /**
     * Helper: Obtém ID do blog a partir da assinatura
     */
    private static function get_blog_id_from_subscription($subscription) {
        // Reutiliza a função do WooCommerce Hooks
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-subscription-hooks.php';
        return Limiter_MKP_Pro_WooCommerce_Subscription_Hooks::get_blog_id_from_subscription($subscription);
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-deactivator.php e os codigos deste arquivo:
<?php
/**
 * Acionado durante a desativação do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Evita acesso direto
}

class Limiter_MKP_Pro_Deactivator {

    /**
     * Método executado durante a desativação do plugin.
     *
     * Realiza:
     * - Cancelamento do cron diário
     * - Limpeza do transient da rotina de tokens
     * - Registro no log (caso a tabela exista)
     *
     * Não remove tabelas para preservar os dados.
     *
     * @since    1.0.0
     */
    public static function deactivate() {

        // -------------------------------------------------------
        // 1. CANCELA O EVENTO CRON DIÁRIO AO DESATIVAR O PLUGIN
        // -------------------------------------------------------
        if ( function_exists( 'wp_next_scheduled' ) ) {
            $timestamp = wp_next_scheduled( 'limiter_mkp_pro_cron_daily' );
            if ( $timestamp ) {
                wp_unschedule_event( $timestamp, 'limiter_mkp_pro_cron_daily' );
            }
        }

        // -------------------------------------------------------
        // 2. REMOVE O TRANSIENT DE LIMPEZA DE TOKENS
        // -------------------------------------------------------
        delete_transient( 'mkp_token_cleanup_last_run' );

        // -------------------------------------------------------
        // 3. REGISTRO EM LOG DA DESATIVAÇÃO (SE A TABELA EXISTIR)
        // -------------------------------------------------------
        global $wpdb;

        $table_logs = $wpdb->base_prefix . 'limiter_mkp_pro_logs';

        // Verifica existência da tabela corretamente
        $exists = $wpdb->get_var( $wpdb->prepare(
            "SHOW TABLES LIKE %s",
            $table_logs
        ) );

        if ( $exists === $table_logs ) {
            // Sanitização mínima — todos os valores são fixos/sob controle
            $wpdb->insert(
                $table_logs,
                array(
                    'blog_id'   => 0, // 0 = ação em nível de rede
                    'acao'      => 'desativacao',
                    'descricao' => 'Plugin desativado pelo administrador da rede.',
                ),
                array( '%d', '%s', '%s' )
            );
        }
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-error-handler.php e os codigos deste arquivo:
<?php
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Classe para tratamento centralizado de erros
 */
class Limiter_MKP_Pro_Error_Handler {
    /**
     * Registra um erro no log do WordPress
     */
    public static function log_error($message, $data = array(), $level = 'error') {
        $error_message = 'Limiter MKP Pro [' . strtoupper($level) . ']: ' . $message;
        
        if (!empty($data)) {
            // Remove dados sensíveis
            $sanitized_data = self::sanitize_sensitive_data($data);
            $error_message .= ' - Data: ' . wp_json_encode($sanitized_data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
        }
        
        // Log no arquivo de erro do WordPress
        error_log($error_message);
        
        // Também registra no log personalizado do plugin
        if (function_exists('wp_get_current_user')) {
            $user = wp_get_current_user();
            $user_id = $user->ID ?? 0;
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log(
                $user_id, 
                'system_error', 
                $message,
                [
                    'level' => $level,
                    'data' => $data,
                    'timestamp' => current_time('mysql')
                ]
            );
        }
        
        return $error_message;
    }
    
    /**
     * Verifica e loga erros de banco de dados
     */
    public static function check_db_error($result, $operation, $data = array()) {
        global $wpdb;
        
        if ($wpdb->last_error) {
            $error_data = $data ?: [];
            $error_data['db_error'] = $wpdb->last_error;
            $error_data['db_query'] = $wpdb->last_query;
            $error_data['operation'] = $operation;
            $error_data['result'] = $result;
            
            self::log_error("Database error in {$operation}", $error_data, 'critical');
            return false;
        }
        
        if ($result === false) {
            $error_data = $data ?: [];
            $error_data['operation'] = $operation;
            $error_data['result'] = $result;
            
            self::log_error("Operation failed: {$operation}", $error_data, 'error');
            return false;
        }
        
        return true;
    }
    
    /**
     * Remove dados sensíveis antes de logar
     */
    private static function sanitize_sensitive_data($data) {
        if (!is_array($data)) {
            return $data;
        }
        
        $sensitive_keys = [
            'password', 'senha', 'token', 'access_token', 'secret', 'credit_card', 
            'cc_number', 'card_number', 'cvv', 'cvc', 'user_pass', 'pass'
        ];
        
        $sanitized = [];
        foreach ($data as $key => $value) {
            $key_lower = strtolower($key);
            
            if (is_array($value)) {
                $sanitized[$key] = self::sanitize_sensitive_data($value);
            } else if (in_array($key_lower, $sensitive_keys) || strpos($key_lower, 'password') !== false || strpos($key_lower, 'pass') !== false) {
                $sanitized[$key] = '***REDACTED***';
            } else {
                $sanitized[$key] = $value;
            }
        }
        
        return $sanitized;
    }
    
    /**
     * Registra exceções
     */
    public static function log_exception($exception, $context = []) {
        $error_data = array_merge($context, [
            'message' => $exception->getMessage(),
            'code' => $exception->getCode(),
            'file' => $exception->getFile(),
            'line' => $exception->getLine(),
            'trace' => $exception->getTraceAsString()
        ]);
        
        self::log_error('Exception caught: ' . $exception->getMessage(), $error_data, 'exception');
    }
    
    /**
     * Registra erros de segurança
     */
    public static function log_security_violation($action, $details = []) {
        $error_data = array_merge($details, [
            'ip' => $_SERVER['REMOTE_ADDR'] ?? 'unknown',
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? 'unknown',
            'timestamp' => current_time('mysql')
        ]);
        
        self::log_error("Security violation: {$action}", $error_data, 'security');
        
        // Notifica administradores em caso de violações críticas
        if (in_array($action, ['sql_injection_attempt', 'xss_attempt', 'auth_bypass'])) {
            self::notify_admins_security_violation($action, $error_data);
        }
    }
    
    /**
     * Notifica administradores sobre violações de segurança
     */
    private static function notify_admins_security_violation($action, $data) {
        $admin_email = get_network_option(null, 'admin_email');
        
        $subject = "[ALERTA DE SEGURANÇA] Limiter MKP Pro - {$action}";
        $message = "
        Uma possível violação de segurança foi detectada no plugin Limiter MKP Pro.
        
        Detalhes:
        - Ação: {$action}
        - IP: {$data['ip']}
        - User Agent: {$data['user_agent']}
        - Timestamp: {$data['timestamp']}
        
        Por favor, verifique os logs detalhados e tome as medidas necessárias.
        
        Esta é uma notificação automática do sistema de segurança do Limiter MKP Pro.
        ";
        
        wp_mail($admin_email, $subject, $message);
    }
    
    /**
     * Registra erros de API externa
     */
    public static function log_api_error($api_name, $endpoint, $error, $request_data = []) {
        $error_data = [
            'api_name' => $api_name,
            'endpoint' => $endpoint,
            'error' => $error,
            'request_data' => $request_data,
            'timestamp' => current_time('mysql')
        ];
        
        self::log_error("API error: {$api_name} - {$endpoint}", $error_data, 'api_error');
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-health-check.php e os codigos deste arquivo:
<?php
/**
 * Classe para verificação de saúde do sistema.
 *
 * @since      1.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Health_Check {
    
    /**
     * Executa todas as verificações de saúde.
     *
     * @since    1.2.0
     * @return   array    Resultados das verificações.
     */
    public static function run_checks() {
        return [
            'database_tables' => self::check_database_tables(),
            'woocommerce_integration' => self::check_woocommerce_status(),
            'cron_jobs' => self::check_cron_jobs(),
            'file_permissions' => self::check_file_permissions(),
            'cache_status' => self::check_cache_status()
        ];
    }
    
    /**
     * Verifica se todas as tabelas do banco de dados existem.
     *
     * @since    1.2.0
     * @return   array    Resultado da verificação.
     */
    public static function check_database_tables() {
        global $wpdb;
        
        $tables = [
            'planos',
            'subdominios',
            'solicitacoes',
            'logs',
            'plano_products',
            'tokens'
        ];
        
        $missing_tables = [];
        
        foreach ($tables as $table) {
            $table_name = Limiter_MKP_Pro_Database::get_table_name($table);
            $result = $wpdb->get_var("SHOW TABLES LIKE '$table_name'");
            if ($result != $table_name) {
                $missing_tables[] = $table_name;
            }
        }
        
        return [
            'status' => empty($missing_tables) ? 'ok' : 'error',
            'message' => empty($missing_tables) ? 'Todas as tabelas do banco de dados existem.' : 'Tabelas faltando: ' . implode(', ', $missing_tables),
            'details' => $missing_tables
        ];
    }
    
    /**
     * Verifica o status da integração com WooCommerce.
     *
     * @since    1.2.0
     * @return   array    Resultado da verificação.
     */
    public static function check_woocommerce_status() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
        
        $wc_active = Limiter_MKP_Pro_WooCommerce_Integration::is_woocommerce_active();
        $subs_active = Limiter_MKP_Pro_WooCommerce_Integration::is_subscriptions_active();
        
        $status = 'warning';
        $message = 'WooCommerce não está ativo.';
        
        if ($wc_active && $subs_active) {
            $status = 'ok';
            $message = 'WooCommerce e Subscriptions estão ativos e funcionando.';
        } elseif ($wc_active && !$subs_active) {
            $status = 'warning';
            $message = 'WooCommerce está ativo mas Subscriptions não está.';
        }
        
        return [
            'status' => $status,
            'message' => $message,
            'details' => [
                'woocommerce_active' => $wc_active,
                'subscriptions_active' => $subs_active
            ]
        ];
    }
    
    /**
     * Verifica se os cron jobs estão agendados.
     *
     * @since    1.2.0
     * @return   array    Resultado da verificação.
     */
    public static function check_cron_jobs() {
        $crons = _get_cron_array();
        $our_crons = [];
        
        foreach ($crons as $timestamp => $cronhooks) {
            foreach ($cronhooks as $hook => $keys) {
                if (strpos($hook, 'limiter_mkp_pro') !== false) {
                    $our_crons[] = $hook;
                }
            }
        }
        
        $expected_crons = ['limiter_mkp_pro_cron_daily'];
        $missing_crons = array_diff($expected_crons, $our_crons);
        
        return [
            'status' => empty($missing_crons) ? 'ok' : 'warning',
            'message' => empty($missing_crons) ? 'Todos os cron jobs estão agendados.' : 'Cron jobs faltando: ' . implode(', ', $missing_crons),
            'details' => [
                'found' => $our_crons,
                'missing' => $missing_crons
            ]
        ];
    }
    
    /**
     * Verifica permissões de arquivos importantes.
     *
     * @since    1.2.0
     * @return   array    Resultado da verificação.
     */
    public static function check_file_permissions() {
        $plugin_dir = LIMITER_MKP_PRO_PLUGIN_DIR;
        $important_files = [
            $plugin_dir . 'limiter-mkp-pro.php',
            $plugin_dir . 'includes/class-database.php',
            $plugin_dir . 'includes/class-woocommerce-integration.php'
        ];
        
        $incorrect_permissions = [];
        
        foreach ($important_files as $file) {
            if (file_exists($file)) {
                $permissions = substr(sprintf('%o', fileperms($file)), -4);
                if ($permissions !== '0644') {
                    $incorrect_permissions[] = [
                        'file' => basename($file),
                        'current' => $permissions,
                        'expected' => '0644'
                    ];
                }
            }
        }
        
        return [
            'status' => empty($incorrect_permissions) ? 'ok' : 'warning',
            'message' => empty($incorrect_permissions) ? 'Permissões de arquivo estão corretas.' : 'Alguns arquivos têm permissões incorretas.',
            'details' => $incorrect_permissions
        ];
    }
    
    /**
     * Verifica o status do cache.
     *
     * @since    1.2.0
     * @return   array    Resultado da verificação.
     */
    public static function check_cache_status() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
        
        // Testa o cache
        $test_key = 'health_check_test';
        $test_value = 'test_value';
        
        $set_result = Limiter_MKP_Pro_Cache_Manager::set($test_key, $test_value, 60);
        $get_result = Limiter_MKP_Pro_Cache_Manager::get($test_key);
        $delete_result = Limiter_MKP_Pro_Cache_Manager::delete($test_key);
        
        $cache_working = ($set_result && $get_result === $test_value && $delete_result);
        
        return [
            'status' => $cache_working ? 'ok' : 'error',
            'message' => $cache_working ? 'Sistema de cache está funcionando.' : 'Sistema de cache com problemas.',
            'details' => [
                'set_works' => $set_result,
                'get_works' => ($get_result === $test_value),
                'delete_works' => $delete_result
            ]
        ];
    }
    
    /**
     * Gera um relatório completo de saúde.
     *
     * @since    1.2.0
     * @return   string    Relatório em formato de texto.
     */
    public static function generate_report() {
        $checks = self::run_checks();
        $report = "=== RELATÓRIO DE SAÚDE - LIMITER MKP PRO ===\n";
        $report .= "Data: " . current_time('mysql') . "\n\n";
        
        foreach ($checks as $check_name => $result) {
            $status_icon = $result['status'] === 'ok' ? '✅' : ($result['status'] === 'warning' ? '⚠️' : '❌');
            $report .= "{$status_icon} " . strtoupper(str_replace('_', ' ', $check_name)) . "\n";
            $report .= "   Status: {$result['message']}\n";
            
            if (!empty($result['details'])) {
                $report .= "   Detalhes: " . json_encode($result['details']) . "\n";
            }
            $report .= "\n";
        }
        
        return $report;
    }
}


----------------------------------------------------------------------------------------
limiter-mkp-pro/includes/class-helper-functions.php e os codigos deste arquivo:
<?php
if (!defined('ABSPATH')) exit;

class Limiter_MKP_Pro_Helper_Functions {
    
    /**
     * Conta arquivos (inodes) na pasta de uploads
     */
    public static function count_files($dir) {
        if (!is_dir($dir)) return 0;
        $count = 0;
        $iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir, FilesystemIterator::SKIP_DOTS));
        foreach ($iterator as $file) {
            $count++;
        }
        return $count;
    }
    
    /**
     * Detecta o plano ativo do usuário via WooCommerce Subscriptions
     */
    public static function get_user_plan($user_id = null) {
        if (!class_exists('WC_Subscriptions') || !function_exists('wcs_get_users_subscriptions')) return 'starter';
        if (!$user_id) $user_id = get_current_user_id();
        $subscriptions = wcs_get_users_subscriptions($user_id);
        if (empty($subscriptions)) return 'starter';
        foreach ($subscriptions as $sub) {
            if ($sub->has_status('active')) {
                $plan_name = strtolower($sub->get_items()[0]->get_name());
                if (strpos($plan_name, 'pro') !== false) return 'pro';
                if (strpos($plan_name, 'business') !== false || strpos($plan_name, 'bussiness') !== false) return 'business';
                return 'starter';
            }
        }
        return 'starter';
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-i18n.php e os codigos deste arquivo:
<?php
/**
 * Define a funcionalidade de internacionalização do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

class Limiter_MKP_Pro_i18n {

    /**
     * Carrega o domínio de texto do plugin para tradução.
     *
     * @since    1.0.0
     */
    public function load_plugin_textdomain() {
        load_plugin_textdomain(
            'limiter-mkp-pro',
            false,
            dirname(dirname(plugin_basename(__FILE__))) . '/languages/'
        );
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-inode-counter.php e os codigos deste arquivo:
<?php
/**
 * Classe otimizada para contagem de Inodes (Arquivos Reais)
 * Considera Arquivo Original + Variações de Tamanho (Miniaturas)
 * * @since 2.2.0
 * @package Limiter_MKP_Pro
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Inode_Counter {
    
    /**
     * Nome da opção no banco de dados para cache do contador
     */
    const OPTION_NAME = 'limiter_mkp_pro_inode_count';

    public function __construct() {
        // MUDANÇA: Usamos o filtro de metadados. Ele roda logo após o WP criar as miniaturas.
        // Isso garante que sabemos exatamente quantos arquivos físicos foram gerados.
        add_filter('wp_generate_attachment_metadata', [$this, 'increment_smart_count'], 10, 2);
        
        // Hook para quando um anexo é deletado
        add_action('delete_attachment', [$this, 'decrement_smart_count']);
        
        // Verificações de limite (Mantidas)
        add_action('admin_init', [$this, 'check_inodes']);
        add_action('init', [$this, 'check_inodes_frontend']);
    }
    
    /**
     * Incrementa o contador baseando-se nos arquivos REAIS gerados.
     * Soma: 1 (Original) + N (Miniaturas listadas nos metadados)
     */
    public function increment_smart_count($metadata, $attachment_id) {
        // Começamos com 1, que representa o arquivo original enviado
        $files_generated = 1;

        // Se houver tamanhos gerados (thumbnails), somamos eles à contagem
        if (isset($metadata['sizes']) && is_array($metadata['sizes'])) {
            $files_generated += count($metadata['sizes']);
        }

        // Obtém o contador atual e soma os novos arquivos
        $current = $this->get_inode_count();
        update_option(self::OPTION_NAME, $current + $files_generated, false); // autoload=false para performance

        // Retorna os metadados inalterados (obrigatório para filtros WP)
        return $metadata;
    }

    /**
     * Decrementa o contador considerando as miniaturas que serão apagadas.
     */
    public function decrement_smart_count($post_id) {
        $files_deleted = 1; // O arquivo original

        // Recupera os metadados ANTES de serem deletados para saber quantas cópias existiam
        $metadata = wp_get_attachment_metadata($post_id);

        if ($metadata && isset($metadata['sizes']) && is_array($metadata['sizes'])) {
            $files_deleted += count($metadata['sizes']);
        }

        $current = $this->get_inode_count();
        // Garante que não fique negativo
        $new_count = max(0, $current - $files_deleted);
        
        update_option(self::OPTION_NAME, $new_count, false);
    }

    /**
     * Obtém a contagem atual de forma OTIMIZADA.
     * Lê do cache (option). Se não existir, faz uma contagem básica no DB como fallback.
     *
     * @return int Número de arquivos
     */
    public function get_inode_count() {
        $count = get_option(self::OPTION_NAME);

        // Se o contador não existe (primeira instalação ou cache limpo)
        if ($count === false) {
            global $wpdb;
            // FALLBACK INICIAL: Conta apenas os anexos (1 por 1).
            // Nota: Isso subestima o valor real até que um recálculo total seja feito,
            // mas evita travar o servidor tentando ler metadados de tudo de uma vez.
            $count = (int) $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->posts} WHERE post_type = 'attachment'");
            
            // Salva esse valor inicial
            update_option(self::OPTION_NAME, $count, false);
        }

        return (int) $count;
    }
    
    /**
     * Verifica limites de inodes no admin (Painel)
     */
    public function check_inodes() {
        if (!is_multisite() || !Limiter_MKP_Pro_Security::is_blog_admin()) {
            return;
        }
        
        // Verificação rápida de cache estático para evitar múltiplas chamadas na mesma página
        static $checked = false;
        if ($checked) return;
        $checked = true;

        $blog_id = get_current_blog_id();
        
        // Obtém limite do banco
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $subdominio = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        
        if (!$subdominio) return;
        
        $plano = Limiter_MKP_Pro_Database::get_plano($subdominio->plano_id);
        if (!$plano) return;

        // Define o limite (Personalizado ou do Plano)
        $limite_inodes = !empty($subdominio->limite_personalizado_inodes) ?
                         $subdominio->limite_personalizado_inodes : 
                         $plano->limite_inodes;

        if (empty($limite_inodes)) return;
        
        // Usa o método otimizado
        $count = $this->get_inode_count();

        // Atualiza a option auxiliar para uso em widgets/shortcodes
        update_option('limiter_mkp_pro_inode_limit', $limite_inodes, false);

        $this->show_admin_notices($count, $limite_inodes, $plano->nome);
    }
    
    /**
     * Verifica limites de inodes no frontend (Bloqueio de Upload - async-upload.php)
     */
    public function check_inodes_frontend() {
        if (!is_user_logged_in()) return;

        // Só roda se estiver tentando acessar mídia ou upload
        if (!is_admin() && strpos($_SERVER['REQUEST_URI'], 'async-upload.php') === false) {
            return;
        }

        $blog_id = get_current_blog_id();
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        $subdominio = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$subdominio) return;
        
        $plano = Limiter_MKP_Pro_Database::get_plano($subdominio->plano_id);
        if (!$plano) return;
        
        $limite_inodes = !empty($subdominio->limite_personalizado_inodes) ?
                         $subdominio->limite_personalizado_inodes : 
                         $plano->limite_inodes;

        if (empty($limite_inodes)) return;
        
        $count = $this->get_inode_count();

        // Bloqueia uploads se limite atingido
        if ($count >= $limite_inodes) {
            add_filter('user_has_cap', function($allcaps) {
                $allcaps['upload_files'] = false;
                return $allcaps;
            });
        }
    }
    
    /**
     * Exibe notificações no admin baseado no uso de inodes
     */
    private function show_admin_notices($count, $limit, $plan_name) {
        if ($limit <= 0) return;
        $percent = round(($count / $limit) * 100);
        
        // Alerta 80%
        if ($count >= ($limit * 0.8) && $count < $limit) {
            add_action('admin_notices', function() use ($count, $limit, $plan_name, $percent) {
                $class = 'notice notice-warning is-dismissible';
                $message = sprintf(
                    __('<strong>⚠️ Aviso de Armazenamento:</strong> Você usou %s%% do seu limite de arquivos (%s de %s). Plano: %s.', 'limiter-mkp-pro'),
                    $percent, $count, $limit, ucfirst($plan_name)
                );
                printf('<div class="%1$s"><p>%2$s</p></div>', esc_attr($class), $message);
            });
        }
        
        // Bloqueio total (100%)
        if ($count >= $limit) {
            add_action('admin_notices', function() use ($limit, $count, $plan_name) {
                $class = 'notice notice-error';
                $message = sprintf(
                    __('<strong>🚫 Limite de arquivos atingido:</strong> Você possui %s de %s arquivos permitidos no plano %s. O envio de novas mídias foi bloqueado. Por favor, exclua arquivos antigos ou faça um upgrade.', 'limiter-mkp-pro'),
                    $count, $limit, ucfirst($plan_name)
                );
                printf('<div class="%1$s"><p>%2$s</p></div>', esc_attr($class), $message);
            });
        }
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-inode-emails.php e os codigos deste arquivo:
<?php
if (!defined('ABSPATH')) exit;

class Limiter_MKP_Pro_Inode_Emails {
    public function __construct() {
        add_action('admin_init', [$this, 'check_email_alert']);
    }
    
    public function check_email_alert() {
        $count = get_option('limiter_mkp_pro_inode_count', 0);
        $limit = get_option('limiter_mkp_pro_inode_limit', 1000);
        $percent = round(($count / $limit) * 100);
        
        if (in_array($percent, [80, 100])) {
            $this->send_email($percent, $count, $limit);
        }
    }
    
    private function send_email($percent, $count, $limit) {
        $admin_email = get_option('admin_email');
        $network_admin = get_site_option('admin_email');
        $subject = "Aviso: Limite de Inodes ({$percent}%) atingido";
        $message = "Seu site atingiu {$percent}% do limite de arquivos: {$count}/{$limit}.
Recomenda-se revisar as mídias ou atualizar o plano.";
        wp_mail([$admin_email, $network_admin], $subject, $message);
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-inode-shortcodes.php e os codigos deste arquivo:
<?php
if (!defined('ABSPATH')) exit;

class Limiter_MKP_Pro_Inode_Shortcodes {
    
    public function __construct() {
        add_shortcode('inode_usage', [$this, 'usage']);
        add_shortcode('inode_limit', [$this, 'limit']);
        add_shortcode('inode_percent', [$this, 'percent']);
        add_shortcode('inode_bar', [$this, 'bar']);
        add_shortcode('inode_panel', [$this, 'panel']);
    }
    
    private function get_data() {
        $count = get_option('limiter_mkp_pro_inode_count', 0);
        $limit = get_option('limiter_mkp_pro_inode_limit', 1000);
        $percent = min(100, round(($count / $limit) * 100));
        return compact('count', 'limit', 'percent');
    }
    
    public function usage() {
        return $this->get_data()['count'];
    }
    
    public function limit() {
        return $this->get_data()['limit'];
    }
    
    public function percent() {
        return $this->get_data()['percent'] . '%';
    }
    
    public function bar() {
        $p = $this->get_data()['percent'];
        return '<div class="limiter-mkp-pro-progress-bar"><div class="limiter-mkp-pro-progress" style="width:' . $p . '%"></div></div>';
    }
    
    public function panel() {
        $data = $this->get_data();
        ob_start(); ?>
        <div class="limiter-mkp-pro-inode-panel" style="background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #ddd; margin: 10px 0;">
            <h4 style="margin-top: 0;"><?php _e('Uso de Arquivos', 'limiter-mkp-pro'); ?></h4>
            <p><strong><?php _e('Arquivos usados:', 'limiter-mkp-pro'); ?></strong> <?php echo $data['count']; ?> / <?php echo $data['limit']; ?> (<?php echo $data['percent']; ?>%)</p>
            <?php echo $this->bar(); ?>
        </div>
        <?php return ob_get_clean();
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-lifecycle-manager.php e os codigos deste arquivo:
<?php
/**
 * Classe principal de gerenciamento do ciclo de vida
 * OTIMIZADA COM PROCESSAMENTO EM FILA E PROTEÇÃO DE USUÁRIOS
 * * @since 2.1.0
 * @package Limiter_MKP_Pro
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Lifecycle_Manager {
    
    /**
     * Status personalizados do plugin
     */
    const BLOG_STATUS_ACTIVE = 'active';
    const BLOG_STATUS_GRACE_PERIOD = 'grace_period';
    const BLOG_STATUS_SUSPENDED = 'suspended';
    const BLOG_STATUS_LOCKED = 'locked';
    const BLOG_STATUS_SCHEDULED_DELETION = 'scheduled_deletion';
    const BLOG_STATUS_ARCHIVED = 'archived';

    /**
     * Configurações da Fila
     */
    const QUEUE_OPTION_NAME = 'limiter_mkp_lifecycle_queue';
    const BATCH_SIZE = 30; // Processa 30 sites por vez
    
    /**
     * Ações disponíveis
     */
    const ACTION_NOTIFY = 'notify';
    const ACTION_SUSPEND = 'suspend';
    const ACTION_LOCK = 'lock';
    const ACTION_SCHEDULE_DELETION = 'schedule_deletion';
    const ACTION_DELETE = 'delete';
    const ACTION_RESTORE = 'restore';

    /**
     * Inicializa o sistema
     */
    public static function init() {
        // Hooks do WordPress
        add_action('limiter_mkp_pro_daily_cron', [__CLASS__, 'init_daily_queue']);
        add_action('limiter_mkp_pro_process_queue', [__CLASS__, 'process_queue_batch']);
        add_action('template_redirect', [__CLASS__, 'check_blog_access'], 1);

        // Hooks do WooCommerce
        if (class_exists('WC_Subscriptions')) {
            self::init_woocommerce_hooks();
        }
        
        // Agenda o cron job diário se não existir
        self::schedule_cron();
    }
    
    /**
     * Inicializa hooks do WooCommerce
     */
    private static function init_woocommerce_hooks() {
        add_action('woocommerce_subscription_status_updated', [__CLASS__, 'handle_subscription_status_change'], 10, 3);
        add_action('woocommerce_subscription_payment_failed', [__CLASS__, 'handle_payment_failed'], 10, 2);
        add_action('woocommerce_subscription_payment_complete', [__CLASS__, 'handle_payment_complete'], 10, 2);
        add_action('woocommerce_subscription_cancelled', [__CLASS__, 'handle_cancellation'], 10, 2);
        add_action('woocommerce_subscription_expired', [__CLASS__, 'handle_expiration'], 10, 2);
    }
    
    /**
     * Agenda o cron job diário
     */
    public static function schedule_cron() {
        if (!wp_next_scheduled('limiter_mkp_pro_daily_cron')) {
            wp_schedule_event(time(), 'daily', 'limiter_mkp_pro_daily_cron');
        }
    }
    
    /**
     * Remove o cron job
     */
    public static function unschedule_cron() {
        $timestamp = wp_next_scheduled('limiter_mkp_pro_daily_cron');
        if ($timestamp) {
            wp_unschedule_event($timestamp, 'limiter_mkp_pro_daily_cron');
        }
        // Limpa também o agendamento da fila se houver
        $queue_timestamp = wp_next_scheduled('limiter_mkp_pro_process_queue');
        if ($queue_timestamp) {
            wp_unschedule_event($queue_timestamp, 'limiter_mkp_pro_process_queue');
        }
        delete_option(self::QUEUE_OPTION_NAME);
    }
    
    /**
     * PASSO 1: Inicia a Fila Diária
     */
    public static function init_daily_queue() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';

        $blogs = Limiter_MKP_Pro_Database::get_all_blogs_with_subscriptions();
        $blog_ids = array();
        
        foreach ($blogs as $blog) {
            $blog_ids[] = $blog->blog_id;
        }
        
        if (!empty($blog_ids)) {
            update_option(self::QUEUE_OPTION_NAME, $blog_ids, false);
            if (!wp_next_scheduled('limiter_mkp_pro_process_queue')) {
                wp_schedule_single_event(time() + 60, 'limiter_mkp_pro_process_queue');
            }
        }
        
        self::process_scheduled_deletions();
    }

    /**
     * PASSO 2: Processa um Lote da Fila
     */
    public static function process_queue_batch() {
        $queue = get_option(self::QUEUE_OPTION_NAME, array());
        if (empty($queue)) {
            return;
        }
        
        $batch = array_splice($queue, 0, self::BATCH_SIZE);

        if (empty($queue)) {
            delete_option(self::QUEUE_OPTION_NAME);
        } else {
            update_option(self::QUEUE_OPTION_NAME, $queue, false);
            wp_schedule_single_event(time() + 120, 'limiter_mkp_pro_process_queue');
        }
        
        foreach ($batch as $blog_id) {
            self::process_blog_lifecycle($blog_id);
        }
    }
    
    public static function run_daily_checks() {
        self::init_daily_queue();
    }
    
    public static function process_scheduled_deletions() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database-lifecycle.php';
        $deleted_blogs = Limiter_MKP_Pro_Database_Lifecycle::process_scheduled_deletions();
        
        if (!empty($deleted_blogs)) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log(
                0,
                'exclusao_automatica_lote',
                "Rotina de limpeza executada. Sites arquivados: " . implode(', ', $deleted_blogs)
            );
        }
    }
    
    public static function process_blog_lifecycle($blog_id) {
        $settings = self::get_settings();
        $subscription = self::get_subscription_for_blog($blog_id);
        
        if (!$subscription) {
            return;
        }
        
        $wc_status = $subscription->get_status();
        $days_in_status = self::get_days_in_current_status($blog_id);
        
        switch ($wc_status) {
            case 'on-hold':
            case 'failed':
            case 'past-due':
                self::process_payment_failure($blog_id, $subscription, $settings, $days_in_status);
                break;
                
            case 'cancelled':
                self::process_cancellation($blog_id, $subscription, $settings, $days_in_status);
                break;
                
            case 'expired':
                self::process_expiration($blog_id, $subscription, $settings, $days_in_status);
                break;
                
            case 'pending-cancel':
                self::process_pending_cancellation($blog_id, $subscription, $settings, $days_in_status);
                break;
                
            case 'active':
                self::process_active_status($blog_id, $subscription, $settings);
                break;
        }
    }
    
    private static function process_payment_failure($blog_id, $subscription, $settings, $days) {
        $config = $settings['payment_failure'];
        $grace_days = intval($config['grace_period_days']);
        $suspension_days = intval($config['suspension_days']);
        $lock_days = intval($config['lock_days']);
        $deletion_days = intval($config['deletion_days']);

        if ($days <= $grace_days) {
            if ($days == 1) self::notify($blog_id, 'payment_failed_day1', $subscription);
            self::update_blog_status($blog_id, self::BLOG_STATUS_GRACE_PERIOD);
            
        } elseif ($days <= ($grace_days + $suspension_days)) {
            if ($days == $grace_days + 1) {
                self::suspend_blog($blog_id);
                self::notify($blog_id, 'suspension_activated', $subscription);
            }
            self::update_blog_status($blog_id, self::BLOG_STATUS_SUSPENDED);

        } elseif ($days <= ($grace_days + $suspension_days + $lock_days)) {
            if ($days == $grace_days + $suspension_days + 1) {
                self::lock_blog($blog_id);
                self::notify($blog_id, 'lock_activated', $subscription);
            }
            self::update_blog_status($blog_id, self::BLOG_STATUS_LOCKED);

        } else {
            $current_status = self::get_blog_status($blog_id);
            if ($current_status !== self::BLOG_STATUS_SCHEDULED_DELETION) {
                $deletion_date = date('Y-m-d', strtotime("+{$deletion_days} days"));
                self::schedule_deletion($blog_id, $deletion_date);
                self::notify($blog_id, 'scheduled_for_deletion', $subscription);
                self::update_blog_status($blog_id, self::BLOG_STATUS_SCHEDULED_DELETION);
            }
        }
    }
    
    private static function process_cancellation($blog_id, $subscription, $settings, $days) {
        $config = $settings['cancellation'];
        if (!empty($config['immediate_suspend']) && $days == 0) {
            self::suspend_blog($blog_id);
            self::notify($blog_id, 'cancellation_immediate', $subscription);
        }
        
        $admin_days = intval($config['admin_access_days']);
        $del_days = intval($config['deletion_days']);
        
        if ($days <= $admin_days) {
            self::update_blog_status($blog_id, self::BLOG_STATUS_SUSPENDED);
        } elseif ($days <= ($admin_days + $del_days)) {
            if ($days == $admin_days + 1) {
                self::lock_blog($blog_id);
            }
            self::update_blog_status($blog_id, self::BLOG_STATUS_LOCKED);
        } else {
            $current_status = self::get_blog_status($blog_id);
            if ($current_status !== self::BLOG_STATUS_SCHEDULED_DELETION) {
                $deletion_date = date('Y-m-d', strtotime("+{$del_days} days"));
                self::schedule_deletion($blog_id, $deletion_date);
                self::update_blog_status($blog_id, self::BLOG_STATUS_SCHEDULED_DELETION);
            }
        }
    }
    
    private static function process_expiration($blog_id, $subscription, $settings, $days) {
        self::process_cancellation($blog_id, $subscription, $settings, $days);
    }
    
    private static function process_pending_cancellation($blog_id, $subscription, $settings, $days) {
        self::update_blog_status($blog_id, self::BLOG_STATUS_ACTIVE);
    }
    
    private static function process_active_status($blog_id, $subscription, $settings) {
        $current_status = self::get_blog_status($blog_id);
        
        if (in_array($current_status, [
            self::BLOG_STATUS_GRACE_PERIOD,
            self::BLOG_STATUS_SUSPENDED,
            self::BLOG_STATUS_LOCKED,
            self::BLOG_STATUS_SCHEDULED_DELETION
        ])) {
            self::restore_blog($blog_id);
            self::notify($blog_id, 'subscription_reactivated', $subscription);
        }
        
        self::update_blog_status($blog_id, self::BLOG_STATUS_ACTIVE);
    }
    
    /**
     * Ações do Sistema - Métodos Modificados para Proteção de Usuários
     */
    
    public static function suspend_blog($blog_id) {
        update_blog_option($blog_id, 'limiter_blog_suspended', true);
        update_blog_option($blog_id, 'limiter_blog_suspended_date', current_time('mysql'));
        self::log_action($blog_id, self::ACTION_SUSPEND, 'Blog suspenso visualmente');
    }
    
    /**
     * Bloqueia o blog e remove usuários, MAS salva backup para restauração.
     */
    public static function lock_blog($blog_id) {
        $users = get_users(['blog_id' => $blog_id]);
        $users_to_restore = [];

        foreach ($users as $user) {
            if (!is_super_admin($user->ID)) {
                // CORREÇÃO: Salva os dados do usuário antes de remover
                $user_object = new WP_User($user->ID, '', $blog_id);
                $users_to_restore[$user->ID] = $user_object->roles;

                remove_user_from_blog($user->ID, $blog_id);
            }
        }

        // Salva o backup dos usuários removidos
        update_blog_option($blog_id, 'limiter_locked_users_backup', $users_to_restore);

        update_blog_option($blog_id, 'limiter_blog_locked', true);
        update_blog_option($blog_id, 'limiter_blog_locked_date', current_time('mysql'));
        
        self::log_action($blog_id, self::ACTION_LOCK, 'Blog bloqueado e usuários removidos temporariamente (Backup salvo)');
    }
    
    public static function schedule_deletion($blog_id, $deletion_date) {
        update_blog_option($blog_id, 'limiter_scheduled_deletion_date', $deletion_date);
        self::log_action($blog_id, self::ACTION_SCHEDULE_DELETION, "Exclusão agendada para {$deletion_date}");
    }
    
    /**
     * Restaura o blog e readiciona os usuários salvos.
     */
    public static function restore_blog($blog_id) {
        delete_blog_option($blog_id, 'limiter_blog_suspended');
        delete_blog_option($blog_id, 'limiter_blog_locked');
        delete_blog_option($blog_id, 'limiter_scheduled_deletion_date');
        delete_blog_option($blog_id, 'limiter_blog_suspended_date');
        delete_blog_option($blog_id, 'limiter_blog_locked_date'); 
        
        // CORREÇÃO: Restaura os usuários que foram removidos no bloqueio
        $locked_users = get_blog_option($blog_id, 'limiter_locked_users_backup', []);
        
        if (!empty($locked_users) && is_array($locked_users)) {
            foreach ($locked_users as $user_id => $roles) {
                // Tenta restaurar a role original, senão define como administrator
                $role = !empty($roles) ? reset($roles) : 'administrator';
                add_user_to_blog($blog_id, $user_id, $role);
            }
            // Limpa o backup após restaurar
            delete_blog_option($blog_id, 'limiter_locked_users_backup');
            $restored_count = count($locked_users);
        } else {
            $restored_count = 0;
        }
        
        update_blog_status($blog_id, 'public', 1);
        self::log_action($blog_id, self::ACTION_RESTORE, "Blog restaurado para status normal ({$restored_count} usuários recuperados)");
    }
    
    public static function check_blog_access() {
        if (!is_multisite()) return;
        $blog_id = get_current_blog_id();
        
        if (get_blog_option($blog_id, 'limiter_blog_suspended')) {
            if (!current_user_can('manage_network') && !is_admin()) {
                self::show_suspension_page($blog_id);
            }
        }
    }
    
    private static function show_suspension_page($blog_id) {
        $settings = self::get_settings();
        $template = $settings['suspension_page_template'] ?: self::get_default_suspension_template();
        
        $template = str_replace(
            ['[BLOG_NAME]', '[SUPPORT_EMAIL]', '[PLANS_URL]'],
            [get_bloginfo('name'), $settings['support_email'], $settings['plans_url']],
            $template
        );

        status_header(503);
        nocache_headers();
        
        die($template);
    }
    
    /**
     * Helpers e Utilitários
     */
    public static function notify($blog_id, $event, $subscription = null) {
        $settings = self::get_settings();
        if (empty($settings['email_templates'][$event])) return;
        
        $template = $settings['email_templates'][$event];
        $blog_details = get_blog_details($blog_id);
        
        $data = [
            'blog_name' => $blog_details->blogname,
            'blog_url' => $blog_details->siteurl,
            'customer_name' => get_blog_option($blog_id, 'limiter_nome_cliente', 'Cliente'),
            'customer_email' => get_blog_option($blog_id, 'limiter_email_cliente', ''),
            'days_remaining' => self::get_days_until_next_action($blog_id), 
            'suspension_date' => get_blog_option($blog_id, 'limiter_blog_suspended_date', ''),
            'deletion_date' => get_blog_option($blog_id, 'limiter_scheduled_deletion_date', '')
        ];
        
        $subject = self::replace_placeholders($template['subject'], $data);
        $message = self::replace_placeholders($template['message'], $data);
        
        if ($data['customer_email']) {
            wp_mail($data['customer_email'], $subject, $message);
        }
        
        if (!empty($settings['notification_emails'])) {
            $emails = explode(',', $settings['notification_emails']);
            foreach ($emails as $email) {
                if (is_email(trim($email))) wp_mail(trim($email), "[CÓPIA] {$subject}", $message);
            }
        }
        
        self::log_action($blog_id, self::ACTION_NOTIFY, "Notificação '{$event}' enviada");
    }
    
    public static function handle_subscription_status_change($subscription, $new_status, $old_status) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        if ($blog_id) {
            update_blog_option($blog_id, 'limiter_subscription_status', $new_status);
            update_blog_option($blog_id, 'limiter_subscription_status_date', current_time('mysql'));
        }
    }
    
    private static function get_subscription_for_blog($blog_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
        return Limiter_MKP_Pro_WooCommerce_Integration::get_subscription_for_blog($blog_id);
    }
    
    private static function get_blog_id_from_subscription($subscription) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-subscription-hooks.php';
        return Limiter_MKP_Pro_WooCommerce_Subscription_Hooks::get_blog_id_from_subscription($subscription);
    }
    
    private static function get_blog_status($blog_id) {
        return get_blog_option($blog_id, 'limiter_blog_status', self::BLOG_STATUS_ACTIVE);
    }
    
    private static function update_blog_status($blog_id, $status) {
        if (self::get_blog_status($blog_id) !== $status) {
            update_blog_option($blog_id, 'limiter_blog_status', $status);
            update_blog_option($blog_id, 'limiter_blog_status_date', current_time('mysql'));
        }
    }
    
    private static function get_days_in_current_status($blog_id) {
        $date = get_blog_option($blog_id, 'limiter_subscription_status_date');
        if (!$date) return 0;
        $now = new DateTime(current_time('mysql'));
        $then = new DateTime($date);
        return $then->diff($now)->days;
    }
    
    /**
     * Correção: Calcula os dias reais para a próxima ação
     */
    private static function get_days_until_next_action($blog_id) {
        $status = self::get_blog_status($blog_id);
        $settings = self::get_settings();
        $days_in_status = self::get_days_in_current_status($blog_id);
        
        // Padrão para evitar erros
        $remaining = 0;

        switch ($status) {
            case self::BLOG_STATUS_ACTIVE: // Se acabou de falhar o pagamento
                $remaining = intval($settings['payment_failure']['grace_period_days']) - $days_in_status;
                break;
            case self::BLOG_STATUS_GRACE_PERIOD:
                $total_days = intval($settings['payment_failure']['grace_period_days']) + intval($settings['payment_failure']['suspension_days']);
                $remaining = $total_days - $days_in_status;
                break;
            case self::BLOG_STATUS_SUSPENDED:
                $remaining = intval($settings['payment_failure']['lock_days']); // Simplificação
                break;
            default:
                $remaining = 7;
        }

        return max(0, $remaining);
    }
    
    public static function get_settings() {
        $defaults = [
            'payment_failure' => ['grace_period_days' => 7, 'suspension_days' => 7, 'lock_days' => 14, 'deletion_days' => 30],
            'cancellation' => ['immediate_suspend' => true, 'admin_access_days' => 7, 'deletion_days' => 30],
            'notification_emails' => get_option('admin_email'),
            'support_email' => 'suporte@marketing-place.store',
            'plans_url' => home_url('/planos/'),
            'suspension_page_template' => '',
            'email_templates' => self::get_default_email_templates()
        ];
        $settings = get_network_option(null, 'limiter_mkp_pro_lifecycle_settings', []);
        return array_replace_recursive($defaults, $settings);
    }
    
    private static function get_default_email_templates() {
        return [
            'payment_failed_day1' => ['subject' => 'Pagamento Pendente - [BLOG_NAME]', 'message' => "Olá [CUSTOMER_NAME],\n\nSeu pagamento falhou. Você tem 7 dias para regularizar."],
            'suspension_activated' => ['subject' => 'Site Suspenso - [BLOG_NAME]', 'message' => "Olá [CUSTOMER_NAME],\n\nSeu site foi suspenso por falta de pagamento."]
        ];
    }
    
    private static function get_default_suspension_template() {
        return '<!DOCTYPE html><html><head><title>Site Suspenso</title></head><body><h1>Site Suspenso</h1><p>Entre em contato com o suporte: [SUPPORT_EMAIL]</p></body></html>';
    }
    
    private static function replace_placeholders($text, $data) {
        foreach ($data as $key => $value) {
            $text = str_replace("[{$key}]", $value, $text);
            $text = str_replace("[" . strtoupper($key) . "]", $value, $text);
        }
        return $text;
    }
    
    private static function log_action($blog_id, $action, $description) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        Limiter_MKP_Pro_Database::log($blog_id, $action, $description);
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-limiter-mkp-pro.php e os codigos deste arquivo:
<?php
/**
 * A classe principal do plugin.
 *
 * Esta é a classe principal que coordena todas as funcionalidades do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */
if (! defined( 'ABSPATH' ) ) {
    exit;
}

class Limiter_MKP_Pro {

    protected $loader = null;
    protected $plugin_name = 'limiter-mkp-pro';
    protected $version = '2.3.2'; // Versão incrementada para controle

    public function __construct() {
        if ( defined( 'LIMITER_MKP_PRO_VERSION' ) ) {
            $this->version = LIMITER_MKP_PRO_VERSION;
        }
        if ( defined( 'LIMITER_MKP_PRO_PLUGIN_NAME' ) ) {
            $this->plugin_name = LIMITER_MKP_PRO_PLUGIN_NAME;
        }

        $this->load_dependencies();
        $this->set_locale();
        $this->define_admin_hooks();
        $this->define_public_hooks();
    }

    private function load_dependencies() {
        // Loader
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-loader.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-loader.php';
        }
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-i18n.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-i18n.php';
        }
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-security.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-security.php';
        }
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-security-trait.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-security-trait.php';
        }
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-helper-functions.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-helper-functions.php';
        }

        // Modelos
        $models = array(
            'models/class-database.php',
            'models/class-email.php',
            'models/class-database-get-estatisticas.php',
        );
        foreach ( $models as $m ) {
            $path = LIMITER_MKP_PRO_PLUGIN_DIR . $m;
            if ( file_exists( $path ) ) {
                require_once $path;
            }
        }

        // Admin
        $admin_files = array(
            'admin/class-admin.php',
            'admin/class-dashboard.php',
            'admin/class-planos.php',
            'admin/class-subdominios.php',
            'admin/class-configuracoes.php',
            'admin/class-logs.php',
            'admin/class-admin-handlers.php',
        );
        foreach ( $admin_files as $a ) {
            $path = LIMITER_MKP_PRO_PLUGIN_DIR . $a;
            if ( file_exists( $path ) ) {
                require_once $path;
            }
        }

        // Public controllers
        $public_files = array(
            'public/class-public.php',
            'public/class-widget.php',
            'public/class-limiter.php',
            'public/class-registration-form.php',
            'public/class-subdomain-checker.php',
        );
        foreach ( $public_files as $p ) {
            $path = LIMITER_MKP_PRO_PLUGIN_DIR . $p;
            if ( file_exists( $path ) ) {
                require_once $path;
            }
        }

        // Loader
        if ( class_exists( 'Limiter_MKP_Pro_Loader' ) ) {
            $this->loader = new Limiter_MKP_Pro_Loader();
        }
    }

    private function set_locale() {
        if ( ! $this->loader ) return;
        if ( class_exists( 'Limiter_MKP_Pro_i18n' ) ) {
            $plugin_i18n = new Limiter_MKP_Pro_i18n();
            $this->loader->add_action( 'plugins_loaded', $plugin_i18n, 'load_plugin_textdomain' );
        }
    }

    private function define_admin_hooks() {
        if ( ! $this->loader ) return;
        if ( class_exists( 'Limiter_MKP_Pro_Admin' ) ) {
            $plugin_admin = new Limiter_MKP_Pro_Admin( $this->get_plugin_name(), $this->get_version() );
            $this->loader->add_action( 'admin_enqueue_scripts', $plugin_admin, 'enqueue_styles' );
            $this->loader->add_action( 'admin_enqueue_scripts', $plugin_admin, 'enqueue_scripts' );
            $this->loader->add_action( 'network_admin_menu', $plugin_admin, 'add_network_admin_menu' );
        }
        if ( class_exists( 'Limiter_MKP_Pro_Admin_Handlers' ) ) {
            $plugin_handlers = new Limiter_MKP_Pro_Admin_Handlers( $this->get_plugin_name(), $this->get_version() );
            $this->loader->add_action( 'wp_ajax_limiter_mkp_pro_save_plano', $plugin_handlers, 'handle_save_plano' );
            $this->loader->add_action( 'wp_ajax_limiter_mkp_pro_delete_plano', $plugin_handlers, 'handle_delete_plano' );
            $this->loader->add_action( 'wp_ajax_limiter_mkp_pro_save_subdominio', $plugin_handlers, 'handle_save_subdominio' );
            $this->loader->add_action( 'wp_ajax_limiter_mkp_pro_save_configuracoes', $plugin_handlers, 'handle_save_configuracoes' );
        }
    }

    private function define_public_hooks() {
        if ( ! $this->loader ) return;
        if ( class_exists( 'Limiter_MKP_Pro_Public' ) ) {
            $plugin_public = new Limiter_MKP_Pro_Public( $this->get_plugin_name(), $this->get_version() );
            $this->loader->add_action( 'wp_enqueue_scripts', $plugin_public, 'enqueue_styles' );
            $this->loader->add_action( 'wp_enqueue_scripts', $plugin_public, 'enqueue_scripts' );
        }

        if ( class_exists( 'Limiter_MKP_Pro_Widget' ) ) {
            $plugin_widget = new Limiter_MKP_Pro_Widget( $this->get_plugin_name(), $this->get_version() );
            $this->loader->add_action( 'wp_dashboard_setup', $plugin_widget, 'add_dashboard_widget' );
        }

        if ( class_exists( 'Limiter_MKP_Pro_Limiter' ) ) {
            $plugin_limiter = new Limiter_MKP_Pro_Limiter( $this->get_plugin_name(), $this->get_version() );
            $this->loader->add_action( 'save_post', $plugin_limiter, 'check_limit', 10, 3 );
            $this->loader->add_action( 'untrash_post', $plugin_limiter, 'check_limit_untrash', 10, 1 );
        }

        $this->loader->add_action( 'save_post', $this, 'clear_post_count_cache', 20, 2 );
        $this->loader->add_action( 'delete_post', $this, 'clear_post_count_cache', 20, 1 );

        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'public/class-subdomain-configuration.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'public/class-subdomain-configuration.php';
            if ( class_exists( 'Limiter_MKP_Pro_Subdomain_Configuration' ) ) {
                new Limiter_MKP_Pro_Subdomain_Configuration();
            }
        }

        // Gancho diário (O "Gerente") - Agora faz limpeza E backup do sistema
        $this->loader->add_action( 'limiter_mkp_pro_daily_cron', $this, 'handle_cron_tasks' );
        
        if ( class_exists( 'Limiter_MKP_Pro_Inode_Counter' ) ) {
            new Limiter_MKP_Pro_Inode_Counter();
        }

        if ( class_exists( 'Limiter_MKP_Pro_Inode_Shortcodes' ) ) {
            new Limiter_MKP_Pro_Inode_Shortcodes();
        }

        if ( class_exists( 'WC_Subscriptions' ) && file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-subscription-handler.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-subscription-handler.php';
            if ( class_exists( 'Limiter_MKP_Pro_WooCommerce_Subscription_Handler' ) ) {
                new Limiter_MKP_Pro_WooCommerce_Subscription_Handler();
            }
        }

        // Interceptador de upload para verificar cota nativa (MB)
        $this->loader->add_filter('wp_handle_upload_prefilter', $this, 'custom_upload_quota_check');
    }

    /**
     * Verifica a cota de upload e injeta mensagem personalizada se estourar.
     */
    public function custom_upload_quota_check($file) {
        if (!is_multisite() || !is_user_logged_in()) {
            return $file;
        }

        $quota = get_site_option('blog_upload_space'); 
        if (!$quota) {
            $quota = get_blog_option(get_current_blog_id(), 'blog_upload_space');
        }

        if ($quota) {
            $quota_bytes = $quota * 1024 * 1024;
            $used_bytes = get_space_used() * 1024 * 1024; 
            $file_size = $file['size'];

            if (($used_bytes + $file_size) > $quota_bytes) {
                $mensagem = "⚠️ Limite de Armazenamento Excedido!\n\nSeu plano atual permite apenas {$quota}MB.\nPor favor, exclua arquivos antigos ou faça um upgrade para continuar enviando mídias.";
                $file['error'] = $mensagem; 
            }
        }

        return $file;
    }

    /**
     * Tarefas de manutenção diária (Limpeza + Backup do Sistema)
     * ATUALIZADO: Agora com logs detalhados de execução.
     */
    public function handle_cron_tasks() {
        global $wpdb;
        
        // Garante que a classe de banco de dados está carregada para logar
        if (!class_exists('Limiter_MKP_Pro_Database')) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        }

        // ----------------------------------------------------
        // 1. Limpeza de Logs (Log Rotation Otimizado)
        // ----------------------------------------------------
        $table_logs = $wpdb->base_prefix . 'limiter_mkp_pro_logs';
        $total_logs_removidos = 0;
        
        if ($wpdb->get_var("SHOW TABLES LIKE '$table_logs'") === $table_logs) {
            $dias_retencao = 60;
            $data_limite = date('Y-m-d H:i:s', strtotime("-{$dias_retencao} days"));
            
            $lote = 1000;
            do {
                $linhas_afetadas = $wpdb->query(
                    $wpdb->prepare(
                        "DELETE FROM $table_logs WHERE timestamp < %s LIMIT %d",
                        $data_limite,
                        $lote
                    )
                );
                
                if ($linhas_afetadas > 0) {
                    $total_logs_removidos += $linhas_afetadas;
                    usleep(100000); // Pausa leve para não travar CPU
                }
            } while ($linhas_afetadas > 0);

            // LOG DA AÇÃO 1: Registra se houve limpeza
            if ($total_logs_removidos > 0) {
                Limiter_MKP_Pro_Database::log(
                    0, 
                    'manutencao_logs', 
                    "Limpeza automática: {$total_logs_removidos} logs antigos removidos."
                );
            }
        }

        // ----------------------------------------------------
        // 2. Limpeza de tokens expirados
        // ----------------------------------------------------
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-token-manager.php' ) && class_exists( 'Limiter_MKP_Pro_Token_Manager' ) ) {
            try {
                require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-token-manager.php';
                if ( method_exists( 'Limiter_MKP_Pro_Token_Manager', 'cleanup_expired_tokens' ) ) {
                    Limiter_MKP_Pro_Token_Manager::cleanup_expired_tokens();
                }
            } catch ( Throwable $e ) {
                error_log( 'Limiter MKP Pro cron error (tokens cleanup): ' . $e->getMessage() );
            }
        }

        // ----------------------------------------------------
        // 3. Backup Diário das Configurações do Sistema (JSON)
        // ----------------------------------------------------
        if ( file_exists( LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-backup.php' ) ) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-backup.php';
            
            try {
                // Prepara diretório
                $upload_dir = wp_upload_dir();
                $backup_dir = $upload_dir['basedir'] . '/limiter-mkp-pro-backups/';
                if (!file_exists($backup_dir)) {
                    wp_mkdir_p($backup_dir);
                    file_put_contents($backup_dir . '.htaccess', 'deny from all');
                    file_put_contents($backup_dir . 'index.php', '<?php // Silence is golden');
                }

                // Gera JSON com todas as configurações
                $data = Limiter_MKP_Pro_Backup::export_settings(['config', 'plans', 'subs', 'tokens']);
                $filename = 'limiter-system-backup-auto-' . date('Y-m-d') . '.json';
                $file_path = $backup_dir . $filename;

                if (file_put_contents($file_path, json_encode($data, JSON_PRETTY_PRINT))) {
                    // LOG DA AÇÃO 3: Sucesso do Backup
                    Limiter_MKP_Pro_Database::log(
                        0,
                        'backup_sistema_sucesso',
                        "Backup diário de configurações gerado: {$filename}"
                    );
                }

                // Retenção: Mantém apenas os últimos 7 backups de sistema
                $files = glob($backup_dir . 'limiter-system-backup-auto-*.json');
                if ($files && count($files) > 7) {
                    usort($files, function($a, $b) { return filemtime($b) - filemtime($a); });
                    $files_to_delete = array_slice($files, 7);
                    $deleted_count = 0;
                    foreach ($files_to_delete as $file) {
                        if (file_exists($file)) {
                            unlink($file);
                            $deleted_count++;
                        }
                    }
                    if ($deleted_count > 0) {
                         Limiter_MKP_Pro_Database::log(0, 'backup_sistema_limpeza', "Removidos {$deleted_count} backups antigos de sistema.");
                    }
                }

            } catch ( Throwable $e ) {
                $erro_msg = 'Limiter MKP Pro cron error (system backup): ' . $e->getMessage();
                error_log( $erro_msg );
                Limiter_MKP_Pro_Database::log(0, 'backup_sistema_erro', $erro_msg);
            }
        }

        // LOG FINAL: Confirmação de execução total
        Limiter_MKP_Pro_Database::log(
            0,
            'cron_diario_concluido',
            'Rotina diária de manutenção finalizada com sucesso.'
        );
    }

    public function run() {
        if ( $this->loader ) {
            $this->loader->run();
        }
    }

    public function get_plugin_name() {
        return $this->plugin_name;
    }

    public function get_loader() {
        return $this->loader;
    }

    public function get_version() {
        return $this->version;
    }

    public function clear_post_count_cache($post_id, $post = null) {
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
        if (wp_is_post_revision($post_id)) return;

        $blog_id = get_current_blog_id();
        
        if (class_exists('Limiter_MKP_Pro_Database')) {
            Limiter_MKP_Pro_Database::force_update_content_count($blog_id);
            Limiter_MKP_Pro_Database::clear_count_cache($blog_id);
        }
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-loader.php e os codigos deste arquivo:
<?php
/**
 * Registra todos os hooks do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

class Limiter_MKP_Pro_Loader {

    /**
     * O array de ações registradas com WordPress.
     *
     * @since    1.0.0
     * @access   protected
     * @var      array    $actions    As ações registradas com WordPress para executar quando o plugin carrega.
     */
    protected $actions;

    /**
     * O array de filtros registrados com WordPress.
     *
     * @since    1.0.0
     * @access   protected
     * @var      array    $filters    Os filtros registrados com WordPress para executar quando o plugin carrega.
     */
    protected $filters;

    /**
     * Inicializa as coleções usadas para manter as ações e filtros.
     *
     * @since    1.0.0
     */
    public function __construct() {
        $this->actions = array();
        $this->filters = array();
    }

    /**
     * Adiciona uma nova ação ao array de ações a serem registradas com WordPress.
     *
     * @since    1.0.0
     * @param    string               $hook             O nome da ação do WordPress que está sendo registrada.
     * @param    object               $component        Uma referência ao objeto da instância do componente.
     * @param    string               $callback         O nome da função definida no componente.
     * @param    int                  $priority         Opcional. A prioridade na qual a função deve ser executada. Default 10.
     * @param    int                  $accepted_args    Opcional. O número de argumentos que devem ser passados para o callback. Default 1.
     */
    public function add_action($hook, $component, $callback, $priority = 10, $accepted_args = 1) {
        $this->actions = $this->add($this->actions, $hook, $component, $callback, $priority, $accepted_args);
    }

    /**
     * Adiciona um novo filtro ao array de filtros a serem registrados com WordPress.
     *
     * @since    1.0.0
     * @param    string               $hook             O nome do filtro do WordPress que está sendo registrado.
     * @param    object               $component        Uma referência ao objeto da instância do componente.
     * @param    string               $callback         O nome da função definida no componente.
     * @param    int                  $priority         Opcional. A prioridade na qual a função deve ser executada. Default 10.
     * @param    int                  $accepted_args    Opcional. O número de argumentos que devem ser passados para o callback. Default 1.
     */
    public function add_filter($hook, $component, $callback, $priority = 10, $accepted_args = 1) {
        $this->filters = $this->add($this->filters, $hook, $component, $callback, $priority, $accepted_args);
    }

    /**
     * Uma função utilitária que é usada para registrar as ações e hooks em uma única coleção.
     *
     * @since    1.0.0
     * @access   private
     * @param    array                $hooks            A coleção de hooks que está sendo registrada (ou ações ou filtros).
     * @param    string               $hook             O nome do filtro do WordPress que está sendo registrado.
     * @param    object               $component        Uma referência ao objeto da instância do componente.
     * @param    string               $callback         O nome da função definida no componente.
     * @param    int                  $priority         A prioridade na qual a função deve ser executada.
     * @param    int                  $accepted_args    O número de argumentos que devem ser passados para o callback.
     * @return   array                                  A coleção de ações e filtros registrados com WordPress.
     */
    private function add($hooks, $hook, $component, $callback, $priority, $accepted_args) {
        $hooks[] = array(
            'hook'          => $hook,
            'component'     => $component,
            'callback'      => $callback,
            'priority'      => $priority,
            'accepted_args' => $accepted_args
        );

        return $hooks;
    }

    /**
     * Registra os filtros e ações com WordPress.
     *
     * @since    1.0.0
     */
    public function run() {
        foreach ($this->filters as $hook) {
            add_filter($hook['hook'], array($hook['component'], $hook['callback']), $hook['priority'], $hook['accepted_args']);
        }

        foreach ($this->actions as $hook) {
            add_action($hook['hook'], array($hook['component'], $hook['callback']), $hook['priority'], $hook['accepted_args']);
        }
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-rate-limiting.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável por limitar taxas de requisição.
 *
 * @since      1.1.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

class Limiter_MKP_Pro_Rate_Limiting {
    
    /**
     * Verifica se a taxa de requisição foi excedida.
     *
     * @since    1.1.0
     * @param    int       $blog_id    ID do blog.
     * @param    string    $action     Ação sendo realizada.
     * @return   boolean               Verdadeiro se dentro do limite, falso se excedido.
     */
    public static function check_rate_limit($blog_id, $action) {
        $key = "limiter_rate_{$blog_id}_{$action}";
        $attempts = get_transient($key) ?: 0;
        
        if ($attempts > 10) { // 10 tentativas por minuto
            Limiter_MKP_Pro_Database::log(
                $blog_id,
                'rate_limit_exceeded',
                "Muitas tentativas da ação: $action"
            );
            return false;
        }
        
        set_transient($key, $attempts + 1, 60); // 1 minuto
        return true;
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-security.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pela segurança do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

class Limiter_MKP_Pro_Security {

    /**
     * Verifica se o usuário atual é um super administrador.
     *
     * @since    1.0.0
     * @return   boolean    Verdadeiro se o usuário é super admin, falso caso contrário.
     */
    public static function is_super_admin() {
        return is_super_admin();
    }

    /**
     * Verifica se o usuário atual é um administrador do blog.
     *
     * @since    1.0.0
     * @return   boolean    Verdadeiro se o usuário é admin do blog, falso caso contrário.
     */
    public static function is_blog_admin() {
        return current_user_can('manage_options');
    }

    /**
     * Verifica se o nonce é válido.
     *
     * @since    1.0.0
     * @param    string    $nonce      O nonce a ser verificado.
     * @param    string    $action     A ação associada ao nonce.
     * @return   boolean               Verdadeiro se o nonce é válido, falso caso contrário.
     */
    public static function verify_nonce($nonce, $action) {
        return wp_verify_nonce($nonce, $action);
    }

    /**
     * Cria um nonce para uma ação específica.
     *
     * @since    1.0.0
     * @param    string    $action     A ação associada ao nonce.
     * @return   string                O nonce criado.
     */
    public static function create_nonce($action) {
        return wp_create_nonce($action);
    }

    /**
     * Verifica permissões para operações de rede.
     *
     * @since    1.0.0
     * @return   boolean    Verdadeiro se o usuário tem permissões de rede, falso caso contrário.
     */
    public static function check_network_permissions() {
        // Verifica se é uma instalação multisite
        if (!is_multisite()) {
            return false;
        }

        // Verifica se o usuário é super admin
        if (!self::is_super_admin()) {
            return false;
        }

        return true;
    }

    /**
     * Verifica permissões para operações de blog.
     *
     * @since    1.0.0
     * @return   boolean    Verdadeiro se o usuário tem permissões de blog, falso caso contrário.
     */
    public static function check_blog_permissions() {
        // Verifica se o usuário é admin do blog
        if (!self::is_blog_admin()) {
            return false;
        }

        return true;
    }

    /**
     * Sanitiza dados de entrada.
     *
     * @since    1.0.0
     * @param    mixed     $data       Os dados a serem sanitizados.
     * @param    string    $type       O tipo de sanitização a ser aplicada.
     * @return   mixed                 Os dados sanitizados.
     */
    public static function sanitize_data($data, $type = 'text') {
        switch ($type) {
            case 'email':
                return sanitize_email($data);
            case 'url':
                return esc_url_raw($data);
            case 'int':
                return intval($data);
            case 'float':
                return floatval($data);
            case 'textarea':
                return sanitize_textarea_field($data);
            case 'html':
                return wp_kses_post($data);
            case 'text':
            default:
                return sanitize_text_field($data);
        }
    }

    /**
     * Registra uma tentativa de acesso não autorizado.
     *
     * @since    1.0.0
     * @param    string    $action     A ação que foi tentada.
     * @param    int       $blog_id    O ID do blog, se aplicável.
     */
    public static function log_unauthorized_attempt($action, $blog_id = 0) {
        global $wpdb;
        $table_logs = $wpdb->base_prefix . 'limiter_mkp_pro_logs';
        
        // Verifica se a tabela existe antes de tentar inserir
        if ($wpdb->get_var("SHOW TABLES LIKE '$table_logs'") == $table_logs) {
            $wpdb->insert(
                $table_logs,
                array(
                    'blog_id' => $blog_id,
                    'acao' => 'acesso_nao_autorizado',
                    'descricao' => 'Tentativa de acesso não autorizado: ' . $action,
                ),
                array('%d', '%s', '%s')
            );
        }
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-security-audit.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável por auditoria de segurança do plugin.
 *
 * @since      1.1.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

class Limiter_MKP_Pro_Security_Audit {
    
    /**
     * Executa uma verificação de segurança.
     *
     * @since    1.1.0
     * @return   array    Array com os resultados da auditoria.
     */
    public static function run_security_scan() {
        $issues = array();
        
        // Verificar permissões de arquivos
        $issues[] = self::check_file_permissions();
        
        // Verificar se tabelas existem
        $issues[] = self::check_database_tables();
        
        // Verificar usuários suspeitos
        $issues[] = self::check_suspicious_activity();
        
        return $issues;
    }
    
    /**
     * Verifica as permissões de arquivos do plugin.
     *
     * @since    1.1.0
     * @return   array    Resultado da verificação.
     */
    public static function check_file_permissions() {
        $plugin_dir = LIMITER_MKP_PRO_PLUGIN_DIR;
        $required_permissions = 0644;
        
        // Verificar permissões de arquivos .php
        $php_files = glob($plugin_dir . '*.php');
        $issues = array();
        
        foreach ($php_files as $file) {
            $permissions = substr(sprintf('%o', fileperms($file)), -4);
            if ($permissions != '0644') {
                $issues[] = array(
                    'file' => basename($file),
                    'permission' => $permissions,
                    'expected' => '0644'
                );
            }
        }
        
        return array(
            'check' => 'file_permissions',
            'status' => empty($issues) ? 'ok' : 'warning',
            'issues' => $issues
        );
    }
    
    /**
     * Verifica se todas as tabelas do plugin existem.
     *
     * @since    1.1.0
     * @return   array    Resultado da verificação.
     */
    public static function check_database_tables() {
        global $wpdb;
        
        $tables = array(
            'planos',
            'subdominios',
            'solicitacoes',
            'logs',
            'plano_products'
        );
        
        $missing_tables = array();
        
        foreach ($tables as $table) {
            $table_name = Limiter_MKP_Pro_Database::get_table_name($table);
            $result = $wpdb->get_var("SHOW TABLES LIKE '$table_name'");
            if ($result != $table_name) {
                $missing_tables[] = $table_name;
            }
        }
        
        return array(
            'check' => 'database_tables',
            'status' => empty($missing_tables) ? 'ok' : 'error',
            'issues' => $missing_tables
        );
    }
    
    /**
     * Verifica atividade suspeita.
     *
     * @since    1.1.0
     * @return   array    Resultado da verificação.
     */
    public static function check_suspicious_activity() {
        global $wpdb;
        
        $table_logs = Limiter_MKP_Pro_Database::get_table_name('logs');
        
        // Verificar múltiplas tentativas de criação em curto período
        $recent_attempts = $wpdb->get_var(
            "SELECT COUNT(*) FROM $table_logs 
             WHERE acao LIKE '%limite_excedido%' 
             AND timestamp > DATE_SUB(NOW(), INTERVAL 1 HOUR)"
        );
        
        $issues = array();
        
        if ($recent_attempts > 10) {
            $issues[] = "Múltiplas tentativas de bypass detectadas: $recent_attempts na última hora";
        }
        
        return array(
            'check' => 'suspicious_activity',
            'status' => empty($issues) ? 'ok' : 'warning',
            'issues' => $issues
        );
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-security-trait.php e os codigos deste arquivo:
<?php
/**
 * Trait para funcionalidades de segurança.
 *
 * @since      1.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */

if (!defined('ABSPATH')) {
    exit;
}

trait Limiter_MKP_Pro_Security_Trait {
    
    /**
     * Verifica permissões de rede.
     *
     * @since    1.2.0
     * @return   boolean
     */
    public function verify_network_permissions() {
        if (!is_multisite() || !current_user_can('manage_network')) {
            wp_die('Você não tem permissão para acessar esta página.');
        }
        return true;
    }

    /**
     * Verifica permissões de rede para AJAX.
     *
     * @since    1.2.0
     * @return   boolean
     */
    public function verify_ajax_network_permissions() {
        if (!is_multisite() || !current_user_can('manage_network')) {
            wp_send_json_error(['message' => 'Permissão negada.']);
        }
        return true;
    }

    /**
     * Verifica nonce para requisições AJAX.
     *
     * @since    1.2.0
     * @param    string    $nonce    Nonce.
     * @param    string    $action   Ação.
     * @return   boolean
     */
    public function verify_ajax_nonce($nonce, $action) {
        if (!wp_verify_nonce($nonce, $action)) {
            wp_send_json_error(['message' => 'Erro de segurança. Recarregue a página e tente novamente.']);
        }
        return true;
    }

    /**
     * Sanitiza dados de entrada de forma rigorosa.
     *
     * @since    1.2.0
     * @param    mixed     $data    Dados a sanitizar.
     * @param    string    $type    Tipo de sanitização.
     * @return   mixed
     */
    public function sanitize_input($data, $type = 'text') {
        switch ($type) {
            case 'email':
                return sanitize_email($data);
            case 'url':
                return esc_url_raw($data);
            case 'int':
                return intval($data);
            case 'float':
                return floatval($data);
            case 'textarea':
                return sanitize_textarea_field($data);
            case 'html':
                return wp_kses_post($data);
            case 'array':
                if (!is_array($data)) return [];
                return array_map('sanitize_text_field', $data);
            case 'text':
            default:
                return sanitize_text_field($data);
        }
    }

    /**
     * Valida dados de um plano.
     *
     * @since    1.2.0
     * @param    array    $data    Dados do plano.
     * @return   array             Array de erros.
     */
    public function validate_plano_data($data) {
        $errors = [];

        // Nome
        if (empty($data['nome']) || !is_string($data['nome'])) {
            $errors[] = 'O nome do plano é obrigatório.';
        } elseif (strlen($data['nome']) > 100) {
            $errors[] = 'O nome do plano não pode exceder 100 caracteres.';
        }

        // Descrição
        if (!empty($data['descricao']) && strlen($data['descricao']) > 1000) {
            $errors[] = 'A descrição não pode exceder 1000 caracteres.';
        }

        // Duração
        if (empty($data['duracao']) || $data['duracao'] <= 0) {
            $errors[] = 'A duração deve ser maior que zero.';
        } elseif ($data['duracao'] > 3650) {
            $errors[] = 'A duração não pode exceder 3650 dias.';
        }

        // Limite de páginas
        if (empty($data['limite_paginas']) || $data['limite_paginas'] <= 0) {
            $errors[] = 'O limite de páginas deve ser maior que zero.';
        } elseif ($data['limite_paginas'] > 100000) {
            $errors[] = 'O limite de páginas não pode exceder 100.000.';
        }

        return $errors;
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-token-manager.php e os codigos deste arquivo:
<?php
/**
 * Classe para gerenciar tokens de configuração de subdomínios
 */
// Segurança: impede acesso direto ao arquivo
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Token_Manager {
    /**
     * Gera um token vinculado a uma conta de usuário e assinatura
     *
     * @param int    $user_id          ID do usuário
     * @param int    $subscription_id  ID da assinatura no WooCommerce
     * @param string $email            E-mail do usuário
     * @param int    $plano_id         ID do plano no MKP Pro
     * @param string $regiao           Região do usuário (global, jp)
     * @return string|false            Token gerado ou false em caso de erro
     */
    public static function generate_token_with_region($user_id, $subscription_id, $email, $plano_id, $regiao = 'global') {
        global $wpdb;
        $table_tokens = Limiter_MKP_Pro_Database::get_table_name('tokens');
        
        // Valida se tabela existe
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_tokens)) {
            Limiter_MKP_Pro_Error_Handler::log_error('Tabela de tokens inválida na operação generate_token_with_region');
            return false;
        }
        
        // Verifica se já existe um token pendente para este e-mail
        $existing_token = $wpdb->get_var($wpdb->prepare(
            "SELECT token FROM $table_tokens WHERE email = %s AND status = 'pending'",
            $email
        ));
        
        if ($existing_token) {
            return $existing_token;
        }
        
        // Gera novo token (Criptograficamente seguro)
	$token = bin2hex(random_bytes(32));
        $expires_at = date('Y-m-d H:i:s', strtotime('+7 days', current_time('timestamp')));
        
        $result = $wpdb->insert(
            $table_tokens,
            array(
                'user_id' => $user_id,
                'subscription_id' => $subscription_id,
                'token' => $token,
                'email' => $email,
                'plano_id' => $plano_id,
                'regiao' => $regiao,
                'expires_at' => $expires_at,
                'status' => 'pending',
                'created_at' => current_time('mysql')
            ),
            array('%d', '%d', '%s', '%s', '%d', '%s', '%s', '%s', '%s')
        );
        
        if (Limiter_MKP_Pro_Error_Handler::check_db_error($result, 'generate_token', ['user_id' => $user_id, 'email' => $email])) {
            return $token;
        }
        
        return false;
    }
    
    /**
     * Gera um token (versão antiga, mantida para compatibilidade)
     */
    public static function generate_token($user_id, $subscription_id, $email, $plano_id) {
        return self::generate_token_with_region($user_id, $subscription_id, $email, $plano_id, 'global');
    }
    
    /**
     * Valida um token
     * 
     * Verifica se:
     * - Token existe e está válido
     * - Token não expirou
     * - Token ainda não foi usado
     * - Usuário/subdomínio associado está ativo
     */
    public static function validate_token($token) {
        global $wpdb;
        $table_tokens = Limiter_MKP_Pro_Database::get_table_name('tokens');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_tokens)) {
            Limiter_MKP_Pro_Error_Handler::log_error('Tabela de tokens inválida na operação validate_token');
            return null;
        }
        
        $token_data = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table_tokens 
             WHERE token = %s 
             AND status = 'pending' 
             AND expires_at > %s",
            $token,
            current_time('mysql')
        ));
        
        if (!$token_data) {
            Limiter_MKP_Pro_Error_Handler::log_error('Token não encontrado ou inválido', ['token' => $token]);
            return null;
        }
        
        // Verifica se o usuário existe e está ativo
        $user = get_user_by('id', $token_data->user_id);
        if (!$user || !$user->exists()) {
            Limiter_MKP_Pro_Error_Handler::log_error('Usuário não encontrado para o token', ['user_id' => $token_data->user_id, 'token' => $token]);
            return null;
        }
        
        // Verifica se já existe um subdomínio ativo para este usuário
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        if (Limiter_MKP_Pro_Database::validate_table_name($table_subdominios)) {
            $existing_sub = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM $table_subdominios 
                 WHERE user_id = %d AND status = 'active'",
                $token_data->user_id
            ));
            
            if ($existing_sub > 0) {
                // Já possui subdomínio ativo - não permitir novo token
                Limiter_MKP_Pro_Error_Handler::log_error('Usuário já possui subdomínio ativo', ['user_id' => $token_data->user_id, 'token' => $token]);
                return null;
            }
        }
        
        return $token_data;
    }
    
    /**
     * Marca token como usado e salva subdomínio com região
     */
    public static function mark_token_used($token, $subdomain_name) {
        global $wpdb;
        $table_tokens = Limiter_MKP_Pro_Database::get_table_name('tokens');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_tokens)) {
            Limiter_MKP_Pro_Error_Handler::log_error('Tabela de tokens inválida na operação mark_token_used');
            return false;
        }
        
        // Primeiro obtém os dados do token para registrar o subdomínio
        $token_data = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table_tokens WHERE token = %s",
            $token
        ));
        
        if (!$token_data) {
            Limiter_MKP_Pro_Error_Handler::log_error('Token não encontrado para marcar como usado', ['token' => $token]);
            return false;
        }
        
        // Verifica se o token já foi usado
        if ($token_data->status !== 'pending') {
            Limiter_MKP_Pro_Error_Handler::log_error('Tentativa de usar token já utilizado', ['token' => $token, 'status' => $token_data->status]);
            return false;
        }
        
        // Salva no subdomínio com região
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $result = Limiter_MKP_Pro_Database::save_subdominio(array(
            'blog_id' => $token_data->blog_id ?? 0,
            'user_id' => $token_data->user_id,
            'dominio' => $subdomain_name . '.marketing-place.store',
            'plano_id' => $token_data->plano_id,
            'regiao' => $token_data->regiao ?? 'global',
            'status' => 'active'
        ));
        
        if (!$result) {
            Limiter_MKP_Pro_Error_Handler::log_error('Falha ao salvar subdomínio para token', ['token' => $token, 'subdomain_name' => $subdomain_name]);
            return false;
        }
        
        // Atualiza status do token para "used"
        $update_result = $wpdb->update(
            $table_tokens, 
            array('status' => 'used'),
            array('token' => $token),
            array('%s'),
            array('%s')
        );
        
        if (!Limiter_MKP_Pro_Error_Handler::check_db_error($update_result, 'mark_token_used', ['token' => $token])) {
            Limiter_MKP_Pro_Error_Handler::log_error('Falha ao atualizar status do token', ['token' => $token]);
            return false;
        }
        
        // Log de sucesso
        Limiter_MKP_Pro_Database::log(0, 'token_utilizado', "Token utilizado com sucesso para subdomínio: {$subdomain_name}", [
            'token' => $token,
            'user_id' => $token_data->user_id,
            'plano_id' => $token_data->plano_id,
            'regiao' => $token_data->regiao
        ]);
        
        return true;
    }
    
    /**
     * Limpa tokens expirados
     */
    public static function cleanup_expired_tokens() {
        global $wpdb;
        $table_tokens = Limiter_MKP_Pro_Database::get_table_name('tokens');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_tokens)) {
            Limiter_MKP_Pro_Error_Handler::log_error('Tabela de tokens inválida na operação cleanup_expired_tokens');
            return 0;
        }
        
        $result = $wpdb->query(
            "DELETE FROM $table_tokens 
             WHERE expires_at < NOW() 
             AND status = 'pending'"
        );
        
        if ($result !== false) {
            $log_message = "Tokens expirados limpos: {$result}";
            Limiter_MKP_Pro_Database::log(0, 'tokens_limpados', $log_message);
        } else {
            $error_message = "Erro ao limpar tokens expirados: " . $wpdb->last_error;
            Limiter_MKP_Pro_Error_Handler::log_error($error_message);
        }
        
        return $result !== false ? intval($result) : 0;
    }
    
    /**
     * Verifica se já existe um token pendente para um e-mail
     */
    public static function has_pending_token($email) {
        global $wpdb;
        $table_tokens = Limiter_MKP_Pro_Database::get_table_name('tokens');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_tokens)) {
            Limiter_MKP_Pro_Error_Handler::log_error('Tabela de tokens inválida na operação has_pending_token');
            return false;
        }
        
        $count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table_tokens 
             WHERE email = %s AND status = 'pending'",
            $email
        ));
        
        return intval($count) > 0;
    }
    
    /**
     * Obtém o sufixo de subdomínio configurado
     */
    public static function get_sufixo_subdominio() {
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        return !empty($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp';
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-validator.php e os codigos deste arquivo:
<?php
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Validator {

    /**
     * Valida dados de um plano
     */
    public static function validate_plano_data($data) {
        $errors = array();

        // Nome
        if (empty($data['nome']) || !is_string($data['nome'])) {
            $errors[] = __('O nome do plano é obrigatório.', 'limiter-mkp-pro');
        } elseif (strlen($data['nome']) > 100) {
            $errors[] = __('O nome do plano não pode exceder 100 caracteres.', 'limiter-mkp-pro');
        }

        // Descrição
        if (!empty($data['descricao']) && strlen($data['descricao']) > 1000) {
            $errors[] = __('A descrição não pode exceder 1000 caracteres.', 'limiter-mkp-pro');
        }

        // Duração
        if (empty($data['duracao']) || $data['duracao'] <= 0) {
            $errors[] = __('A duração deve ser maior que zero.', 'limiter-mkp-pro');
        } elseif ($data['duracao'] > 3650) { // 10 anos
            $errors[] = __('A duração não pode exceder 3650 dias.', 'limiter-mkp-pro');
        }

        // Limite de páginas
        if (empty($data['limite_paginas']) || $data['limite_paginas'] <= 0) {
            $errors[] = __('O limite de páginas deve ser maior que zero.', 'limiter-mkp-pro');
        } elseif ($data['limite_paginas'] > 100000) {
            $errors[] = __('O limite de páginas não pode exceder 100.000.', 'limiter-mkp-pro');
        }

        return $errors;
    }

    /**
     * Valida dados de subdomínio
     */
    public static function validate_subdominio_data($data) {
        $errors = array();

        // Blog ID
        if (empty($data['blog_id']) || $data['blog_id'] <= 0) {
            $errors[] = __('ID do blog inválido.', 'limiter-mkp-pro');
        }

        // Domínio
        if (empty($data['dominio']) || !is_string($data['dominio'])) {
            $errors[] = __('O domínio é obrigatório.', 'limiter-mkp-pro');
        } elseif (!preg_match('/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/', $data['dominio'])) {
            $errors[] = __('Formato de domínio inválido.', 'limiter-mkp-pro');
        }

        // Plano ID
        if (empty($data['plano_id']) || $data['plano_id'] <= 0) {
            $errors[] = __('É necessário selecionar um plano.', 'limiter-mkp-pro');
        }

        // Limite personalizado
        if (!empty($data['limite_personalizado']) && $data['limite_personalizado'] <= 0) {
            $errors[] = __('O limite personalizado deve ser maior que zero.', 'limiter-mkp-pro');
        }

        // Email
        if (!empty($data['email_cliente']) && !is_email($data['email_cliente'])) {
            $errors[] = __('E-mail do cliente inválido.', 'limiter-mkp-pro');
        }

        return $errors;
    }

    /**
     * Sanitiza dados de entrada
     */
    public static function sanitize_input($input, $type = 'text') {
        switch ($type) {
            case 'email':
                return sanitize_email($input);
            case 'url':
                return esc_url_raw($input);
            case 'int':
                return intval($input);
            case 'float':
                return floatval($input);
            case 'textarea':
                return sanitize_textarea_field($input);
            case 'html':
                return wp_kses_post($input);
            case 'array':
                if (!is_array($input)) return array();
                return array_map('sanitize_text_field', $input);
            case 'text':
            default:
                return sanitize_text_field($input);
        }
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-woocommerce-integration.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pela integração com WooCommerce Subscriptions.
 *
 * @since      1.1.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */
class Limiter_MKP_Pro_WooCommerce_Integration {
    /**
     * Verifica se o WooCommerce está ativo.
     *
     * @since    1.1.0
     * @return   boolean    Verdadeiro se WooCommerce está ativo, falso caso contrário.
     */
    public static function is_woocommerce_active() {
        return class_exists('WooCommerce');
    }
    /**
     * Verifica se o WooCommerce Subscriptions está ativo.
     *
     * @since    1.1.0
     * @return   boolean    Verdadeiro se WooCommerce Subscriptions está ativo, falso caso contrário.
     */
    public static function is_subscriptions_active() {
        return class_exists('WC_Subscriptions');
    }
    /**
     * Obtém a duração em dias de um produto de assinatura.
     *
     * @since    1.2.0
     * @param    int       $product_id    ID do produto.
     * @return   int                      Duração em dias.
     */
    public static function get_product_duration_days($product_id) {
        if (!self::is_subscriptions_active()) {
            return 30; // Fallback padrão
        }
        $product = wc_get_product($product_id);
        if (!$product || !$product->is_type('subscription')) {
            return 30;
        }
        $interval = $product->get_meta('_subscription_period_interval', true);
        $period = $product->get_meta('_subscription_period', true);
        // Converter para dias
        $days_multiplier = [
            'day' => 1,
            'week' => 7,
            'month' => 30, // Aproximação
            'year' => 365
        ];
        if (isset($days_multiplier[$period])) {
            return $interval * $days_multiplier[$period];
        }
        return 30; // Fallback
    }
    /**
     * Obtém todos os produtos de assinatura.
     *
     * @since    1.1.0
     * @return   array    Array com produtos de assinatura.
     */
    public static function get_subscription_products() {
        if (!self::is_woocommerce_active() || !self::is_subscriptions_active()) {
            return array();
        }
        $args = array(
            'post_type' => 'product',
            'posts_per_page' => -1,
            'post_status' => 'publish',
            'meta_query' => array(
                array(
                    'key' => '_subscription_price',
                    'compare' => 'EXISTS'
                )
            )
        );
        $products = get_posts($args);
        $subscription_products = array();
        foreach ($products as $product) {
            $wc_product = wc_get_product($product->ID);
            if ($wc_product && $wc_product->is_type('subscription')) {
                $subscription_products[] = array(
                    'id' => $product->ID,
                    'name' => $product->post_title,
                    'price' => $wc_product->get_meta('_subscription_price'),
                    'period' => $wc_product->get_meta('_subscription_period'),
                    'interval' => $wc_product->get_meta('_subscription_period_interval'),
                    'duration_days' => self::get_product_duration_days($product->ID)
                );
            }
        }
        return $subscription_products;
    }
    /**
     * Obtém informações de um produto específico.
     *
     * @since    1.1.0
     * @param    int       $product_id    ID do produto.
     * @return   array|null               Array com informações do produto ou null se não encontrado.
     */
    public static function get_product_info($product_id) {
        if (!self::is_woocommerce_active()) {
            return null;
        }
        $product = wc_get_product($product_id);
        if (!$product || $product->get_status() !== 'publish') {
            return null;
        }
        $info = array(
            'id' => $product_id,
            'name' => $product->get_name(),
            'price' => $product->get_price(),
            'type' => $product->get_type(),
            'status' => $product->get_status(),
            'permalink' => get_permalink($product_id)
        );
        // Informações específicas de assinatura
        if (self::is_subscriptions_active() && $product->is_type('subscription')) {
            $info['subscription_price'] = $product->get_meta('_subscription_price');
            $info['subscription_period'] = $product->get_meta('_subscription_period');
            $info['subscription_interval'] = $product->get_meta('_subscription_period_interval');
            $info['subscription_duration_days'] = self::get_product_duration_days($product_id);
            $info['is_subscription'] = true;
        } else {
            $info['is_subscription'] = false;
        }
        return $info;
    }
    /**
     * Verifica se um produto é uma assinatura válida.
     *
     * @since    1.1.0
     * @param    int       $product_id    ID do produto.
     * @return   boolean                  Verdadeiro se é uma assinatura válida, falso caso contrário.
     */
    public static function is_valid_subscription($product_id) {
        $product_info = self::get_product_info($product_id);
        if (!$product_info) {
            return false;
        }
        return $product_info['is_subscription'] && $product_info['status'] === 'publish';
    }
    /**
     * Gera o link de compra para um produto.
     *
     * @since    1.1.0
     * @param    int       $product_id    ID do produto.
     * @return   string                   URL para adicionar ao carrinho.
     */
    public static function get_purchase_link($product_id) {
        if (!self::is_woocommerce_active()) {
            return '';
        }
        return wc_get_checkout_url() . '?add-to-cart=' . $product_id;
    }
    /**
     * Obtém os produtos WooCommerce vinculados a um plano.
     *
     * @since    1.1.0
     * @param    int       $plano_id    ID do plano.
     * @return   array                  Array com produtos vinculados.
     */
    public static function get_plano_products($plano_id) {
        global $wpdb;
        $table_plano_products = Limiter_MKP_Pro_Database::get_table_name('plano_products');
        $query = $wpdb->prepare(
            "SELECT woocommerce_product_id, ordem 
             FROM $table_plano_products 
             WHERE plano_id = %d 
             ORDER BY ordem ASC, data_vinculo ASC",
            $plano_id
        );
        $product_ids = $wpdb->get_results($query);
        $products = array();
        foreach ($product_ids as $row) {
            $product_info = self::get_product_info($row->woocommerce_product_id);
            if ($product_info) {
                $product_info['ordem'] = $row->ordem;
                $products[] = $product_info;
            }
        }
        return $products;
    }
    /**
     * Vincula produtos WooCommerce a um plano.
     *
     * @since    1.1.0
     * @param    int       $plano_id     ID do plano.
     * @param    array     $product_ids  Array de IDs de produtos.
     * @return   boolean                 Verdadeiro se vinculado com sucesso, falso caso contrário.
     */
    public static function save_plano_products($plano_id, $product_ids) {
        global $wpdb;
        $table_plano_products = Limiter_MKP_Pro_Database::get_table_name('plano_products');
        // Remove vinculações existentes
        $wpdb->delete($table_plano_products, array('plano_id' => $plano_id), array('%d'));
        // Insere as novas vinculações
        $ordem = 0;
        foreach ($product_ids as $product_id) {
            if (!empty($product_id) && $product_id > 0) {
                $wpdb->insert(
                    $table_plano_products,
                    array(
                        'plano_id' => $plano_id,
                        'woocommerce_product_id' => $product_id,
                        'ordem' => $ordem++
                    ),
                    array('%d', '%d', '%d')
                );
            }
        }
        return true;
    }
    /**
     * Remove todos os produtos vinculados a um plano.
     *
     * @since    1.1.0
     * @param    int       $plano_id    ID do plano.
     * @return   boolean                Verdadeiro se removido com sucesso, falso caso contrário.
     */
    public static function delete_plano_products($plano_id) {
        global $wpdb;
        $table_plano_products = Limiter_MKP_Pro_Database::get_table_name('plano_products');
        return $wpdb->delete($table_plano_products, array('plano_id' => $plano_id), array('%d')) !== false;
    }
    /**
     * Verifica se um produto está vinculado a algum plano.
     *
     * @since    1.1.0
     * @param    int       $product_id    ID do produto.
     * @return   boolean                  Verdadeiro se está vinculado, falso caso contrário.
     */
    public static function is_product_linked($product_id) {
        global $wpdb;
        $table_plano_products = Limiter_MKP_Pro_Database::get_table_name('plano_products');
        $count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table_plano_products WHERE woocommerce_product_id = %d",
            $product_id
        ));
        return $count > 0;
    }
    /**
     * Obtém o plano vinculado a um produto.
     *
     * @since    1.1.0
     * @param    int       $product_id    ID do produto.
     * @return   int|null                 ID do plano vinculado ou null se não encontrado.
     */
    public static function get_plano_by_product($product_id) {
        global $wpdb;
        $table_plano_products = Limiter_MKP_Pro_Database::get_table_name('plano_products');
        $plano_id = $wpdb->get_var($wpdb->prepare(
            "SELECT plano_id FROM $table_plano_products WHERE woocommerce_product_id = %d LIMIT 1",
            $product_id
        ));
        return $plano_id ? intval($plano_id) : null;
    }

    /**
     * Obtém a assinatura WooCommerce ativa associada a um blog_id (subdomínio).
     * 
     * @since 1.4.0
     * @param int $blog_id ID do blog/subdomínio.
     * @return object|null Objeto da assinatura ou null se não encontrada.
     */
    public static function get_subscription_for_blog($blog_id) {
        if (!self::is_subscriptions_active()) {
            return null;
        }

        global $wpdb;
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_subdominios)) {
            return null;
        }

        // Obtém o user_id do subdomínio
        $user_id = $wpdb->get_var($wpdb->prepare(
            "SELECT user_id FROM {$table_subdominios} WHERE blog_id = %d AND status = 'active'",
            $blog_id
        ));

        if (!$user_id) {
            return null;
        }

        // Usa a API do WooCommerce Subscriptions para buscar assinaturas do usuário
        $subscriptions = wcs_get_users_subscriptions($user_id);
        if (empty($subscriptions)) {
            return null;
        }

        foreach ($subscriptions as $sub) {
            if ($sub->has_status('active')) {
                return $sub;
            }
        }

        return null;
    }

    /**
     * Obtém o histórico de status de uma assinatura (timeline).
     * 
     * @since 1.4.0
     * @param int $subscription_id ID da assinatura WooCommerce.
     * @return array Array com entradas de status e timestamps.
     */
    public static function get_subscription_status_timeline($subscription_id) {
        if (!self::is_subscriptions_active()) {
            return array();
        }

        $subscription = wcs_get_subscription($subscription_id);
        if (!$subscription) {
            return array();
        }

        $timeline = array();
        $status_log = $subscription->get_meta('_subscription_status_log', true);
        
        if (!empty($status_log) && is_array($status_log)) {
            foreach ($status_log as $entry) {
                $timeline[] = array(
                    'status' => $entry['status'] ?? 'unknown',
                    'timestamp' => $entry['timestamp'] ?? '',
                    'note' => $entry['note'] ?? ''
                );
            }
        } else {
            // Fallback: apenas status atual
            $timeline[] = array(
                'status' => $subscription->get_status(),
                'timestamp' => $subscription->get_date_created() ? $subscription->get_date_created()->format('Y-m-d H:i:s') : current_time('mysql'),
                'note' => 'Status atual (sem histórico detalhado)'
            );
        }

        return $timeline;
    }

    /**
     * Dispara um webhook personalizado para integração externa com base em eventos do ciclo de vida.
     * 
     * @since 1.4.0
     * @param string $event Nome do evento (ex: 'subscription_created', 'plan_changed', 'grace_period_started').
     * @param array $data Dados contextuais a serem enviados.
     * @return bool True se webhook foi disparado com sucesso.
     */
    public static function trigger_subscription_webhook($event, $data) {
        // Obtém endpoint configurado (opcional)
        $webhook_url = get_network_option(null, 'limiter_mkp_pro_lifecycle_webhook_url', '');
        if (empty($webhook_url)) {
            return false; // Nenhum webhook configurado
        }

        $payload = array(
            'event' => sanitize_text_field($event),
            'timestamp' => current_time('mysql'),
            'data' => $data,
            'plugin_version' => LIMITER_MKP_PRO_VERSION,
            'site_url' => home_url()
        );

        $response = wp_remote_post($webhook_url, array(
            'body' => wp_json_encode($payload),
            'headers' => array('Content-Type' => 'application/json'),
            'timeout' => 10,
            'blocking' => false // não bloqueia a execução
        ));

        if (is_wp_error($response)) {
            Limiter_MKP_Pro_Error_Handler::log_error('Falha ao enviar webhook', [
                'event' => $event,
                'error' => $response->get_error_message(),
                'url' => $webhook_url
            ]);
            return false;
        }

        Limiter_MKP_Pro_Database::log(0, 'webhook_disparado', "Webhook disparado para evento: {$event}", [
            'url' => $webhook_url,
            'event' => $event
        ]);

        return true;
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-woocommerce-subscription-handler.php e os codigos deste arquivo:
<?php
/**
 * Classe para integração com WooCommerce Subscriptions
 *
 * @since      1.3.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/includes
 */
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_WooCommerce_Subscription_Handler {
    /**
     * Cache para planos processados
     * * @var array
     */
    private $processed_subscriptions = [];

    public function __construct() {
        // Hooks para integração com WooCommerce Subscriptions
        add_action('woocommerce_subscription_status_updated', array($this, 'handle_subscription_status_change'), 10, 3);
        add_action('woocommerce_subscription_payment_complete', array($this, 'handle_subscription_payment'), 10, 1);
        add_action('woocommerce_subscription_item_switched', array($this, 'handle_subscription_item_switched'), 10, 4);

        // Campo personalizado no produto
        add_action('woocommerce_product_options_general_product_data', array($this, 'add_plano_field_to_product'));
        add_action('woocommerce_process_product_meta', array($this, 'save_plano_field'));

        // AJAX para verificação de atualização de plano
        add_action('wp_ajax_limiter_mkp_pro_check_plan_update', array($this, 'ajax_check_plan_update'));

        // Inicializa cache de assinaturas processadas
        $this->load_processed_subscriptions();
    }
    
    /**
     * Carrega o cache de assinaturas processadas
     */
    private function load_processed_subscriptions() {
        $this->processed_subscriptions = get_transient('mkp_processed_subscriptions') ?: [];
    }
    
    /**
     * Salva uma assinatura como processada
     */
    private function mark_subscription_processed($subscription_id, $plan_id) {
        $this->processed_subscriptions[$subscription_id] = [
            'plan_id' => $plan_id,
            'processed_at' => current_time('mysql')
        ];
        set_transient('mkp_processed_subscriptions', $this->processed_subscriptions, WEEK_IN_SECONDS);
    }
    
    /**
     * Verifica se uma assinatura já foi processada
     */
    private function is_subscription_processed($subscription_id) {
        return isset($this->processed_subscriptions[$subscription_id]);
    }
    
    /**
     * Adiciona campo para vincular produto a um plano
     */
    public function add_plano_field_to_product() {
        global $post;
        echo '<div class="options_group">';
        echo '<h3>Configurações MKP Pro - Subdomínios</h3>';
        
        // Campo para selecionar plano
        woocommerce_wp_select(array(
            'id' => '_mkp_plano_id',
            'label' => 'Plano Vinculado',
            'description' => 'Selecione qual plano este produto de assinatura fornecerá',
            'desc_tip' => true,
            'options' => $this->get_planos_options()
        ));
        
        echo '</div>';
    }
    
    /**
     * Salva o campo do plano
     */
    public function save_plano_field($post_id) {
        $plano_id = isset($_POST['_mkp_plano_id']) ? intval($_POST['_mkp_plano_id']) : 0;
        update_post_meta($post_id, '_mkp_plano_id', $plano_id);
        
        // Vincular produto ao plano no sistema MKP Pro
        if ($plano_id > 0) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
            Limiter_MKP_Pro_WooCommerce_Integration::save_plano_products($plano_id, array($post_id));
        }
    }
    
    /**
     * Obtém opções de planos para o select
     */
    private function get_planos_options() {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $planos = Limiter_MKP_Pro_Database::get_planos();
        $options = array(0 => 'Nenhum plano vinculado');
        foreach ($planos as $plano) {
            $options[$plano->id] = $plano->nome . ' (' . $plano->limite_paginas . ' páginas)';
        }
        
        return $options;
    }
    
    /**
     * Lida com mudanças no status da assinatura
     */
    public function handle_subscription_status_change($subscription, $new_status, $old_status) {
        try {
            // Ignora se não é ativa ou o status não mudou para ativo
            if ($new_status !== 'active' && $new_status !== 'on-hold') {
                return;
            }
            
            // Verifica se já foi processada
            if ($this->is_subscription_processed($subscription->get_id())) {
                return;
            }
            
            // Verifica se é uma mudança de plano válida
            if ($this->is_valid_plan_change($subscription)) {
                $this->process_automatic_plan_change($subscription);
                $this->mark_subscription_processed($subscription->get_id(), $this->get_current_plan_id($subscription));
            }
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro no status change da assinatura', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'subscription_id' => $subscription->get_id() ?? 0,
                'new_status' => $new_status,
                'old_status' => $old_status
            ]);
        }
    }
    
    /**
     * Lida com pagamento completo da assinatura
     */
    public function handle_subscription_payment($subscription) {
        try {
            // Ignora se não está ativa
            if (!$subscription->has_status('active')) {
                return;
            }
            
            // Verifica se já foi processada
            if ($this->is_subscription_processed($subscription->get_id())) {
                return;
            }
            
            // Verifica se é uma mudança de plano válida
            if ($this->is_valid_plan_change($subscription)) {
                $this->process_automatic_plan_change($subscription);
                $this->mark_subscription_processed($subscription->get_id(), $this->get_current_plan_id($subscription));
            }
            
            // ENVIA E-MAIL DE CONFIGURAÇÃO APÓS PAGAMENTO CONFIRMADO
            $new_plan_id = $this->get_current_plan_id($subscription);
            if ($new_plan_id && $new_plan_id > 0) {
                $this->send_configuration_email($subscription, $new_plan_id);
            }
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro no pagamento da assinatura', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'subscription_id' => $subscription->get_id() ?? 0
            ]);
        }
    }
    
    /**
     * Lida com a troca de itens na assinatura
     */
    public function handle_subscription_item_switched($subscription, $new_item, $old_item, $subscription_key) {
        try {
            // Verifica se já foi processada
            if ($this->is_subscription_processed($subscription->get_id())) {
                return;
            }
            
            // Aguarda o pagamento ser processado
            if ($subscription->has_status('active')) {
                $new_plan_id = $this->get_current_plan_id($subscription);
                $old_plan_id = $this->get_current_plan_id_from_item($old_item);
                
                if ($new_plan_id && $new_plan_id != $old_plan_id) {
                    $this->process_automatic_plan_change($subscription);
                    $this->mark_subscription_processed($subscription->get_id(), $new_plan_id);
                }
            }
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro na troca de itens da assinatura', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'subscription_id' => $subscription->get_id() ?? 0,
                'subscription_key' => $subscription_key ?? ''
            ]);
        }
    }
    
    /**
     * Verifica se é uma mudança de plano válida
     */
    private function is_valid_plan_change($subscription) {
        try {
            // 1. Verifica se a assinatura está ativa
            if (!$subscription->has_status('active')) {
                return false;
            }
            
            // 2. Verifica se o último pagamento foi bem-sucedido
            $last_order = $subscription->get_last_order();
            if (!$last_order || !$last_order->is_paid()) {
                return false;
            }
            
            // 3. Verifica se há um produto vinculado a um plano
            $new_plan_id = $this->get_current_plan_id($subscription);
            if (!$new_plan_id || $new_plan_id <= 0) {
                return false;
            }
            
            // 4. Verifica se o usuário tem um subdomínio
            $user_id = $subscription->get_user_id();
            $blog_id = $this->get_user_blog_id($user_id);
            
            // Permite criação de novo subdomínio se não existir
            return true;
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro na validação de mudança de plano', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'subscription_id' => $subscription->get_id() ?? 0
            ]);
            return false;
        }
    }
    
    /**
     * Processa a mudança automática de plano
     */
    private function process_automatic_plan_change($subscription) {
        try {
            $user_id = $subscription->get_user_id();
            $blog_id = $this->get_user_blog_id($user_id);
            $new_plan_id = $this->get_current_plan_id($subscription);
            
            if (!$new_plan_id || $new_plan_id <= 0) {
                throw new Exception('Plano não encontrado para a assinatura ID: ' . $subscription->get_id());
            }
            
            $new_plan = Limiter_MKP_Pro_Database::get_plano($new_plan_id);
            if (!$new_plan) {
                throw new Exception('Dados do plano não encontrados (ID: ' . $new_plan_id . ')');
            }
            
            // Se não tem blog_id, cria um novo blog
            if (!$blog_id) {
                $blog_id = $this->create_new_blog_for_user($user_id, $subscription, $new_plan_id);
            }
            
            $old_plan_id = $this->get_current_user_plan_id($blog_id);

            // 3. Valida a mudança
            $this->validate_plan_change($subscription, $user_id, $new_plan_id);

            // 4. Executa a mudança
            $this->update_blog_plan($blog_id, $new_plan_id, $subscription->get_id());

            // 5. Notifica usuário
            $this->send_success_notification($user_id, $new_plan_id, $blog_id, $subscription->get_id());

            // 6. Log da operação bem-sucedida
            $this->log_success('Mudança de plano processada com sucesso', $subscription, $new_plan_id, $old_plan_id, $blog_id);
            
            return true;
        } catch (Exception $e) {
            $this->handle_plan_change_error($e, $subscription);
            return false;
        }
    }
    
    /**
     * Obtém o ID do plano atual da assinatura
     */
    private function get_current_plan_id($subscription) {
        foreach ($subscription->get_items() as $item) {
            $product_id = $item->get_product_id();
            $plano_id = get_post_meta($product_id, '_mkp_plano_id', true);
            if ($plano_id && intval($plano_id) > 0) {
                return intval($plano_id);
            }
        }
        return null;
    }
    
    /**
     * Obtém o plano atual de um item da assinatura
     */
    private function get_current_plan_id_from_item($item) {
        $product_id = $item->get_product_id();
        $plano_id = get_post_meta($product_id, '_mkp_plano_id', true);
        return $plano_id ? intval($plano_id) : 0;
    }
    
    /**
     * Obtém o ID do blog associado ao usuário
     */
    private function get_user_blog_id($user_id) {
        global $wpdb;
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_subdominios)) {
            return false;
        }
        
        $user_id = intval($user_id);
        if ($user_id <= 0) {
            return false;
        }
        
        $blog_id = $wpdb->get_var($wpdb->prepare(
            "SELECT blog_id FROM $table_subdominios 
             WHERE user_id = %d AND status = 'active'",
            $user_id
        ));
        
        return $blog_id ? intval($blog_id) : false;
    }
    
    /**
     * Obtém o plano atual do usuário
     */
    private function get_current_user_plan_id($blog_id) {
        global $wpdb;
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_subdominios)) {
            return 0;
        }
        
        $blog_id = intval($blog_id);
        if ($blog_id <= 0) {
            return 0;
        }
        
        $plan_id = $wpdb->get_var($wpdb->prepare(
            "SELECT plano_id FROM $table_subdominios 
             WHERE blog_id = %d AND status = 'active'",
            $blog_id
        ));
        
        return $plan_id ? intval($plan_id) : 0;
    }
    
    /**
     * Valida a mudança de plano
     */
    private function validate_plan_change($subscription, $user_id, $new_plan_id) {
        try {
            // 1. Verifica se usuário tem permissão
            if (!$this->user_owns_subscription($user_id, $subscription)) {
                throw new Exception('Usuário não é proprietário desta assinatura');
            }
            
            // 2. Verifica se o plano existe
            $new_plan = Limiter_MKP_Pro_Database::get_plano($new_plan_id);
            if (!$new_plan) {
                throw new Exception('Plano não encontrado (ID: ' . $new_plan_id . ')');
            }
            
            // 3. Verifica se o produto está vinculado a um plano válido
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-woocommerce-integration.php';
            $product_id = $this->get_product_id_from_subscription($subscription);
            if (!$product_id) {
                throw new Exception('Produto não encontrado na assinatura');
            }
            
            $plano_by_product = Limiter_MKP_Pro_WooCommerce_Integration::get_plano_by_product($product_id);
            if (!$plano_by_product) {
                throw new Exception('Produto não está vinculado a um plano válido');
            }
            
            return true;
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro na validação de mudança de plano', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'subscription_id' => $subscription->get_id() ?? 0,
                'user_id' => $user_id,
                'new_plan_id' => $new_plan_id
            ]);
            throw $e;
        }
    }
    
    /**
     * Verifica se o usuário é dono da assinatura
     */
    private function user_owns_subscription($user_id, $subscription) {
        return $subscription->get_user_id() == $user_id;
    }
    
    /**
     * Obtém o ID do produto da assinatura
     */
    private function get_product_id_from_subscription($subscription) {
        foreach ($subscription->get_items() as $item) {
            return $item->get_product_id();
        }
        return null;
    }
    
    /**
     * Atualiza o plano do blog
     */
    private function update_blog_plan($blog_id, $new_plan_id, $subscription_id) {
        global $wpdb;
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        
        if (!Limiter_MKP_Pro_Database::validate_table_name($table_subdominios)) {
            throw new Exception('Tabela de subdomínios inválida');
        }
        
        $blog_id = intval($blog_id);
        $new_plan_id = intval($new_plan_id);
        $subscription_id = intval($subscription_id);
        
        if ($blog_id <= 0 || $new_plan_id <= 0) {
            throw new Exception('IDs de blog ou plano inválidos');
        }
        
        // 1. Obtém plano atual para log
        $current_plan_id = $wpdb->get_var($wpdb->prepare(
            "SELECT plano_id FROM $table_subdominios 
             WHERE blog_id = %d AND status = 'active'", 
            $blog_id
        ));
        
        $current_plan = null;
        if ($current_plan_id) {
            $current_plan = Limiter_MKP_Pro_Database::get_plano($current_plan_id);
        }
        
        $new_plan = Limiter_MKP_Pro_Database::get_plano($new_plan_id);
        if (!$new_plan) {
            throw new Exception('Novo plano não encontrado (ID: ' . $new_plan_id . ')');
        }
        
        // 2. Atualiza para novo plano
        $data_expiracao = $this->calculate_new_expiration($new_plan_id);
        
        $result = $wpdb->update(
            $table_subdominios,
            [
                'plano_id' => $new_plan_id,
                'limite_personalizado' => NULL, // Remove limite personalizado
                'data_expiracao' => $data_expiracao
            ],
            ['blog_id' => $blog_id],
            ['%d', '%s', '%s'],
            ['%d']
        );
        
        // Verifica se a atualização foi bem-sucedida
        if ($result === false || $wpdb->rows_affected == 0) {
            throw new Exception('Erro ao atualizar plano no banco de dados: ' . $wpdb->last_error);
        }
        
        // 3. Log da mudança automática
        $log_message = $current_plan_id ? 
            "Plano alterado de '{$current_plan->nome}' para '{$new_plan->nome}' via WooCommerce. Assinatura: {$subscription_id}" :
            "Novo plano '{$new_plan->nome}' atribuído via WooCommerce. Assinatura: {$subscription_id}";
            
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'plano_alterado_auto',
            $log_message
        );
        
        // 4. Limpa cache
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-cache-manager.php';
        Limiter_MKP_Pro_Cache_Manager::clear_blog_cache($blog_id);
        
        return true;
    }
    
    /**
     * Calcula nova data de expiração
     */
    private function calculate_new_expiration($plan_id) {
        $plan = Limiter_MKP_Pro_Database::get_plano($plan_id);
        if (!$plan) {
            return null;
        }
        return date('Y-m-d H:i:s', strtotime("+{$plan->duracao} days"));
    }
    
    /**
     * Cria um novo blog para o usuário
     */
    private function create_new_blog_for_user($user_id, $subscription, $plano_id) {
        try {
            // Verifica se usuário existe
            $user = get_user_by('id', $user_id);
            if (!$user) {
                throw new Exception('Usuário não encontrado (ID: ' . $user_id . ')');
            }
            
            // Cria um nome de blog baseado no nome do usuário
            $blogname = sanitize_title($user->display_name . '-' . $user_id);
            $blogname = preg_replace('/[^a-z0-9-]/', '', $blogname);
            $blogname = substr($blogname, 0, 20);
            
            // Usa sufixo configurado
            $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
            $sufixo = !empty($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp';
            $domain = $blogname . $sufixo;
            
            $current_site = get_current_site();
            
            $blog_id = wpmu_create_blog(
                $domain . '.' . $current_site->domain,
                $current_site->path,
                $blogname,
                $user_id,
                array('public' => 1),
                $current_site->id
            );
            
            if (is_wp_error($blog_id)) {
                throw new Exception('Erro ao criar blog: ' . $blog_id->get_error_message());
            }
            
            // Adiciona o usuário como administrador do blog
            add_user_to_blog($blog_id, $user_id, 'administrator');
            
            // Salva o subdomínio no banco de dados
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::save_subdominio(array(
                'blog_id' => $blog_id,
                'user_id' => $user_id,
                'dominio' => $domain . '.' . $current_site->domain,
                'plano_id' => $plano_id,
                'nome_cliente' => $user->display_name,
                'email_cliente' => $user->user_email,
                'status' => 'active',
                'regiao' => $this->detect_user_region()
            ));
            
            return $blog_id;
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error("Erro ao criar novo blog para usuário", [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'user_id' => $user_id,
                'plano_id' => $plano_id
            ]);
            throw $e;
        }
    }
    
    /**
     * Detecta região do usuário usando a Geolocalização Nativa do WooCommerce.
     * Substitui a chamada insegura HTTP externa por consulta ao banco de dados local da MaxMind.
     */
    private function detect_user_region() {
        // Fallback padrão
        $regiao = 'global';

        // Verifica se a classe do WooCommerce Geolocation está disponível
        if ( class_exists( 'WC_Geolocation' ) ) {
            // O método geolocate_ip() já trata proxies (Cloudflare) e identifica o IP real
            $location = WC_Geolocation::geolocate_ip();

            // Verifica se o país retornado é Japão
            // O código 'JP' é o padrão ISO para Japão
            if ( ! empty( $location['country'] ) && 'JP' === $location['country'] ) {
                $regiao = 'jp';
            }
        }

        return $regiao;
    }
    
    /**
     * Envia notificação de sucesso para o usuário
     */
    private function send_success_notification($user_id, $new_plan_id, $blog_id, $subscription_id) {
        $user = get_user_by('id', $user_id);
        $new_plan = Limiter_MKP_Pro_Database::get_plano($new_plan_id);
        $blog = get_blog_details($blog_id);
        
        if (!$user || !$new_plan || !$blog) {
            return;
        }
        
        $site_url = $blog->siteurl;
        $admin_url = $blog->siteurl . '/wp-admin';
        
        $subject = "✅ Mudança de Plano Confirmada - Marketing Place Store";
        $message = "
        Olá {$user->display_name},
        
        Sua mudança para o plano <strong>{$new_plan->nome}</strong> foi processada com sucesso!
        
        📊 <strong>Novo limite:</strong> {$new_plan->limite_paginas} páginas/posts
        📅 <strong>Expira em:</strong> " . date('d/m/Y', strtotime("+{$new_plan->duracao} days")) . "
        
        🔗 <strong>Acessos:</strong>
        - Administração: {$admin_url}
        - Seu site: {$site_url}
        
        Você já pode usar todos os recursos do seu novo plano.
        
        Atenciosamente,
        Equipe Marketing Place Store
        ";
        
        wp_mail($user->user_email, $subject, $message);
    }
    
    /**
     * Trata erros na mudança de plano
     */
    private function handle_plan_change_error($exception, $subscription) {
        $error_message = $exception->getMessage();
        $subscription_id = $subscription->get_id() ?? 0;
        $user_id = $subscription->get_user_id() ?? 0;

        // Log de erro detalhado
        error_log('ERRO MKP Pro - Mudança automática de plano: ' . $error_message);
        
        // Log no sistema do plugin
        Limiter_MKP_Pro_Database::log(
            0,
            'erro_mudanca_plano_auto',
            "Assinatura {$subscription_id}: {$error_message}",
            ['exception' => $error_message, 'trace' => $exception->getTraceAsString()]
        );
        
        // Notifica administradores
        $this->notify_admins_of_failure($subscription, $error_message);
        
        // Notifica usuário sobre o problema
        $this->send_error_notification($user_id, $error_message, $subscription_id);
    }
    
    /**
     * Notifica administradores sobre a falha
     */
    private function notify_admins_of_failure($subscription, $error_message) {
        $admin_email = get_network_option(null, 'admin_email');
        $subject = "🚨 Falha na Mudança Automática de Plano - MKP Pro";
        $message = "
        Uma falha ocorreu ao processar a mudança de plano via WooCommerce.
        
        🔍 <strong>Detalhes do Erro:</strong>
        - Assinatura: {$subscription->get_id()}
        - Usuário: {$subscription->get_user_id()}
        - Erro: {$error_message}
        
        ⚠️ <strong>Ação necessária:</strong>
        Verifique os logs do sistema e entre em contato com o usuário.
        
        Atenciosamente,
        Sistema Automático MKP Pro
        ";
        
        wp_mail($admin_email, $subject, $message);
        
        // Notifica também os super administradores
        foreach (get_super_admins() as $admin_login) {
            $user = get_user_by('login', $admin_login);
            if ($user && $user->user_email !== $admin_email) {
                wp_mail($user->user_email, $subject, $message);
            }
        }
    }
    
    /**
     * Envia notificação de erro para o usuário
     */
    private function send_error_notification($user_id, $error_message, $subscription_id = 0) {
        $user = get_user_by('id', $user_id);
        if (!$user) {
            return;
        }
        
        $subject = "⚠️ Problema na Mudança de Plano - Marketing Place Store";
        $message = "
        Olá {$user->display_name},
        
        Ocorreu um problema ao processar sua mudança de plano.
        
        🔍 <strong>Detalhes do problema:</strong>
        {$error_message}
        
        ID da Assinatura: {$subscription_id}
        
        Nossa equipe foi notificada e está trabalhando para resolver o problema.
        Se o problema persistir, entre em contato com nosso suporte.
        
        Atenciosamente,
        Equipe Marketing Place Store
        ";
        
        wp_mail($user->user_email, $subject, $message);
    }
    
    /**
     * Log de sucesso
     */
    private function log_success($message, $subscription, $new_plan_id, $old_plan_id, $blog_id) {
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'mudanca_plano_sucesso',
            "{$message} - Assinatura: {$subscription->get_id()}, Plano Antigo: {$old_plan_id}, Novo Plano: {$new_plan_id}",
            [
                'subscription_id' => $subscription->get_id(),
                'old_plan_id' => $old_plan_id,
                'new_plan_id' => $new_plan_id,
                'user_id' => $subscription->get_user_id(),
                'blog_id' => $blog_id
            ]
        );
    }
    
    /**
     * DETECTA REGIÃO E ENVIA E-MAIL DE CONFIGURAÇÃO
     */
    private function send_configuration_email($subscription, $plano_id) {
        $user_id = $subscription->get_user_id();
        $user = get_user_by('id', $user_id);
        if (!$user) {
            return false;
        }
        
        // Verifica se já existe um subdomínio ativo para este usuário
        $blog_id = $this->get_user_blog_id($user_id);
        if ($blog_id) {
            // Já tem subdomínio, não envia e-mail de configuração
            return false;
        }
        
        // Verifica se já tem token pendente para este usuário
        if (Limiter_MKP_Pro_Token_Manager::has_pending_token($user->user_email)) {
            return false;
        }
        
        // === DETECÇÃO DE REGIÃO PELO IP ===
        $regiao = $this->detect_user_region();
        
        // Gera token com região
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-token-manager.php';
        $token = Limiter_MKP_Pro_Token_Manager::generate_token_with_region(
            $user_id,
            $subscription->get_id(),
            $user->user_email,
            $plano_id,
            $regiao
        );
        
        if (!$token) {
            throw new Exception('Falha ao gerar token de configuração');
        }
        
        // URL de configuração
        $current_site = get_current_site();
        $config_url = home_url('/configurar-subdominio?token=' . $token);
        
        $subject = '🚀 Configure seu Subdomínio - Marketing Place Store';
        $message = "
        Olá {$user->display_name},
        
        Sua assinatura foi confirmada com sucesso! 🎉
        
        Agora você precisa configurar seu subdomínio para começar a usar nossa plataforma.
        
        📝 <strong>Configure seu subdomínio:</strong>
        {$config_url}
        
        ⚠️ <strong>Este link expira em 7 dias</strong>
        
        <strong>Como funciona:</strong>
        1. Clique no link acima
        2. Escolha o nome do seu subdomínio (exemplo: 'loja' se tornará 'loja-mkp.marketing-place.store')
        3. Crie sua senha
        4. Seu subdomínio será criado automaticamente
        
        Se tiver qualquer dúvida, entre em contato conosco.
        
        Atenciosamente,
        Equipe Marketing Place Store
        ";
        
        return wp_mail($user->user_email, $subject, $message);
    }
    
    /**
     * Verifica atualização de plano via AJAX
     */
    public function ajax_check_plan_update() {
        try {
            if (!wp_verify_nonce($_POST['nonce'] ?? '', 'limiter_mkp_pro_public_nonce')) {
                wp_send_json_error(['message' => 'Token de segurança inválido']);
                exit;
            }
            
            $blog_id = get_current_blog_id();
            $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
            
            if (!$sub) {
                wp_send_json_success([
                    'has_update' => false,
                    'current_plan' => 'Não configurado',
                    'current_plan_id' => 0
                ]);
                exit;
            }
            
            $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
            if (!$plano) {
                wp_send_json_success([
                    'has_update' => false,
                    'current_plan' => 'Plano não encontrado',
                    'current_plan_id' => $sub->plano_id
                ]);
                exit;
            }
            
            wp_send_json_success([
                'has_update' => false,
                'current_plan' => $plano->nome,
                'current_plan_id' => $plano->id
            ]);
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro na verificação de atualização de plano via AJAX', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            wp_send_json_error(['message' => 'Erro interno']);
        }
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/includes/class-woocommerce-subscription-hooks.php e os codigos deste arquivo:
<?php
/**
 * Classe para gerenciar hooks do WooCommerce Subscriptions
 * 
 * @since 2.0.0
 * @package Limiter_MKP_Pro
 */

if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_WooCommerce_Subscription_Hooks {
    
    /**
     * Inicializa os hooks do WooCommerce Subscriptions
     */
    public static function init() {
        // Verifica se o WooCommerce Subscriptions está ativo
        if (!class_exists('WC_Subscriptions')) {
            return;
        }
        
        // Hooks para mudanças de status
        add_action('woocommerce_subscription_status_updated', 
            [__CLASS__, 'handle_subscription_status_change'], 10, 3);
        
        add_action('woocommerce_subscription_payment_failed', 
            [__CLASS__, 'handle_payment_failed'], 10, 2);
        
        add_action('woocommerce_subscription_payment_complete', 
            [__CLASS__, 'handle_payment_complete'], 10, 2);
        
        add_action('woocommerce_subscription_cancelled', 
            [__CLASS__, 'handle_cancellation'], 10, 2);
        
        add_action('woocommerce_subscription_expired', 
            [__CLASS__, 'handle_expiration'], 10, 2);
        
        add_action('woocommerce_subscription_status_changed', 
            [__CLASS__, 'handle_status_changed'], 10, 3);
        
        // Hook para renovação automática
        add_action('woocommerce_subscription_renewal_payment_complete', 
            [__CLASS__, 'handle_renewal_complete'], 10, 2);
        
        // Hook para quando o usuário troca de plano
        add_action('woocommerce_subscriptions_switched_item', 
            [__CLASS__, 'handle_plan_switch'], 10, 3);
    }
    
    /**
     * Handler para mudança de status da assinatura
     */
    public static function handle_subscription_status_change($subscription, $new_status, $old_status) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Atualiza o status no banco de dados do plugin
        self::update_blog_subscription_status($blog_id, $new_status, $subscription->get_id());
        
        // Log da mudança
        self::log_status_change($blog_id, $old_status, $new_status, $subscription->get_id());
        
        // Dispara ação para o lifecycle manager
        do_action('limiter_mkp_pro_subscription_status_updated', $blog_id, $new_status, $old_status, $subscription);
    }
    
    /**
     * Handler para pagamento falhado
     */
    public static function handle_payment_failed($subscription, $last_order) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Registra o pagamento falhado
        self::log_payment_failure($blog_id, $subscription->get_id(), $last_order);
        
        // Dispara ação para o lifecycle manager
        do_action('limiter_mkp_pro_payment_failed', $blog_id, $subscription, $last_order);
    }
    
    /**
     * Handler para pagamento completado
     */
    public static function handle_payment_complete($subscription, $last_order) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Atualiza a data do último pagamento
        self::update_last_payment_date($blog_id, $last_order);
        
        // Dispara ação para o lifecycle manager
        do_action('limiter_mkp_pro_payment_complete', $blog_id, $subscription, $last_order);
    }
    
    /**
     * Handler para cancelamento
     */
    public static function handle_cancellation($subscription, $last_order) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Obtém o motivo do cancelamento
        $cancellation_reason = self::get_cancellation_reason($subscription);
        
        // Atualiza o status para cancelado
        self::update_blog_subscription_status($blog_id, 'cancelled', $subscription->get_id());
        
        // Log do cancelamento
        self::log_cancellation($blog_id, $subscription->get_id(), $cancellation_reason);
        
        // Dispara ação para o lifecycle manager
        do_action('limiter_mkp_pro_subscription_cancelled', $blog_id, $subscription, $cancellation_reason);
    }
    
    /**
     * Handler para expiração
     */
    public static function handle_expiration($subscription, $last_order) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Atualiza o status para expirado
        self::update_blog_subscription_status($blog_id, 'expired', $subscription->get_id());
        
        // Log da expiração
        self::log_expiration($blog_id, $subscription->get_id());
        
        // Dispara ação para o lifecycle manager
        do_action('limiter_mkp_pro_subscription_expired', $blog_id, $subscription);
    }
    
    /**
     * Handler para mudança de status geral
     */
    public static function handle_status_changed($subscription, $new_status, $old_status) {
        // Este é um hook genérico que captura todas as mudanças
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Log da mudança
        self::log_status_change($blog_id, $old_status, $new_status, $subscription->get_id());
        
        // Para status específicos que precisam de ação imediata
        if ($new_status === 'on-hold') {
            do_action('limiter_mkp_pro_subscription_on_hold', $blog_id, $subscription);
        }
    }
    
    /**
     * Handler para renovação completada
     */
    public static function handle_renewal_complete($subscription, $last_order) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Atualiza a data de renovação
        self::update_renewal_date($blog_id, $subscription->get_id());
        
        // Log da renovação
        self::log_renewal($blog_id, $subscription->get_id(), $last_order);
        
        // Dispara ação para o lifecycle manager
        do_action('limiter_mkp_pro_subscription_renewed', $blog_id, $subscription, $last_order);
    }
    
    /**
     * Handler para troca de plano
     */
    public static function handle_plan_switch($subscription, $new_order_item, $old_order_item) {
        $blog_id = self::get_blog_id_from_subscription($subscription);
        
        if (!$blog_id) {
            return;
        }
        
        // Obtém os IDs dos produtos antigo e novo
        $old_product_id = $old_order_item->get_product_id();
        $new_product_id = $new_order_item->get_product_id();
        
        // Encontra os planos correspondentes
        $old_plano_id = self::get_plano_id_from_product($old_product_id);
        $new_plano_id = self::get_plano_id_from_product($new_product_id);
        
        if ($old_plano_id && $new_plano_id) {
            // Log da troca de plano
            self::log_plan_switch($blog_id, $old_plano_id, $new_plano_id, $subscription->get_id());
            
            // Atualiza o plano do blog
            self::update_blog_plan($blog_id, $new_plano_id);
            
            // Dispara ação para o lifecycle manager
            do_action('limiter_mkp_pro_plan_switched', $blog_id, $old_plano_id, $new_plano_id, $subscription);
        }
    }
    
    /**
     * Obtém o ID do blog a partir de uma assinatura
     */
    private static function get_blog_id_from_subscription($subscription) {
        // Tenta obter pelo email do cliente
        $customer_email = $subscription->get_billing_email();
        
        if (!$customer_email) {
            return false;
        }
        
        global $wpdb;
        $table_subdominios = $wpdb->base_prefix . 'limiter_mkp_pro_subdominios';
        
        $blog_id = $wpdb->get_var($wpdb->prepare(
            "SELECT blog_id FROM {$table_subdominios} WHERE email_cliente = %s LIMIT 1",
            $customer_email
        ));
        
        // Se não encontrar pelo email, tenta pelo user_id
        if (!$blog_id) {
            $user_id = $subscription->get_user_id();
            $blog_id = $wpdb->get_var($wpdb->prepare(
                "SELECT blog_id FROM {$table_subdominios} WHERE user_id = %d LIMIT 1",
                $user_id
            ));
        }
        
        return $blog_id ? intval($blog_id) : false;
    }
    
    /**
     * Atualiza o status da assinatura no blog
     */
    private static function update_blog_subscription_status($blog_id, $status, $subscription_id) {
        update_blog_option($blog_id, 'limiter_subscription_status', $status);
        update_blog_option($blog_id, 'limiter_subscription_id', $subscription_id);
        update_blog_option($blog_id, 'limiter_last_status_update', current_time('mysql'));
        
        // Se for ativo, limpa datas de suspensão
        if ($status === 'active') {
            delete_blog_option($blog_id, 'limiter_blog_suspended_date');
            delete_blog_option($blog_id, 'limiter_blog_locked_date');
        }
    }
    
    /**
     * Obtém o motivo do cancelamento
     */
    private static function get_cancellation_reason($subscription) {
        // Tenta obter do metadado do WooCommerce
        $reason = $subscription->get_meta('_cancellation_reason');
        
        if (!$reason) {
            $reason = $subscription->get_meta('cancellation_reason');
        }
        
        return $reason ?: 'Razão não especificada';
    }
    
    /**
     * Atualiza a data do último pagamento
     */
    private static function update_last_payment_date($blog_id, $order) {
        $payment_date = $order->get_date_paid();
        
        if ($payment_date) {
            update_blog_option($blog_id, 'limiter_last_payment_date', $payment_date->date('Y-m-d H:i:s'));
        }
        
        // Também atualiza a próxima data de pagamento se disponível
        $next_payment = $order->get_meta('_next_payment_date');
        if ($next_payment) {
            update_blog_option($blog_id, 'limiter_next_payment_date', $next_payment);
        }
    }
    
    /**
     * Atualiza a data de renovação
     */
    private static function update_renewal_date($blog_id, $subscription_id) {
        update_blog_option($blog_id, 'limiter_last_renewal_date', current_time('mysql'));
    }
    
    /**
     * Obtém o ID do plano a partir do ID do produto
     */
    private static function get_plano_id_from_product($product_id) {
        global $wpdb;
        $table_plano_products = $wpdb->base_prefix . 'limiter_mkp_pro_plano_products';
        
        $plano_id = $wpdb->get_var($wpdb->prepare(
            "SELECT plano_id FROM {$table_plano_products} WHERE woocommerce_product_id = %d LIMIT 1",
            $product_id
        ));
        
        return $plano_id ? intval($plano_id) : false;
    }
    
    /**
     * Atualiza o plano do blog
     */
    private static function update_blog_plan($blog_id, $plano_id) {
        global $wpdb;
        $table_subdominios = $wpdb->base_prefix . 'limiter_mkp_pro_subdominios';
        
        $wpdb->update(
            $table_subdominios,
            ['plano_id' => $plano_id],
            ['blog_id' => $blog_id],
            ['%d'],
            ['%d']
        );
    }
    
    /**
     * Métodos de logging
     */
    private static function log_status_change($blog_id, $old_status, $new_status, $subscription_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'subscription_status_change',
            "Status da assinatura alterado de '{$old_status}' para '{$new_status}'",
            [
                'subscription_id' => $subscription_id,
                'old_status' => $old_status,
                'new_status' => $new_status
            ]
        );
    }
    
    private static function log_payment_failure($blog_id, $subscription_id, $order) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'payment_failed',
            'Pagamento da assinatura falhou',
            [
                'subscription_id' => $subscription_id,
                'order_id' => $order->get_id(),
                'order_total' => $order->get_total()
            ]
        );
    }
    
    private static function log_cancellation($blog_id, $subscription_id, $reason) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'subscription_cancelled',
            "Assinatura cancelada. Motivo: {$reason}",
            [
                'subscription_id' => $subscription_id,
                'cancellation_reason' => $reason
            ]
        );
    }
    
    private static function log_expiration($blog_id, $subscription_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'subscription_expired',
            'Assinatura expirou',
            ['subscription_id' => $subscription_id]
        );
    }
    
    private static function log_renewal($blog_id, $subscription_id, $order) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'subscription_renewed',
            'Assinatura renovada com sucesso',
            [
                'subscription_id' => $subscription_id,
                'order_id' => $order->get_id(),
                'renewal_amount' => $order->get_total()
            ]
        );
    }
    
    private static function log_plan_switch($blog_id, $old_plano_id, $new_plano_id, $subscription_id) {
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        // Obtém os nomes dos planos
        global $wpdb;
        $table_planos = $wpdb->base_prefix . 'limiter_mkp_pro_planos';
        
        $old_plano = $wpdb->get_var($wpdb->prepare(
            "SELECT nome FROM {$table_planos} WHERE id = %d",
            $old_plano_id
        ));
        
        $new_plano = $wpdb->get_var($wpdb->prepare(
            "SELECT nome FROM {$table_planos} WHERE id = %d",
            $new_plano_id
        ));
        
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'plan_switched',
            "Plano alterado de '{$old_plano}' para '{$new_plano}'",
            [
                'subscription_id' => $subscription_id,
                'old_plano_id' => $old_plano_id,
                'new_plano_id' => $new_plano_id,
                'old_plano_name' => $old_plano,
                'new_plano_name' => $new_plano
            ]
        );
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/models/class-database.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelas operações de banco de dados do plugin.
 * OTIMIZADA: Compatibilidade HPOS e Índices de Alta Performance.
 *
 * @since 2.3.3
 */
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Database {
    
    protected static $allowed_tables = array(
        'planos', 'subdominios', 'logs', 'solicitacoes', 'tokens', 'plano_products', 'clientes'
    );

    /**
     * Retorna o nome da tabela com o prefixo correto do WP.
     */
    public static function get_table_name($table_name) {
        global $wpdb;
        $table_name = sanitize_key($table_name);
        
        // Garante que não duplique o prefixo se já vier com ele
        if (strpos($table_name, 'limiter_mkp_pro_') === false) {
            return $wpdb->base_prefix . 'limiter_mkp_pro_' . $table_name;
        }
        
        return $wpdb->base_prefix . $table_name;
    }
   
    public static function validate_table_name($table_full_name) {
        global $wpdb;
        return strpos($table_full_name, $wpdb->base_prefix . 'limiter_mkp_pro_') === 0;
    }

    // --- MÉTODOS DE GET E SAVE (PLANOS) ---
    
    public static function get_planos() {
        global $wpdb;
        $table = self::get_table_name('planos');
        
        // Cache simples para evitar query repetitiva na mesma requisição
        $cache_key = 'limiter_mkp_all_plans';
        $planos = wp_cache_get($cache_key, 'limiter_mkp');
        
        if (false === $planos) {
            $planos = $wpdb->get_results("SELECT * FROM {$table} ORDER BY nome ASC");
            
            foreach ($planos as $plano) {
                // Decodifica JSONs e define defaults para evitar erros de PHP
                if (!isset($plano->post_types_contaveis)) $plano->post_types_contaveis = json_encode(['page', 'post']);
                if (!isset($plano->post_status_contaveis)) $plano->post_status_contaveis = json_encode(['publish', 'draft', 'trash']);
                if (!isset($plano->limite_upload_mb)) $plano->limite_upload_mb = 100;
                if (!isset($plano->backup_frequency)) $plano->backup_frequency = 'none';
                if (!isset($plano->backup_retention)) $plano->backup_retention = 3;
            }
            wp_cache_set($cache_key, $planos, 'limiter_mkp', 3600);
        }
        
        return $planos;
    }

    public static function get_plano($id) {
        global $wpdb;
        $id = intval($id);
        if ($id <= 0) return null;

        $table = self::get_table_name('planos');
        $plano = $wpdb->get_row($wpdb->prepare("SELECT * FROM {$table} WHERE id = %d", $id));
        
        if ($plano) {
            if (!isset($plano->post_types_contaveis)) $plano->post_types_contaveis = json_encode(['page', 'post']);
            if (!isset($plano->post_status_contaveis)) $plano->post_status_contaveis = json_encode(['publish', 'draft', 'trash']);
            if (!isset($plano->limite_upload_mb)) $plano->limite_upload_mb = 100;
            if (!isset($plano->backup_frequency)) $plano->backup_frequency = 'none';
            if (!isset($plano->backup_retention)) $plano->backup_retention = 3;
        }
        return $plano;
    }

    public static function save_plano($data) {
        global $wpdb;
        $table = self::get_table_name('planos');
        
        $post_types = isset($data['post_types_contaveis']) ? (array) $data['post_types_contaveis'] : ['page', 'post'];
        $post_status = isset($data['post_status_contaveis']) ? (array) $data['post_status_contaveis'] : ['publish', 'draft', 'trash'];
        
        $plano_data = array(
            'nome' => sanitize_text_field($data['nome']),
            'descricao' => sanitize_textarea_field($data['descricao']),
            'duracao' => intval($data['duracao']),
            'limite_paginas' => intval($data['limite_paginas']),
            'limite_inodes' => intval($data['limite_inodes']),
            'limite_upload_mb' => isset($data['limite_upload_mb']) ? intval($data['limite_upload_mb']) : 100,
            'backup_frequency' => isset($data['backup_frequency']) ? sanitize_text_field($data['backup_frequency']) : 'none',
            'backup_retention' => isset($data['backup_retention']) ? intval($data['backup_retention']) : 3,
            'post_types_contaveis' => json_encode($post_types),
            'post_status_contaveis' => json_encode($post_status)
        );
        
        // Limpa cache ao salvar
        wp_cache_delete('limiter_mkp_all_plans', 'limiter_mkp');
        
        if (!empty($data['id']) && intval($data['id']) > 0) {
            $wpdb->update($table, $plano_data, ['id' => intval($data['id'])]);
            return intval($data['id']);
        } else {
            $wpdb->insert($table, $plano_data);
            return intval($wpdb->insert_id);
        }
    }

    public static function delete_plano($id) {
        global $wpdb;
        $t_planos = self::get_table_name('planos');
        $t_subs = self::get_table_name('subdominios');
        
        // Impede exclusão se houver subdomínios vinculados (Integridade Referencial)
        $count = $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM {$t_subs} WHERE plano_id = %d", $id));
        if ($count > 0) return false;
        
        wp_cache_delete('limiter_mkp_all_plans', 'limiter_mkp');
        return $wpdb->delete($t_planos, ['id' => $id]) !== false;
    }

    // --- MÉTODOS DE SUBDOMÍNIOS ---

    public static function get_subdominios() {
        global $wpdb;
        $t_subs = self::get_table_name('subdominios');
        $t_planos = self::get_table_name('planos');
        
        // Query otimizada com JOIN
        return $wpdb->get_results("
            SELECT s.*, p.nome as plano_nome 
            FROM {$t_subs} s 
            LEFT JOIN {$t_planos} p ON s.plano_id = p.id 
            ORDER BY s.dominio ASC
        ");
    }

    public static function get_subdominio_by_blog_id($blog_id) {
        global $wpdb;
        $blog_id = intval($blog_id);
        if ($blog_id <= 0) return null;

        $t_subs = self::get_table_name('subdominios');
        $t_planos = self::get_table_name('planos');
        
        // Usa o índice UNIQUE KEY blog_id criado no activator
        return $wpdb->get_row($wpdb->prepare("
            SELECT s.*, p.post_types_contaveis, p.post_status_contaveis, 
                   p.limite_paginas as plano_limite, p.limite_inodes as plano_limite_inodes
            FROM {$t_subs} s 
            LEFT JOIN {$t_planos} p ON s.plano_id = p.id
            WHERE s.blog_id = %d AND s.status = 'active'
        ", $blog_id));
    }

    public static function save_subdominio($data) {
        global $wpdb;
        $table = self::get_table_name('subdominios');
        $blog_id = intval($data['blog_id']);
        
        $sub_data = array(
            'blog_id' => $blog_id,
            'user_id' => isset($data['user_id']) ? intval($data['user_id']) : get_current_user_id(),
            'dominio' => sanitize_text_field($data['dominio']),
            'plano_id' => intval($data['plano_id']),
            'limite_personalizado' => !empty($data['limite_personalizado']) ? intval($data['limite_personalizado']) : null,
            'limite_personalizado_inodes' => !empty($data['limite_personalizado_inodes']) ? intval($data['limite_personalizado_inodes']) : null,
            'nome_cliente' => sanitize_text_field($data['nome_cliente']),
            'email_cliente' => sanitize_email($data['email_cliente']),
            'telefone_cliente' => sanitize_text_field($data['telefone_cliente']),
            'status' => isset($data['status']) ? sanitize_text_field($data['status']) : 'active',
            'regiao' => isset($data['regiao']) ? sanitize_text_field($data['regiao']) : 'global'
        );
        
        // Verifica existência usando o índice blog_id
        $exists = $wpdb->get_var($wpdb->prepare("SELECT id FROM {$table} WHERE blog_id = %d", $blog_id));
        
        if ($exists) {
            $wpdb->update($table, $sub_data, ['blog_id' => $blog_id]);
            return intval($exists);
        } else {
            $wpdb->insert($table, $sub_data);
            return intval($wpdb->insert_id);
        }
    }

    public static function get_subdomain_by_name($domain_name) {
        global $wpdb;
        $table = self::get_table_name('subdominios');
        // Sanitização extra para busca
        $domain_name = sanitize_text_field($domain_name);
        $like = '%' . $wpdb->esc_like($domain_name) . '%';
        return $wpdb->get_row($wpdb->prepare("SELECT * FROM {$table} WHERE dominio LIKE %s", $like));
    }

    public static function get_limite_paginas($blog_id) {
        $sub = self::get_subdominio_by_blog_id($blog_id);
        if (!$sub) return 0;
        $limite_plano = isset($sub->plano_limite) ? intval($sub->plano_limite) : 0;
        return !empty($sub->limite_personalizado) ? intval($sub->limite_personalizado) : $limite_plano;
    }

    // --- MÉTODOS DE CONTAGEM OTIMIZADOS (PERFORMANCE CRÍTICA) ---

    /**
     * Conta conteúdo limitado com cache no banco para não pesar o carregamento do admin.
     */
    public static function count_limited_content($blog_id) {
        $blog_id = intval($blog_id);
        if ($blog_id <= 0) return 0;
        
        // Tenta pegar do cache da tabela wp_X_options
        $cached_count = get_blog_option($blog_id, 'limiter_mkp_total_content_count', false);
        
        // Se existir e for numérico, retorna
        if ($cached_count !== false && is_numeric($cached_count)) {
            return intval($cached_count);
        }
        
        // Se não, calcula e salva
        return self::count_pages_posts($blog_id, false, true);
    }

    public static function count_pages_posts($blog_id, $only_published = false, $count_all = false) {
        $sub = self::get_subdominio_by_blog_id($blog_id);
        if (!$sub) return 0;

        $post_types = json_decode($sub->post_types_contaveis, true) ?: ['page', 'post'];
        $post_status = json_decode($sub->post_status_contaveis, true) ?: ['publish', 'draft', 'trash'];
        
        if ($only_published) {
            $post_status = ['publish'];
        }

        // Switch to blog é necessário para ler a tabela wp_X_posts correta
        switch_to_blog($blog_id);
        global $wpdb;
        
        $types_placeholders = implode(',', array_fill(0, count($post_types), '%s'));
        $status_placeholders = implode(',', array_fill(0, count($post_status), '%s'));
        
        // Query direta na tabela de posts (HPOS não afeta wp_posts)
        $query = "SELECT COUNT(*) FROM {$wpdb->posts} 
                  WHERE post_type IN ($types_placeholders) 
                  AND post_status IN ($status_placeholders)";
                  
        $params = array_merge($post_types, $post_status);
        $total = (int) $wpdb->get_var($wpdb->prepare($query, $params));
        
        // Atualiza o cache se solicitado (usado quando um post é salvo/deletado)
        if ($count_all) {
            update_blog_option($blog_id, 'limiter_mkp_total_content_count', $total);
        }
        
        restore_current_blog();
        return $total;
    }

    public static function count_published_pages_posts($blog_id) {
        return self::count_pages_posts($blog_id, true);
    }

    public static function count_trash_pages_posts($blog_id) {
        $sub = self::get_subdominio_by_blog_id($blog_id);
        if (!$sub) return 0;

        $post_types = json_decode($sub->post_types_contaveis, true) ?: ['page', 'post'];
        
        switch_to_blog($blog_id);
        global $wpdb;
        
        $types_placeholders = implode(',', array_fill(0, count($post_types), '%s'));
        $query = "SELECT COUNT(*) FROM {$wpdb->posts} 
                  WHERE post_type IN ($types_placeholders) 
                  AND post_status = 'trash'";
                  
        $total = (int) $wpdb->get_var($wpdb->prepare($query, $post_types));
        restore_current_blog();
        return $total;
    }

    /**
     * Força a atualização da contagem (chamado ao salvar/deletar post).
     */
    public static function force_update_content_count($blog_id) {
        self::count_pages_posts($blog_id, false, true);
    }
    
    public static function clear_count_cache($blog_id) {
        delete_blog_option($blog_id, 'limiter_mkp_total_content_count');
        self::force_update_content_count($blog_id);
    }

    // --- MÉTODOS DE DASHBOARD E CHURN (USANDO OS NOVOS ÍNDICES) ---

    public static function count_blogs_by_lifecycle_status($status) {
        global $wpdb;
        $table = self::get_table_name('subdominios');
        // Usa o índice KEY status
        return (int) $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM {$table} WHERE status = %s", $status));
    }

    public static function get_blogs_by_lifecycle_status($status, $limit = 50) {
        global $wpdb;
        $table = self::get_table_name('subdominios');
        $limit = intval($limit);
        
        // Otimização: SELECT apenas o necessário para a tabela do dashboard
        return $wpdb->get_results($wpdb->prepare("
            SELECT s.blog_id, s.dominio, s.nome_cliente, s.email_cliente, s.telefone_cliente, 
                   s.data_inicio, s.data_expiracao, s.plano_id,
                   p.nome as plano_nome
            FROM {$table} s
            LEFT JOIN " . self::get_table_name('planos') . " p ON s.plano_id = p.id
            WHERE s.status = %s
            ORDER BY s.data_inicio DESC
            LIMIT %d", 
            $status, $limit
        ));
    }

    public static function count_overdue_subscriptions() {
        global $wpdb;
        $table = self::get_table_name('subdominios');
        $now = current_time('mysql');
        // Otimizado para verificar status e data
        return (int) $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM {$table} WHERE status = 'active' AND data_expiracao IS NOT NULL AND data_expiracao < %s", 
            $now
        ));
    }

    public static function get_all_blogs_with_subscriptions() {
        global $wpdb;
        $table = self::get_table_name('subdominios');
        // Exclui arquivados para não processar sites mortos
        return $wpdb->get_results("SELECT blog_id FROM {$table} WHERE status != 'archived'");
    }

    // --- SISTEMA DE LOGS BLINDADO ---
    
    public static function log($blog_id, $acao, $descricao, $dados_extras = []) {
        global $wpdb;
        $table = self::get_table_name('logs');
        
        // Verificação de segurança extra para garantir que a tabela existe
        if ($wpdb->get_var("SHOW TABLES LIKE '$table'") != $table) return false;
        
        $wpdb->insert($table, [
            'blog_id' => intval($blog_id),
            'acao' => sanitize_text_field($acao),
            'descricao' => sanitize_text_field($descricao),
            'dados_extras' => maybe_serialize($dados_extras),
            'user_id' => get_current_user_id(),
            'ip' => self::get_client_ip() // Helper method
        ]);
        return $wpdb->insert_id;
    }

    public static function log_enhanced($log_data) {
        return self::log(
            isset($log_data['blog_id']) ? $log_data['blog_id'] : 0, 
            isset($log_data['acao']) ? $log_data['acao'] : 'sistema', 
            isset($log_data['descricao']) ? $log_data['descricao'] : '', 
            isset($log_data['dados_extras']) ? $log_data['dados_extras'] : []
        );
    }

    public static function get_logs($limit = 100, $blog_id = null) {
        global $wpdb;
        $table = self::get_table_name('logs');
        $sql = "SELECT * FROM {$table} ";
        
        if ($blog_id) {
            $sql .= $wpdb->prepare("WHERE blog_id = %d ", $blog_id);
        }
        
        // Usa o índice KEY timestamp para ordenação rápida
        $sql .= "ORDER BY timestamp DESC LIMIT %d";
        
        return $wpdb->get_results($wpdb->prepare($sql, $limit));
    }

    /**
     * Obtém IP real do cliente (Suporte a Cloudflare/Proxy)
     */
    private static function get_client_ip() {
        $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';
        if (isset($_SERVER['HTTP_CF_CONNECTING_IP'])) {
            $ip = $_SERVER['HTTP_CF_CONNECTING_IP'];
        } elseif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
        }
        return sanitize_text_field($ip);
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/models/class-database-get-estatisticas.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável por obter estatísticas do sistema.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/models
 */
class Limiter_MKP_Pro_Database_Get_Estatisticas {
    /**
     * Obtém estatísticas gerais do sistema para o dashboard do super admin.
     *
     * @since    1.0.0
     * @return   array    Array com as estatísticas gerais.
     */
    public static function get_estatisticas_gerais() {
        global $wpdb;
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        $table_planos = Limiter_MKP_Pro_Database::get_table_name('planos');
        // Total de subdomínios gerenciados
        $total_subdominios = $wpdb->get_var("SELECT COUNT(*) FROM $table_subdominios");
        // Total de planos ativos
        $total_planos = $wpdb->get_var("SELECT COUNT(*) FROM $table_planos");
        return array(
            'total_subdominios' => $total_subdominios ?: 0,
            'total_planos' => $total_planos ?: 0
        );
    }
    /**
     * Obtém estatísticas de um blog específico para o dashboard do subdomínio.
     *
     * @since    1.0.0
     * @param    int       $blog_id    ID do blog.
     * @return   array                 Array com as estatísticas do blog.
     */
    public static function get_estatisticas_blog($blog_id) {
        // Obtém informações do subdomínio
        $subdominio = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$subdominio) {
            return array(
                'tem_plano' => false,
                'plano_nome' => 'Não definido',
                'limite_paginas' => 0,
                'paginas_publicadas' => 0,
                'paginas_rascunho' => 0,
                'paginas_lixeira' => 0,
                'paginas_total' => 0,
                'paginas_restantes' => 0,
                'percentual_uso' => 0,
                'mostrar_alerta' => false
            );
        }
        // Conta TODAS as páginas e posts (publicados, rascunhos, pendentes, agendados e lixeira)
        $paginas_total = Limiter_MKP_Pro_Database::count_pages_posts($blog_id, false, true);
        // Conta páginas e posts publicados
        $paginas_publicadas = Limiter_MKP_Pro_Database::count_published_pages_posts($blog_id);
        // Conta páginas e posts na lixeira
        $paginas_lixeira = Limiter_MKP_Pro_Database::count_trash_pages_posts($blog_id);
        // Calcula páginas em rascunho
        $paginas_rascunho = $paginas_total - $paginas_publicadas - $paginas_lixeira;
        // Define o limite de páginas
        $limite_paginas = !empty($subdominio->limite_personalizado) ? 
                          $subdominio->limite_personalizado : 
                          $subdominio->plano_limite;
        // Calcula páginas restantes
        $paginas_restantes = max(0, $limite_paginas - $paginas_total);
        // Calcula percentual de uso
        $percentual_uso = $limite_paginas > 0 ? 
                          min(100, round(($paginas_total / $limite_paginas) * 100)) : 
                          100;
        // Verifica se deve mostrar alerta (penúltima página)
        $mostrar_alerta = ($paginas_total == ($limite_paginas - 1));
        return array(
            'tem_plano' => true,
            'plano_nome' => $subdominio->plano_nome,
            'plano_id' => $subdominio->plano_id,
            'limite_paginas' => $limite_paginas,
            'paginas_publicadas' => $paginas_publicadas,
            'paginas_rascunho' => $paginas_rascunho,
            'paginas_lixeira' => $paginas_lixeira,
            'paginas_total' => $paginas_total,
            'paginas_restantes' => $paginas_restantes,
            'percentual_uso' => $percentual_uso,
            'mostrar_alerta' => $mostrar_alerta
        );
    }
    /**
     * Obtém a distribuição de subdomínios por plano.
     *
     * @since    1.0.0
     * @return   array    Array com a distribuição de subdomínios por plano.
     */
    public static function get_distribuicao_planos() {
        global $wpdb;
        $table_subdominios = Limiter_MKP_Pro_Database::get_table_name('subdominios');
        $table_planos = Limiter_MKP_Pro_Database::get_table_name('planos');
        $query = "SELECT p.id, p.nome, COUNT(s.id) as total
                 FROM $table_planos p
                 LEFT JOIN $table_subdominios s ON p.id = s.plano_id
                 GROUP BY p.id
                 ORDER BY p.limite_paginas ASC";
        return $wpdb->get_results($query);
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/models/class-database-lifecycle.php e os codigos deste arquivo:
<?php
/**
 * Queries específicas para gerenciamento de ciclo de vida
 */

class Limiter_MKP_Pro_Database_Lifecycle {
    
    /**
     * Obtém blogs com status específico
     */
    public static function get_blogs_by_status($status, $limit = 100) {
        global $wpdb;
        
        $blogs = $wpdb->get_col($wpdb->prepare(
            "SELECT blog_id 
            FROM {$wpdb->blogmeta} 
            WHERE meta_key = 'limiter_blog_status' 
            AND meta_value = %s 
            LIMIT %d",
            $status, $limit
        ));
        
        return array_map('intval', $blogs);
    }
    
    /**
     * Obtém blogs agendados para exclusão
     */
    public static function get_blogs_scheduled_for_deletion() {
        global $wpdb;
        
        $today = current_time('mysql');
        
        return $wpdb->get_results($wpdb->prepare(
            "SELECT b.blog_id, bm.meta_value as deletion_date
            FROM {$wpdb->blogmeta} bm
            INNER JOIN {$wpdb->blogs} b ON b.blog_id = bm.blog_id
            WHERE bm.meta_key = 'limiter_scheduled_deletion_date'
            AND bm.meta_value <= %s
            AND b.deleted = 0",
            $today
        ));
    }
    
    /**
     * Obtém estatísticas de ciclo de vida
     */
    public static function get_lifecycle_stats() {
        global $wpdb;
        
        $stats = [
            'total_blogs' => 0,
            'active' => 0,
            'grace_period' => 0,
            'suspended' => 0,
            'locked' => 0,
            'scheduled_deletion' => 0,
            'cancelled_today' => 0,
            'failed_payments' => 0
        ];
        
        // Total de blogs
        $stats['total_blogs'] = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->blogs} WHERE deleted = 0");
        
        // Por status
        $status_counts = $wpdb->get_results(
            "SELECT meta_value as status, COUNT(*) as count
            FROM {$wpdb->blogmeta}
            WHERE meta_key = 'limiter_blog_status'
            GROUP BY meta_value"
        );
        
        foreach ($status_counts as $row) {
            if (isset($stats[$row->status])) {
                $stats[$row->status] = (int) $row->count;
            }
        }
        
        // Cancelamentos hoje
        $stats['cancelled_today'] = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT s.blog_id)
            FROM {$wpdb->blogmeta} s
            WHERE s.meta_key = 'limiter_subscription_status'
            AND s.meta_value = 'cancelled'
            AND DATE(s.meta_date) = %s",
            current_time('Y-m-d')
        ));
        
        return $stats;
    }
    
    /**
     * Processa exclusões agendadas
     */
    public static function process_scheduled_deletions() {
        $blogs = self::get_blogs_scheduled_for_deletion();
        $deleted = [];
        
        foreach ($blogs as $blog) {
            // Backup antes de deletar
            self::create_pre_deletion_backup($blog->blog_id);
            
            // Marca como deletado (não deleta fisicamente ainda)
            update_blog_status($blog->blog_id, 'deleted', 1);
            
            // Agenda exclusão física para 30 dias depois
            $physical_deletion = date('Y-m-d', strtotime('+30 days'));
            update_blog_option($blog->blog_id, 'limiter_physical_deletion_date', $physical_deletion);
            
            $deleted[] = $blog->blog_id;
        }
        
        return $deleted;
    }
    
    /**
     * Cria backup antes da exclusão
     */
    private static function create_pre_deletion_backup($blog_id) {
        // Implementar sistema de backup
        // Pode ser exportação XML + compactação de uploads
        // Salvar em diretório seguro ou S3
        
        $backup_dir = WP_CONTENT_DIR . '/limiter-backups/';
        wp_mkdir_p($backup_dir);
        
        $filename = "blog-{$blog_id}-" . date('Y-m-d-H-i-s') . '.json';
        $backup_data = [
            'blog_id' => $blog_id,
            'backup_date' => current_time('mysql'),
            'metadata' => self::get_blog_metadata($blog_id)
        ];
        
        file_put_contents(
            $backup_dir . $filename,
            json_encode($backup_data, JSON_PRETTY_PRINT)
        );
        
        return $backup_dir . $filename;
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/models/class-email.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo envio de e-mails.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/models
 */
if (!defined('ABSPATH')) {
    exit;
}
class Limiter_MKP_Pro_Email {
    /**
     * Retorna cabeçalhos padronizados de envio de e-mails.
     */
    private static function get_default_headers($from_name = null) {
        if ($from_name === null) {
            $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
            $from_name = isset($config['nome_sistema']) ? $config['nome_sistema'] : 'Marketing Place Store';
        }
        $domain = parse_url(network_site_url(), PHP_URL_HOST);
        return array(
            'Content-Type: text/plain; charset=UTF-8',
            'From: ' . sanitize_text_field($from_name) . ' <noreply@' . $domain . '>'
        );
    }
    /**
     * Envia e-mail de notificação sobre solicitação de mudança de plano.
     */
    public static function notificar_solicitacao($blog_id, $plano_atual_id, $plano_solicitado_id) {
        global $wpdb;
        // Configurações do plugin
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $email_notificacao = !empty($config['email_notificacao'])
            ? sanitize_email($config['email_notificacao'])
            : 'alterar-plano@marketing-place.store';
        $nome_sistema = !empty($config['nome_sistema']) ? $config['nome_sistema'] : 'Marketing Place Store';
        // Informações do blog
        $blog = get_blog_details($blog_id);
        if (!$blog) {
            return false;
        }
        // Planos
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $plano_atual = Limiter_MKP_Pro_Database::get_plano($plano_atual_id);
        $plano_solicitado = Limiter_MKP_Pro_Database::get_plano($plano_solicitado_id);
        if (!$plano_atual || !$plano_solicitado) {
            return false;
        }
        // Subdomínio
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        // Obtém mensagens personalizadas
        $assunto = isset($config['email_solicitacao_titulo']) ? $config['email_solicitacao_titulo'] : '[Limiter MKP Pro] Nova solicitação de mudança de plano - [SITE]';
        $mensagem = isset($config['email_solicitacao_corpo']) ? $config['email_solicitacao_corpo'] : "Uma nova solicitação de mudança de plano foi registrada:\nSite: [SITE]\nURL: [URL_SITE]\nID do Blog: [BLOG_ID]\nPlano Atual: [PLANO_ATUAL] (limite de [LIMITE_ATUAL] páginas)\nPlano Solicitado: [PLANO_SOLICITADO] (limite de [LIMITE_SOLICITADO] páginas)\nInformações do Cliente:\nNome: [NOME_CLIENTE]\nE-mail: [EMAIL_CLIENTE]\nTelefone: [TELEFONE_CLIENTE]\nPara processar esta solicitação, acesse o painel da rede:\n[PAINEL_LINK]\nMensagem automática do plugin Limiter MKP Pro.";
        // Substitui placeholders
        $dados = array(
            'SITE' => sanitize_text_field($blog->blogname),
            'URL_SITE' => esc_url($blog->siteurl),
            'BLOG_ID' => $blog_id,
            'PLANO_ATUAL' => sanitize_text_field($plano_atual->nome),
            'LIMITE_ATUAL' => intval($plano_atual->limite_paginas),
            'PLANO_SOLICITADO' => sanitize_text_field($plano_solicitado->nome),
            'LIMITE_SOLICITADO' => intval($plano_solicitado->limite_paginas),
            'NOME_CLIENTE' => $sub ? sanitize_text_field($sub->nome_cliente) : 'Não informado',
            'EMAIL_CLIENTE' => $sub ? sanitize_email($sub->email_cliente) : 'Não informado',
            'TELEFONE_CLIENTE' => $sub ? sanitize_text_field($sub->telefone_cliente) : 'Não informado',
            'PAINEL_LINK' => network_admin_url('admin.php?page=limiter-mkp-pro-solicitacoes')
        );
        $assunto = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($assunto, $dados);
        $mensagem = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($mensagem, $dados);
        $headers = self::get_default_headers($nome_sistema);
        // Envia para e-mail principal
        $enviado = wp_mail($email_notificacao, $assunto, $mensagem, $headers);
        // Envia para super administradores
        foreach (get_super_admins() as $admin_login) {
            $user = get_user_by('login', $admin_login);
            if ($user && sanitize_email($user->user_email) !== $email_notificacao) {
                wp_mail($user->user_email, $assunto, $mensagem, $headers);
            }
        }
        return $enviado;
    }
    /**
     * Envia e-mail de confirmação da solicitação (aprovada/rejeitada).
     */
    public static function confirmar_processamento($blog_id, $plano_id, $status) {
        $blog = get_blog_details($blog_id);
        if (!$blog) {
            return false;
        }
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub || empty($sub->email_cliente)) {
            return false;
        }
        $plano = Limiter_MKP_Pro_Database::get_plano($plano_id);
        if (!$plano) {
            return false;
        }
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $nome_sistema = !empty($config['nome_sistema']) ? $config['nome_sistema'] : 'Marketing Place Store';
        if ($status === 'aprovada') {
            $assunto_padrao = '[Limiter MKP Pro] Atualização da sua solicitação - [SITE]';
            $mensagem_padrao = "Olá [NOME_CLIENTE],\nSua solicitação de mudança de plano foi APROVADA!\nSite: [SITE]\nURL: [URL_SITE]\nNovo Plano: [NOVO_PLANO]\nLimite de Páginas: [NOVO_LIMITE]\nSeu site já está atualizado com o novo limite.\nAtenciosamente,\nEquipe Marketing Place Store";
            $assunto_config = isset($config['email_confirmacao_aprovada_titulo']) ? $config['email_confirmacao_aprovada_titulo'] : $assunto_padrao;
            $mensagem_config = isset($config['email_confirmacao_aprovada_corpo']) ? $config['email_confirmacao_aprovada_corpo'] : $mensagem_padrao;
        } else {
            $assunto_padrao = '[Limiter MKP Pro] Atualização da sua solicitação - [SITE]';
            $mensagem_padrao = "Olá [NOME_CLIENTE],\nSua solicitação de mudança de plano foi REJEITADA.\nSite: [SITE]\nURL: [URL_SITE]\nPara mais detalhes, entre em contato com o suporte.\nAtenciosamente,\nEquipe Marketing Place Store";
            $assunto_config = isset($config['email_confirmacao_rejeitada_titulo']) ? $config['email_confirmacao_rejeitada_titulo'] : $assunto_padrao;
            $mensagem_config = isset($config['email_confirmacao_rejeitada_corpo']) ? $config['email_confirmacao_rejeitada_corpo'] : $mensagem_padrao;
        }
        $dados = array(
            'NOME_CLIENTE' => $sub->nome_cliente ?: 'Cliente',
            'SITE' => sanitize_text_field($blog->blogname),
            'URL_SITE' => esc_url($blog->siteurl),
            'NOVO_PLANO' => sanitize_text_field($plano->nome),
            'NOVO_LIMITE' => intval($plano->limite_paginas)
        );
        $assunto = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($assunto_config, $dados);
        $mensagem = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($mensagem_config, $dados);
        $headers = self::get_default_headers($nome_sistema);
        return wp_mail($sub->email_cliente, $assunto, $mensagem, $headers);
    }
    /**
     * Alerta limite de páginas.
     */
    public static function alerta_limite($blog_id, $limite, $utilizadas) {
        $blog = get_blog_details($blog_id);
        if (!$blog) {
            return false;
        }
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub || empty($sub->email_cliente)) {
            return false;
        }
        $restantes = max(0, $limite - $utilizadas);
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $nome_sistema = !empty($config['nome_sistema']) ? $config['nome_sistema'] : 'Marketing Place Store';
        $assunto_padrao = '[Limiter MKP Pro] Alerta: limite de páginas quase atingido - [SITE]';
        $mensagem_padrao = "Olá [NOME_CLIENTE],\nEste é um alerta automático:\nSeu site está próximo do limite de páginas permitido.\nSite: [SITE]\nURL: [URL_SITE]\nLimite: [LIMITE] páginas\nUtilizadas: [UTILIZADAS]\nRestantes: [RESTANTES]\nConsidere solicitar um plano maior para evitar interrupções.\nAtenciosamente,\nEquipe Marketing Place Store";
        $assunto = isset($config['email_alerta_limite_titulo']) ? $config['email_alerta_limite_titulo'] : $assunto_padrao;
        $mensagem = isset($config['email_alerta_limite_corpo']) ? $config['email_alerta_limite_corpo'] : $mensagem_padrao;
        $dados = array(
            'NOME_CLIENTE' => $sub->nome_cliente ?: 'Cliente',
            'SITE' => sanitize_text_field($blog->blogname),
            'URL_SITE' => esc_url($blog->siteurl),
            'LIMITE' => intval($limite),
            'UTILIZADAS' => intval($utilizadas),
            'RESTANTES' => intval($restantes)
        );
        $assunto = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($assunto, $dados);
        $mensagem = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($mensagem, $dados);
        $headers = self::get_default_headers($nome_sistema);
        return wp_mail($sub->email_cliente, $assunto, $mensagem, $headers);
    }
    /**
     * Envia e-mail de configuração de subdomínio
     */
    public static function enviar_email_configuracao($email_destino, $nome_cliente, $url_configuracao) {
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $nome_sistema = !empty($config['nome_sistema']) ? $config['nome_sistema'] : 'Marketing Place Store';
        $assunto_padrao = 'Configure seu Subdomínio - Marketing Place Store';
        $mensagem_padrao = "Olá [NOME_CLIENTE],\nSua assinatura foi confirmada com sucesso! 🎉\nAgora você precisa configurar seu subdomínio para começar a usar nossa plataforma.\n📝 Configure seu subdomínio:\n[URL_CONFIGURACAO]\n⚠️ Este link expira em 7 dias\nComo funciona:\n1. Clique no link acima\n2. Escolha o nome do seu subdomínio (exemplo: 'loja' se tornará 'loja-mkp.marketing-place.store')\n3. Crie sua senha\n4. Seu subdomínio será criado automaticamente\nSe tiver qualquer dúvida, entre em contato conosco.\nAtenciosamente,\nEquipe Marketing Place Store";
        $assunto = isset($config['email_configuracao_subdominio_titulo']) ? $config['email_configuracao_subdominio_titulo'] : $assunto_padrao;
        $mensagem = isset($config['email_configuracao_subdominio_corpo']) ? $config['email_configuracao_subdominio_corpo'] : $mensagem_padrao;
        $dados = array(
            'NOME_CLIENTE' => $nome_cliente,
            'URL_CONFIGURACAO' => $url_configuracao
        );
        $assunto = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($assunto, $dados);
        $mensagem = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($mensagem, $dados);
        $headers = self::get_default_headers($nome_sistema);
        return wp_mail($email_destino, $assunto, $mensagem, $headers);
    }
    /**
     * Envia e-mail de boas-vindas ao subdomínio
     */
    public static function enviar_email_boas_vindas($email_destino, $dados_usuario) {
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $nome_sistema = !empty($config['nome_sistema']) ? $config['nome_sistema'] : 'Marketing Place Store';
        $assunto_padrao = 'Bem-vindo ao seu Subdomínio - Marketing Place Store';
        $mensagem_padrao = "Olá [NOME_CLIENTE],\nSeu subdomínio foi criado com sucesso! 🎉\n📋 Detalhes do seu plano:\nPlano: [NOME_PLANO]\nLimite: [LIMITE_PAGINAS] páginas/posts\n🔐 Suas credenciais de acesso:\nSubdomínio: [NOME_SUBDOMINIO].marketing-place.store\nE-mail: [EMAIL_USUARIO]\nSenha: [SENHA_ACESSO]\n🌐 Links importantes:\nAcessar Administração: [URL_ADM]\nVer seu Site: [URL_SITE]\n💡 Dicas:\n- Você pode personalizar seu subdomínio acessando a área de administração\n- Crie páginas e posts dentro do limite do seu plano\n- Em caso de dúvidas, entre em contato conosco\nAtenciosamente,\nEquipe Marketing Place Store";
        $assunto = isset($config['email_boas_vindas_subdominio_titulo']) ? $config['email_boas_vindas_subdominio_titulo'] : $assunto_padrao;
        $mensagem = isset($config['email_boas_vindas_subdominio_corpo']) ? $config['email_boas_vindas_subdominio_corpo'] : $mensagem_padrao;
        $dados = array(
            'NOME_CLIENTE' => $dados_usuario['nome_cliente'],
            'NOME_PLANO' => $dados_usuario['plano_nome'],
            'LIMITE_PAGINAS' => $dados_usuario['limite_paginas'],
            'NOME_SUBDOMINIO' => $dados_usuario['subdominio'],
            'EMAIL_USUARIO' => $dados_usuario['email_usuario'],
            'SENHA_ACESSO' => $dados_usuario['senha'],
            'URL_ADM' => $dados_usuario['url_admin'],
            'URL_SITE' => $dados_usuario['url_site']
        );
        $assunto = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($assunto, $dados);
        $mensagem = Limiter_MKP_Pro_Configuracoes::substituir_placeholders($mensagem, $dados);
        $headers = self::get_default_headers($nome_sistema);
        return wp_mail($email_destino, $assunto, $mensagem, $headers);
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/class-limiter.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pela limitação de páginas e posts.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/public
 */
class Limiter_MKP_Pro_Limiter {
    /**
     * O identificador único deste plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string    $plugin_name    O nome ou identificador único deste plugin.
     */
    private $plugin_name;
    /**
     * A versão atual do plugin.
     *
     * @since    1.0.0
     * @access   private
     * @var      string    $version    A versão atual do plugin.
     */
    private $version;
    /**
     * Inicializa a classe e define suas propriedades.
     *
     * @since    1.0.0
     * @param    string    $plugin_name       O nome do plugin.
     * @param    string    $version           A versão do plugin.
     */
    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
        // Verifica o limite antes de exibir a tela de criação de nova página/post
        add_action('load-post-new.php', array($this, 'check_limit_before_new_post_screen'));
        // Adiciona filtro para bloquear a criação de novas páginas/posts quando o limite for atingido
        add_filter('wp_insert_post_empty_content', array($this, 'block_new_post_if_limit_reached'), 10, 2);
        // Adiciona verificação para REST API
        add_filter('rest_pre_dispatch', array($this, 'check_rest_api_limits'), 10, 3);
        // Adiciona verificação para XML-RPC
        add_filter('xmlrpc_methods', array($this, 'check_xmlrpc_limits'));
    }
    /**
     * Verifica o limite antes de exibir a tela de criação de nova página/post.
     * Se o limite for atingido, exibe a mensagem usando wp_die().
     *
     * @since    1.0.0
     */
    public function check_limit_before_new_post_screen() {
        global $typenow;
        // Obtém o ID do blog atual
        $blog_id = get_current_blog_id();
        // Obtém o subdomínio
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub || !$sub->plano_id) {
            return; // Sem limite definido
        }
        // Obtém o plano
        $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
        if (!$plano) {
            return;
        }
        // Obtém os tipos de post que contam para este plano
        $post_types = json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
        // Verifica se o tipo atual conta para o limite
        if (!in_array($typenow, $post_types)) {
            return;
        }
        // Conta o conteúdo
        $total_pages_posts = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
        // Obtém o limite
        $limite = !empty($sub->limite_personalizado) ? $sub->limite_personalizado : $plano->limite_paginas;
        // Se estiver dentro do limite, permite a criação
        if ($total_pages_posts < $limite) {
            return;
        }
        // Se chegou aqui, está tentando criar além do limite
        // Obtém a mensagem personalizada
        $configuracoes = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $mensagem = isset($configuracoes['mensagem_limite']) ? 
                    $configuracoes['mensagem_limite'] : 
                    'Desculpe o inconveniente, mas seu plano tem suporte a criação de [X] paginas. Considere fazer upgrade do seu plano para continuar criando novas páginas.';
        // Substitui o placeholder [X] pelo limite real
        $mensagem = str_replace('[X]', $limite, $mensagem);
        // Registra no log
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'limite_excedido',
            sprintf('Tentativa de criar página/post além do limite de %d.', $limite)
        );
        // Exibe a mensagem usando wp_die com botão de voltar
        wp_die(
            $mensagem,
            __('Limite de páginas atingido', 'limiter-mkp-pro'),
            array('back_link' => true)
        );
    }
    /**
     * Bloqueia a criação de novas páginas/posts quando o limite for atingido.
     * Este filtro é chamado antes da criação do post e retorna true para bloquear.
     *
     * @since    1.0.0
     * @param    boolean   $maybe_empty  Se o conteúdo está vazio.
     * @param    array     $postarr      Array com os dados do post.
     * @return   boolean                 True para bloquear, false para permitir.
     */
    public function block_new_post_if_limit_reached($maybe_empty, $postarr) {
        // Se já está vazio ou é uma atualização, não interfere
        if ($maybe_empty || !empty($postarr['ID'])) {
            return $maybe_empty;
        }
        // Obtém o ID do blog atual
        $blog_id = get_current_blog_id();
        // Obtém o subdomínio
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub || !$sub->plano_id) {
            return $maybe_empty; // Sem limite definido
        }
        // Obtém o plano
        $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
        if (!$plano) {
            return $maybe_empty;
        }
        // Obtém os tipos de post que contam para este plano
        $post_types = json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
        // Ignora tipos de post que não contam para o limite
        if (!in_array($postarr['post_type'], $post_types)) {
            return $maybe_empty;
        }
        // Conta o conteúdo
        $total_pages_posts = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
        // Obtém o limite
        $limite = !empty($sub->limite_personalizado) ? $sub->limite_personalizado : $plano->limite_paginas;
        // Se estiver dentro do limite, permite a criação
        if ($total_pages_posts < $limite) {
            return $maybe_empty;
        }
        // Se chegou aqui, está tentando criar além do limite
        // Obtém a mensagem personalizada
        $configuracoes = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $mensagem = isset($configuracoes['mensagem_limite']) ? 
                    $configuracoes['mensagem_limite'] : 
                    'Desculpe o inconveniente, mas seu plano tem suporte a criação de [X] paginas. Considere fazer upgrade do seu plano para continuar criando novas páginas.';
        // Substitui o placeholder [X] pelo limite real
        $mensagem = str_replace('[X]', $limite, $mensagem);
        // Registra no log
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'limite_excedido',
            sprintf('Tentativa de criar página/post além do limite de %d.', $limite)
        );
        // Exibe a mensagem usando wp_die com botão de voltar
        wp_die(
            $mensagem,
            __('Limite de páginas atingido', 'limiter-mkp-pro'),
            array('back_link' => true)
        );
        // Retorna true para bloquear a criação (caso wp_die não funcione)
        return true;
    }
    /**
     * Verifica o limite de páginas/posts ao salvar um post.
     * Esta é uma verificação secundária, caso o filtro block_new_post_if_limit_reached falhe.
     *
     * @since    1.0.0
     * @param    int       $post_id     ID do post.
     * @param    object    $post        Objeto do post.
     * @param    boolean   $update      Se é uma atualização ou novo post.
     */
    public function check_limit($post_id, $post, $update) {
        // Ignora autosaves e revisões
        if (wp_is_post_revision($post_id) || wp_is_post_autosave($post_id)) {
            return;
        }
        // Ignora atualizações, apenas verifica novas criações
        if ($update) {
            return;
        }
        // Obtém o ID do blog atual
        $blog_id = get_current_blog_id();
        // Obtém o subdomínio
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub || !$sub->plano_id) {
            return; // Sem limite definido
        }
        // Obtém o plano
        $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
        if (!$plano) {
            return;
        }
        // Obtém os tipos de post que contam para este plano
        $post_types = json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
        // Ignora tipos de post que não contam para o limite
        if (!in_array($post->post_type, $post_types)) {
            return;
        }
        // Conta o conteúdo
        $total_pages_posts = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
        // Obtém o limite
        $limite = !empty($sub->limite_personalizado) ? $sub->limite_personalizado : $plano->limite_paginas;
        // Se estiver dentro do limite, permite a criação
        if ($total_pages_posts < $limite) {
            return;
        }
        // Se chegou aqui, está tentando criar além do limite
        // Remove o post que estava sendo criado
        wp_delete_post($post_id, true);
        // Obtém a mensagem personalizada
        $configuracoes = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $mensagem = isset($configuracoes['mensagem_limite']) ? 
                    $configuracoes['mensagem_limite'] : 
                    'Desculpe o inconveniente, mas seu plano tem suporte a criação de [X] paginas. Considere fazer upgrade do seu plano para continuar criando novas páginas.';
        // Substitui o placeholder [X] pelo limite real
        $mensagem = str_replace('[X]', $limite, $mensagem);
        // Registra no log
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'limite_excedido',
            sprintf('Tentativa de criar página/post além do limite de %d.', $limite)
        );
        // Exibe a mensagem usando wp_die com botão de voltar
        wp_die(
            $mensagem,
            __('Limite de páginas atingido', 'limiter-mkp-pro'),
            array('back_link' => true)
        );
    }
    /**
     * Verifica o limite ao restaurar itens da lixeira.
     *
     * @since    1.0.0
     * @param    int       $post_id     ID do post.
     */
    public function check_limit_untrash($post_id) {
        $post = get_post($post_id);
        // Obtém o ID do blog atual
        $blog_id = get_current_blog_id();
        // Obtém o subdomínio
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub || !$sub->plano_id) {
            return; // Sem limite definido
        }
        // Obtém o plano
        $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
        if (!$plano) {
            return;
        }
        // Obtém os tipos de post que contam para este plano
        $post_types = json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
        // Ignora tipos de post que não contam para o limite
        if (!in_array($post->post_type, $post_types)) {
            return;
        }
        // Conta o conteúdo
        $total_pages_posts = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
        // Obtém o limite
        $limite = !empty($sub->limite_personalizado) ? $sub->limite_personalizado : $plano->limite_paginas;
        // Se estiver dentro do limite, permite a restauração
        if ($total_pages_posts < $limite) {
            return;
        }
        // Se chegou aqui, está tentando restaurar além do limite
        // Mantém o post na lixeira
        wp_trash_post($post_id);
        // Obtém a mensagem personalizada
        $configuracoes = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
        $mensagem = isset($configuracoes['mensagem_limite']) ? 
                    $configuracoes['mensagem_limite'] : 
                    'Desculpe o inconveniente, mas seu plano tem suporte a criação de [X] paginas. Considere fazer upgrade do seu plano para continuar criando novas páginas.';
        // Substitui o placeholder [X] pelo limite real
        $mensagem = str_replace('[X]', $limite, $mensagem);
        // Registra no log
        Limiter_MKP_Pro_Database::log(
            $blog_id,
            'limite_excedido_restauracao',
            sprintf('Tentativa de restaurar página/post da lixeira além do limite de %d.', $limite)
        );
        // Exibe a mensagem usando wp_die com botão de voltar
        wp_die(
            $mensagem,
            __('Limite de páginas atingido', 'limiter-mkp-pro'),
            array('back_link' => true)
        );
    }
    /**
     * Verifica limites na REST API.
     *
     * @since    1.1.0
     * @param    mixed           $response    Resposta atual.
     * @param    WP_REST_Server  $handler     Instância do servidor REST.
     * @param    WP_REST_Request $request     Requisição atual.
     * @return   mixed                        Resposta modificada ou erro.
     */
    public function check_rest_api_limits($response, $handler, $request) {
        $method = $request->get_method();
        $route = $request->get_route();
        if ($method === 'POST' && in_array($route, ['/wp/v2/pages', '/wp/v2/posts'])) {
            $blog_id = get_current_blog_id();
            $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
            if (!$sub || !$sub->plano_id) {
                return $response; // Sem limite definido
            }
            $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
            if (!$plano) {
                return $response;
            }
            $post_types = json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
            if (!in_array('page', $post_types) && !in_array('post', $post_types)) {
                return $response; // Nenhum dos tipos que contam
            }
            $total_pages_posts = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
            $limite = !empty($sub->limite_personalizado) ? $sub->limite_personalizado : $plano->limite_paginas;
            if ($total_pages_posts >= $limite && $limite > 0) {
                // Registra no log
                Limiter_MKP_Pro_Database::log(
                    $blog_id,
                    'limite_excedido_rest_api',
                    sprintf('Tentativa de criar página/post via REST API além do limite de %d.', $limite)
                );
                return new WP_Error(
                    'limite_atingido',
                    'Limite de páginas/posts atingido para este plano.',
                    array('status' => 403)
                );
            }
        }
        return $response;
    }
    /**
     * Verifica limites no XML-RPC.
     *
     * @since    1.1.0
     * @param    array     $methods    Métodos XML-RPC.
     * @return   array                 Métodos XML-RPC.
     */
    public function check_xmlrpc_limits($methods) {
        add_filter('xmlrpc_call', array($this, 'block_xmlrpc_if_limit_reached'));
        return $methods;
    }
    /**
     * Bloqueia criação via XML-RPC se o limite for atingido.
     *
     * @since    1.1.0
     * @param    string    $method    Método XML-RPC.
     */
    public function block_xmlrpc_if_limit_reached($method) {
        if (in_array($method, array('wp.newPost', 'wp.newPage'))) {
            $blog_id = get_current_blog_id();
            $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
            if (!$sub || !$sub->plano_id) {
                return; // Sem limite definido
            }
            $plano = Limiter_MKP_Pro_Database::get_plano($sub->plano_id);
            if (!$plano) {
                return;
            }
            $post_types = json_decode($plano->post_types_contaveis, true) ?: ['page', 'post'];
            if (!in_array('page', $post_types) && !in_array('post', $post_types)) {
                return; // Nenhum dos tipos que contam
            }
            $total_pages_posts = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
            $limite = !empty($sub->limite_personalizado) ? $sub->limite_personalizado : $plano->limite_paginas;
            if ($total_pages_posts >= $limite && $limite > 0) {
                // Registra no log
                Limiter_MKP_Pro_Database::log(
                    $blog_id,
                    'limite_excedido_xmlrpc',
                    sprintf('Tentativa de criar página/post via XML-RPC além do limite de %d.', $limite)
                );
                wp_die(__('Limite de páginas atingido', 'limiter-mkp-pro'));
            }
        }
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/class-public.php e os codigos deste arquivo:
<?php
/**
 * A funcionalidade voltada para o público (frontend) do plugin.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/public
 */
class Limiter_MKP_Pro_Public {
    private $plugin_name;
    private $version;
    
    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
        add_action('admin_menu', array($this, 'add_subdomain_dashboard_menu'));
        add_shortcode('mkp_dashboard_paginas', array($this, 'paginas_shortcode'));
    }
    
    /**
     * Verifica se a página atual contém um dos shortcodes do plugin.
     * Helper para otimização de carregamento de assets.
     *
     * @return bool
     */
    private function has_mkp_shortcodes() {
        global $post;
        
        if ( ! is_a( $post, 'WP_Post' ) ) {
            return false;
        }

        // Lista de todos os shortcodes usados pelo plugin
        $shortcodes = array(
            'mkp_dashboard_paginas',
            'mkp_registration_form',
            'mkp_subdomain_checker',
            'mkp_subdomain_configuration'
        );

        foreach ( $shortcodes as $shortcode ) {
            if ( has_shortcode( $post->post_content, $shortcode ) ) {
                return true;
            }
        }

        return false;
    }

    /**
     * Registra os estilos públicos do plugin.
     * OTIMIZAÇÃO: Carrega apenas se o shortcode estiver presente na página.
     *
     * @since    1.4.0
     */
    public function enqueue_styles() {
        // Se não tiver shortcode, não carrega o CSS
        if ( ! $this->has_mkp_shortcodes() ) {
            return;
        }

        wp_enqueue_style(
            $this->plugin_name,
            plugin_dir_url(__FILE__) . 'css/public.css',
            array(),
            $this->version,
            'all'
        );
    }
    
    /**
     * Registra os scripts públicos do plugin.
     * OTIMIZAÇÃO: Carrega apenas se o shortcode estiver presente na página.
     *
     * @since    1.4.0
     */
    public function enqueue_scripts() {
        // Se não tiver shortcode, não carrega o JS
        if ( ! $this->has_mkp_shortcodes() ) {
            return;
        }

        wp_enqueue_script(
            $this->plugin_name,
            plugin_dir_url(__FILE__) . 'js/public.js',
            array('jquery'),
            $this->version,
            true
        );
        
        wp_localize_script($this->plugin_name, 'limiter_mkp_pro_public', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('limiter_mkp_pro_public_nonce')
        ));
    }
    
    public function add_subdomain_dashboard_menu() {
        if (is_main_site() || !current_user_can('manage_options')) return;
        
        $blog_id = get_current_blog_id();
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        
        // Verifica se o subdomínio existe no sistema antes de adicionar o menu
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        if (!$sub) return;
        
        add_menu_page(
            'Meu MKP Pro',
            'Meu MKP Pro',
            'manage_options',
            'meu-mkp-pro',
            array($this, 'dashboard_page'),
            'dashicons-tickets',
            60
        );
        add_submenu_page(
            'meu-mkp-pro',
            'Minhas Páginas',
            'Minhas Páginas',
            'manage_options',
            'meu-mkp-pro-paginas',
            array($this, 'paginas_page')
        );
        add_submenu_page(
            'meu-mkp-pro',
            'Upgrade de Plano',
            'Upgrade de Plano',
            'manage_options',
            'meu-mkp-pro-upgrade',
            array($this, 'upgrade_page')
        );
    }
    
    public function dashboard_page() {
        $blog_id = get_current_blog_id();
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database-get-estatisticas.php';
        // Usa a versão com cache das estatísticas se disponível, ou busca direto
        $estatisticas = Limiter_MKP_Pro_Database_Get_Estatisticas::get_estatisticas_blog($blog_id);
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'public/partials/client-dashboard.php';
    }
    
    public function paginas_page() {
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'public/partials/client-paginas.php';
    }
    
    public function upgrade_page() {
        $blog_id = get_current_blog_id();
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $sub = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        $regiao = !empty($sub->regiao) ? $sub->regiao : 'global';
        $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', []);
        
        $url = ($regiao === 'jp') ? 
            ($config['planos_url_jp'] ?? home_url('/planos-jp/')) : 
            ($config['planos_url_global'] ?? home_url('/planos/'));
            
        echo '<div class="wrap"><h1>Upgrade de Plano</h1>';
        echo '<p>Acesse nossa loja para alterar seu plano:</p>';
        echo '<a href="' . esc_url($url) . '" class="button button-primary" target="_blank">🛒 Ver Planos</a>';
        echo '</div>';
    }
    
    public function paginas_shortcode() {
        ob_start();
        include LIMITER_MKP_PRO_PLUGIN_DIR . 'public/partials/client-paginas.php';
        return ob_get_clean();
    }
}


----------------------------------------------------------------------------------------

limiter-mkp-pro/public/class-registration-form.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo formulário de registro de subdomínios.
 *
 * @since      1.2.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/public
 */
class Limiter_MKP_Pro_Registration_Form {
  
    public function __construct() {
        add_shortcode('mkp_registration_form', array($this, 'render_registration_form'));
        add_action('wp_ajax_process_mkp_registration', array($this, 'process_registration'));
        add_action('wp_ajax_nopriv_process_mkp_registration', array($this, 'process_registration'));
        add_action('wp_ajax_check_subdomain_availability', array($this, 'check_subdomain_availability'));
        add_action('wp_ajax_nopriv_check_subdomain_availability', array($this, 'check_subdomain_availability'));
    }

    public function render_registration_form($atts) {
        if (is_user_logged_in()) {
            return '<p>Você já está logado. <a href="' . wp_logout_url(home_url()) . '">Sair</a></p>';
        }
        
        $planos = shortcode_atts(array(
            'plano_id' => '',
            'plano_nome' => 'Plano Básico'
        ), $atts);

        // Obtém configurações personalizadas
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
        $config_class = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', '1.0.0');
        $config = $config_class->get_configuracoes();
        
        $subdominio_disponivel = $config['subdominio_disponivel'];
        $subdominio_indisponivel = $config['subdominio_indisponivel'];
        $subdominio_curto = $config['subdominio_curto'];
        $registro_concluido = $config['registro_concluido'];
        
        ob_start();
        ?>
        <div id="mkp-registration-form-container">
            <form id="mkp-registration-form" enctype="multipart/form-data">
                <?php wp_nonce_field('mkp_registration_nonce', 'registration_nonce'); ?>
                <input type="hidden" name="plano_id" value="<?php echo esc_attr($planos['plano_id']); ?>">
                <input type="hidden" name="plano_nome" value="<?php echo esc_attr($planos['plano_nome']); ?>">
                <input type="hidden" name="action" value="process_mkp_registration">
            
                <h3>Dados Pessoais</h3>
                <div class="form-row">
                    <label for="mkp_nome">Nome Completo *</label>
                    <input type="text" id="mkp_nome" name="nome" required>
                </div>
                
                <div class="form-row">
                    <label for="mkp_email">E-mail *</label>
                    <input type="email" id="mkp_email" name="email" required>
                </div>

                <div class="form-row">
                    <label for="mkp_endereco">Endereço Completo *</label>
                    <textarea id="mkp_endereco" name="endereco" required></textarea>
                </div>
                
                <div class="form-row">
                    <label for="mkp_telefone">Telefone *</label>
                    <input type="text" id="mkp_telefone" name="telefone" required>
                </div>
                
                <div class="form-row">
                    <label for="mkp_cpf">CPF ou Passaporte *</label>
                    <input type="text" id="mkp_cpf" name="cpf_passaporte" required>
                </div>
                <div class="form-row">
                    <label for="mkp_documento">Documento (RG ou Passaporte) *</label>
                    <input type="file" id="mkp_documento" name="documento" accept=".jpg,.jpeg,.png,.pdf" required>
                    <small>Formatos: JPG, PNG, PDF (máx. 5MB)</small>
                </div>
                
                <h3>Dados de Acesso</h3>
                <div class="form-row">
                    <label for="mkp_subdominio">Nome do Subdomínio *</label>
                    <div class="mkp-input-wrapper" style="position: relative;">
                        <input type="text" id="mkp_subdominio" name="subdominio" autocomplete="off" required>
                        <span class="mkp-loading-spinner" style="display:none; position: absolute; right: 10px; top: 10px;">Checking...</span>
                    </div>
                    <small>Seu subdomínio será: <span id="subdomain-preview">...</span></small>
                    <div id="subdomain-feedback-container"></div>
                </div>
                <div class="form-row">
                    <label for="mkp_username">Nome de Usuário *</label>
                    <input type="text" id="mkp_username" name="username" required>
                </div>
                <div class="form-row">
                    <label for="mkp_password">Senha *</label>
                    <input type="password" id="mkp_password" name="password" minlength="6" required>
                    <small>Mínimo 6 caracteres</small>
                </div>
                <div class="form-row">
                    <label for="mkp_confirm_password">Confirmar Senha *</label>
                    <input type="password" id="mkp_confirm_password" name="confirm_password" minlength="6" required>
                </div>
                <div class="form-row">
                    <button type="submit" id="mkp-submit-btn">Criar Subdomínio</button>
                </div>
                <div id="mkp-message"></div>
            </form>
        </div>
        
        <style>
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-row input, .form-row textarea, .form-row select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-row small { color: #666; font-size: 12px; }
        /* Estados visuais */
        #mkp_subdominio.subdomain-available { border-color: #28a745; background-color: #f8fff9; }
        #mkp_subdominio.subdomain-taken { border-color: #dc3545; background-color: #fff8f8; }
        #mkp_subdominio.checking { border-color: #ffc107; background-color: #fffdf5; }
        /* Mensagens */
        .subdomain-message { margin-top: 5px; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
        .subdomain-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .subdomain-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .subdomain-message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        #mkp-submit-btn { background: #007cba; color: white; padding: 12px 30px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #mkp-submit-btn:hover { background: #005a87; }
        #mkp-submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        #mkp-message { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        </style>
       
        <script>
        jQuery(document).ready(function($) {
            var subdomainAvailable = false;
            var checkTimeout = null;
            var currentRequest = null;
            var $input = $('#mkp_subdominio');
            var $feedback = $('#subdomain-feedback-container');
            var $submitBtn = $('#mkp-submit-btn');
            var $preview = $('#subdomain-preview');
            
            // Sufixo vindo do PHP
            var sufixo = '<?php 
                $config = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
                echo esc_js(isset($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp');
            ?>';
            
            $input.on('input', function() {
                var rawValue = $(this).val().toLowerCase();
                var cleanValue = rawValue.replace(/[^a-z0-9-]/g, '');
                if (rawValue !== cleanValue) {
                    $(this).val(cleanValue);
                }
                $preview.text(cleanValue + sufixo + '.' + window.location.hostname);
                
                // Resetar estados
                subdomainAvailable = false;
                $input.removeClass('subdomain-available subdomain-taken checking');
                $feedback.empty();
                clearTimeout(checkTimeout);
                
                // Abortar requisição anterior se existir
                if (currentRequest) {
                    currentRequest.abort();
                    currentRequest = null;
                }
                
                if (cleanValue.length < 3) {
                    if(cleanValue.length > 0) showSubdomainMessage('<?php echo esc_js($subdominio_curto); ?>', 'warning');
                    return;
                }
                
                // Iniciar delay
                $input.addClass('checking');
                checkTimeout = setTimeout(function() {
                    checkSubdomainAvailability(cleanValue);
                }, 600);
            });
            
            function checkSubdomainAvailability(subdomain) {
                // Desabilita botão enquanto verifica
                $submitBtn.prop('disabled', true);
                currentRequest = $.ajax({
                    url: '<?php echo admin_url('admin-ajax.php'); ?>',
                    type: 'POST',
                    data: { 
                        'action': 'check_subdomain_availability',
                        'subdominio': subdomain
                    },
                    success: function(response) {
                        $input.removeClass('checking');
                        if (response.success) {
                            $input.addClass('subdomain-available');
                            subdomainAvailable = true;
                            showSubdomainMessage('<?php echo esc_js($subdominio_disponivel); ?>', 'success');
                            $submitBtn.prop('disabled', false);
                        } else {
                            $input.addClass('subdomain-taken');
                            subdomainAvailable = false;
                            showSubdomainMessage('<?php echo esc_js($subdominio_indisponivel); ?>', 'error');
                        }
                    },
                    error: function(jqXHR) {
                        if (jqXHR.statusText !== 'abort') {
                            $input.removeClass('checking');
                            showSubdomainMessage('Erro de conexão. Tente novamente.', 'error');
                        }
                    },
                    complete: function() {
                        currentRequest = null;
                    }
                });
            }
           
            function showSubdomainMessage(message, type) {
                var html = '<div class="subdomain-message ' + type + '">' + message + '</div>';
                $feedback.html(html);
            }
            
            $('#mkp-registration-form').on('submit', function(e) {
                e.preventDefault();
                if (!subdomainAvailable) {
                    $('#mkp-message').html('<div class="error">Por favor, escolha um subdomínio disponível.</div>');
                    return;
                }
                var password = $('#mkp_password').val();
                var confirmPassword = $('#mkp_confirm_password').val();
                if (password !== confirmPassword) {
                    $('#mkp-message').html('<div class="error">As senhas não coincidem.</div>');
                    return;
                }
                
                var formData = new FormData(this);
                $submitBtn.prop('disabled', true).text('Processando...');
                $('#mkp-message').empty();
                
                $.ajax({
                    url: '<?php echo admin_url('admin-ajax.php'); ?>',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#mkp-message').html('<div class="success"><?php echo esc_js($registro_concluido); ?></div>');
                            $('#mkp-registration-form')[0].reset();
                            subdomainAvailable = false;
                            $input.removeClass('subdomain-available subdomain-taken');
                            $feedback.empty();
                            $preview.text('...');
                        } else {
                            $('#mkp-message').html('<div class="error">' + response.data.message + '</div>');
                            $submitBtn.prop('disabled', false).text('Criar Subdomínio');
                        }
                    },
                    error: function() {
                        $('#mkp-message').html('<div class="error">Erro crítico ao processar. Contate o suporte.</div>');
                        $submitBtn.prop('disabled', false).text('Criar Subdomínio');
                    }
                });
            });
        });
        </script>
        <?php
        return ob_get_clean();
    }

    public function process_registration() {
        if (!isset($_POST['registration_nonce']) || !wp_verify_nonce($_POST['registration_nonce'], 'mkp_registration_nonce')) {
            wp_send_json_error(array('message' => 'Erro de segurança.'));
        }
        
        $nome = sanitize_text_field($_POST['nome']);
        // SANITIZAÇÃO DE EMAIL ADICIONADA
        $email = sanitize_email($_POST['email']);
        $endereco = sanitize_textarea_field($_POST['endereco']);
        $telefone = sanitize_text_field($_POST['telefone']);
        $cpf_passaporte = sanitize_text_field($_POST['cpf_passaporte']);
        $username = sanitize_user($_POST['username']);
        $password = $_POST['password'];
        $plano_id = intval($_POST['plano_id']);

        // VALIDAÇÃO DE EMAIL ADICIONADA
        if (empty($email) || !is_email($email)) {
            wp_send_json_error(array('message' => 'O e-mail informado é inválido.'));
        }

        // Limpa e valida o subdomínio
        $subdominio = strtolower(sanitize_text_field($_POST['subdominio'] ?? ''));
        $subdominio = preg_replace('/[^a-z0-9-]/', '', $subdominio);
        
        if (empty($subdominio) || strlen($subdominio) < 3) {
            wp_send_json_error(array('message' => 'Nome do subdomínio inválido (mínimo 3 caracteres).'));
        }
        
        // Instanciação da classe de configurações
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
        $config_class = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', '1.4.1');
        $config = $config_class->get_configuracoes();
        $sufixo = !empty($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp';
        $subdominio_completo = $subdominio . $sufixo;
        
        // Verificação avançada de blacklist
        if (Limiter_MKP_Pro_Configuracoes::is_subdomain_blacklisted($subdominio)) {
            wp_send_json_error(array('message' => 'Este nome de subdomínio é reservado e não pode ser utilizado.'));
        }
        
        global $current_site;
        if (domain_exists($subdominio_completo . '.' . $current_site->domain, '/')) {
            wp_send_json_error(array('message' => 'Este subdomínio já foi escolhido por outro usuário.'));
        }
        
        if (!function_exists('wp_handle_upload')) {
            require_once(ABSPATH . 'wp-admin/includes/file.php');
        }
        
        if (!isset($_FILES['documento'])) {
            wp_send_json_error(array('message' => 'O documento é obrigatório.'));
        }
        
        $uploaded_file = $_FILES['documento'];
        
        // --- INÍCIO CORREÇÃO DE SEGURANÇA (BLINDAGEM DE UPLOAD) ---
        // 1. Verifica extensão e tipo via WordPress
        $file_check = wp_check_filetype_and_ext($uploaded_file['tmp_name'], $uploaded_file['name']);
        $ext = $file_check['ext'];
        $type = $file_check['type'];
        
        // 2. Lista de permitidos
        $allowed_mimes = [
            'jpg'  => 'image/jpeg',
            'jpeg' => 'image/jpeg',
            'png'  => 'image/png',
            'pdf'  => 'application/pdf'
        ];
        
        // 3. Validação Cruzada (Extensão permitida e compatível com MIME do WP)
        if ( !$ext || !$type || !array_key_exists($ext, $allowed_mimes) ) {
            wp_send_json_error(array('message' => 'Tipo de arquivo não permitido. Apenas JPG, PNG e PDF.'));
            exit;
        }

        // 4. Verificação Profunda (Magic Numbers) - BLINDAGEM REAL
        // Garante que o conteúdo do arquivo corresponde à extensão declarada
        if (function_exists('finfo_open')) {
            $finfo = finfo_open(FILEINFO_MIME_TYPE);
            $real_mime = finfo_file($finfo, $uploaded_file['tmp_name']);
            finfo_close($finfo);

            // Se o tipo real detectado não bater com o esperado para aquela extensão, bloqueia
            if ($real_mime !== $allowed_mimes[$ext]) {
                 // Tenta registrar tentativa maliciosa se o handler de erro existir
                 if (class_exists('Limiter_MKP_Pro_Error_Handler')) {
                     Limiter_MKP_Pro_Error_Handler::log_security_violation('upload_fake_extension', [
                         'filename' => $uploaded_file['name'],
                         'real_mime' => $real_mime,
                         'claimed_ext' => $ext
                     ]);
                 }
                 wp_send_json_error(array('message' => 'Arquivo corrompido ou inseguro detectado. Upload bloqueado.'));
                 exit;
            }
        }
        // --- FIM CORREÇÃO DE SEGURANÇA ---

        $upload_overrides = array('test_form' => false);
        $movefile = wp_handle_upload($uploaded_file, $upload_overrides);
        
        if (isset($movefile['error'])) {
            wp_send_json_error(array('message' => 'Erro no upload do documento: ' . $movefile['error']));
        }
        
        $result = $this->create_subdomain_and_user(
            $nome, $email, $endereco, $telefone, $cpf_passaporte, 
            $movefile['url'], $subdominio_completo, $username, $password, $plano_id
        );

        if ($result['success']) {
            wp_send_json_success(array('message' => 'Subdomínio criado com sucesso! Você receberá um e-mail com as instruções de acesso.'));
        } else {
            wp_send_json_error(array('message' => $result['message']));
        }
    }

    public function check_subdomain_availability() {
        global $current_site;
        $subdominio = strtolower(sanitize_text_field($_POST['subdominio'] ?? ''));
        $subdominio = preg_replace('/[^a-z0-9-]/', '', $subdominio);

        // 1. Validações básicas
        if (strlen($subdominio) < 3) {
            wp_send_json_error(array('message' => 'Muito curto (mínimo 3 caracteres).'));
        }
        
        // 2. Sufixo e verificação
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
        $config_class = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', '1.4.1');
        $config = $config_class->get_configuracoes();
        $sufixo = !empty($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp';
        $subdominio_completo = $subdominio . $sufixo;
        
        // 3. Verificação de blacklist avançada
        if (Limiter_MKP_Pro_Configuracoes::is_subdomain_blacklisted($subdominio)) {
            wp_send_json_error(array('message' => 'Este nome de subdomínio é reservado.'));
        }
        
        // 4. Verifica se já existe
        if (domain_exists($subdominio_completo . '.' . $current_site->domain, '/', $current_site->id)) {
            wp_send_json_error(array('message' => 'Indisponível (já existe).'));
        } else {
            // Verifica tabela customizada do plugin para reservas pendentes
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            $existing = Limiter_MKP_Pro_Database::get_subdomain_by_name($subdominio_completo);
            if ($existing) {
                wp_send_json_error(array('message' => 'Indisponível.'));
            } else {
                wp_send_json_success(array('message' => 'Disponível!'));
            }
        }
    }

    private function create_subdomain_and_user($nome, $email, $endereco, $telefone, $cpf_passaporte, $documento_url, $subdominio, $username, $password, $plano_id) {
        global $wpdb, $current_site;

        if (username_exists($username)) {
            return array('success' => false, 'message' => 'Este nome de usuário já está em uso.');
        }

        if (email_exists($email)) {
            return array('success' => false, 'message' => 'Este e-mail já está em uso.');
        }
        
        $table_clientes = $wpdb->base_prefix . 'limiter_mkp_pro_clientes';
        $cpf_existe = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table_clientes WHERE cpf_passaporte = %s",
            $cpf_passaporte
        ));

        if ($cpf_existe > 0) {
            return array('success' => false, 'message' => 'Este CPF/Passaporte já foi cadastrado.');
        }
        
        $user_id = wp_create_user($username, $password, $email);
        if (is_wp_error($user_id)) {
            return array('success' => false, 'message' => 'Erro ao criar usuário: ' . $user_id->get_error_message());
        }
        
        $domain = $subdominio . '.' . $current_site->domain;
        $path = '/';
        $title = $subdominio;
        
        $blog_id = wpmu_create_blog($domain, $path, $title, $user_id, array('public' => 1));
        if (is_wp_error($blog_id)) {
            wp_delete_user($user_id);
            return array('success' => false, 'message' => 'Erro ao criar subdomínio: ' . $blog_id->get_error_message());
        }
        
        add_user_to_blog($blog_id, $user_id, 'administrator');
        $wpdb->insert(
            $table_clientes,
            array(
                'blog_id' => $blog_id,
                'nome' => $nome,
                'endereco' => $endereco,
                'telefone' => $telefone,
                'cpf_passaporte' => $cpf_passaporte,
                'documento_url' => $documento_url,
                'subdominio' => $subdominio,
                'username' => $username
            ),
            array('%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s')
        );
        
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        Limiter_MKP_Pro_Database::save_subdominio(array(
            'blog_id' => $blog_id,
            'dominio' => $domain,
            'plano_id' => $plano_id,
            'nome_cliente' => $nome,
            'email_cliente' => $email,
            'telefone_cliente' => $telefone
        ));
        Limiter_MKP_Pro_Database::log($blog_id, 'subdominio_criado', 'Subdomínio criado via formulário de registro');
        
        return array('success' => true, 'blog_id' => $blog_id, 'user_id' => $user_id);
    }
}
new Limiter_MKP_Pro_Registration_Form();



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/class-subdomain-checker.php e os codigos deste arquivo:
<?php
/**
 * Classe responsável pelo Shortcode de consulta de disponibilidade de subdomínio no frontend.
 *
 * @since      1.4.1
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/public
 */
if (!defined('ABSPATH')) {
    exit;
} // <--- Chave adicionada aqui para corrigir o erro de sintaxe

class Limiter_MKP_Pro_Subdomain_Checker {
    public function __construct() {
        // Shortcode: [mkp_subdomain_checker]
        add_shortcode('mkp_subdomain_checker', array($this, 'render_checker_form'));
    }

    public function render_checker_form($atts) {
        if (!wp_script_is('jquery', 'enqueued')) {
            wp_enqueue_script('jquery');
        }
        $atts = shortcode_atts(array(
            'button_text' => 'Verificar Disponibilidade',
        ), $atts);
        
        // Correção: Instanciar a classe de configurações corretamente
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
        $configuracoes = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', '1.4.1');
        $config = $configuracoes->get_configuracoes();
        
        $sufixo = isset($config['sufixo_subdominio']) ? $config['sufixo_subdominio'] : '-mkp';
        $site_domain = defined('DOMAIN_CURRENT_SITE') ? DOMAIN_CURRENT_SITE : $_SERVER['HTTP_HOST'];
        ob_start();
        ?>
        <div id="mkp-checker-container">
            <div class="mkp-form-group">
                <label for="mkp_checker_input">Verifique o nome do seu site:</label>
                <div class="mkp-input-wrapper" style="position:relative;">
                    <input type="text" id="mkp_checker_input" name="subdominio" placeholder="Ex: minhaempresa" autocomplete="off">
                    <span class="mkp-checker-spinner" style="display:none; position:absolute; right:10px; top:10px;">↻</span>
                </div>
            </div>
            <div id="subdomain-feedback-checker"></div>
            <div class="mkp-preview-wrapper">
                <small>Seu endereço será: <strong><span id="checker-preview-name">...</span><?php echo esc_html($sufixo); ?>.<span id="checker-domain"><?php echo esc_html($site_domain); ?></span></strong></small>
            </div>
        </div>
        <style>
            #mkp-checker-container { max-width: 500px; margin: 20px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f9f9f9; }
            .mkp-form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
            .mkp-form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
            #mkp_checker_input.available { border-color: #28a745; background-color: #f8fff9; }
            #mkp_checker_input.taken { border-color: #dc3545; background-color: #fff8f8; }
            #mkp_checker_input.checking { border-color: #ffc107; }
            .checker-message { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px; }
            .checker-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
            .checker-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
            .checker-message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
            .mkp-preview-wrapper { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; color: #555; }
        </style>
        <script>
        jQuery(document).ready(function($) {
            var checkTimeout = null;
            var currentRequest = null; 
            var $input = $('#mkp_checker_input');
            var $spinner = $('.mkp-checker-spinner');
            var $previewName = $('#checker-preview-name');
            var $feedback = $('#subdomain-feedback-checker');
            
            $input.on('input', function() {
                var rawValue = $(this).val().toLowerCase();
                var cleanValue = rawValue.replace(/[^a-z0-9-]/g, '');
                if (rawValue !== cleanValue) $input.val(cleanValue);
                $previewName.text(cleanValue);
                $input.removeClass('available taken checking');
                $feedback.empty();
                
                if (currentRequest) { currentRequest.abort(); currentRequest = null; }
                clearTimeout(checkTimeout);
                
                if (cleanValue.length < 3) {
                    if(cleanValue.length > 0) showCheckerMessage('Mínimo 3 caracteres.', 'warning');
                    return;
                }
                
                $spinner.show();
                $input.addClass('checking');
                checkTimeout = setTimeout(function() {
                    checkAvailability(cleanValue);
                }, 600); 
            });
            
            function checkAvailability(subdomain) {
                currentRequest = $.ajax({
                    // Reutiliza o endpoint do formulário principal
                    url: '<?php echo admin_url('admin-ajax.php'); ?>',
                    type: 'POST',
                    data: { 'action': 'check_subdomain_availability', 'subdominio': subdomain },
                    success: function(response) {
                        $spinner.hide();
                        $input.removeClass('checking');
                        if (response.success) {
                            $input.addClass('available');
                            showCheckerMessage('✓ ' + response.data.message, 'success');
                        } else {
                            $input.addClass('taken');
                            showCheckerMessage('✗ ' + response.data.message, 'error');
                        }
                    },
                    error: function(jqXHR) {
                        if(jqXHR.statusText !== 'abort') {
                            $spinner.hide(); $input.removeClass('checking');
                        }
                    }
                });
            }
            
            function showCheckerMessage(message, type) {
                $feedback.html('<div class="checker-message ' + type + '">' + message + '</div>');
            }
        });
        </script>
        <?php
        return ob_get_clean();
    }
}
new Limiter_MKP_Pro_Subdomain_Checker();



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/class-subdomain-configuration.php e os codigos deste arquivo:
<?php
/**
 * Classe para o formulário de configuração de subdomínio
 */
if (!defined('ABSPATH')) {
    exit;
}

class Limiter_MKP_Pro_Subdomain_Configuration {
    private $blacklist_cache = null;
    
    public function __construct() {
        add_shortcode('mkp_subdomain_configuration', array($this, 'render_configuration_form'));
        add_action('wp_ajax_nopriv_mkp_check_subdomain', array($this, 'check_subdomain_availability'));
        add_action('wp_ajax_mkp_check_subdomain', array($this, 'check_subdomain_availability'));
        add_action('wp_ajax_nopriv_mkp_configure_subdomain', array($this, 'handle_subdomain_configuration'));
        add_action('wp_ajax_mkp_configure_subdomain', array($this, 'handle_subdomain_configuration'));
    }
    
    public function render_configuration_form() {
        $token = sanitize_text_field($_GET['token'] ?? '');
        if (!$token) {
            return '<div class="mkp-error">Token inválido ou expirado.</div>';
        }
        
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-token-manager.php';
        $token_data = Limiter_MKP_Pro_Token_Manager::validate_token($token);
        if (!$token_data) {
            return '<div class="mkp-error">Token inválido ou expirado.</div>';
        }
        
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        $plano = Limiter_MKP_Pro_Database::get_plano($token_data->plano_id);
        if (!$plano) {
            return '<div class="mkp-error">Plano não encontrado. Por favor, entre em contato com o suporte.</div>';
        }
        
        // Obtém configurações personalizadas
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
        $config_class = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', '1.0.0');
        $config = $config_class->get_configuracoes();
        
        $subdominio_disponivel = $config['subdominio_disponivel'];
        $subdominio_indisponivel = $config['subdominio_indisponivel'];
        $subdominio_curto = $config['subdominio_curto'];
        
        ob_start();
        ?>
        <div class="mkp-subdomain-configuration">
            <h2>Configurar Subdomínio</h2>
            <div class="mkp-plan-info">
                <h3>Plano: <?php echo esc_html($plano->nome); ?></h3>
                <p>Limite: <?php echo esc_html($plano->limite_paginas); ?> páginas/posts</p>
            </div>
            <form id="mkp-subdomain-form" class="mkp-config-form">
                <input type="hidden" name="token" value="<?php echo esc_attr($token); ?>">
                <input type="hidden" name="action" value="mkp_configure_subdomain">
                <?php wp_nonce_field('mkp_configure_subdomain', 'mkp_nonce'); ?>
                <div class="form-group">
                    <label for="subdomain_name">Nome do Subdomínio *</label>
                    <input type="text" id="subdomain_name" name="subdomain_name" required 
                           placeholder="ex: loja, empresa, meunegocio" pattern="[a-zA-Z0-9-]+" 
                           title="Use apenas letras, números e hífens">
                    <div class="subdomain-preview">
                        Seu subdomínio será: <span id="subdomain_preview">.marketing-place.store</span>
                    </div>
                    <div id="subdomain_availability" class="availability-status"></div>
                    <small>Use apenas letras, números e hífens. O sufixo será adicionado automaticamente.</small>
                </div>
                <div class="form-group">
                    <label for="password">Senha *</label>
                    <input type="password" id="password" name="password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirmar Senha *</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                    <div id="password_match" class="password-status"></div>
                </div>
                <div class="form-group">
                    <button type="submit" id="mkp-submit-btn" class="button button-primary">
                        Criar Subdomínio
                    </button>
                </div>
                <div id="mkp-message" class="mkp-message"></div>
            </form>
        </div>
        <style>
        .mkp-subdomain-configuration {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .mkp-plan-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .subdomain-preview {
            margin: 5px 0;
            font-style: italic;
            color: #666;
        }
        .availability-status, .password-status {
            margin: 5px 0;
            font-weight: bold;
        }
        .available { color: green; }
        .unavailable { color: red; }
        .mkp-message { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .mkp-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .mkp-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        </style>
        <script>
        jQuery(document).ready(function($) {
            var checkTimeout;
            $('#subdomain_name').on('input', function() {
                var name = $(this).val().toLowerCase().replace(/[^a-z0-9-]/g, '');
                var sufixo = '<?php echo esc_js(Limiter_MKP_Pro_Configuracoes::get_sufixo_subdominio()); ?>';
                $('#subdomain_preview').text(name + sufixo + '.marketing-place.store');
                clearTimeout(checkTimeout);
                checkTimeout = setTimeout(function() {
                    if (name.length > 2) {
                        checkSubdomainAvailability(name);
                    } else if (name.length > 0) {
                        $('#subdomain_availability').html('<?php echo esc_js($subdominio_curto); ?>').removeClass('available').addClass('unavailable');
                    } else {
                        $('#subdomain_availability').empty();
                    }
                }, 500);
            });
            $('#confirm_password').on('input', function() {
                var password = $('#password').val();
                var confirm = $(this).val();
                if (confirm.length > 0) {
                    if (password === confirm) {
                        $('#password_match').html('✓ Senhas coincidem').removeClass('unavailable').addClass('available');
                    } else {
                        $('#password_match').html('✗ Senhas não coincidem').removeClass('available').addClass('unavailable');
                    }
                } else {
                    $('#password_match').empty();
                }
            });
            function checkSubdomainAvailability(name) {
                $.ajax({
                    url: '<?php echo admin_url('admin-ajax.php'); ?>',
                    type: 'POST',
                    data: {
                        action: 'mkp_check_subdomain',
                        subdomain_name: name,
                        nonce: '<?php echo wp_create_nonce('mkp_check_subdomain'); ?>'
                    },
                    beforeSend: function() {
                        $('#subdomain_availability').html('Verificando...');
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#subdomain_availability').html('<?php echo esc_js($subdominio_disponivel); ?>').removeClass('unavailable').addClass('available');
                        } else {
                            $('#subdomain_availability').html('<?php echo esc_js($subdominio_indisponivel); ?>').removeClass('available').addClass('unavailable');
                        }
                    },
                    error: function() {
                        $('#subdomain_availability').html('Erro na verificação. Tente novamente.').removeClass('available').addClass('unavailable');
                    }
                });
            }
            $('#mkp-subdomain-form').on('submit', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                var $submitBtn = $('#mkp-submit-btn');
                var $message = $('#mkp-message');
                $submitBtn.prop('disabled', true).text('Criando...');
                $message.removeClass('mkp-success mkp-error').empty();
                $.ajax({
                    url: '<?php echo admin_url('admin-ajax.php'); ?>',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            $message.html(response.data.message).addClass('mkp-success');
                            $('#mkp-subdomain-form').hide();
                        } else {
                            $message.html(response.data.message).addClass('mkp-error');
                            $submitBtn.prop('disabled', false).text('Criar Subdomínio');
                        }
                    },
                    error: function() {
                        $message.html('Erro ao processar solicitação. Tente novamente.').addClass('mkp-error');
                        $submitBtn.prop('disabled', false).text('Criar Subdomínio');
                    }
                });
            });
        });
        </script>
        <?php
        return ob_get_clean();
    }
    
    public function check_subdomain_availability() {
        try {
            if (!wp_verify_nonce($_POST['nonce'] ?? '', 'mkp_check_subdomain')) {
                wp_send_json_error(array('message' => 'Erro de segurança.'));
                exit;
            }
            
            $subdomain_name = sanitize_text_field($_POST['subdomain_name'] ?? '');
            if (!$subdomain_name) {
                wp_send_json_error(array('message' => 'Nome do subdomínio é obrigatório.'));
                exit;
            }
            
            // Sufixo dinâmico
            $sufixo = Limiter_MKP_Pro_Configuracoes::get_sufixo_subdominio();
            $full_domain = $subdomain_name . $sufixo;
            
            // Blacklist APRIMORADA
            $reserved_words = $this->get_blacklist_cached();
            $current_site = get_current_site();
            
            // Verifica se alguma palavra reservada está contida no nome
            foreach ($reserved_words as $word) {
                if (strpos($subdomain_name, $word) !== false || strpos($full_domain, $word) !== false) {
                    wp_send_json_error(array('message' => 'Nome contém termos reservados.'));
                    exit;
                }
                
                // Verifica padrões como "admin1", "admin2", etc.
                if (preg_match('/^' . preg_quote($word, '/') . '\d+$/', $subdomain_name)) {
                    wp_send_json_error(array('message' => 'Este nome está em uma lista de nomes reservados.'));
                    exit;
                }
            }
            
            // Verifica se já existe no banco de dados
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            $existing = Limiter_MKP_Pro_Database::get_subdomain_by_name($full_domain);
            if ($existing) {
                wp_send_json_error(array('message' => 'Este subdomínio já está em uso. Escolha outro nome.'));
                exit;
            }
            
            // Verifica se o subdomínio existe no WordPress
            if (domain_exists($full_domain . '.' . $current_site->domain, '/', $current_site->id)) {
                wp_send_json_error(array('message' => 'Este subdomínio não está disponível. Escolha outro nome.'));
                exit;
            }
            
            wp_send_json_success(array('message' => 'Subdomínio disponível!'));
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro na verificação de subdomínio', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'subdomain_name' => $subdomain_name ?? ''
            ]);
            wp_send_json_error(array('message' => 'Ocorreu um erro ao verificar o subdomínio. Por favor, tente novamente.'));
        }
    }
    
    public function handle_subdomain_configuration() {
        try {
            if (!wp_verify_nonce($_POST['mkp_nonce'] ?? '', 'mkp_configure_subdomain')) {
                wp_send_json_error(array('message' => 'Erro de segurança.'));
                exit;
            }
            
            $token = sanitize_text_field($_POST['token'] ?? '');
            $subdomain_name = sanitize_text_field($_POST['subdomain_name'] ?? '');
            $password = $_POST['password'] ?? '';
            
            if (!$token || !$subdomain_name || !$password) {
                wp_send_json_error(array('message' => 'Todos os campos são obrigatórios.'));
                exit;
            }
            
            if (strlen($password) < 6) {
                wp_send_json_error(array('message' => 'A senha deve ter pelo menos 6 caracteres.'));
                exit;
            }
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'includes/class-token-manager.php';
            $token_data = Limiter_MKP_Pro_Token_Manager::validate_token($token);
            if (!$token_data) {
                wp_send_json_error(array('message' => 'Token inválido ou expirado.'));
                exit;
            }
            
            // Sufixo dinâmico
            $sufixo = Limiter_MKP_Pro_Configuracoes::get_sufixo_subdominio();
            $full_domain = $subdomain_name . $sufixo;
            
            // Blacklist APRIMORADA
            $reserved_words = $this->get_blacklist_cached();
            $current_site = get_current_site();
            
            foreach ($reserved_words as $word) {
                if (strpos($subdomain_name, $word) !== false || strpos($full_domain, $word) !== false) {
                    wp_send_json_error(array('message' => 'Nome contém termos reservados.'));
                    exit;
                }
            }
            
            if (domain_exists($full_domain . '.' . $current_site->domain, '/', $current_site->id)) {
                wp_send_json_error(array('message' => 'Subdomínio não disponível.'));
                exit;
            }
            
            $result = $this->create_subdomain($token_data, $full_domain, $password);
            if (is_wp_error($result)) {
                wp_send_json_error(array('message' => 'Erro ao criar subdomínio: ' . $result->get_error_message()));
                exit;
            }
            
            Limiter_MKP_Pro_Token_Manager::mark_token_used($token, $full_domain);
            $this->send_welcome_email($token_data, $full_domain, $password);
            
            // Log da criação do subdomínio
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::log($result, 'subdominio_criado', "Subdomínio '{$full_domain}' criado com sucesso via token", [
                'token_data' => (array)$token_data,
                'user_id' => $token_data->user_id
            ]);
            
            wp_send_json_success(array(
                'message' => 'Subdomínio criado com sucesso! Verifique seu e-mail para obter as credenciais de acesso.'
            ));
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error('Erro na configuração de subdomínio', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'token' => $token ?? '',
                'subdomain_name' => $subdomain_name ?? ''
            ]);
            wp_send_json_error(['message' => 'Ocorreu um erro interno. Por favor, contate o suporte técnico.']);
        }
    }
    
    private function create_subdomain($token_data, $domain, $password) {
        try {
            $user_id = $token_data->user_id;
            $user = get_user_by('id', $user_id);
            if (!$user) {
                return new WP_Error('user_not_found', 'Usuário não encontrado.');
            }
            
            // Define a senha do usuário
            wp_set_password($password, $user_id);
            
            $current_site = get_current_site();
            $blog_id = wpmu_create_blog(
                $domain . '.' . $current_site->domain,
                $current_site->path,
                $domain,
                $user_id,
                array('public' => 1),
                $current_site->id
            );
            
            if (is_wp_error($blog_id)) {
                return $blog_id;
            }
            
            // Adiciona o usuário como administrador do blog
            add_user_to_blog($blog_id, $user_id, 'administrator');
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            Limiter_MKP_Pro_Database::save_subdominio(array(
                'blog_id' => $blog_id,
                'user_id' => $user_id,
                'dominio' => $domain . '.' . $current_site->domain,
                'plano_id' => $token_data->plano_id,
                'nome_cliente' => $user->display_name,
                'email_cliente' => $user->user_email,
                'status' => 'active',
                'regiao' => $token_data->regiao ?? 'global'
            ));
            
            return $blog_id;
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error("Erro ao criar subdomínio {$domain}", [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'user_id' => $token_data->user_id ?? 0
            ]);
            return new WP_Error('creation_error', 'Erro interno ao criar subdomínio: ' . $e->getMessage());
        }
    }
    
    private function send_welcome_email($token_data, $domain, $password) {
        try {
            $user = get_user_by('id', $token_data->user_id);
            if (!$user) {
                return false;
            }
            
            $plano = Limiter_MKP_Pro_Database::get_plano($token_data->plano_id);
            if (!$plano) {
                return false;
            }
            
            $current_site = get_current_site();
            $admin_url = "https://{$domain}.{$current_site->domain}/wp-admin";
            $site_url = "https://{$domain}.{$current_site->domain}";
            
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-email.php';
            
            $dados_usuario = array(
                'nome_cliente' => $user->display_name,
                'plano_nome' => $plano->nome,
                'limite_paginas' => $plano->limite_paginas,
                'nome_subdominio' => $domain,
                'email_usuario' => $user->user_email,
                'senha' => $password,
                'url_admin' => $admin_url,
                'url_site' => $site_url
            );
            
            return Limiter_MKP_Pro_Email::enviar_email_boas_vindas($user->user_email, $dados_usuario);
        } catch (Exception $e) {
            Limiter_MKP_Pro_Error_Handler::log_error("Erro ao enviar e-mail de boas-vindas", [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'user_id' => $token_data->user_id ?? 0,
                'domain' => $domain
            ]);
            return false;
        }
    }
    
    /**
     * Obtém a blacklist em cache para melhor performance
     */
    private function get_blacklist_cached() {
        if ($this->blacklist_cache === null) {
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
            $this->blacklist_cache = Limiter_MKP_Pro_Configuracoes::get_subdomain_blacklist();
        }
        return $this->blacklist_cache;
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/class-widget.php e os codigos deste arquivo:
<?php
/**
 * Widget Otimizado para o dashboard do subdomínio.
 * @since 2.1.0
 */
class Limiter_MKP_Pro_Widget {
    private $plugin_name;
    private $version;

    public function __construct($plugin_name, $version) {
        $this->plugin_name = $plugin_name;
        $this->version = $version;
    }

    public function add_dashboard_widget() {
        wp_add_dashboard_widget(
            'limiter_mkp_pro_dashboard_widget',
            __('Limiter MKP Pro - Status do Plano', 'limiter-mkp-pro'),
            array($this, 'display_dashboard_widget')
        );
    }

    public function display_dashboard_widget() {
        $blog_id = get_current_blog_id();
        
        // Carregamento otimizado de classes
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
        require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'admin/class-configuracoes.php';
        
        // Busca dados do cache (não faz query pesada)
        $subdominio = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
        
        // Configurações
        $config = Limiter_MKP_Pro_Configuracoes::get_mensagem('widget_sem_plano'); // Uso direto do método estático se disponível
        if (!$config) {
             $config_inst = new Limiter_MKP_Pro_Configuracoes('limiter-mkp-pro', '1.0.0');
             $all_configs = $config_inst->get_configuracoes();
             $msg_sem_plano = $all_configs['widget_sem_plano'];
             $msg_alerta = $all_configs['widget_alerta_limite'];
             $msg_auto = $all_configs['widget_sistema_automatico'];
             $txt_botao = $all_configs['botao_ver_planos'];
        }

        if (!$subdominio || empty($subdominio->plano_id)) {
            echo '<div class="notice notice-warning"><p>' . esc_html($msg_sem_plano ?? 'Sem plano configurado.') . '</p></div>';
            return;
        }
        
        $plano = Limiter_MKP_Pro_Database::get_plano($subdominio->plano_id);
        if (!$plano) return;
        
        // --- OTIMIZAÇÃO AQUI ---
        // Em vez de wp_count_posts(), usamos a função que lê do cache
        $total_pages = Limiter_MKP_Pro_Database::count_limited_content($blog_id);
        // -----------------------

        $limite = !empty($subdominio->limite_personalizado) ? (int) $subdominio->limite_personalizado : (int) $plano->limite_paginas;
        $percentual = $limite > 0 ? min(100, round(($total_pages / $limite) * 100)) : 0;
        
        ?>
        <div class="limiter-mkp-pro-widget">
            <div class="limiter-mkp-pro-logo-header">
                <img src="<?php echo esc_url(plugin_dir_url(__FILE__) . '../images/marketing-place-store-logo.png'); ?>" 
                     alt="Marketing Place Store" 
                     style="max-width: 150px; height: auto; margin: 0 auto 10px; display: block;">
            </div>

            <div class="limiter-widget-section">
                <p style="font-size: 14px; margin-bottom: 5px;"><strong>Plano:</strong> <?php echo esc_html($plano->nome); ?></p>
                <p style="font-size: 14px;"><strong>Páginas:</strong> <?php echo esc_html($total_pages); ?> / <?php echo esc_html($limite); ?></p>
                
                <div class="limiter-progress-bar" style="background:#eee; height:15px; border-radius:10px; overflow:hidden; margin-top:5px;">
                    <div style="width: <?php echo esc_attr($percentual); ?>%; 
                                height:100%; 
                                background-color: <?php echo $percentual >= 90 ? '#dc3545' : ($percentual >= 70 ? '#ffc107' : '#28a745'); ?>;
                                text-align:center; 
                                color:white; 
                                font-size:10px; 
                                line-height:15px;">
                        <?php echo esc_html($percentual); ?>%
                    </div>
                </div>
            </div>

            <div class="limiter-widget-section" style="margin-top: 15px; text-align: center;">
                <a href="<?php echo esc_url(wc_get_page_permalink('shop')); ?>" class="button button-primary" target="_blank">
                    <?php echo esc_html($txt_botao ?? 'Fazer Upgrade'); ?>
                </a>
            </div>
        </div>
        <?php
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/css/dashboard.css e os codigos deste arquivo:
.limiter-mkp-pro-dashboard-wrapper {
    background-color: #f8f9fc;
    padding: 20px;
    border-radius: 8px;
    max-width: 1200px;
    margin: 20px auto;
}

.limiter-mkp-pro-dashboard-header {
    text-align: center;
    margin-bottom: 30px;
}

.limiter-mkp-pro-logo-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.limiter-mkp-pro-logo-header img {
    max-width: 60px;
    height: auto;
    margin-right: 15px;
}

.limiter-mkp-pro-logo-header h1 {
    font-size: 28px;
    color: #333;
    margin: 0;
}

.limiter-mkp-pro-subtitle h2 {
    font-size: 18px;
    color: #666;
    margin: 0;
}

/* Cards de Estatísticas */
.limiter-mkp-pro-stats-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.limiter-mkp-pro-card {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.limiter-mkp-pro-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.limiter-mkp-pro-card:nth-child(1) {
    border-top: 4px solid #4e73df;
}

.limiter-mkp-pro-card:nth-child(2) {
    border-top: 4px solid #1cc88a;
}

.limiter-mkp-pro-card:nth-child(3) {
    border-top: 4px solid #f6c23e;
}

.limiter-mkp-pro-card:nth-child(4) {
    border-top: 4px solid #e74a3b;
}

.limiter-mkp-pro-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.limiter-mkp-pro-card-header h3 {
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
    margin: 0;
}

.limiter-mkp-pro-card-icon {
    font-size: 24px;
    color: #dddfeb;
}

.limiter-mkp-pro-card-content {
    text-align: center;
}

.limiter-mkp-pro-card-value {
    font-size: 28px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.limiter-mkp-pro-card-description {
    font-size: 13px;
    color: #666;
}

/* Seção de Progresso */
.limiter-mkp-pro-progress-section {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 30px;
}

.limiter-mkp-pro-progress-section h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
}

.limiter-mkp-pro-progress-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
}

.limiter-mkp-pro-progress-detail {
    display: flex;
    align-items: center;
}

.limiter-mkp-pro-detail-label {
    font-size: 14px;
    color: #666;
    margin-right: 5px;
}

.limiter-mkp-pro-detail-value {
    font-size: 14px;
    font-weight: bold;
    color: #333;
}

.limiter-mkp-pro-progress-warning-text {
    color: #e74a3b;
    font-size: 14px;
    display: flex;
    align-items: center;
}

.limiter-mkp-pro-progress-warning-text .dashicons {
    margin-right: 5px;
}

/* Seção de Solicitações */
.limiter-mkp-pro-solicitations-section {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 30px;
}

.limiter-mkp-pro-solicitations-section h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
}

.limiter-mkp-pro-solicitacao-pendente-card {
    background-color: #f8f9fc;
    border-left: 4px solid #4e73df;
    padding: 15px;
    margin-bottom: 20px;
}

.limiter-mkp-pro-solicitacao-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.limiter-mkp-pro-solicitacao-header h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.limiter-mkp-pro-solicitacao-status {
    background-color: #4e73df;
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
}

.limiter-mkp-pro-solicitacao-details {
    margin-bottom: 15px;
}

.limiter-mkp-pro-solicitacao-detail {
    margin-bottom: 5px;
}

.limiter-mkp-pro-solicitar-plano-container {
    margin-bottom: 20px;
}

.limiter-mkp-pro-planos-disponiveis {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.limiter-mkp-pro-plano-option {
    background-color: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 4px;
    padding: 15px;
    cursor: pointer;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.limiter-mkp-pro-plano-option:hover {
    border-color: #4e73df;
    box-shadow: 0 0 0 1px #4e73df;
}

.limiter-mkp-pro-plano-option input[type="radio"] {
    margin-right: 10px;
}

.limiter-mkp-pro-plano-nome {
    font-weight: bold;
    color: #333;
    display: block;
    margin-bottom: 5px;
}

.limiter-mkp-pro-plano-limite {
    color: #4e73df;
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
}

.limiter-mkp-pro-plano-descricao {
    font-size: 13px;
    color: #666;
    display: block;
}

.limiter-mkp-pro-form-group {
    margin-bottom: 15px;
}

.limiter-mkp-pro-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

/* Histórico de Solicitações */
.limiter-mkp-pro-historico-section {
    margin-top: 20px;
}

.limiter-mkp-pro-historico-section h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: #333;
}

.limiter-mkp-pro-historico-table {
    width: 100%;
    border-collapse: collapse;
}

.limiter-mkp-pro-historico-table th,
.limiter-mkp-pro-historico-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e3e6f0;
}

.limiter-mkp-pro-historico-table th {
    background-color: #f8f9fc;
    font-weight: bold;
    color: #333;
}

.limiter-mkp-pro-status {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    color: #fff;
}

.limiter-mkp-pro-status-pendente {
    background-color: #f6c23e;
}

.limiter-mkp-pro-status-aprovada {
    background-color: #1cc88a;
}

.limiter-mkp-pro-status-rejeitada {
    background-color: #e74a3b;
}

/* Dicas e Informações */
.limiter-mkp-pro-tips-section {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
}

.limiter-mkp-pro-tips-section h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
}

.limiter-mkp-pro-tips {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
}

.limiter-mkp-pro-tip {
    display: flex;
    align-items: flex-start;
    background-color: #f8f9fc;
    border-radius: 4px;
    padding: 15px;
}

.limiter-mkp-pro-tip .dashicons {
    color: #4e73df;
    font-size: 20px;
    margin-right: 10px;
}

.limiter-mkp-pro-tip p {
    margin: 0;
    font-size: 14px;
    color: #666;
}

/* Sem Plano */
.limiter-mkp-pro-no-plan {
    text-align: center;
    padding: 40px 20px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.limiter-mkp-pro-no-plan-icon {
    margin-bottom: 20px;
}

.limiter-mkp-pro-no-plan-icon .dashicons {
    font-size: 48px;
    color: #f6c23e;
}

.limiter-mkp-pro-no-plan h3 {
    font-size: 24px;
    color: #333;
    margin-bottom: 15px;
}

.limiter-mkp-pro-no-plan p {
    font-size: 16px;
    color: #666;
    margin-bottom: 10px;
}

/* Responsividade */
@media (max-width: 992px) {
    .limiter-mkp-pro-stats-cards {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .limiter-mkp-pro-stats-cards {
        grid-template-columns: 1fr;
    }
    
    .limiter-mkp-pro-progress-details {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .limiter-mkp-pro-progress-warning-text {
        margin-top: 10px;
    }
    
    .limiter-mkp-pro-tips {
        grid-template-columns: 1fr;
    }
}




----------------------------------------------------------------------------------------

limiter-mkp-pro/public/css/public.css e os codigos deste arquivo:
.limiter-mkp-pro-widget {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
}
.limiter-mkp-pro-logo {
    text-align: center;
    margin-bottom: 20px;
}
.limiter-mkp-pro-logo img {
    max-width: 200px;
    height: auto;
}
.limiter-mkp-pro-info h3 {
    font-size: 18px;
    margin-bottom: 15px;
    color: #333;
}
.limiter-mkp-pro-plano {
    font-weight: bold;
    color: #4e73df;
}
.limiter-mkp-pro-progress-container {
    margin: 15px 0;
}
.limiter-mkp-pro-progress-bar {
    background-color: #e9ecef;
    border-radius: 4px;
    height: 20px;
    overflow: hidden;
}
.limiter-mkp-pro-progress {
    background-color: #4e73df;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.3s ease;
}
.limiter-mkp-pro-progress-warning {
    background-color: #e74a3b;
}
.limiter-mkp-pro-progress-text {
    color: #fff;
    font-size: 12px;
    font-weight: bold;
}
.limiter-mkp-pro-stats {
    display: flex;
    justify-content: space-between;
    margin: 15px 0;
}
.limiter-mkp-pro-stat {
    text-align: center;
    flex: 1;
}
.limiter-mkp-pro-stat-label {
    display: block;
    font-size: 12px;
    color: #666;
}
.limiter-mkp-pro-stat-value {
    display: block;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}
.limiter-mkp-pro-actions {
    margin: 20px 0;
}
.limiter-mkp-pro-solicitacao-pendente {
    background-color: #f8f9fc;
    border-left: 4px solid #4e73df;
    padding: 10px 15px;
    margin-bottom: 15px;
}
.limiter-mkp-pro-solicitar-plano-form {
    background-color: #f8f9fc;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}
.limiter-mkp-pro-solicitar-plano-form h4 {
    margin-top: 0;
    margin-bottom: 10px;
}
.limiter-mkp-pro-plano-select {
    width: 100%;
    margin-bottom: 10px;
}
.limiter-mkp-pro-notas {
    width: 100%;
    min-height: 80px;
    margin-bottom: 10px;
}
.limiter-mkp-pro-form-actions {
    display: flex;
    justify-content: space-between;
}
.limiter-mkp-pro-dashboard-link {
    text-align: center;
    margin-top: 15px;
}
.limiter-mkp-pro-no-plan {
    text-align: center;
    padding: 20px;
    background-color: #f8f9fc;
    border-radius: 4px;
}
/* Modal de mensagem */
.limiter-mkp-pro-message-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
}
.limiter-mkp-pro-message-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 80%;
    max-width: 500px;
    position: relative;
}
.limiter-mkp-pro-message-close {
    position: absolute;
    top: 10px;
    right: 15px;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.limiter-mkp-pro-message-ok {
    display: block;
    margin: 15px auto 0;
}
/* NOVOS ESTILOS PARA O CONTROLE DE INODES */
.limiter-mkp-pro-inode-panel {
    background: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 4px;
    padding: 15px;
    margin: 20px 0;
}
/* Responsividade */
@media (max-width: 768px) {
    .limiter-mkp-pro-stats {
        flex-direction: column;
    }
    .limiter-mkp-pro-stat {
        margin-bottom: 10px;
    }
    .limiter-mkp-pro-form-actions {
        flex-direction: column;
    }
    .limiter-mkp-pro-form-actions button {
        margin-bottom: 10px;
    }
}



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/images/marketing-place-logo.JPEG, pode deixar esta pasta vazia.




----------------------------------------------------------------------------------------

limiter-mkp-pro/public/js/plan-update-checker.js e os codigos deste arquivo:
/**
 * Verificador de atualização de planos em tempo real
 */
jQuery(document).ready(function($) {
    let lastPlanCheck = 0;
    const CHECK_INTERVAL = 300000; // 5 minutos (300.000 ms)
    let lastKnownPlanId = null;

    function checkPlanUpdate() {
        const now = Date.now();
        
        // Evita verificações muito rápidas
        if (now - lastPlanCheck < CHECK_INTERVAL) {
            return;
        }

        lastPlanCheck = now;

        $.ajax({
            url: limiter_mkp_pro_public.ajax_url,
            type: 'POST',
            data: {
                action: 'limiter_mkp_pro_check_plan_update',
                nonce: limiter_mkp_pro_public.nonce
            },
            success: function(response) {
                if (response.success) {
                    updatePlanDisplay(response.data);
                }
            },
            error: function() {
                console.log('Erro ao verificar atualização de plano');
            }
        });
    }

    function updatePlanDisplay(data) {
        // Atualiza o widget do dashboard se existir
        const $planElement = $('.limiter-mkp-pro-current-plan');
        if ($planElement.length) {
            $planElement.text('Plano: ' + data.current_plan);
        }

        // Mostra notificação se o plano mudou
        if (lastKnownPlanId !== null && lastKnownPlanId !== data.current_plan_id) {
            showPlanUpdateNotification(data.current_plan);
        }

        lastKnownPlanId = data.current_plan_id;
    }

    function showPlanUpdateNotification(newPlanName) {
        // Cria notificação elegante
        $('body').append(`
            <div class="limiter-plan-update-notice" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 999999;
                animation: slideInRight 0.5s ease;
            ">
                <strong>🎉 Plano Atualizado!</strong>
                <p>Seu plano foi alterado para: ${newPlanName}</p>
                <small>Você já pode usar todos os recursos do novo plano.</small>
            </div>
        `);

        // Remove após 5 segundos
        setTimeout(function() {
            $('.limiter-plan-update-notice').fadeOut(300, function() {
                $(this).remove();
            });
        }, 5000);
    }

    // Inicia verificações periódicas
    setInterval(checkPlanUpdate, CHECK_INTERVAL);
    
    // Verifica também em eventos específicos
    $(document).on('click', '.limiter-check-plan-update', checkPlanUpdate);

    // Verificação inicial
    checkPlanUpdate();
});




----------------------------------------------------------------------------------------

limiter-mkp-pro/public/js/public.js e os codigos deste arquivo:
/**
 * Script simplificado — sem lógica de solicitação manual.
 *
 * @since 1.4.0
 */
jQuery(document).ready(function($) {
    console.log('Limiter MKP Pro: Modo automático via WooCommerce');
});


----------------------------------------------------------------------------------------

limiter-mkp-pro/public/partials/client-paginas.php e os codigos deste arquivo:
<?php
if (!current_user_can('manage_options')) {
    wp_die('Acesso negado.');
}
$blog_id = get_current_blog_id();
$domain = wp_parse_url(network_site_url(), PHP_URL_HOST);
$current_url = wp_parse_url(home_url(), PHP_URL_HOST);
$subdomain = str_replace('.' . $domain, '', $current_url);

$posts = get_posts([
    'post_type' => ['page', 'post'],
    'post_status' => 'publish',
    'numberposts' => -1,
    'orderby' => 'title',
    'order' => 'ASC'
]);
?>
<div class="wrap">
    <h1>Minhas Páginas e URLs</h1>
    <p>Use as URLs abaixo para compartilhar suas páginas:</p>
    <?php if ($posts): ?>
        <table class="wp-list-table widefat">
            <thead>
                <tr>
                    <th>Título</th>
                    <th>URL Real</th>
                    <th>URL para Anúncios</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($posts as $post): ?>
                    <?php
                    $real_url = get_permalink($post->ID);
                    $slug = $post->post_name;
                    $proxy_url = "https://{$slug}.{$domain}/{$subdomain}/";
                    ?>
                    <tr>
                        <td><?php echo esc_html($post->post_title); ?></td>
                        <td>
                            <a href="<?php echo esc_url($real_url); ?>" target="_blank"><?php echo esc_html($real_url); ?></a>
                            <button type="button" class="button button-secondary copy-btn" data-url="<?php echo esc_attr($real_url); ?>">📋 Copiar</button>
                        </td>
                        <td>
                            <a href="<?php echo esc_url($proxy_url); ?>" target="_blank"><?php echo esc_html($proxy_url); ?></a>
                            <button type="button" class="button button-secondary copy-btn" data-url="<?php echo esc_attr($proxy_url); ?>">📋 Copiar</button>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php else: ?>
        <p>Nenhuma página ou post publicado encontrado.</p>
    <?php endif; ?>
</div>
<script>
document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const url = this.getAttribute('data-url');
        navigator.clipboard.writeText(url).then(() => {
            const original = this.textContent;
            this.textContent = '✔ Copiado!';
            setTimeout(() => this.textContent = original, 2000);
        });
    });
});
</script>




----------------------------------------------------------------------------------------

limiter-mkp-pro/public/partials/dashboard.php e os codigos deste arquivo:
<?php
/**
 * Template para o dashboard completo do subdomínio.
 *
 * @since      1.4.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/public/partials
 */
?>
<div class="limiter-mkp-pro-dashboard-wrapper">
    <div class="limiter-mkp-pro-dashboard-header">
        <div class="limiter-mkp-pro-logo-header">
            <h1>Limiter MKP Pro</h1>
        </div>
        <div class="limiter-mkp-pro-subtitle">
            <h2><?php _e('Dashboard de Controle de Subdomínios', 'limiter-mkp-pro'); ?></h2>
        </div>
    </div>
    <?php if ($estatisticas['tem_plano']) : ?>
        <div class="limiter-mkp-pro-stats-cards">
            <div class="limiter-mkp-pro-card">
                <div class="limiter-mkp-pro-card-header">
                    <h3><?php _e('Plano Atual', 'limiter-mkp-pro'); ?></h3>
                    <span class="limiter-mkp-pro-card-icon dashicons dashicons-chart-pie"></span>
                </div>
                <div class="limiter-mkp-pro-card-content">
                    <div class="limiter-mkp-pro-card-value"><?php echo esc_html($estatisticas['plano_nome']); ?></div>
                    <div class="limiter-mkp-pro-card-description"><?php _e('Limite de', 'limiter-mkp-pro'); ?> <?php echo esc_html($estatisticas['limite_paginas']); ?> <?php _e('páginas', 'limiter-mkp-pro'); ?></div>
                </div>
            </div>
            <div class="limiter-mkp-pro-card">
                <div class="limiter-mkp-pro-card-header">
                    <h3><?php _e('Páginas Utilizadas', 'limiter-mkp-pro'); ?></h3>
                    <span class="limiter-mkp-pro-card-icon dashicons dashicons-admin-page"></span>
                </div>
                <div class="limiter-mkp-pro-card-content">
                    <div class="limiter-mkp-pro-card-value"><?php echo esc_html($estatisticas['paginas_total']); ?></div>
                    <div class="limiter-mkp-pro-card-description"><?php _e('Publicadas + Lixeira', 'limiter-mkp-pro'); ?></div>
                </div>
            </div>
            <div class="limiter-mkp-pro-card">
                <div class="limiter-mkp-pro-card-header">
                    <h3><?php _e('Restantes', 'limiter-mkp-pro'); ?></h3>
                    <span class="limiter-mkp-pro-card-icon dashicons dashicons-plus-alt"></span>
                </div>
                <div class="limiter-mkp-pro-card-content">
                    <div class="limiter-mkp-pro-card-value"><?php echo esc_html($estatisticas['paginas_restantes']); ?></div>
                    <div class="limiter-mkp-pro-card-description"><?php _e('Páginas disponíveis', 'limiter-mkp-pro'); ?></div>
                </div>
            </div>
            <div class="limiter-mkp-pro-card">
                <div class="limiter-mkp-pro-card-header">
                    <h3><?php _e('Uso', 'limiter-mkp-pro'); ?></h3>
                    <span class="limiter-mkp-pro-card-icon dashicons dashicons-leftright"></span>
                </div>
                <div class="limiter-mkp-pro-card-content">
                    <div class="limiter-mkp-pro-card-value"><?php echo esc_html($estatisticas['percentual_uso']); ?>%</div>
                    <div class="limiter-mkp-pro-card-description"><?php _e('Do limite total', 'limiter-mkp-pro'); ?></div>
                </div>
            </div>
        </div>
        <div class="limiter-mkp-pro-progress-section">
            <h3><?php _e('Utilização do Plano', 'limiter-mkp-pro'); ?></h3>
            <div class="limiter-mkp-pro-progress-bar">
                <div class="limiter-mkp-pro-progress <?php echo $estatisticas['percentual_uso'] > 90 ? 'limiter-mkp-pro-progress-warning' : ''; ?>" 
                     style="width: <?php echo esc_attr($estatisticas['percentual_uso']); ?>%;">
                    <?php echo esc_html($estatisticas['percentual_uso']); ?>%
                </div>
            </div>
            <?php if ($estatisticas['percentual_uso'] >= 70) : ?>
                <div class="limiter-mkp-pro-progress-warning-text">
                    <span class="dashicons dashicons-warning"></span>
                    <?php _e('Você está próximo do limite. Faça upgrade na loja.', 'limiter-mkp-pro'); ?>
                </div>
            <?php endif; ?>
        </div>
        <div class="limiter-mkp-pro-solicitations-section">
            <h3><?php _e('Mudança de Plano', 'limiter-mkp-pro'); ?></h3>
            <div class="notice notice-info">
                <p>
                    <strong>Automação Total via WooCommerce</strong><br>
                    Não é mais necessário solicitar manualmente. Basta comprar um novo plano na loja.
                </p>
                <p>
                    <a href="<?php echo esc_url(wc_get_page_permalink('shop')); ?>" class="button button-primary" target="_blank">
                        🛒 Acessar Loja de Planos
                    </a>
                </p>
            </div>
        </div>
    <?php else : ?>
        <div class="limiter-mkp-pro-no-plan">
            <div class="limiter-mkp-pro-no-plan-icon">
                <span class="dashicons dashicons-warning"></span>
            </div>
            <h3><?php _e('Plano não configurado', 'limiter-mkp-pro'); ?></h3>
            <p><?php _e('Este subdomínio não possui um plano. Entre em contato com o administrador da rede.', 'limiter-mkp-pro'); ?></p>
        </div>
    <?php endif; ?>
</div>



----------------------------------------------------------------------------------------

limiter-mkp-pro/public/partials/widget.php e os codigos deste arquivo:
<?php
/**
 * Template para o widget no dashboard do subdomínio.
 *
 * @since      1.0.0
 * @package    Limiter_MKP_Pro
 * @subpackage Limiter_MKP_Pro/public/partials
 */

// Segurança: impede acesso direto
if (!defined('ABSPATH')) {
    exit;
}
?>
<div class="limiter-mkp-pro-widget">
    <div class="limiter-mkp-pro-logo">
        <img src="<?php echo esc_url(plugin_dir_url(dirname(__FILE__)) . 'images/marketing-place-logo.jpeg'); ?>" alt="Marketing Place Store" style="max-width: 50%; height: auto; display: block; margin: 0 auto;">
    </div>

    <?php if (isset($estatisticas['tem_plano']) && $estatisticas['tem_plano']) : ?>
        <div class="limiter-mkp-pro-info">
            <h3><?php _e('Plano Atual', 'limiter-mkp-pro'); ?>: <span class="limiter-mkp-pro-plano"><?php echo esc_html(isset($estatisticas['plano_nome']) ? $estatisticas['plano_nome'] : ''); ?></span></h3>
            
            <div class="limiter-mkp-pro-progress-container">
                <div class="limiter-mkp-pro-progress-bar">
                    <div class="limiter-mkp-pro-progress" style="width: <?php echo esc_attr(isset($estatisticas['percentual_uso']) ? $estatisticas['percentual_uso'] : 0); ?>%;">
                        <span class="limiter-mkp-pro-progress-text"><?php echo esc_html(isset($estatisticas['percentual_uso']) ? $estatisticas['percentual_uso'] : 0); ?>%</span>
                    </div>
                </div>
            </div>

            <div class="limiter-mkp-pro-stats">
                <div class="limiter-mkp-pro-stat">
                    <span class="limiter-mkp-pro-stat-label"><?php _e('Limite', 'limiter-mkp-pro'); ?>:</span>
                    <span class="limiter-mkp-pro-stat-value"><?php echo esc_html(isset($estatisticas['limite_paginas']) ? $estatisticas['limite_paginas'] : 0); ?> <?php _e('páginas', 'limiter-mkp-pro'); ?></span>
                </div>
                <div class="limiter-mkp-pro-stat">
                    <span class="limiter-mkp-pro-stat-label"><?php _e('Utilizadas', 'limiter-mkp-pro'); ?>:</span>
                    <span class="limiter-mkp-pro-stat-value"><?php echo esc_html(isset($estatisticas['paginas_total']) ? $estatisticas['paginas_total'] : 0); ?> <?php _e('páginas', 'limiter-mkp-pro'); ?></span>
                </div>
                <div class="limiter-mkp-pro-stat">
                    <span class="limiter-mkp-pro-stat-label"><?php _e('Restantes', 'limiter-mkp-pro'); ?>:</span>
                    <span class="limiter-mkp-pro-stat-value"><?php echo esc_html(isset($estatisticas['paginas_restantes']) ? $estatisticas['paginas_restantes'] : 0); ?> <?php _e('páginas', 'limiter-mkp-pro'); ?></span>
                </div>
            </div>

            <?php
            $blog_id = get_current_blog_id();
            
            // Recupera dados do banco de forma segura
            require_once LIMITER_MKP_PRO_PLUGIN_DIR . 'models/class-database.php';
            $subdominio = Limiter_MKP_Pro_Database::get_subdominio_by_blog_id($blog_id);
            $plano = ($subdominio) ? Limiter_MKP_Pro_Database::get_plano($subdominio->plano_id) : null;

            if ($plano) {
                // Obtém limite personalizado de inodes ou usa o do plano
                $limite_inodes = !empty($subdominio->limite_personalizado_inodes) ? 
                                 $subdominio->limite_personalizado_inodes : 
                                 $plano->limite_inodes;

                // CORREÇÃO CRÍTICA DE PERFORMANCE:
                // Substituída a varredura de disco recursiva por leitura de cache ou contagem no banco
                $inode_count = get_option('limiter_mkp_pro_inode_count');

                if ($inode_count === false) {
                    // Fallback rápido via banco de dados se o cache não existir (muito mais rápido que ler disco)
                    global $wpdb;
                    $inode_count = (int) $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->posts} WHERE post_type = 'attachment'");
                    // Atualiza a option para futuras leituras
                    update_option('limiter_mkp_pro_inode_count', $inode_count, false);
                }

                $inode_percent = $limite_inodes > 0 ? min(100, round(($inode_count / $limite_inodes) * 100)) : 0;
                
                // Formata informações adicionais sobre o limite
                $limite_tipo = !empty($subdominio->limite_personalizado_inodes) ? 
                               __('(Personalizado)', 'limiter-mkp-pro') : 
                               __('(Do plano)', 'limiter-mkp-pro');
            ?>
                <div class="limiter-mkp-pro-stat" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <span class="limiter-mkp-pro-stat-label"><?php _e('Arquivos (Mídia)', 'limiter-mkp-pro'); ?>:</span>
                    <span class="limiter-mkp-pro-stat-value"><?php echo esc_html($inode_count); ?> / <?php echo esc_html($limite_inodes); ?> <small style="font-weight:normal;"><?php echo esc_html($limite_tipo); ?></small></span>
                </div>
                
                <div class="limiter-mkp-pro-progress-container" style="margin-top: 5px;">
                    <h4 style="margin-bottom: 5px; font-size: 12px; color: #666;"><?php _e('Uso de Armazenamento', 'limiter-mkp-pro'); ?></h4>
                    <div class="limiter-mkp-pro-progress-bar">
                        <div class="limiter-mkp-pro-progress" style="width: <?php echo esc_attr($inode_percent); ?>%; background-color: <?php echo $inode_percent > 90 ? '#e74a3b' : ($inode_percent > 70 ? '#f39c12' : '#2ecc71'); ?>;">
                            <span class="limiter-mkp-pro-progress-text"><?php echo esc_html($inode_percent); ?>%</span>
                        </div>
                    </div>
                </div>
            <?php } ?>

            <?php 
            if (isset($estatisticas['mostrar_alerta']) && $estatisticas['mostrar_alerta']) : 
                // Obtém a mensagem personalizada para o alerta
                $configuracoes = get_network_option(null, 'limiter_mkp_pro_configuracoes', array());
                $mensagem_alerta = isset($configuracoes['mensagem_alerta']) ? 
                                   $configuracoes['mensagem_alerta'] : 
                                   __('Você está na penúltima página. Considere fazer upgrade.', 'limiter-mkp-pro');
            ?>
                <div class="limiter-mkp-pro-alert" style="margin-top: 15px; padding: 10px 15px; background-color: #fcf8e3; border-left: 4px solid #f0ad4e; color: #8a6d3b;">
                    <p><strong><?php _e('Atenção!', 'limiter-mkp-pro'); ?></strong> <?php echo esc_html($mensagem_alerta); ?></p>
                </div>
            <?php endif; ?>

            <div class="limiter-mkp-pro-actions">
                <div class="notice notice-info" style="margin: 15px 0 0 0;">
                    <p style="margin-bottom: 10px;">
                        <strong><?php _e('Sistema Automático via WooCommerce', 'limiter-mkp-pro'); ?></strong><br>
                        <?php _e('Para mudar de plano, acesse nossa loja.', 'limiter-mkp-pro'); ?>
                    </p>
                    <p>
                        <a href="<?php echo esc_url(function_exists('wc_get_page_permalink') ? wc_get_page_permalink('shop') : '#'); ?>" class="button button-primary" target="_blank" style="width: 100%; text-align: center;">
                            <?php _e('🛒 Ver Planos e Fazer Upgrade', 'limiter-mkp-pro'); ?>
                        </a>
                    </p>
                </div>
            </div>
        </div>
    <?php else : ?>
        <div class="limiter-mkp-pro-no-plan">
            <p><?php _e('Este subdomínio não possui um plano configurado. Entre em contato com o administrador da rede.', 'limiter-mkp-pro'); ?></p>
        </div>
    <?php endif; ?>
</div>


----------------------------------------------------------------------------------------

limiter-mkp-pro/tests/test-checklist.MD e os codigos deste arquivo:
Lista de Testes para o Plugin "Limiter MKP Pro"
Testes de Instalação
⦁	[ ] Verificar se o plugin ativa corretamente em ambiente WordPress Multisite 6.8.1
⦁	[ ] Confirmar criação das tabelas no banco de dados
⦁	[ ] Verificar inserção dos planos padrão (Starter, Pro, Business)
⦁	[ ] Confirmar criação das opções de rede
Testes de Limitação de Páginas/Posts
⦁	[ ] Verificar se o plugin bloqueia corretamente a criação de páginas quando o limite é atingido
⦁	[ ] Confirmar que o plugin considera tanto páginas publicadas quanto na lixeira
⦁	[ ] Testar restauração de itens da lixeira quando o limite já foi atingido
⦁	[ ] Verificar se a mensagem personalizada é exibida corretamente ao atingir o limite
Testes do Painel de Super Admin
⦁	[ ] Verificar acesso ao menu "Limiter MKP Pro" no painel de administração da rede
⦁	[ ] Confirmar exibição correta do dashboard com estatísticas
⦁	[ ] Testar CRUD de planos (criar, editar, excluir)
⦁	[ ] Testar associação de subdomínios a planos
⦁	[ ] Verificar adição de subdomínios ao sistema (individual e em massa)
⦁	[ ] Confirmar visualização e processamento de solicitações de mudança de plano
⦁	[ ] Testar configurações gerais
⦁	[ ] Verificar visualização de logs
Testes do Widget e Dashboard para Subdomínios
⦁	[ ] Confirmar exibição do widget no dashboard dos subdomínios
⦁	[ ] Verificar se o logo do Marketing Place Store aparece corretamente
⦁	[ ] Testar exibição de informações do plano atual
⦁	[ ] Confirmar exibição correta do limite de páginas/posts
⦁	[ ] Verificar contagem correta de páginas utilizadas e restantes
⦁	[ ] Testar solicitação de mudança de plano
⦁	[ ] Verificar cancelamento de solicitação pendente
⦁	[ ] Testar dashboard visual completo
⦁	[ ] Confirmar responsividade em diferentes tamanhos de tela
Testes do Sistema de Solicitações
⦁	[ ] Verificar criação de solicitação de mudança de plano
⦁	[ ] Confirmar envio de e-mail de notificação
⦁	[ ] Testar aprovação de solicitação pelo super admin
⦁	[ ] Verificar rejeição de solicitação pelo super admin
⦁	[ ] Confirmar cancelamento de solicitação pelo subdomínio
⦁	[ ] Verificar atualização automática do widget após aprovação
⦁	[ ] Testar limpeza automática de solicitações antigas
Testes do Sistema de Notificações
⦁	[ ] Verificar alertas quando um subdomínio está próximo do limite
⦁	[ ] Confirmar exibição da mensagem personalizada ao atingir o limite
⦁	[ ] Testar envio de e-mails para notificar sobre solicitações
⦁	[ ] Verificar envio para alterar-plano@marketing-place.store
⦁	[ ] Confirmar envio para todos os super administradores
Testes de Segurança
⦁	[ ] Verificar verificações de nonce em todas as operações
⦁	[ ] Confirmar verificações de permissões
⦁	[ ] Testar sanitização de dados de entrada
⦁	[ ] Verificar escape de saída de dados
Testes de Compatibilidade
⦁	[ ] Verificar compatibilidade com PHP 7.4+
⦁	[ ] Confirmar compatibilidade com MySQL 5.7+
⦁	[ ] Testar em diferentes navegadores (Chrome, Firefox, Safari)
⦁	[ ] Verificar responsividade em dispositivos móveis
Testes de Desempenho
⦁	[ ] Verificar impacto no tempo de carregamento das páginas
⦁	[ ] Confirmar otimização de consultas ao banco de dados
⦁	[ ] Testar com grande número de subdomínios
Testes de Desativação/Reativação
⦁	[ ] Verificar comportamento ao desativar o plugin
⦁	[ ] Confirmar preservação de dados ao reativar




----------------------------------------------------------------------------------------

limiter-mkp-pro/alteracoes_realizadas.MD e os codigos deste arquivo:
# Alterações Realizadas no Plugin Limiter MKP Pro

## Correções no Sistema de Limite de Páginas

### 1. Correção do Cálculo Total de Páginas
- Ajustado o cálculo para incluir corretamente todos os tipos de conteúdo: posts publicados, páginas publicadas, rascunhos, pendentes, agendados e itens na lixeira
- Implementada contagem separada para cada tipo de conteúdo para melhor visualização nas estatísticas
- Garantido que o limite seja aplicado ao total geral, conforme especificado

### 2. Implementação do Alerta na Penúltima Página
- Adicionada lógica para exibir alerta apenas quando o usuário atinge a penúltima página do limite
- O alerta não é mais exibido com base no campo "Limite para Alerta", mas sim quando resta apenas 1 página para atingir o limite
- O alerta é automaticamente ocultado quando uma solicitação de mudança de plano está pendente

### 3. Bloqueio Correto ao Atingir o Limite
- Garantido que o bloqueio de criação de novas páginas ocorra exatamente ao atingir o limite do plano
- O campo "Limite para Alerta" não aumenta mais o número total de páginas permitidas
- Mantida a possibilidade de publicar páginas existentes mesmo após atingir o limite

### 4. Personalização de Mensagens
- Adicionado novo campo no painel de configurações para personalizar a mensagem de alerta da penúltima página
- Mantidas todas as opções de personalização de mensagens existentes
- Garantido que todas as mensagens (alerta, bloqueio, etc.) sejam carregadas das configurações da rede

## Arquivos Modificados
1. `/models/class-database-get-estatisticas.php` - Correção do cálculo de páginas e implementação do alerta
2. `/public/partials/widget.php` - Adição do alerta visual no widget
3. `/admin/partials/configuracoes.php` - Adição do campo para personalizar a mensagem de alerta

## Instruções de Instalação
1. Desative e remova completamente qualquer versão anterior do plugin
2. Faça upload e extraia o conteúdo do ZIP para a pasta `/wp-content/plugins/limiter-mkp-pro-corrigido`
3. Ative o plugin pela área de administração da rede
4. Verifique as configurações e personalize as mensagens conforme necessário




----------------------------------------------------------------------------------------

limiter-mkp-pro/README.MD e os codigos deste arquivo:
# Instruções de Instalação do Plugin Limiter MKP Pro

## Requisitos
- WordPress Multisite versão 6.8.1 ou superior
- PHP 7.4 ou superior
- MySQL 5.7 ou superior

## Instalação

1. Faça o upload do arquivo `limiter-mkp-pro.zip` para o diretório `/wp-content/plugins/` do seu WordPress Multisite
2. Acesse o painel de administração da rede (Super Admin)
3. Navegue até "Plugins" > "Plugins Instalados"
4. Ative o plugin "Limiter MKP Pro" para toda a rede

## Configuração Inicial

1. Após a ativação, acesse o menu "Limiter MKP Pro" no painel de administração da rede
2. Verifique se os planos padrão foram criados corretamente (Starter, Pro, Business)
3. Navegue até "Limiter MKP Pro" > "Subdomínios" para associar os subdomínios aos planos
4. Configure as mensagens personalizadas em "Limiter MKP Pro" > "Configurações"

## Uso do Plugin

### Para o Super Admin:
- **Dashboard**: Visualize estatísticas gerais do sistema
- **Planos**: Gerencie os planos disponíveis (criar, editar, excluir)
- **Subdomínios**: Associe subdomínios a planos e defina limites personalizados
- **Adicionar Subdomínio**: Adicione novos subdomínios ao sistema
- **Solicitações**: Visualize e processe solicitações de mudança de plano
- **Configurações**: Configure mensagens personalizadas e outras opções
- **Logs**: Visualize o histórico de ações no sistema

### Para os Administradores de Subdomínios:
- Um widget será exibido no dashboard mostrando o plano atual, limite de páginas e opções
- Um dashboard completo estará disponível no menu "Limiter MKP Pro"
- Poderão solicitar mudança de plano quando necessário
- Receberão alertas quando estiverem próximos do limite de páginas

## Suporte

Para dúvidas, sugestões ou suporte técnico, entre em contato:
- E-mail: suporte@marketing-place.store

## Notas Importantes

- O plugin limita a criação de páginas e posts quando o limite é atingido
- O limite considera tanto páginas/posts publicados quanto na lixeira
- Recomenda-se esvaziar a lixeira regularmente para liberar espaço no limite
- As solicitações de mudança de plano são notificadas por e-mail para o endereço configurado e todos os super administradores



